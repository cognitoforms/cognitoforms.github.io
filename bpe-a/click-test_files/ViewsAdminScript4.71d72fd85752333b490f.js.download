(window["webpackJsonp"] = window["webpackJsonp"] || []).push([["ViewsAdminScript4"],{

/***/ "../../../Cognito.Services/Views/Admin/entries.js":
/*!*****************************************************************************************!*\
  !*** C:/Users/TylerTrotter/repos/Cognito Forms/Cognito.Services/Views/Admin/entries.js ***!
  \*****************************************************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/// <reference path="../../../Cognito.Web.Client/apps/spa/src/views/admin/utils/exoweb.d.ts" />
/* harmony default export */ __webpack_exports__["default"] = (function ({
	emitViewUpdated,
	currentEntryView,
	showNewEntry,
	onCreateNewEntry,
	onExportEntries,
	onPerformBulkAction,
	currentViewEntryCount,
	isLimitedAccess,
	canManageEntries,
	formData,
	isAssignedView,
	onOverrideFormEntryCreation,
	onUpdateHasSelectedEntries,
	setEntryDetailsIsOpen,
	isMobile
}) {

	Cognito.ready("entries", ["pageScripts", "Cognito.Forms", "expression-builder"], function ($) {

		hideEntryDetails();

		//#region Global Variables

		var layoutMode;
		var currentEntryKey;
		var entryHasChanges = false;
		var performingSubmit = false;
		var pendingAction;
		var selectedEntries = [];
		var previousViewData;
		var shareEntryDialog;
		var submittingCashPayment = false;
		var submittingRefund = false;

		var tempColumns;
		var tempSort;
		var tempFilter;

		currentViewEntryCount.value = Cognito.Forms.model.initialEntryCount;
		// #endregion

		/**
		 * Returns a function that will call the underlying callback as long as the form has not changed.
		 * @param {Function} callback The underlying callback to invoke
		 * @returns A function that conditionally calls the given callback.
		 */
		function checkForm(callback) {
			if (!window.Cognito || !Cognito.Forms.model || !Cognito.Forms.model.formId) {
				console.warn('Cannot bind a callback prior to the form id being established.');
				return callback;
			}

			let capturedFormId = Cognito.Forms.model.formId;

			return function checkFormCallback() {
				if (!window.Cognito || !Cognito.Forms || !Cognito.Forms.model || Cognito.Forms.model.formId !== capturedFormId) {
					console.log('Discarding callback due to form change from ' + capturedFormId + ' to ' + (window.Cognito && Cognito.Forms.model && Cognito.Forms.model.formId) + '.');
					return;
				}

				// Call the original callback
				return callback.apply(this, arguments);
			};
		}

		//#region Controller
		var menu = null;
		var previousViewId = null;
		var controller = {

			openActionsMenu: function openActionsMenu(shouldHideDetails, x, y) {
				if (menu) {
					menu.close("entry-view-actions");
				}

				if (!menu || previousViewId != Cognito.Forms.model.currentView.get_Id()) {
					menu = document.querySelector('[data-menu="entry-view-actions__menu--context"] > ul').__vue__.$root.$refs.menu
				}
				previousViewId = Cognito.Forms.model.currentView.get_Id()

				// Close entry details pane before opening context menu
				if (shouldHideDetails) {
					controller.hideEntry();
				}

				var openDialogs = document.getElementsByClassName("c-modal is-active");
				if (openDialogs.length > 0) {
					return;
				}

				setTimeout(function () {
					menu.open("entry-view-actions");
					menu.$emit('open');
					menu.$el.firstChild.focus();
				});

				var container = document.querySelector('.entry-view-actions__menu--context');
				container.style.display = 'none';

				setTimeout(() => {
					container.style.display = 'block';
					container.style.top = y + "px";
					container.style.left = x + "px";
				});
			},

			// Initialize Master
			initMaster: function initMaster(masterController) {
				if (typeof masterController === 'string')
					controller.master = Cognito.Messaging.proxy($("#c-entrylist")[0].contentWindow, masterController);
				else
					controller.master = masterController;

				Cognito.ready("master");
			},

			// Initialize Detail
			initDetail: function initDetail(detailController) {
				if (typeof detailController === 'string')
					controller.detail = Cognito.Messaging.proxy($("#c-entrydetails")[0].contentWindow, detailController);
				else
					controller.detail = detailController;
				controller.detail.setRole(getEntryViewRole().get_Name());
				controller.detail.setSummaryProperty(getSummaryProperty());
				controller.detail.setIsAssignedEntry(isAssignedView.value);
				Cognito.ready("detail");
			},

			// Remove Detail controller
			removeDetail: function removeDetail() {
				delete controller.detail;
				delete Cognito.readyDependencies["detail"];
			},

			// Initialize Refund Order Dialog
			initRefundOrder: function initRefundOrder(refundOrderController) {
				controller.refundOrder = Cognito.Messaging.proxy($("iframe[name=refundOrder]")[0].contentWindow, refundOrderController);
			},

			// Initialize Document Templates Dialog
			initDocumentTemplates: function initDocumentTemplates(documentTemplatesController) {
				controller.documentTemplates = Cognito.Messaging.proxy($("iframe[name=documentTemplates]")[0].contentWindow, documentTemplatesController);
			},

			// Initialize Share Entry Dialog
			initShareEntry: function initShareEntry(shareEntryController) {
				controller.shareEntryDialog = Cognito.Messaging.proxy($("iframe[name=share]")[0].contentWindow, shareEntryController);
				controller.shareEntryDialog.updateNotificationFromAddressBadge();
			},

			// Preview Files
			previewFiles: function previewFiles(files, index) {
				Cognito.showOverlay(function () {
					Cognito.hideOverlay();
				});
			},

			// View Entry
			viewEntry: function viewEntry(entryKey) {
				executeAction(function () {
					Cognito.ready("view-entry", ["detail", "master"], function () {
						currentEntryKey = entryKey;
						controller.master.viewEntry(entryKey, Cognito.Forms.model.currentView.get_Token());
						controller.detail.viewEntry(entryKey, Cognito.Forms.model.currentView.get_Token());
						showEntryDetails();
						updateNavigation();
					});
				});
			},

			// Hide Entry
			hideEntry: function hideEntry(newView) {
				executeAction(function () {
					if (!isEntryDetailsVisible())
						return;

					controller.master.hideEntry();
					currentEntryKey = null;
					hideEntryDetails();
					updateNavigation(newView);
				});
			},

			// New Entry
			newEntry: function newEntry() {
				currentEntryKey = null;
				const viewType = Cognito.Forms.model.currentView.get_Type().get_Name();
				if (viewType === 'Table') {
					// Clear the current entry selection
					controller.master.clearSelection();
					controller.master.hideEntry();

					// Display the details edit view
					controller.detail.newEntry();

					showEntryDetails();
				}
				else if (viewType === 'Form') {
					const roleId = Cognito.Forms.model.currentView.get_RoleId();
					const role = Cognito.Forms.model.currentForm.get_Roles().find(function (r) { return r.get_Id() === roleId; });
					const isPublic = role.get_IsPublic();
					Cognito.formViewAdapter.setNewEntry(role.get_Name(), isPublic);
					onOverrideFormEntryCreation(false);
				}

			},

			// Entry Changed
			entryChanged: function entryChanged() {
				entryHasChanges = true;
			},

			// Discard Entry Changes
			discardChanges: function discardChanges(entryKey, keepNewEntry, showDialog) {
				// Show the "Unsaved Changes" dialog
				if (showDialog && entryHasChanges) {
					Cognito.navigate();
					return;
				}

				entryHasChanges = false;

				controller.detail.discardChanges(entryKey, keepNewEntry);

				// Hide the entry details if a current entryKey does not exist (new entry)
				if (!currentEntryKey && !keepNewEntry)
					hideEntryDetails();

				// Execute the pending action
				executeAction();
			},

			// Entry Added
			entryAdded: function entryAdded(entryKey, viewEntry) {
				currentEntryKey = entryKey;
				entryHasChanges = false;

				var onEntriesGridUpdated = function () {
					controller.master.viewEntry(entryKey)
				}

				if (!Cognito.config.flags.AppNav) {
					if (Cognito.config.flags.UseCosmosIndexes)
						controller.master.pollEntryChanges(entryKey, onEntriesGridUpdated);
					else
						controller.master.refreshEntries(onEntriesGridUpdated);
				}
				else
					controller.master.viewEntry(entryKey);

				// If quantity is exceeded during a race condition, the entry will be saved but the model is invalid, so stay on the edit view
				if (viewEntry !== false) {
					controller.detail.viewEntry(entryKey);
				}

				// Execute the pending action
				executeAction();
			},

			/**
			 * Sets the performingSubmit flag to indicate that a workflow action or a save and resume save is being performed
			 */
			setPerformingSubmit: function setPerformingSubmit(value) {
				performingSubmit = value;
			},

			// Entry Updated
			entryUpdated: function entryUpdated(entryKey, viewEntry, callback) {
				entryHasChanges = false;

				if (!Cognito.config.flags.AppNav) {
					if (Cognito.config.flags.UseCosmosIndexes)
						controller.master.pollEntryChanges(entryKey);
					else
						controller.master.refreshEntries();
				}

				if (currentEntryKey && currentEntryKey.EntryId === entryKey.EntryId && viewEntry !== false)
					controller.detail.viewEntry(entryKey);

				currentEntryKey = entryKey;

				if (callback)
					callback();

				// Execute the pending action
				executeAction();
			},

			// Entry Update Failed
			entryUpdateFailed: function entryUpdateFailed(entryKey) {
				controller.hideMenus();

				// Ensure the current entry is selected. The update may have been triggered by the
				// unsaved changes dialog that was displayed due to selecting another entry.
				controller.master.viewEntry(entryKey, Cognito.Forms.model.currentView.get_Token());

				// If the entry update failed, executing pending actions
				if (pendingAction)
					executeAction();
			},

			// Entry Deleted
			entryDeleted: function entryDeleted(entryKey) {
				entryHasChanges = false;
				if (!Cognito.config.flags.AppNav) {
					if (Cognito.config.flags.UseCosmosIndexes)
						controller.master.pollEntryChanges(entryKey);
					else
						controller.master.refreshEntries();
				}

				if (currentEntryKey && currentEntryKey.EntryId === entryKey.EntryId)
					controller.hideEntry();

				// Execute the pending action
				executeAction();
			},

			// Delete Entries
			deleteEntries: function deleteEntries(entries) {
				deleteEntryDialog.entries = entries;
				deleteEntryDialog.open();
			},

			// Update Entry Status
			updateEntryStatus: function updateEntryStatus(entries, statusName, triggerEntryNotifications, statusId) {

				// Show the change status dialog when changing the status of multiple entries
				if (entries.length > 1) {

					// Clear the incomplete entries flag
					delete changeStatusDialog.incompleteEntries;

					changeStatusDialog.entries = entries;
					changeStatusDialog.statusName = statusName;
					changeStatusDialog.statusId = statusId;
					changeStatusDialog.open();
				}
				else
					changeStatus(entries, statusName, triggerEntryNotifications, changeStatusDialog.incompleteEntries, statusId);

				// Clear the incomplete entries flag
				delete changeStatusDialog.incompleteEntries;
			},

			// Updates the entry read states in the grid. This eventually calls updateEntryReadState with only completed entries
			updateGridReadState: function updateGridReadState(entries, read) {
				controller.master.changeReadStates(entries, read);
			},

			// Update Entry Read State
			updateEntryReadState: function updateEntryReadState(entries, read) {
				changeReadState(entries, read, !read);
			},

			// Import Entries
			importEntries: function importEntries() {
				// Hide menus
				controller.hideMenus();

				displayImportEntriesDialog();
			},

			// Export Entries
			exportEntries: function exportEntries(exportAllFields, selectedEntries) {

				// Hide menus
				controller.hideMenus();

				if (Cognito.config.exportId) {
					controller.openEntryExportDialog(Cognito.config.exportId, "InProgress");
				}
				else {
					var formId = Cognito.Forms.model.currentForm.get_Id();
					var entryView = Cognito.Forms.model.currentView;
					var entryViewSaved = Cognito.Forms.model.currentView.get_noViewChanges();

					Cognito.Forms.exportController.tryStartExport(formId, entryView, entryViewSaved, selectedEntries, exportAllFields, currentViewEntryCount.value, startExportSuccessful, startExportFailed);
				}

				function startExportSuccessful(jsonData, textStatus, xhrData) {
					startEntryExportCallback(jsonData.Id, xhrData);
				}

				function startExportFailed(xhrData) {
					startEntryExportCallback(null, xhrData);
				}

				function startEntryExportCallback(exportId, responseData) {
					if (exportId)
						Cognito.config.exportId = exportId;

					var requestStatus = responseData.status;
					var responseMessage = null;

					if (responseData.responseText) {
						var responseBody = JSON.parse(responseData.responseText);
						responseMessage = responseBody.Message;
					}

					var exportStatus = requestStatus === 200 ? "Pending" : "Failed";

					controller.openEntryExportDialog(exportId, exportStatus, requestStatus, responseMessage);
				}
			},

			openEntryExportDialog: function (exportId, status, startExportRequestStatus, startExportResponseMessage) {
				if (exportId === "expired")
					status = "Expired";

				// Success event handler to download the file
				var handleExportSuccess = function (eventData) {
					Cognito.config.exportId = null;
					$.fileDownload(eventData.downloadUrl, { httpMethod: "GET" });
				}

				var handleExportFailure = function () {
					Cognito.config.exportId = null;
				}

				VueComponents.EntryExportDialog.open(
					{
						exportId: exportId,
						startExportRequestStatus: startExportRequestStatus,
						startExportResponseMessage: startExportResponseMessage,
						userEmail: Cognito.config.userInfo.Email,
						status: status
					},
					[
						{
							eventName: "success",
							eventHandler: handleExportSuccess
						},
						{
							eventName: "failure",
							eventHandler: handleExportFailure
						},

					]
				);
			},

			initViews: function initViews(changingForm) {
				VueComponents.closeAllDialogs();
				Cognito.Forms.model.views = [];
				Cognito.Forms.refreshViews().then(checkForm(function (views) {
					Cognito.ready(null, ["master"], checkForm(function () {
						const view = views.find(function (v) { return v.Id === Cognito.Forms.model.currentView.get_Id(); });
						Cognito.Forms.model.currentView.set_isUserSpecific(view.IsUserSpecific || false);
						const currentViewType = Cognito.Forms.model.currentView.get_Type().get_Name();
						if (currentViewType === 'Form') {
							Cognito.ready(null, ["formViewAdapter"], function () {
								controller.changeView(Cognito.Forms.model.currentView, layoutMode, changingForm);
							});
						}
						else {
							controller.changeView(Cognito.Forms.model.currentView, layoutMode, changingForm);
						}
					}));
				}));
			},

			changeForm: function changeForm(form) {
				$extend(Cognito.Forms.model.entryTypeName, function (entryType) {

					Cognito.Forms.entryType = entryType;

					// Ensure the calculated order property is initialized
					if (entryType.$Order) {
						entryType.$Order.calculated({
							calculate: function () {
								if (!this.hasOwnProperty("_Order")) {
									this.set_Order(null);
								}
							}
						});
					}
				});

				currentEntryKey = null;
				controller.initViews(true);
			},

			// Change View
			changeView: function changeView(view, mode, changingForm) {
				var currentView = Cognito.Forms.model.currentView;

				// Close the details view and clear selections if changing views
				if (view.get_Id() != currentView.get_Id()) {
					if (controller.master) {
						controller.hideEntry(view);
						controller.master.clearSelection();
					}
				}

				// Rollback changes if there is previous view data
				if (!Cognito.Forms.model.currentView.get_noViewChanges() && previousViewData) {
					// Remove the view from the client memory cache
					var entryViewType = Cognito.Forms.EntryView.meta;
					delete entryViewType._pool[currentView.meta.id.toLowerCase()];
					if (entryViewType._known)
						entryViewType._known.remove(currentView);

					Cognito.Forms.model.views[Cognito.Forms.model.views.indexOf(Cognito.Forms.model.currentView)] = Cognito.deserialize(Cognito.Forms.EntryView, previousViewData);

					// Clear the view has changes flag
					Cognito.Forms.model.currentView.set_noViewChanges(true);
				}

				// Store the view data so it can be rolled back if needed. Stringify and parse the data to ensure arrays are copied.
				previousViewData = JSON.parse(JSON.stringify(Cognito.serialize(view)));

				// Reset noViewChanges
				currentView.set_noViewChanges(true);

				ExoWeb.Observer.setValue(Cognito.Forms.model, "currentView", view);

				requestAnimationFrame(function () {
					if (Cognito.config.flags.UserSpecificViews) {
						const newView = Cognito.Forms.model.views.find(function (v) { return v.Id === view.get_Id() });
						if (newView)
							currentViewEntryCount.value = newView.Entries;
						else
							currentViewEntryCount.value = 0;
					}
				});

				const roleId = Cognito.Forms.model.currentView.get_RoleId();
				const role = formData.value.Roles.find(function (r) { return r.Id === roleId; });
				ExoWeb.Observer.setValue(Cognito.Forms.model, "isPublicRole", role.IsPublic);

				Cognito.ready(null, ['detail', 'master'], checkForm(function () {
					controller.master.changeView(view, mode, role, changingForm);

					controller.detail.setIsAssignedEntry(isAssignedView.value);

					controller.detail.changeView(view);
					controller.detail.setSummaryProperty(getSummaryProperty());

					controller.detail.setRole(role.Name);

					updateNavigation();

					if (showNewEntry.value)
						executeAction(() => controller.newEntry());
				}));
			},

			// New View
			newView: function newView() {
				Cognito.Forms.onNewView();
			},

			// Save View
			saveView: async function saveView(view, isOnlyRenaming) {

				// Individual Plan
				if (!Cognito.config.hasPaidPlan) {
					controller.showFeatureWarning("entryviews");
					return;
				}

				// Check if user can manage entries
				if (!canManageEntries.value) {
					return;
				}

				// Clear out the view internal name
				view.set_InternalName(null);

				//refresh the current entry view's sequence key
				if (view.get_Id() && Cognito.config.flags.AppNav)
					view.set_SequenceKey(currentEntryView.value.SequenceKey);

				// Save the view
				Cognito.Forms.saveEntryView(view, function (data) {
					view.isUserSpecific = view.get_SharedWithMe();
					Cognito.deserialize(Cognito.Forms.EntryView, data, view);

					// Set previous view data since new view could be a copy before being saved
					previousViewData = JSON.parse(JSON.stringify(Cognito.serialize(view)));

					// update currentView in the globalStore passed in from EntriesPage.vue
					emitViewUpdated(data.Id, data);

					// Do not refresh grid if only renaming current view name
					if (isOnlyRenaming)
						return;

					// Change to the saved view
					controller.changeView(view, null);
				});

				// Clear the previous view data
				previousViewData = null;

				$(".c-save-view .c-nav-button").addClass("c-nav-disabled");
			},

			// Save View As
			saveViewAs: function saveViewAs() {
				if (!Cognito.config.hasPaidPlan) {
					if (Cognito.Forms.model.views.length > Cognito.config.entryViewLimit)
						this.showFeatureWarning("entryviewsexist");
					else
						this.showFeatureWarning("entryviews");
					return;
				}
				else if (Cognito.Forms.model.views.length >= Cognito.config.entryViewLimit) {
					showViewLimitExceededWarning();
					return;
				}

				var newView = Object.assign({}, Cognito.serialize(Cognito.Forms.model.currentView));
				newView.Id = null;

				controller.openEntryViewSettings(newView, true);
			},

			// View Changed
			viewChanged: function viewChanged() {

				// Flag the view has changes
				Cognito.Forms.model.currentView.set_noViewChanges(false);
			},

			// Delete View
			deleteView: function deleteView(viewId = null) {
				var view = viewId ? Cognito.deserialize(Cognito.Forms.EntryView, Cognito.Forms.model.views.find(function (v) { return v.Id === viewId })) : Cognito.Forms.model.currentView;

				// Switch to the first view in the list that is not the current view
				var defaultView = Cognito.Forms.model.views.find(function (v) { return v.Id !== view.get_Id() });
				Cognito.Forms.onChangeView(defaultView.Id);

				// Then delete the view
				Cognito.Forms.deleteEntryView(view.get_Id(), function () {
					/// Refresh the list of available views
					Cognito.Forms.refreshViews();
				});
			},

			// Copy View
			copyView: function copyView() {
				if (Cognito.Forms.model.views.length >= Cognito.config.entryViewLimit) {
					showViewLimitExceededWarning();
					return;
				}

				// Save the copied view
				Cognito.Forms.copyEntryView(Cognito.Forms.model.currentView, function (copyData) {
					var copy = Cognito.deserialize(Cognito.Forms.EntryView, copyData);
					Cognito.Forms.model.views.add(copy);
					controller.changeView(copy, layoutMode);

					if (!Cognito.config.flags.UserSpecificViews) {
						controller.showRenameView();
					}
				});
			},
			canAccessDestinationView: function canAccessDestinationView() {
				return Cognito.Forms.model.views.map(function (v) { return v.Id; }).includes(Cognito.Forms.model.currentView.get_AfterSubmitDestinationViewId());
			},

			// Show Rename View
			showRenameView: function showRenameView() {
				// Select and focus name text
				var textInput = $(".c-rename-view input:text").get(0);
				textInput.selectionStart = 0;
				textInput.selectionEnd = textInput.value.length;

				controller.hideMenus();

				showMenu($(".c-menu-current-view"));

				window.setTimeout(function () {
					// Add CSS to show the rename textbox
					$(".c-menu-current-view").addClass("c-show-rename");

					$(".entry-views-menu")[0].style.display = 'none';

					// Focus the element now that it is visible
					textInput.focus();
				}, 0);
			},

			// Change Layout
			changeLayout: function changeLayout(mode) {
				Cognito.ready(null, ["master, detail"], function () {
					controller.master.changeLayout(mode);
					controller.detail.changeLayout(mode);
				});
			},

			// Change Columns
			changeColumns: function changeColumns(columns) {
				Cognito.Forms.model.currentView.set_Columns(columns);

				if (controller.master)
					controller.master.changeColumns(columns);
				else
					tempColumns = columns;

				controller.viewChanged();

				if (controller.detail)
					controller.detail.setSummaryProperty(getSummaryProperty());
			},

			// Change Sort
			changeSort: function changeSort(columns) {
				Cognito.Forms.model.currentView.set_SortBy(columns);
				if (controller.master)
					controller.master.changeSort(columns);
				else
					tempSort = columns;

				controller.viewChanged();
			},

			// Change Filter
			changeFilter: function changeFilter(filter) {
				// Close the details view
				controller.hideEntry();

				if (filter.get_allEntryStatuses())
					filter.get_EntryStatus().clear();
				if (filter.get_allPaymentStatuses())
					filter.get_PaymentStatus().clear();

				Cognito.Forms.model.currentView.set_Filter(filter);
				if (controller.master)
					controller.master.changeFilter(filter);
				else
					tempFilter = filter;

				controller.viewChanged();
			},

			// Hide Menus
			hideMenus: function hideMenus() {
				Cognito.timers.hideMenus = window.setTimeout(function () {
					$(".c-menu-expanded").removeClass("c-menu-expanded");
					$(".c-menu-open").removeClass("c-menu-open").css("transition", "").css("max-height", "").css("overflow-y", "");

					// Hide context menus in child windows, protecting against calls occurring before they are registered
					if (controller.master)
						controller.master.hideMenus();

					// Remove CSS used to display the rename textbox
					$(".c-menu-current-view").removeClass("c-show-rename");

					// Show entry view menu
					var entryViewMenu = $(".entry-views-menu");
					if (entryViewMenu.length)
						entryViewMenu[0].style.display = "block";

					//Clear z-index of entry list grid due to scrolling issues in edge
					$("#c-entrylist").removeClass("c-entries-open-menu");
				}, 0);
			},

			// Select Entries
			selectEntries: function selectEntries(entries) {
				// Update EntriesPage value first
				if (selectedEntries.length == 0 || entries.length == 0)
					onUpdateHasSelectedEntries(entries.length > 0);

				selectedEntries = entries;
				var form = Cognito.Forms.model.currentForm;
				// Clear selected entries
				form.set_selectedEntries([]);
				form.set_selectedEntriesLimited([]);

				form.set_selectedEntries(selectedEntries);
				if (selectedEntries.length > 0 && selectedEntries.length <= 1000) {
					form.set_entriesSelected(true);
					form.set_selectedEntriesLimited(selectedEntries.slice(0, 1000));
				}
				else if (selectedEntries.length > 1000) {
					// Limited Access users should always only see actions they can perform, regardless of how many entries selected
					if (isLimitedAccess.value)
						form.set_selectedEntriesLimited(selectedEntries)
					else
						form.set_selectedEntriesLimited([]);

					form.set_entriesSelected(true);
				}
				else {
					form.set_entriesSelected(false);
					form.set_selectedEntriesLimited([]);
				}
			},

			// Update Entry Count
			updateEntryCount: function updateEntryCount(count) {
				currentViewEntryCount.value = count;
				Cognito.Forms.getEntryViews(Cognito.Forms.model.currentForm.get_Id())
					.then(function (views) {
						ExoWeb.Observer.setValue(Cognito.Forms.model, "views", views);
						return views;
					});
			},

			updateEntryDetails: function updateEntryDetails(entryKey) {
				controller.detail.refreshEntry(entryKey);
			},

			// Pay With Cash
			payWithCash: function payWithCash(entryKey, paymentAmount) {
				if (submittingCashPayment)
					return;
				submittingCashPayment = true;

				var viewId = Cognito.Forms.model.currentView.get_Id();
				Cognito.Forms.makePayment(viewId, entryKey.EntryId, null, null, paymentAmount)
					.then(function (data) {
						controller.entryUpdated(data.entryKey, null, function () { submittingCashPayment = false });
					})
					.catch(function () {
						submittingCashPayment = false;
					});
			},

			// Submit Payment
			submitPayment: function submitPayment(entryKey, customerCard) {
				displaySubmitPaymentDialog(entryKey, customerCard, Cognito.Forms.model.currentForm.get_PaymentAccount().get_ProcessorName().toLowerCase());
			},

			// Refund Manual Payment
			refundManualPayment: function refundManualPayment(entryKey) {
				refundOrder(entryKey.EntryId);
			},

			// Refund Payment
			refundPayment: function refundPayment(entryId, refundModel) {
				displayRefundOrderDialog(entryId, refundModel);
			},

			// Share Entry
			shareEntry: function shareEntry(entryKey, emittedRoles, allowSaveAndResumeLink) {
				if (Cognito.config.hasPaidPlan) {
					// Serialize roles
					var roles = Cognito.Forms.model.currentForm.get_Roles();
					if (!roles)
						return;

					VueComponents.ShareEntryDialog.open({
						entryId: entryKey.EntryId,
						entryViewId: Cognito.Forms.model.currentView.get_Id(),
						roles: emittedRoles,
						allowSaveAndResumeLink: allowSaveAndResumeLink,
						isLimitedWorkflowPro: Cognito.config.isLimitedWorkflowPro,
						dateFormat: Sys.CultureInfo.CurrentCulture.dateTimeFormat.ShortDatePattern
					});
				}
				else {
					controller.showFeatureWarning("entrysharing");
				}
			},

			// Close Share Entry
			closeShareEntry: function closeShareEntry(emailSent) {
				if (shareEntryDialog) {
					if (emailSent) {
						var $button = $(".c-modal:visible .c-modal-button:contains('Send')");
						if ($button.length > 0) {
							$button.text("Sending...");
							$button.addClass("sending").delay(1600).queue(function () {
								$button.addClass("done").dequeue();
								$button.text("Send").dequeue().delay(1600).queue(function () {
									$button.removeClass('sending').dequeue().delay(1200).queue(function () {
										$button.removeClass('done').dequeue();
										shareEntryDialog.close();
									});
								});
							});
						}
					}
					else
						shareEntryDialog.close();
				}
			},

			// Manage Document Templates
			manageTemplates: function manageTemplates() {
				if (Cognito.config.flags.NewDocumentTemplatesDialog) {
					var currentForm = Cognito.Forms.model.currentForm;

					VueComponents.ManageDocumentTemplatesDialog.open(
						{
							rawDocumentTemplates: Cognito.serialize(currentForm.get_DocumentTemplates()),
							formRoles: Cognito.serialize(currentForm.get_Roles()),
							tokensList: Cognito.Forms.generateTokens(),
							formName: currentForm.get_Name(),
							hasPaidPlan: Cognito.config.hasPaidPlan,
							encryptEntries: currentForm.get_EncryptEntries(),
							isPaymentForm: Cognito.Forms.model.isPaymentForm,
							isMultiPageForm: formData.value.IsMultiPageForm,
							tokenizeHtml: Cognito.Forms.tokenizeHtml,
							lowerOrganizationCode: Cognito.config.lowerOrganizationCode,
							currentForm: Cognito.serialize(currentForm),
							isFormPersisted: true,
							customTemplateLimit: Cognito.config.customTemplateLimit,
							templateFee: Cognito.config.templateFee,
							tierTemplateFee: Cognito.config.tierTemplateFee,
							planName: Cognito.config.planName,
							saveDocumentTemplates: function (documentTemplates) {
								var documentTemplates = Cognito.deserialize(Cognito.Forms.FormDocumentTemplate, documentTemplates);
								var form = Cognito.Forms.model.currentForm;

								return Cognito.Forms.saveDocumentTemplates(form, null, documentTemplates);
							},
							generateWordTemplate: function (documentTemplates, docTemplateNumber, allowCaching) {
								var documentTemplates = Cognito.deserialize(Cognito.Forms.FormDocumentTemplate, documentTemplates);
								var form = Cognito.Forms.model.currentForm;

								return Cognito.Forms.generateWordTemplate(form, documentTemplates, docTemplateNumber, allowCaching)
							},
							validateWordTemplate: function (documentTemplates, files) {
								// we only pass null for files if we're doing initialization validation
								if (!documentTemplates && !files) {
									form = Cognito.Forms.model.currentForm.get_Id();
									// create a payload to batch validate document templates
									files = Cognito.Forms.model.currentForm.get_DocumentTemplates().filter(function (d) { return d.get_File() !== null; }).map(function (d) { return ({ FileId: d.get_File().get_Id() }); });
								}
								else {
									var documentTemplates = Cognito.deserialize(Cognito.Forms.FormDocumentTemplate, documentTemplates);
									var form = Cognito.Forms.model.currentForm;
								}

								return Cognito.Forms.validateWordTemplate(form, documentTemplates, files);
							},
							annotateWordTemplate: function (documentTemplates, docTemplateNumber) {
								var documentTemplates = Cognito.deserialize(Cognito.Forms.FormDocumentTemplate, documentTemplates);
								var form = Cognito.Forms.model.currentForm;

								return Cognito.Forms.annotateWordTemplate(form, documentTemplates, docTemplateNumber)
							}
						},
						[
							{
								eventName: "templates-updated",
								eventHandler: function (documentTemplates, version) {
									// Need to set this so that we can make subsequent changes to the form after saving once
									// Should only be called on a successful template update
									currentForm.set_Version(version);
									controller.templatesUpdated(Cognito.deserialize(Cognito.Forms.FormDocumentTemplate, documentTemplates));
								}
							}
						]
					);
				}
				else {
					Cognito.Forms.manageDocumentTemplates({
						autoSave: true,
						usePersistedData: true,
						hasExternalChanges: entryHasChanges
					});
				}
			},

			// Exposes document templates save used by the share entry page/dialog
			saveTemplates: function saveTemplates() {
				controller.documentTemplates.save();
			},

			// Document Templates Updated
			templatesUpdated: function templatesUpdated(templates) {
				controller.detail.templatesUpdated(templates);

				// Update the list of templates to reflect changes
				Cognito.Forms.model.currentForm.set_DocumentTemplates(templates);

				if (controller.shareEntryDialog)
					controller.shareEntryDialog.templatesUpdated(templates);

				Cognito.Forms.closeTemplatesDialog();
			},

			savePanelWidth: function savePanelWidth(width) {
				Cognito.config.entryPageSettings.EntryPanelWidth = width;
				Cognito.serviceRequest({
					method: "PUT",
					endpoint: "/forms/admin/" + Cognito.Forms.model.currentForm.meta.id + "/entry-panel-width/" + width,
					success: function (data) {
					}
				});
			},
			// Email Notification
			openEmailNotificationDialog: function openEmailNotificationDialog(entryKey, documentTemplates, availableRoles) {
				if (Cognito.config.hasPaidPlan) {
					var rolesObject = {
						roles: availableRoles,
						showUpsell: false,
						isLimitedWorkflowPro: Cognito.config.isLimitedWorkflowPro,
						openWorkflowUpsell: function () { return controller.showFeatureWarning('workflowlinks'); }
					};

					var themeSettings = Cognito.Forms.model.currentForm.get_ThemeSettings();
					var formHasLogo = themeSettings && !!themeSettings.get_Logo();

					VueComponents.SendEmailDialog.open({
						entryId: entryKey.EntryId,
						documentTemplates: documentTemplates,
						rolesSelect: rolesObject,
						enableEntrySharing: Cognito.Forms.model.currentForm.get_EnableEntrySharing(),
						isPaymentForm: Cognito.Forms.model.isPaymentForm,
						formHasLogo: formHasLogo,
						defaultWorkflowLinkButtontext: Cognito.config.defaultWorkflowLinkButtonText
					});
				} else {
					controller.showFeatureWarning("entrysharing");
				}
			},

			// Feature Not Available
			showFeatureWarning: function showFeatureWarning(feature) {
				if (typeof feature === 'string') {
					VueComponents.UpsellDialog.open({ feature: feature, isOrgOwner: Cognito.config.role === 'Owner', orgCode: Cognito.config.organizationCode });
				}
				else
					VueComponents.UpsellDialog.open({ feature: feature.featureName, isOrgOwner: feature.isOrgOwner, orgCode: Cognito.config.organizationCode });
			},

			openViewEmailDialog: function openViewEmailDialog(data) {
				VueComponents.ViewEmailDialog.open({
					outcome: data
				});
			},

			openViewIntegrationDialog: function openViewIntegrationDialog(data) {
				VueComponents.ViewIntegrationDialog.open({
					outcome: data
				});
			},

			openViewGoogleAnalyticsDialog: function openViewGoogleAnalyticsDialog(data) {
				VueComponents.ViewGoogleAnalyticsDialog.open({
					outcome: data
				});
			},

			openViewEntryChangeDialog: function openViewEntryChangeDialog(data) {
				VueComponents.ViewEntryChangeDialog.open({
					show: data.show,
					title: data.title,
					entryId: data.entryId,
					entryChangeId: data.entryChangeId,
					condensedRecordEntryChangeId: data.condensedRecordEntryChangeId,
					entryChangeCount: data.entryChangeCount,
				});
			},

			openEntryViewSettings: function openEntryViewSettings(view, isNew) {

				// Delete View
				var onDeleteView = function () {
					executeAction(function () {
						controller.deleteView();
					});
				}

				// Save View
				var onSaveView = function (view) {
					executeAction(function () {
						view.isUserSpecific = !!view.SharedWithMe;

						// Existing View
						if (view.Id)
							view = Cognito.deserialize(Cognito.Forms.EntryView, view, Cognito.Forms.model.currentView);
						// New View
						else
							view = Cognito.deserialize(Cognito.Forms.EntryView, view);

						// Save the view
						controller.saveView(view);
						Cognito.Forms.refreshViews();
					});
				}

				var onShowUpsell = function () {
					executeAction(function () {
						controller.showFeatureWarning("tasks");
					});
				}

				var isLastGridView = Cognito.Forms.model.views.filter(function (v) {
					return v.Type === 'Table';
				}).length === 1 && view.Type === 'Table';

				// Open Entry View Settings Dialog
				VueComponents.EntryViewSettingsDialog.open(
					{
						view: view,
						roles: formData.value.Roles,
						entryViews: Cognito.Forms.model.views,
						canDelete: !isLastGridView,
						canCopy: Cognito.Forms.model.views.length < Cognito.config.entryViewLimit,
						isMultiPageForm: formData.value.IsMultiPageForm,
						showTasks: Cognito.Forms.model.showWorkflowTasks,
						isOrgOwner: Cognito.config.role === 'Owner',
						orgCode: Cognito.config.organizationCode,
						emailRoleAssignments: formData.value.EmailRoleAssignments,
						workflowLinksEnabled: formData.value.WorkflowLinksEnabled,
						isTaskDashboardEnabled: Cognito.config.flags.TaskDashboard,
						isAppNavEnabled: Cognito.config.flags.AppNav,
						dateFieldInfos: Cognito.Forms.model.fieldInfos.filter(fieldInfo => fieldInfo.FieldSubType === 'Date'),
						culture: window.Sys.CultureInfo.CurrentCulture
					},
					[
						{
							eventName: "delete-view",
							eventHandler: onDeleteView
						},
						{
							eventName: "save-view",
							eventHandler: onSaveView
						},
						{
							eventName: "show-tasks-upsell",
							eventHandler: onShowUpsell
						}
					]
				);
			}
		};

		Cognito.Forms.controller = controller;
		Cognito.ready("Cognito.Forms.controller");

		if ($("#c-entrylist").length) {
			Cognito.Messaging.trigger("controllerReady", { target: $("#c-entrylist").get(0).contentWindow });
		}

		if ($("#c-entrydetails").length) {
			Cognito.Messaging.trigger("controllerReady", { target: $("#c-entrydetails").get(0).contentWindow });
		}

		//#endregion

		//#region Dialogs

		// Unsaved Changes

		Cognito.onNavigate({
			title: "Unsaved Changes",
			text: "Are you sure you want to discard your changes?",
			open: function () { return entryHasChanges; },
			buttons: [
				{
					label: "Discard Changes",
					isCancel: true,
					click: function () {
						this.close();
						pendingAction = pendingAction || this.continue;
						controller.discardChanges(currentEntryKey);
					}
				},
				{
					label: "Keep Editing",
					click: function () {
						this.close();

						// Reset Flags
						pendingAction = null;
						if (currentEntryKey) {
							// Ensure the current entry is selected. The dialog may have been displayed as a result of selecting another entry.
							controller.master.viewEntry(currentEntryKey, Cognito.Forms.model.currentView.get_Token());
						}
					},
				}
			],
			cancel: function () {
				if (!window.Cognito)
					return;

				// Reset Flags
				pendingAction = null;
				if (currentEntryKey) {
					// Ensure the current entry is selected. The dialog may have been displayed as a result of selecting another entry.
					controller.master.viewEntry(currentEntryKey, Cognito.Forms.model.currentView.get_Token());
				}
			}
		});

		// Delete Entry
		var deleteEntryDialog = $.fn.dialog({
			title: "Delete Entry?",
			text: function () {
				var entriesToDelete = deleteEntryDialog.entries;
				var hasOrders = false;
				for (var i = 0; i < entriesToDelete.length; i++) {
					if (entriesToDelete[i].OrderId) {
						hasOrders = true;
						break;
					}
				}
				var referenceMessage = Cognito.Forms.model.isLookupSource || Cognito.Forms.model.isPeopleSource ? " " + (entriesToDelete.length > 1 ? "They" : "It") + " may be referenced by " : "";
				if (Cognito.Forms.model.isLookupSource && Cognito.Forms.model.isPeopleSource)
					referenceMessage += "Lookup or Person fields on other forms.";
				else if (Cognito.Forms.model.isLookupSource)
					referenceMessage += "Lookup fields on other forms.";
				else if (Cognito.Forms.model.isPeopleSource)
					referenceMessage += "Person fields on other forms.";
				return "Are you sure you want to permanently delete <strong>" + (entriesToDelete.length > 1 ? entriesToDelete.length + " entries" : "this entry") + "</strong>?" + referenceMessage + "<br><br>This action cannot be undone.";
			},
			height: 220,
			width: 450,
			buttons: [
				{
					label: "Cancel",
					isCancel: true
				},
				{
					label: "Delete",
					autoClose: false,
					click: function () {
						// Disable the delete button until the delete has completed to prevent the dialog from being reopen
						$(".c-delete-button").prop("disabled", true);

						// Show the delete progress message
						controller.master.updateProgressMessage("Deleting...");

						// Hide entry details if the entry is being deleted
						if (currentEntryKey) {
							for (var i = 0; i < deleteEntryDialog.entries.length; i++) {
								var entryKey = deleteEntryDialog.entries[i];
								if (entryKey.EntryId == currentEntryKey.EntryId) {
									controller.discardChanges(currentEntryKey);
									controller.hideEntry();
									break;
								}
							}
						}

						// Delete the specified entries and refresh the grid
						Cognito.Forms.deleteEntries({ Entries: deleteEntryDialog.entries, Token: Cognito.Forms.model.currentView.get_Token() },
							function (data) {
								if (!Cognito.config.flags.AppNav) {
									if (deleteEntryDialog.entries.length === 1 && Cognito.config.flags.UseCosmosIndexes)
										controller.master.pollEntryChanges(deleteEntryDialog.entries[0]);
									else
										controller.master.refreshEntries();
								}

								$(".c-delete-button").prop("disabled", false);
							},
							function () {
								$(".c-delete-button").prop("disabled", false);
							});

						this.close();
					}
				}
			]
		});

		// Change Status
		function changeStatus(entries, statusName, triggerEntryNotifications, incompleteEntries, statusId) {

			// Show progress message when bulk changing entries
			if (entries.length > 1)
				controller.master.updateProgressMessage("Changing Status...");

			// Change the status and refresh the master and detail views
			Cognito.Forms.updateEntryStatus({ Entries: entries, Token: Cognito.Forms.model.currentView.get_Token() }, statusId || statusName, triggerEntryNotifications != false, !!incompleteEntries,
				function (data) {
					var failedUpdates = data.filter(function (entryKey) { return entryKey.Status !== "Success"; });
					if (failedUpdates.length) {
						statusUpdatesFailedDialog.count = failedUpdates.length;
						statusUpdatesFailedDialog.open();
					}
					if (currentEntryKey && !entryHasChanges && entries.some(function (entry) { return entry.EntryId === currentEntryKey.EntryId }) && failedUpdates.every(function (entryKey) { return entryKey.EntryId != currentEntryKey.EntryId })) {
						controller.detail.setStatus(statusName);
					}

					if (!Cognito.config.flags.AppNav) {
						if (Cognito.config.flags.UseCosmosIndexes && data.length === 1)
							controller.master.pollEntryChanges(data[0]);
						else
							controller.master.refreshEntries();
					}
				},
				function (data) {
					controller.master.updateProgressMessage();
					window.setTimeout(function () {
						changeStatusDialog.entries = entries;
						changeStatusDialog.statusName = statusName;
						changeStatusDialog.statusId = statusId;
						changeStatusDialog.incompleteEntries = data.length;
						changeStatusDialog.open();
					}, 500);
				});
		}

		function changeReadState(entries, read) {
			if (entries.length > 1) {
				const message = "Marking as " + (read === true ? "Read" : "Unread") + "...";
				controller.master.updateProgressMessage(message);
			}

			Cognito.Forms.updateEntryReadState({ Entries: entries, Token: Cognito.Forms.model.currentView.get_Token() }, read,
				function (data, read) {
					controller.detail.changeReadStates(entries, read);
					controller.master.updateProgressMessage();
				},
				function () {
					controller.master.updateProgressMessage();
				}
			);
		}

		var changeStatusDialog = $.fn.dialog({
			title: "Change Status?",
			text: function () {
				if (changeStatusDialog.incompleteEntries) {
					var message = "<strong>" + (changeStatusDialog.entries.length == 1 ? "This entry is" : changeStatusDialog.incompleteEntries + " of these entries " + (changeStatusDialog.incompleteEntries > 1 ? "are" : "is")) + " Incomplete!</strong>";
					message += "<br /><br />Are you sure you wish to continue?"
					return message;
				}
				else
					return "Are you sure you want to change the status of <strong>" + (changeStatusDialog.entries.length > 1 ? changeStatusDialog.entries.length + " entries" : "this entry") + "</strong> to " + changeStatusDialog.statusName + "?";
			},
			height: 300,
			width: 500,
			buttons: [
				{
					label: "Cancel",
					isCancel: true
				},
				{
					label: "Change Status",
					autoClose: false,
					click: function () {
						changeStatus(this.entries, this.statusName, true, this.incompleteEntries, this.statusId);
						this.close();
					}
				}
			]
		});

		// This is hardcoded to indicate a quantity limit issue, although the update failure can potentially be caused by other things in the future.
		var statusUpdatesFailedDialog = $.fn.dialog({
			title: "Status Update Failures",
			text: function () {
				return "<strong>Unable to change status for " + statusUpdatesFailedDialog.count + " " + (statusUpdatesFailedDialog.count > 1 ? "entries" : "entry") + " because a quantity limit has been reached."
			},
			height: 300,
			width: 500,
			buttons: [
				{
					label: "Close"
				}
			],
			cancel: function () {
			}
		});

		// Credit Payment
		function displaySubmitPaymentDialog(entryKey, customerCard, paymentProcessor) {
			VueComponents.EntryPaymentDialog.open(
				{
					adminApi: AdminForm,
					formId: Cognito.Forms.model.currentForm.get_Id(),
					entryKey: entryKey,
					viewId: Cognito.Forms.model.currentView.get_Id(),
					viewToken: Cognito.Forms.model.currentView.get_Token(),
					role: Cognito.serialize(getEntryViewRole()),
					paymentProcessor: paymentProcessor,
					currencyCode: Cognito.Forms.model.currentForm.get_Localization().get_Currency().get_Code(),
					customerCard: customerCard,
					makePayment: Cognito.Forms.makePayment
				},
				[
					{
						eventName: "update-entry",
						eventHandler: function (args) {
							controller.entryUpdated(args.entryKey);
						}
					}
				]
			);
		}

		function displayRefundOrderDialog(entryId, refundModel) {
			VueComponents.RefundOrderDialog.open(
				{
					model: refundModel,
					entryId: entryId
				},
				[
					{
						eventName: "refund-entry-order",
						eventHandler: function (args) {
							refundOrder(args.entryId, args.refundSuccess, args.refundError);
						}
					}
				]
			);
		}

		function refundOrder(entryId, success, error) {
			if (submittingRefund)
				return;
			submittingRefund = true;
			var viewId = Cognito.Forms.model.currentView.get_Id();
			Cognito.Forms.refundEntryOrder(viewId, entryId,
				function (data) {
					controller.entryUpdated(data.entryKey, null, function () { submittingRefund = false });

					if (success)
						success(data);
				},
				function () {
					submittingRefund = false;
					if (error)
						error();
				}
			);
		}

		// Advanced Filter
		function advancedFilter(callback) {

			// Open the advance filter dialog
			Cognito.openExpressionBuilder({
				rootType: Cognito.Forms.model.currentForm,
				includeTransientProperties: false,
				scope: Cognito.Forms.model.filter.get_scope(),
				property: "Advanced Filter",
				label: "Advanced Filter...",
				expression: Cognito.Forms.model.filter.get_Expression(),
				saveCallback: function filter(newExpression) {
					function updateFilter(expression, summary, invalid) {

						// Store the new filter criteria
						Cognito.Forms.model.filter.set_Expression(expression);

						// Update the expression summary
						Cognito.Forms.model.filter.set_ExpressionSummary(summary);
						Cognito.Forms.model.filter.set_Invalid(invalid);

						// Apply the new filter
						controller.changeFilter(Cognito.Forms.model.filter);
						controller.hideMenus();
					}

					if (newExpression) {
						Cognito.getExpressionBuilderPreview(Cognito.Forms.model.currentForm, Cognito.Forms.model.filter.get_scope(), newExpression,
							function (preview, invalid) { updateFilter(newExpression, invalid ? "Invalid Filter" : preview, invalid); }
						);
					}
					else
						updateFilter(newExpression, "", false);
				},
				openCallback: function open(dialog) {
					// Switch the Save button to Filter for consistency
					$(".c-expression-builder-dialog .c-modal-button").not(".c-modal-button-cancel").text("Filter");
				}
			});
		}

		function displayBulkDownloadDialog(type, documentTemplateId, bulkDownloadId = null) {
			VueComponents.BulkDownloadDialog.open({
				title: type === "File" ? "Download Files" : "Download Documents",
				show: true,
				userEmail: Cognito.config.userInfo.Email,
				selectedEntries: selectedEntries,
				entryViewId: Cognito.Forms.model.currentView.get_Id(),
				downloadType: type,
				documentTemplateId: documentTemplateId,
				bulkDownloadId: bulkDownloadId
			});
		}

		function displayBulkFileDownloadUpsellDialog() {
			controller.showFeatureWarning('bulkfiledownload');
		}

		function displayBulkDocumentDownloadUpsellDialog() {
			controller.showFeatureWarning('bulkdocumentdownload');
		}

		function displayBulkActionDialog(action) {
			controller.master.stopRefreshInterval();
			VueComponents.BulkActionDialog.open({
				action: action.ActionName,
				role: getEntryViewRole().get_Name(),
				userInfo: Cognito.config.userInfo,
				selectedEntries: selectedEntries,
				viewId: Cognito.Forms.model.currentView.get_Id(),
				viewToken: Cognito.Forms.model.currentView.get_Token(),
				adminApi: AdminForm
			}).then(function (dlg) {
				dlg.$once("close", function () {
					controller.master.startRefreshInterval();
				});
			});
		}

		function displayImportEntriesDialog(importId, callback) {
			VueComponents.ImportEntriesDialog.open(
				{
					show: true,
					formInternalName: Cognito.Forms.model.currentForm.get_LoweredInternalName(),
					formDisplayName: Cognito.Forms.model.currentForm.get_Name(),
					importId: importId || '',
					isOrgOwner: Cognito.config.role === 'Owner',
					orgCode: Cognito.config.organizationCode
				},
				[
					{
						eventName: "refresh:entries",
						eventHandler: controller.master.refreshEntries
					},
					{
						eventName: "close",
						eventHandler: function () {
							if (callback && typeof callback === "function") {
								callback();
							}
						}
					}
				]
			)
		}

		// Share Entry
		function displayshareEntryDialog(entryKey) {
			var entryNumber = entryKey.EntryId.split("-")[1];

			shareEntryDialog = $.fn.dialog({
				title: "Share Entry",
				name: "share",
				url: Cognito.config.baseUrl + "forms/admin/view/" + Cognito.Forms.model.currentForm.get_LoweredInternalName() + "/entries/" + entryNumber + "/share?viewToken=" + Cognito.Forms.model.currentView.get_Token(),
				width: 800,
				height: "750px",
				buttons: [
					{
						label: "Close",
						isCancel: false,
						click: function () {
							this.close(true);
						}
					},
					{
						label: "Send",
						autoClose: false,
						click: function () {
							controller.shareEntryDialog.sendEmail();
						}
					}
				]
			});

			shareEntryDialog._dialog.find(".c-modal-button:contains('Send')").addClass("send-animation");

			shareEntryDialog.open();
		}

		// View Limit Exceeded Available
		var viewLimitExceededDialog;
		function showViewLimitExceededWarning() {
			if (!viewLimitExceededDialog) {
				var viewLimitExceededDialog = $.fn.dialog({
					title: "View Limit Reached",
					text: "Only " + Cognito.config.entryViewLimit + " saved views are allowed per form.",
					buttons: [
						{
							label: "Okay",
							autoClose: true,
							isDefault: true
						}
					]
				});
			}
			viewLimitExceededDialog.open();
		}

		// #endregion

		//#region Model Type Definitions

		// Entry View
		$extend(["Cognito.Forms.EntryView", "Cognito.Forms.EntryViewColumn", "Cognito.FieldInfo"], function (type) {

			// Prevent Entry Creation
			type.meta.addProperty({ name: "isGridView", type: Boolean }).calculated({
				calculate: function () {
					return !this.get_Type() || this.get_Type().get_Name() !== 'Form';
				},
				onChangeOf: ["Type.Name"]
			});

			// Available Columns
			type.meta.addProperty({ name: "availableColumns", type: Cognito.Forms.EntryViewColumn, isList: true });

			type.$SharedWithMe.addChanged(function (sender, args) {
				Cognito.Forms.model.currentView.get_Filter().set_sharedWithMe(args.newValue)
			});

			// All Fields
			type.$AllFields.calculated({
				calculate: function () {
					var selectedFields = 0;
					var allFields = 0;
					var columns = this.get_Columns();
					for (var c = 0; c < columns.length; c++) {
						if ($.isNumeric(columns[c].get_FieldId()[0]))
							selectedFields++
					}
					var columns = this.get_availableColumns();
					for (var c = 0; c < columns.length; c++) {
						if ($.isNumeric(columns[c].get_FieldId()[0]))
							allFields++
					}
					return selectedFields == allFields;
				},
				onChangeOf: ["Columns", "availableColumns"]
			})
				.addChanged(function (sender, args) {
					if (!args.calculated) {
						$(".c-view-columns .c-view-form-field input:checkbox").prop('checked', args.newValue);
						controller.changeColumns($(".c-view-columns input:checkbox:checked").map(function () { return $parentContextData(this).get_rawValue(); }).toArray());
					}
				});

			// Force the token to be serialized in cross window calls
			type.$Token._isPersisted = true;

			// Scope Id
			type.meta.addProperty({ name: "scopeId", type: String }).calculated({
				calculate: function () {
					return this.get_Filter().get_ScopeId() || "";
				}
			})
				.addChanged(function (sender, args) {

					if (!args.calculated) {

						// Remove columns that are no longer valid for the specified scope
						var columns = sender.get_Columns().slice();
						var count = columns.length;
						var scope = sender.get_scopeId() || "";
						for (var c = count - 1; c >= 0; c--) {

							if (!scope.startsWith(columns[c].get_field().get_ScopeId() || ""))
								columns.splice(c, 1);
						}
						if (columns.length < count)
							controller.changeColumns(columns);

						// Refresh the column menu
						refreshColumnMenu();

						// Remove sort columns that are no longer valid for the specified scope
						var sortBy = sender.get_SortBy().slice();
						count = sortBy.length;
						for (var c = count - 1; c >= 0; c--) {

							if (!scope.startsWith(sortBy[c].get_field().get_ScopeId() || ""))
								sortBy.splice(c, 1);
						}
						if (sortBy.length < count)
							controller.changeSort(sortBy);

						// Clear the filter, since it is now invalid
						controller.changeFilter(new Cognito.Forms.EntryViewFilter({ ScopeId: scope }));

						// Hide entry details and clear current selections
						controller.hideEntry();
						controller.master.clearSelection();
					}
				});

			// Columns
			type.$Columns.optionValues("availableColumns");

			// Filter
			type.$Filter.calculated({
				calculate: function () { return this.get_Filter() || new Cognito.Forms.EntryViewFilter(); }
			});
			type.meta.addInitExisting(function (view) { if (!view.get_Filter()) view.set_Filter(new Cognito.Forms.EntryViewFilter()); });

			// Sort Summary
			type.meta.addProperty({ name: "sortSummary", type: String }).calculated({
				calculate: function () {
					var sortBy = this.get_SortBy();
					if (sortBy.length == 0)
						return "Most Recent First";

					var description = "Sort by ";
					for (var s = 0; s < sortBy.length; s++) {
						if (s > 0)
							description += ", then by ";
						description += sortBy[s].get_field().get_Name();
						if (!sortBy[s].get_Ascending())
							description += " descending";
					}

					return description;
				},
				onChangeOf: "SortBy{FieldId,Ascending}"
			});

			// Sort Class
			type.meta.addProperty({ name: "sortClass", type: String }).calculated({
				calculate: function () {
					var buttonClass = Cognito.config.flags.AppNav ? 'text-button' : 'c-nav-button';

					if (this.get_SortBy().length)
						return buttonClass + ' c-sort-applied';
					else
						return buttonClass;
				},
				onChangeOf: "SortBy"
			});

			type.meta.addProperty({ name: "canDelete", type: Boolean }).calculated({
				calculate: function () {
					return Cognito.Forms.model.views.length > 1;
				}
			});

			//TODO: when UserSpecificViews is on, delete this
			type.$Name.addChanged(function (sender, args) {
				if (!Cognito.config.flags.UserSpecificViews) {
					if (!args.newValue || args.newValue.trim() == args.oldValue || args.newValue.trim() == "") {
						sender.set_Name(args.oldValue);
						return;
					}

					Cognito.Forms.renameEntryView(Cognito.Forms.model.currentView.get_Id(), sender.get_Name(), function (data) {
						sender.set_InternalName(data);

						// Update the rollback data
						if (previousViewData) {
							previousViewData.Name = sender.get_Name();
							previousViewData.InternalName = sender.get_InternalName();
						}
						updateNavigation();
					});
				}
			});

			type.meta.addProperty({ name: "roleName", type: String }).calculated({
				calculate: function () {
					var form = getForm(this.get_Form().get_Id());
					return getEntryViewRole(form, this).get_Name();
				},
				onInit: true,
				onChangeOf: ["RoleId"]
			});
		});

		// Entry View Column
		$extend("Cognito.Forms.EntryViewColumn", function (type) {

			// Format
			type.meta.set_format("[field.Name]");

			// Field
			type.meta.addProperty({ name: "field", type: Cognito.FieldInfo }).calculated({
				calculate: function () {
					var fieldId = this.get_FieldId();
					return Cognito.deserialize(Cognito.FieldInfo, Cognito.Forms.model.fieldInfos.filter(function (f) { return f.Id == fieldId; })[0]) || null;
				},
				onChangeOf: "FieldId"
			});

		});

		// Entry View Filter
		$extend("Cognito.Forms.EntryViewFilter", function (type) {

			// Scope
			type.meta.addProperty({ name: "scope", type: String }).calculated({
				calculate: function () {
					var scope = this.get_ScopeId();
					return scope ? Cognito.Forms.model.fieldInfos.filter(function (f) { return f.Id == scope; })[0].Path : "";
				}
			});

			// Allowed Entry Statuses
			type.meta.addProperty({ name: "allowedEntryStatuses", type: String, isList: true }).calculated({
				calculate: function () {
					return Cognito.Forms.model.currentForm.get_EntryStatuses().filter(function (s) { return !s.get_IsArchived(); }).map(function (s) { return s.get_Id().toString() });
				}
			});

			// Entry Status
			type.$EntryStatus.optionValues("allowedEntryStatuses");

			// All Entry Statuses
			type.meta.addProperty({ name: "allEntryStatuses", type: Boolean }).calculated({
				calculate: function () {
					try { if (window.event) window.event.stopPropagation(); } catch (e) { }
					return this.get_allowedEntryStatuses().length == this.get_EntryStatus().length;
				},
				onChangeOf: "EntryStatus"
			})
				.addChanged(function (sender, args) {
					if (!args.calculated) {
						sender.get_EntryStatus().clear();
						if (args.newValue)
							sender.get_EntryStatus().addRange(sender.get_allowedEntryStatuses());
					}
				});

			// Allowed Payment Statuses
			type.meta.addProperty({ name: "allowedPaymentStatuses", type: String, isList: true }).calculated({
				calculate: function () {
					return Cognito.Payment.PaymentStatus.get_All().filter(function (p) { return p.get_Name() !== 'Cancelled' && p.get_Name() !== "New"; }).map(function (p) { return p.get_Name(); });
				}
			});

			// Payment Status
			type.$PaymentStatus.optionValues("allowedPaymentStatuses");

			// All Payment Statuses
			type.meta.addProperty({ name: "allPaymentStatuses", type: Boolean }).calculated({
				calculate: function () {
					try { if (window.event) window.event.stopPropagation(); } catch (e) { }
					return this.get_allowedPaymentStatuses().length == this.get_PaymentStatus().length;
				},
				onChangeOf: "PaymentStatus"
			})
				.addChanged(function (sender, args) {
					if (!args.calculated) {
						sender.get_PaymentStatus().clear();
						if (args.newValue)
							sender.get_PaymentStatus().addRange(sender.get_allowedPaymentStatuses());
					}
				});

			// Filter Summary
			type.meta.addProperty({ name: "filterSummary", type: String }).calculated({
				calculate: function () {

					var summary = "";

					if (this.get_Invalid()) {
						this.set_ExpressionSummary("Invalid Filter");
						return "Invalid Filter";
					}

					// Entry Status
					if (!this.get_allEntryStatuses() && this.get_EntryStatus().length > 0) {
						summary = "Entry is ";
						var statuses = this.get_EntryStatus();

						statuses = statuses.map(function (s) {
							return Cognito.Forms.getEntryStatusById(Cognito.Forms.model.currentForm.get_EntryStatuses(), s).Name;
						});

						for (var s = 0; s < statuses.length; s++) {
							if (s > 0)
								summary += " or ";
							summary += statuses[s];
						}
					}

					// Payment Status
					if (!this.get_allPaymentStatuses() && this.get_PaymentStatus().length > 0) {
						summary = (summary ? summary + " and " : "") + "Order is ";
						var statuses = this.get_PaymentStatus();
						for (var s = 0; s < statuses.length; s++) {
							if (s > 0)
								summary += " or ";
							summary += statuses[s];
						}
					}

					// Expression
					if (this.get_ExpressionSummary())
						summary = this.get_ExpressionSummary() + (summary ? " and " + summary : "");

					// Keywords
					if (this.get_Keyword())
						summary = "Any field containing " + this.get_Keyword() + (summary ? " and " + summary : "");

					return summary;
				},
				onChangeOf: ["ExpressionSummary", "Invalid", "EntryStatus", "PaymentStatus", "Keyword"]
			});

			type.meta.addProperty({ name: "sharedWithMe", type: Boolean }).calculated({
				calculate: function () {
					return Cognito.Forms.model.currentView.get_SharedWithMe();
				}
			});

			// Filter Count
			type.meta.addProperty({ name: "filterCount", type: Number }).calculated({
				calculate: function () {
					var keyword = this.get_Keyword() ? 1 : 0;
					var expressions = this.get_Expression() ? 1 + (this.get_Expression().match(/ and /g) || []).length + (this.get_Expression().match(/ or /g) || []).length : 0;
					var statuses = (this.get_EntryStatus().length == 0 || this.get_allEntryStatuses() ? 0 : 1) + (this.get_PaymentStatus().length == 0 || this.get_allPaymentStatuses() ? 0 : 1);
					var sharedWithMe = this.get_sharedWithMe() ? 1 : 0;
					return keyword + expressions + statuses + sharedWithMe;
				},
				onChangeOf: ["Keyword", "Expression", "EntryStatus", "PaymentStatus", "sharedWithMe"]
			});

			// Filter Class
			type.meta.addProperty({ name: "filterClass", type: String }).calculated({
				calculate: function () {
					var buttonClass = Cognito.config.flags.AppNav ? 'text-button' : 'c-nav-button';

					if (this.get_Invalid())
						return buttonClass + ' c-filter-invalid';

					if (this.get_filterCount())
						return buttonClass + ' c-filter-applied';

					return buttonClass;
				},
				onChangeOf: ["filterCount", "Invalid"]
			});
		});

		// Entry View Sort
		$extend("Cognito.Forms.EntryViewSort", function (type) {

			// Field
			type.meta.addProperty({ name: "field", type: Cognito.FieldInfo }).calculated({
				calculate: function () {
					var fieldId = this.get_FieldId();
					return Cognito.deserialize(Cognito.FieldInfo, Cognito.Forms.model.fieldInfos.filter(function (f) { return f.Id == fieldId; })[0]) || null;
				},
				onChangeOf: "FieldId"
			});

			// Sort Directions
			type.meta.addProperty({ name: "sortDirections", type: String, isList: true }).calculated({
				calculate: function () {
					var field = this.get_field();
					if (field) {
						var fieldType = field.get_FieldType().get_Name();
						var fieldSubType = field.get_FieldSubType() ? field.get_FieldSubType().get_Name() : "";
						if (fieldType == "Number" || fieldType == "Currency" || fieldSubType == "Currency" || fieldSubType == "Decimal")
							return ["0 - 9", "9 - 0"];
						if (fieldSubType == "Date" || fieldSubType == "Time" || fieldSubType == "DateTime")
							return ["Oldest to Newest", "Newest to Oldest"];
						else if (fieldType == "Signature")
							return ["Unsigned, Signed", "Signed, Unsigned"];
						else if (fieldType == "File")
							return ["None to Most", "Most to None"];
						else if (fieldType == "YesNo" || fieldSubType == "YesNo" && field.get_Choices() && field.get_Choices.length == 2) {

							return [field.get_Choices()[1].get_Label() + ", then " + field.get_Choices()[0].get_Label(), field.get_Choices()[0].get_Label() + ", then " + field.get_Choices()[1].get_Label()];
						}
						else
							return ["A - Z", "Z - A"];
					}
					return [];
				},
				onChangeOf: "field"
			});

		});

		// Form
		$extend("Cognito.Forms.Form", function (form) {

			form.meta.addProperty({ name: "workflowActionsList", type: Object, isList: true })
				.calculated({
					calculate: function () {
						var actions = this.get_Actions().filter(function (action) {
							return action.get_IsArchived() !== true;
						});

						return actions.map(function (action) {
							return {
								Id: action.get_Id(),
								ActionName: action.get_ActionName(),
								AllowedWhen: action.get_AllowedWhen(),
								ButtonText: action.get_ButtonText(),
								NewStatus: action.get_NewStatus(),
								Confirmation: action.get_Confirmation(),
								Emails: action.get_Emails(),
								IsArchived: action.get_IsArchived(),
								FieldsToClear: action.get_FieldsToClear(),
								PrefillConfigs: action.get_PrefillConfigs()
							}
						});
					}
				});

			form.meta.addProperty({ name: "roleOptions", type: Object, isList: true }).calculated({
				calculate: function () {
					return Cognito.serialize(this.get_Roles());
				}
			});

			form.meta.addProperty({ name: "entriesSelected", type: Boolean }).calculated({
				calculate: function () {
					return selectedEntries.length > 0;
				}
			});

			form.meta.addProperty({ name: "entryDetailsOpen", type: Boolean });

			form.meta.addProperty({ name: "selectedEntriesLimited", type: Object, isList: true });

			form.meta.addProperty({ name: "documentTemplates", type: Object, isList: true })
				.calculated({
					calculate: function calculate$documentTemplates() {
						return this.get_DocumentTemplates().map(function (d) {
							var document = Cognito.serialize(d);
							document.Description = d.get_description();
							document.NameHtml = d.get_nameHtml();
							return document;
						});
					},
					onChangeOf: ['DocumentTemplates{Number,Name,Description,OutputType}']
				});

			form.meta.addProperty({ name: "isMobile", type: Boolean }).defaultValue(function () { return isMobile.value; });
			Vue.watch(isMobile, () => {
				Cognito.Forms.model.currentForm.set_isMobile(isMobile.value);
			});

			// AppNav Limited Access Mobile version of actions button lives in EntriesPage.vue
			form.meta.addProperty({ name: "showActionsButton", type: Boolean })
				.calculated({
					calculate: function () {
						return !isLimitedAccess.value || !isMobile.value;
					},
					onChangeOf: ["isMobile, isLimitedAccess"]
				})
		})

		$extend(["Cognito.Forms.EntryView", "Cognito.Forms.Form"], function (view, form) {
			var isUserSpecificProp = view.meta.addProperty({ name: "isUserSpecific", type: Boolean, origin: "server" }).defaultValue(false);
			isUserSpecificProp._origin = "server";
			isUserSpecificProp._isPersisted = true;

			form.meta.addProperty({ name: "selectedEntries", type: Object, isList: true });

			form.meta.addProperty({ name: "canManageEntries", type: Boolean }).defaultValue(function () { return canManageEntries.value; });
			Vue.watch(canManageEntries, () => {
				Cognito.Forms.model.currentForm.set_canManageEntries(canManageEntries.value);
			});

			Vue.watch(isAssignedView, () => {
				controller.detail.setIsAssignedEntry(isAssignedView.value);
			});

			view.meta.addProperty({ name: "form", type: Cognito.Forms.Form }).calculated({
				calculate: function () {
					return Cognito.Forms.model.currentForm;
				}
			});

			view.meta.addProperty({ name: "noViewChanges", type: Boolean }).defaultValue(true);

			view.meta.addProperty({ name: "hasViewChanges", type: Boolean }).calculated({
				calculate: function () {
					return !this.get_noViewChanges();
				},
				onChangeOf: ["noViewChanges"]
			});
		})

		//#endregion

		//#region Menu

		// Show Menu
		function showMenu(action, delta) {
			window.setTimeout(function () {
				var menu = action.find("> .c-nav-menu");
				var content = menu.find("> .c-nav-menu-content");
				var menuStyles = getComputedStyle(content[0]);
				var menuPadding = parseInt(menuStyles.paddingTop) + parseInt(menuStyles.paddingBottom);
				var menuHeight = content.height() + menuPadding + (delta || 0);
				var maxHeight = window.document.documentElement.clientHeight - 110;
				var left = action.offset().left;
				var width = menu.width();
				var maxWidth = window.innerWidth;
				left = left + width < maxWidth ? 0 : Math.max(-left, maxWidth - width - left);
				action.addClass("c-menu-expanded");
				menu.addClass("c-menu-open").css("left", left + "px").css("transition", "max-height 0.3s ease").css("max-width", Math.min(width, maxWidth) + "px").css("max-height", Math.min(menuHeight, maxHeight) + "px").css("overflow-y", menuHeight > maxHeight ? "auto" : "hidden");

				// Also resize the parent menu
				var parent = action.parent().closest(".c-nav-action");
				if (parent.length > 0)
					showMenu(parent, menuHeight);

				//Set z-index of entry list grid to -1 to prevent scrolling issues in edge
				$("#c-entrylist").addClass("c-entries-open-menu");

			}, 0);
		}

		$(document.documentElement)

			// Hide/Show context menus
			.on("click", function (event) {

				if (!event.originalEvent || event.originalEvent.dialog || event.dialog)
					return;

				var isMenuButton = $(event.target).closest(Cognito.config.flags.AppNav ? ".text-button" : ".c-nav-button").not(".c-nav-disabled").next(".c-nav-menu").length > 0;

				// Close all menus if the target is a menu button or the click is not inside a menu
				if (isMenuButton || ($(event.target).parents(".c-menu-open").length == 0 && $.contains(document.documentElement, event.target)))
					controller.hideMenus();

				// Open the menu when a menu button is clicked
				if (isMenuButton) {

					// Calculate Menu Size and Position
					var action = $(event.target).parents(".c-nav-action");

					// Only open menus that are currently closed
					if ($(event.target).closest(".c-nav-action").find(".c-nav-menu").css("max-height") != "0px")
						action = $(event.target).closest(".c-nav-action").parents(".c-nav-action");
					if (action.length == 0)
						return;

					// Columns Menu Initialization
					if (action.is(".c-columns"))
						refreshColumnMenu();

					// Sort Menu Initialization
					if (action.is(".c-sort")) {
						var availableColumns = Cognito.Forms.model.currentView.get_Columns().slice();
						availableColumns.unshift(new Cognito.Forms.EntryViewColumn({ FieldId: "Entry.Number", Width: 50 }));
						availableColumns.addRange(Cognito.Forms.model.fieldInfos
							.filter(function (field) { return field.Id != "Entry.Number" && !field.Id.includes('.') && field.FieldType !== "Entity" && field.FieldType !== "EntityList" && !availableColumns.some(function (column) { return column.get_FieldId() == field.Id; }); })
							.map(function (field) { return new Cognito.Forms.EntryViewColumn({ FieldId: field.Id, Width: field.Width }); }));
						Cognito.Forms.model.currentView.set_availableColumns(availableColumns);
						ExoWeb.Observer.setValue(Cognito.Forms.model, "sortBy", ExoWeb.Observer.makeObservable(Cognito.deserialize(Cognito.Forms.EntryViewSort, Cognito.serialize(Cognito.Forms.model.currentView.get_SortBy()))));
						if (Cognito.Forms.model.sortBy.length == 0)
							Cognito.Forms.model.sortBy.add(new Cognito.Forms.EntryViewSort({ Ascending: true }));
					}

					// Filter Menu Initialization
					if (action.is(".c-filter")) {
						ExoWeb.Observer.setValue(Cognito.Forms.model, "filter", Cognito.deserialize(Cognito.Forms.EntryViewFilter, JSON.parse(JSON.stringify(Cognito.serialize(Cognito.Forms.model.currentView.get_Filter() || new Cognito.Forms.EntryViewFilter({ allEntryStatuses: true, allPaymentStatuses: true }))))));
						Cognito.Forms.model.filter.set_ExpressionSummary(Cognito.Forms.model.currentView.get_Filter().get_ExpressionSummary());
						if (Cognito.Forms.model.filter.get_EntryStatus().length == 0)
							Cognito.Forms.model.filter.get_EntryStatus().addRange(Cognito.Forms.model.filter.get_allowedEntryStatuses());
						if (Cognito.Forms.model.filter.get_PaymentStatus().length == 0)
							Cognito.Forms.model.filter.get_PaymentStatus().addRange(Cognito.Forms.model.filter.get_allowedPaymentStatuses());
					}

					// Show Menu
					showMenu(action);
					if (action.parents(".c-nav-action").length > 0) {
						event.stopPropagation();
						showMenu(action.parents(".c-nav-action"));
					}
				}
			});

		//#endregion

		//#region Utility Functions

		// Executes an action if there are no pending changes, otherwise
		// queue the action to be executed after the changes have been confirmed
		function executeAction(action, thisPtr) {

			// Queue the action if provided
			if (action)
				pendingAction = function () { action.apply(thisPtr || this) };

			// If an entry has changes then prompt the user of unsaved changes, if there is no submission being performed
			if (entryHasChanges) {
				if (!performingSubmit)
					Cognito.navigate();
			}
			// Otherwise, execute the pending action
			else if (pendingAction) {
				pendingAction();
				pendingAction = null;
			}
		}

		// Sort views alphabetically with the current view on top
		function reorderViews() {
			var currentView = Cognito.Forms.model.currentView;
			var views = Cognito.Forms.model.views;

			// Remove current view
			var views = views.filter(function (v) { return v != currentView; });

			// Sort the views alphabetically by name
			var views = $transform(views).orderBy("Name");

			// Add current view to the beginning
			views.unshift(currentView);

			// Update the views
			ExoWeb.updateArray(Cognito.Forms.model.views, views);

			return Cognito.Forms.model.views;
		}

		// Update the navigation to reflect the current view and selected entry
		function updateNavigation(view, query) {
			var form = Cognito.Forms.model.currentForm;
			var formName = form.get_LoweredInternalName();
			if (!view)
				view = Cognito.Forms.model.currentView;
			var viewId = view.get_Id().split('-')[1];
			var viewName = view.get_InternalName();
			var entryNumber = currentEntryKey == null ? "" : (currentEntryKey.EntryId.split('-')[1] + (currentEntryKey.Scope ? "." + currentEntryKey.Scope : ""));
			Cognito.Forms.model.currentForm.set_entryDetailsOpen(entryNumber !== "");

			var nav = Cognito.config.navigation;

			var entriesUrl = (viewId && viewId != "0" ? "/" + viewId + "-" + viewName : "") + (entryNumber ? "/" + entryNumber : "") + (query ? "?" + query : "");
			if (!Cognito.config.flags.AppNav)
				entriesUrl = "/entries" + entriesUrl;
			else if (!Cognito.config.hasPaidPlan)
				entriesUrl = '/entries';

			var orgCode = "/" + Cognito.config.lowerOrganizationCode + "/";
			nav.url = orgCode + formName + entriesUrl;
			nav.primary[0].url = orgCode + formName + "/build";
			nav.primary[0].title = form.get_Name();
			for (var p = 0; p < nav.secondary.length; p++)
				nav.secondary[p].url = orgCode + formName + nav.secondary[p].url.substr(nav.secondary[p].url.lastIndexOf('/'));

			Cognito.Messaging.trigger({ event: "navigate", data: nav });
		}

		Cognito.Forms.generateTokens = function () {
			var tokens = [];

			Cognito.Forms.model.fieldInfos.forEach(function (f) {
				if (f.FieldType) {
					var fieldType = f.FieldType;
					if (fieldType !== "Signature" && fieldType !== "File") {
						var hierarchyLevel = f.Path.split('.').length - 1;
						var indentation = "";
						for (var i = 0; i < hierarchyLevel; i++)
							indentation += "    ";

						var internalName = f.Path;

						if (fieldType === "RatingScale" || fieldType === "Entity" || fieldType === "EntityList") {
							internalName = "";
						}

						var isProtected = f.IsProtected;
						if (f.Scope !== 'Entry') { // Entry tokens are added at the end of this function
							tokens.push({
								Name: f.Name,
								InternalName: internalName,
								Path: indentation + f.Name,
								FieldType: fieldType,
								IsProtected: isProtected,
								FieldPath: f.Path
							});
						}

						var path = internalName + ".";

						if (fieldType === "Name") {
							indentation += "    ";

							if (f.Format.indexOf("Prefix") > -1)
								tokens.push({ Name: "Title", InternalName: path + "Prefix", FieldPath: path + "Prefix", Path: indentation + "Title", FieldType: null, IsProtected: isProtected });

							if (f.Format.indexOf("First") > -1)
								tokens.push({ Name: "First", InternalName: path + "First", FieldPath: path + "First", Path: indentation + "First", FieldType: null, IsProtected: isProtected });

							if (f.Format.indexOf("MiddleInitial") > -1)
								tokens.push({ Name: "Middle Initial", InternalName: path + "MiddleInitial", FieldPath: path + "MiddleInitial", Path: indentation + "Middle Initial", FieldType: null, IsProtected: isProtected });

							if (f.Format.indexOf("Middle") > -1)
								tokens.push({ Name: "Middle Name", InternalName: path + "Middle", FieldPath: path + "Middle", Path: indentation + "Middle Name", FieldType: null, IsProtected: isProtected });

							if (f.Format.indexOf("Last") > -1)
								tokens.push({ Name: "Last", InternalName: path + "Last", FieldPath: path + "Last", Path: indentation + "Last", FieldType: null, IsProtected: isProtected });

							if (f.Format.indexOf("Suffix") > -1)
								tokens.push({ Name: "Suffix", InternalName: path + "Suffix", FieldPath: path + "Suffix", Path: indentation + "Suffix", FieldType: null, IsProtected: isProtected });
						}
						else if (fieldType === "Address") {
							indentation += "    ";

							tokens.push({ Name: "Line 1", InternalName: path + "Line1", FieldPath: path + "Line1", Path: indentation + "Line 1", FieldType: null, IsProtected: isProtected });
							tokens.push({ Name: "Line 2", InternalName: path + "Line2", FieldPath: path + "Line2", Path: indentation + "Line 2", FieldType: null, IsProtected: isProtected });
							tokens.push({ Name: "City", InternalName: path + "City", FieldPath: path + "City", Path: indentation + "City", FieldType: null, IsProtected: isProtected });
							tokens.push({ Name: "State", InternalName: path + "State", FieldPath: path + "State", Path: indentation + "State", FieldType: null, IsProtected: isProtected });

							if (f.FieldSubType === "InternationalAddress")
								tokens.push({ Name: "Postal Code", InternalName: path + "PostalCode", FieldPath: path + "PostalCode", Path: indentation + "Postal Code", FieldType: null, IsProtected: isProtected });
							else
								tokens.push({ Name: "Zip Code", InternalName: path + "PostalCode", FieldPath: path + "PostalCode", Path: indentation + "Zip Code", FieldType: null, IsProtected: isProtected });

							if (f.FieldSubType === "InternationalAddress")
								tokens.push({ Name: "Country", InternalName: path + "Country", FieldPath: path + "Country", Path: indentation + "Country", FieldType: null, IsProtected: isProtected });
						}
					}
				}
			});

			tokens.push({ Name: "Entry", InternalName: "", FieldPath: "Entry", Path: "Entry", FieldType: null });
			tokens.push({ Name: "Number", InternalName: "Entry.Number", FieldPath: "Entry.Number", Path: "    Number", FieldType: null });
			tokens.push({ Name: "Status", InternalName: "Entry.Status", FieldPath: "Entry.Status", Path: "    Status", FieldType: null });
			tokens.push({ Name: "Date Created", InternalName: "Entry.DateCreated", FieldPath: "Entry.DateCreated", Path: "    Date Created", FieldType: null });
			tokens.push({ Name: "Date Submitted", InternalName: "Entry.DateSubmitted", FieldPath: "Entry.DateSubmitted", Path: "    Date Submitted", FieldType: null });
			tokens.push({ Name: "Date Updated", InternalName: "Entry.DateUpdated", FieldPath: "Entry.DateUpdated", Path: "    Date Updated", FieldType: null });

			if (Cognito.Forms.model.currentForm && Cognito.Forms.model.currentForm.get_PaymentEnabled())
				tokens.push({ Name: "Order Id", InternalName: "Entry.Order.Id", FieldPath: "Entry.Order.Id", Path: "    Order Id", FieldType: null });

			return tokens;
		};

		// Refreshes the set of available columns on the column menu
		function refreshColumnMenu() {
			var availableColumns = Cognito.Forms.model.currentView.get_Columns().slice();
			var scope = Cognito.Forms.model.currentView.get_scopeId();
			availableColumns.addRange(Cognito.Forms.model.fieldInfos
				.filter(function (field) { return field.Id != "Entry.Number" && scope.startsWith(field.ScopeId || "") && field.FieldType !== "Entity" && field.FieldType !== "EntityList" && field.FieldType !== "RatingScale" && !availableColumns.some(function (column) { return column.get_FieldId() == field.Id; }); })
				.map(function (field) { return new Cognito.Forms.EntryViewColumn({ FieldId: field.Id, Width: field.Width }); }));
			Cognito.Forms.model.currentView.set_availableColumns(availableColumns);
			var columnList = $(".c-view-columns");
			columnList[0].control.set_data(columnList[0].control.get_parent().get_data().get_options());
			columnList[0].control.refresh();
			var instance = columnList.sortable("instance");
			if (instance)
				columnList.sortable("destroy");
			columnList.sortable().bind('sortupdate', function () {
				controller.changeColumns($(".c-view-columns input:checkbox:checked").map(function () { return $parentContextData(this).get_rawValue(); }).toArray());
			});
			showMenu($(".c-columns"));
		}

		function parseQueryString(location) {
			var qs;
			if (Object.prototype.toString.call(location) === "[object Location]") {
				qs = location.search ? location.search.substring(1) : "";
			} else {
				var url = typeof location === "string" ? location : location ? location.toString() : "";
				var qsIdx = url.indexOf('?');
				qs = qsIdx >= 0 ? url.substring(qsIdx + 1) : "";
			}

			var qsObj = {};

			if (qs) {
				qs.split('&').map(function (qsToken) {
					var splitIdx = qsToken.indexOf('=');
					var tokenName, tokenValue;
					if (splitIdx > 0) {
						tokenName = qsToken.substring(0, splitIdx);
						tokenValue = qsToken.substring(splitIdx + 1);
					} else if (splitIdx === qsToken.length - 1) {
						tokenName = qsToken.substring(0, splitIdx);
						tokenValue = "";
					} else {
						tokenName = qsToken;
					}

					qsObj[tokenName] = tokenValue;
				});
			}

			return qsObj;
		}

		function getForm(id) {
			var form = Cognito.Forms.model.currentForm;
			if (form.get_Id() === id)
				return form;
			return form.meta.type.known().filter(function (f) { return f.get_Id() === id; })[0];
		}

		function getEntryViewRole(form, view) {
			if (arguments.length < 2)
				view = Cognito.Forms.model.currentView;

			if (arguments.length === 0)
				form = Cognito.Forms.model.currentForm;

			var role;

			// If this entry view's role is defined, try to find it
			if (view.get_RoleId() !== null) {
				role = form.get_Roles().filter(function (r) {
					return r.get_Id() === view.get_RoleId();
				})[0];

				// If cannot find role on form, check formData as well
				if (role === undefined) {
					role = formData.value.Roles.find(function (r) {
						return r.Id === view.get_RoleId();
					});
				}
			}

			// If the role was undefined or the role wasn't found, default to the internal role
			if (role === undefined) {
				role = form.get_Roles().filter(function (r) {
					return r.get_IsInternal();
				})[0];

				view.set_RoleId(role.get_Id());
				controller.saveView(view);
			}
			return role;
		}

		function getSummaryProperty() {
			var view = Cognito.Forms.model.currentView;
			var columns = view.get_Columns();
			if (columns.length === 0)
				return null;

			for (var i = 0; i < columns.length; i++) {
				var column = columns[i];
				var isField = $.isNumeric(column.get_FieldId().split(".").pop());
				if (!isField)
					continue;

				var fieldInfo = Cognito.Forms.model.fieldInfos.filter(function (fieldInfo) {
					return fieldInfo.Id === column.get_FieldId();
				})[0];

				if (!fieldInfo)
					continue;

				var propertyType = fieldInfo.PropertyType;

				// Accepted property types that don't have a valid format set
				var acceptedTypes = ["String", "Number", "Choice", "YesNo", "Date", "FormEntry", "Time"];

				if (fieldInfo.Format !== null || acceptedTypes.indexOf(propertyType) > -1)
					return fieldInfo.Path;

			}
			return null;
		}

		// #endregion

		//#region Initialize Entries

		Cognito.ready("init-entries", ["entries", "ExoWeb.dom", "Views.Admin.entries.htm", "expression-builder.htm", "admin-component-library", "admin-form-api"], function ($) {

			if (window.matchMedia) {
				var phoneMode = window.matchMedia("(max-width: 400px)");
				if (phoneMode.matches)
					layoutMode = "phone";
				var tabletMode = window.matchMedia("(min-width: 401px) and (max-width: 739px)");
				if (tabletMode.matches)
					layoutMode = "tablet";
				var desktopMode = window.matchMedia("(min-width: 740px)");
				if (desktopMode.matches)
					layoutMode = "desktop";

				phoneMode.addListener(function () { if (phoneMode.matches) controller.changeLayout("phone"); });
				tabletMode.addListener(function () { if (tabletMode.matches) controller.changeLayout("tablet"); });
				desktopMode.addListener(function () { if (desktopMode.matches) controller.changeLayout("desktop"); });
			}

			// Load views from the server when the page loads
			controller.initViews();

			// Store the view data so it can be rolled back if needed. Stringify and parse the data to ensure arrays are copied.
			previousViewData = JSON.parse(JSON.stringify(Cognito.serialize(Cognito.Forms.model.currentView)));

			initializeEventHandlers();
		});

		Cognito.ready("init-layout", ["init-entries", "master", "detail"], function ($) {
			// Update the layout mode
			controller.changeLayout(layoutMode);

			controller.detail.changeView(Cognito.Forms.model.currentView);

			onCreateNewEntry(() => {
				executeAction(() => controller.newEntry());
			});

			if (Cognito.Forms.model.defaultEntry)
				controller.viewEntry(Cognito.Forms.model.defaultEntry);
			else if (showNewEntry.value)
				executeAction(() => controller.newEntry());
			else {
				var query = "";

				// Extract any query string arguments that we want to keep...
				var qsObj = parseQueryString(window.location);
				if (qsObj.hasOwnProperty('import')) {
					query = "import=" + qsObj.import;
					updateNavigation(null, query);
				}

			}

			if (Cognito.Forms.model.importId && Cognito.config.allowImportEntries)
				displayImportEntriesDialog(Cognito.Forms.model.importId, function () {
					if (Cognito.config.entryLimitExceeded === true) {
						// Delay for a moment to allow the currently closing dialog to clean-up
						setTimeout(function () {
							controller.showFeatureWarning("entrylimits");
						}, 100);
					}
				});
			else if (Cognito.Forms.model.importId && !Cognito.config.allowImportEntries)
				controller.showFeatureWarning("entrylimits");
			else if (Cognito.Forms.model.bulkDownloadId)
				displayBulkDownloadDialog(Cognito.Forms.model.downloadType, null, Cognito.Forms.model.bulkDownloadId);
			else if (Cognito.config.formEntryExportId)
				controller.openEntryExportDialog(Cognito.config.formEntryExportId, "Successful", null, null);

			// Apply entry view changes that happened before the grid loaded
			if (tempFilter)
				controller.changeFilter(tempFilter);

			if (tempSort)
				controller.changeSort(tempSort);

			if (tempColumns)
				controller.changeColumns(tempColumns);
		});

		// #endregion

		//#region jQuery Event Handlers

		function initializeEventHandlers() {

			$(document.documentElement)

				// Select Column
				.on("change", ".c-view-columns input", function (event) {
					controller.changeColumns($(".c-view-columns input:checkbox:checked").map(function () { return $parentContextData(this).get_rawValue(); }).toArray());
				})

				// Add Sort Column
				.on("click", ".c-criteria-col.c-add", function (event) {
					Cognito.Forms.model.sortBy.add(new Cognito.Forms.EntryViewSort({ Ascending: true }));
					showMenu($(".c-sort"));
				})

				// Delete Sort Column
				.on("click", ".c-criteria-col.c-delete", function (event) {
					Cognito.Forms.model.sortBy.remove($parentContextData(this));
					showMenu($(".c-sort"));
				})

				// Apply Sort
				.on("click", ".c-sort .c-nav-menu-buttons button", function (event) {
					controller.changeSort(Cognito.Forms.model.sortBy.filter(function (c) { return !!c.get_field(); }));
					controller.hideMenus();
				})

				// Clear Sort
				.on("click", ".c-sort .c-nav-menu-buttons a", function (event) {
					controller.changeSort([]);
					controller.hideMenus();
				})

				// Apply Filter
				.on("click", ".c-filter .c-nav-menu-buttons button", function (event) {
					executeAction(function () {
						controller.changeFilter(Cognito.Forms.model.filter);
						controller.hideMenus();
					});
				})

				// Advanced Filter
				.on("click", ".c-filter-advanced", function (event) {
					advancedFilter();
				})

				// Clear Filter
				.on("click", ".c-filter .c-nav-menu-buttons a", function (event) {
					executeAction(function () {
						controller.changeFilter(new Cognito.Forms.EntryViewFilter({ ScopeId: Cognito.Forms.model.filter.get_ScopeId() }));
						controller.hideMenus();
					});
				})

				// Filter on "Enter" key
				.on("keyup", ".c-filter-keyword", function (event) {
					if (event.keyCode == 13) {
						var keyword = this.value;
						executeAction(function () {
							// In IE11, the lost focus (binding) event is not being handled in time
							Cognito.Forms.model.filter.set_Keyword(keyword);
							controller.changeFilter(Cognito.Forms.model.filter);
							controller.hideMenus();
						});
					}
				})

				// New View
				.on("click", ".c-new-view", function (event) {
					executeAction(function () {
						controller.newView();
					});
				})

				// Save Entry View
				.on("click", ".c-save-view", function (event) {
					if ($(".c-save-view .c-nav-disabled").length == 0)
						controller.saveView(Cognito.Forms.model.currentView);
				})

				// Save Entry View As
				.on("click", ".c-save-view-as", function (event) {
					controller.saveViewAs();
				})

				// New Entry
				.on("click", ".c-new-entry", function (event) {
					executeAction(function () {
						controller.newEntry();
					});
				})

				// Change Status
				.on("click", ".c-nav-menu-content .c-nav-menu .c-action-change-status", function (event) {
					if (selectedEntries.length > 0) {
						executeAction(function () {
							controller.hideMenus();
							controller.updateEntryStatus(selectedEntries, $(this).text().trim(), null, $(this).attr("status-id"));
						}, this);
					}
				})

				// Change Read State
				.on("click", ".c-nav-menu-content .c-nav-menu .c-action-change-read-state", function (event) {
					if (selectedEntries.length > 0) {
						executeAction(function () {
							var read = $(this).text().trim() === "Read";
							controller.hideMenus();
							controller.updateGridReadState(selectedEntries, read);
						}, this);
					}
				})

				// Delete Entries
				.on("click", ".c-action-delete-entries", function (event) {
					if (selectedEntries.length > 0) {
						executeAction(function () {
							controller.hideMenus();
							controller.deleteEntries(selectedEntries);
						});
					}
				})

				// Import Entries
				.on("click", ".c-action-import-entries", function (event) {
					executeAction(function () {
						controller.hideMenus();
						controller.importEntries();
					}, this);
				})

				// Change View
				.on("click", ".c-menu-current-view .c-nav-menu .c-nav-button", function (event) {
					// Id check excludes the "New View" selection
					var id = $(this).attr("id");
					if (id) {

						if (!$(this).hasClass("c-view-enabled")) {
							controller.showFeatureWarning("entryviewsexist");
							return;
						}

						Cognito.Forms.onChangeView(id);
					}
				})

				// Delete View
				.on("click", ".c-view-delete-view", function (event) {
					executeAction(function () {
						//event.stopPropagation();
						controller.deleteView();
						controller.hideMenus();
					});
				})

				// Copy View
				.on("click", ".c-view-copy-view", function (event) {
					executeAction(function () {
						//event.stopPropagation();
						controller.copyView();
					});
				})

				// Rename View
				.on("click", ".c-view-rename", function (event) {
					event.stopPropagation();
					controller.showRenameView();
				})

				// Cancel Rename
				.on("keydown", ".c-rename-view input:text", function (event) {
					if (event.keyCode == 27 || event.keyCode == 9 || event.keyCode == 13) {
						event.stopPropagation();
						controller.hideMenus();

						// Rollback changes
						if (event.keyCode == 27)
							$(this).val(Cognito.Forms.model.currentView.get_Name());
					}
				});

			// Prevent default context menu from opening on top of the Actions submenu
			window.addEventListener('contextmenu', function (event) {
				if (event.target.matches(".entry-view-actions__menu, .entry-view-actions__menu *")) {
					event.preventDefault();
					event.stopPropagation();
				}
			});

			//#region Panel resizing
			(function () {
				if (Cognito.config.flags.AppNav)
					return;

				var $container = $(".c-entries"),
					$left = $("#c-entrylist"),
					$right = $("#c-entrydetails");

				// Variables used during each resize operation
				var _startX = 0,
					_startWidth,
					_containerPixelWidth,
					_maxWidthPct,
					_minWidthPct;

				function parsePercentWidth(widthStyle) {
					return Number(widthStyle.split("%")[0]);
				}

				function parsePixelWidth(widthStyle) {
					return Number(widthStyle.split("px")[0]);
				}

				function resizeDragStart(event) {
					requestAnimationFrame(() => {
						_startX = event.clientX;
						_startWidth = $right.width();
						_containerPixelWidth = $container.width();
						_maxWidthPct = Math.floor(parsePixelWidth($right.css("max-width")) / _containerPixelWidth * 100);
						_minWidthPct = Math.ceil(parsePixelWidth($right.css("min-width")) / _containerPixelWidth * 100);

						$container.addClass("c-resizing");

						$(document.documentElement).on("mouseup mouseout", resizeDragEnd);
						$(document.documentElement).on("mousemove", resizeDrag);
					});

					event.stopPropagation();
					event.preventDefault();
				}

				function setWidth(entryPanelWidth) {
					$right.css({ "width": entryPanelWidth + "%" });
					$left.css("width", (100 - entryPanelWidth) + "%");

					if (Cognito.config.flags.AppNav)
						$toolbar.css("width", (100 - entryPanelWidth) + "%");
				}

				function doResize(x, isEnd) {
					// Since we resize from the left edge of the right panel, moving the cursor left represents increase in width
					var pixelDelta = _startX - x;
					var newWidth = Math.max(_minWidthPct, Math.min(_maxWidthPct, 100 * (_startWidth + pixelDelta) / _containerPixelWidth));

					if (newWidth > 90 && isEnd)
						newWidth = Math.min(100, _maxWidthPct);

					// Clamp the width to an integer to prevent inconsistent browser implementation of floating point percent width
					if (isEnd)
						newWidth = Math.floor(newWidth);

					setWidth(newWidth);
				}

				function resizeDrag(event) {
					requestAnimationFrame(() => {
						if (doResize(event.clientX))
							resizeDragEnd(event);
					});
				}

				function resizeDragEnd(event) {
					doResize(event.clientX, true);

					$(document.documentElement).off("mouseup mouseout", resizeDragEnd);
					$(document.documentElement).off("mousemove", resizeDrag);

					$container.addClass("c-custom-size");
					$container.removeClass("c-resizing");
					_isResizing = false;

					event.preventDefault();
					event.stopPropagation();

					controller.savePanelWidth(Number(parsePercentWidth($right[0].style.width)));
				}

				if (!Cognito.config.AppNav)
					$(".c-panel-resizer").on("mousedown", resizeDragStart);

				if (Cognito.config.entryPageSettings.EntryPanelWidth) {
					$container.addClass("c-custom-size");
					setWidth(Cognito.config.entryPageSettings.EntryPanelWidth);
				}

				// Make sure left and right panels fill the space when window is resized
				function windowResized() {
					if ($container.hasClass("c-custom-size")) {
						clearTimeout(Cognito.timers.panelResizing);
						Cognito.timers.panelResizing = setTimeout(function () {
							var actualPctWidth = $right.width() / $container.width() * 100;
							$container.addClass("c-resizing");
							$left.css("width", (100 - actualPctWidth) + "%");
							if (Cognito.config.flags.AppNav)
								$toolbar.css("width", (100 - actualPctWidth) + "%");
							setTimeout(function () { $container.removeClass("c-resizing"); });
						}, 100);
					}
				}
				$(window).resize(windowResized);
				windowResized();
			})();
			//#endregion

		}

		//#endregion

		// #region menu event handlers

		Cognito.Forms.onOpenEntryViewSettings = function onOpenEntryViewSettings() {
			if (!controller.canAccessDestinationView())
				Cognito.Forms.model.currentView.set_AfterSubmitDestinationViewId(null);
			controller.openEntryViewSettings(Cognito.serialize(Cognito.Forms.model.currentView));
		}

		Cognito.Forms.onRenameView = function onRenameView() {
			controller.showRenameView();
		}

		Cognito.Forms.onCopyView = function onCopyView() {
			controller.copyView();
		}

		Cognito.Forms.onDeleteView = function onDeleteView() {
			controller.deleteView();
		}

		Cognito.Messaging.addHandler("changeView", function (viewId) {
			Cognito.Forms.onChangeView(viewId);
		});
		Cognito.Messaging.addHandler("newView", function (type) {
			Cognito.Forms.onNewView(type);
		});
		Cognito.Messaging.addHandler("reorderView", function (viewIdObject) {
			Cognito.Forms.onReorderView(viewIdObject);
		});
		Cognito.Messaging.addHandler("saveView", function (viewObject) {
			let view = viewObject;
			let isOnlyRenaming = false;
			if (viewObject.view) {
				view = viewObject.view;
				isOnlyRenaming = viewObject.isOnlyRenaming;
			}

			view.isUserSpecific = !!view.SharedWithMe;

			// Existing View
			if (view.Id)
				view = Cognito.deserialize(Cognito.Forms.EntryView, view, Cognito.Forms.model.currentView);
			// New View
			else
				view = Cognito.deserialize(Cognito.Forms.EntryView, view);

			controller.saveView(view, isOnlyRenaming);
		});
		Cognito.Messaging.addHandler("deleteView", function (viewIdObject) {
			controller.deleteView(viewIdObject);
		});

		Cognito.Forms.onChangeView = function onChangeView(viewId) {

			if (viewId && viewId != Cognito.Forms.model.currentView.get_Id()) {

				// Individual Plan
				if (!Cognito.config.hasPaidPlan) {
					controller.showFeatureWarning("entryviewsexist");
					return;
				}

				// Loads the specified view and then changes to the new view
				Cognito.Forms.getEntryView(viewId)
					.then(checkForm(function (data) {
						data.view.isUserSpecific = data.isUserSpecific || false;
						var view = Cognito.deserialize(Cognito.Forms.EntryView, data.view);

						executeAction(function () {
							document.getElementById('grid').classList.add('c-hide-entries-grid');
							controller.changeView(view, layoutMode);
							controller.hideMenus();
						});
					}));
			}
		}

		Cognito.Forms.onNewView = function onNewView(type) {

			// Individual Plan
			if (!Cognito.config.hasPaidPlan) {
				controller.showFeatureWarning("entryviews");
				return;
			}

			// Enforce Entry View Limit
			if (Cognito.Forms.model.views.length >= Cognito.config.entryViewLimit) {
				showViewLimitExceededWarning();
				return;
			}

			const isTaskView = type === 'Task';
			if (isTaskView) {
				type = 'Table';
			}

			// Create the new view
			var form = Cognito.Forms.model.currentForm;
			var view =
			{
				Name: 'New View',
				Form: { Id: form.get_Id() },
				RoleId: formData.value.Roles.find(function (r) { return r.IsInternal; }).Id,
				Type: type,
				Columns: [
					{ FieldId: "Entry.Status", Width: 100 },
					{ FieldId: "Entry.DateSubmitted", Width: 140 }
				],
				PreventEntryCreation: isTaskView ? true : false,
				ShowPageBreaks: true
			};

			// Add order summary for payment forms
			if (form.PaymentEnabled)
				view.Columns.push({ FieldId: "Order.OrderSummary", Width: 120 });

			// Include all fields
			view.AllFields = true;
			if (type == "Form")
				onOverrideFormEntryCreation(false);
			else
				onOverrideFormEntryCreation(true);

			//inititialze SharedWithMe
			if (Cognito.config.flags.UserSpecificViews) {
				view.SharedWithMe = isTaskView;
				view.IsTaskView = isTaskView;
			}

			// Create New View
			controller.openEntryViewSettings(view, true);
		}

		// Reorders the specified view and refreshes to ensure views appear in the correct order
		Cognito.Forms.onReorderView = function onReorderView(e) {
			Cognito.Forms.reorderEntryView(e.viewId, e.afterViewId)
				.then(Cognito.Forms.refreshViews)
		}

		// Refreshed the list of views for the form
		Cognito.Forms.refreshViews = function refreshViews() {
			return Cognito.Forms.getEntryViews(Cognito.Forms.model.currentForm.get_Id())
				.then(function (views) {
					ExoWeb.Observer.setValue(Cognito.Forms.model, "views", views);
					var refetchGrid = Cognito.Forms.model.views.find(function (v) { return v.Id === Cognito.Forms.model.currentView.get_Id() && v.Entries != (currentViewEntryCount.value || 0); });
					if (refetchGrid && controller.master)
						controller.master.refreshEntries();
					return views;
				}).catch(function (response) {
					// If a user loses access to the entries page set all views to 0 and refresh the grid
					if (Cognito.config.flags.UserSpecificViews && response.status == 403) {
						var refetchGrid = false;
						Cognito.Forms.model.views.forEach(function (v) {
							if (v.Entries) {
								v.Entries = 0;
								refetchGrid = true;
							}
						});
						if (refetchGrid)
							controller.master.refreshEntries();
					}
					return response;
				});
		}

		Cognito.Forms.getRoleOptions = function getRoleOptions() {
			return Cognito.serialize(Cognito.Forms.model.currentForm.get_Roles());
		}

		Cognito.Forms.onRoleChanged = function onRoleChanged(e) {
			executeAction(function () {
				Cognito.Forms.model.currentView.set_RoleId(e.Id);
				controller.viewChanged();
				controller.detail.setRole(e.Name);
			});
		}

		Cognito.Forms.onDelete = function onDelete(e) {
			if (selectedEntries.length)
				controller.deleteEntries(selectedEntries);
		}

		onExportEntries((exportData) => {
			const [ exportAllFields, selectedEntries ] = exportData;
			Cognito.Forms.onExport(exportAllFields, selectedEntries);
		});

		Cognito.Forms.onExport = function onExport(exportAllFields, selectedEntries) {
			controller.exportEntries(exportAllFields, selectedEntries);
		}

		Cognito.Forms.onReadStateChange = function onReadStateChange(read) {
			if (selectedEntries.length)
				controller.updateGridReadState(selectedEntries, read);
		}

		Cognito.Forms.onImport = function onImport(e) {
			controller.importEntries();
		}

		Cognito.Forms.onStatusChange = function onStatusChange(status) {
			if (selectedEntries.length)
				controller.updateEntryStatus(selectedEntries, status.Name, null, status.Id);
		}

		Cognito.Forms.onBulkFileDownload = function onBulkFileDownload() {
			if (Cognito.config.allowBulkFileDownload) {
				displayBulkDownloadDialog("File");
			}
			else
				displayBulkFileDownloadUpsellDialog();
		}

		Cognito.Forms.onBulkDocumentDownload = function onBulkDocumentDownload(documentTemplateId) {
			if (Cognito.config.allowBulkDocumentDownload) {
				displayBulkDownloadDialog("Document", documentTemplateId);
			}
			else
				displayBulkDocumentDownloadUpsellDialog();
		}

		onPerformBulkAction((action) => {
			Cognito.Forms.onBulkAction(action);
		});

		Cognito.Forms.onBulkAction = function onBulkAction(action) {
			if (Cognito.config.allowBulkActions)
				displayBulkActionDialog(action);
			else
				controller.showFeatureWarning('bulkactions');
		}

		//#endregion

		// #region Utility
		Cognito.Forms.onFormViewAdapterReady = function onFormViewAdapterReady(formViewAdapter) {
			if (!window.Cognito)
				return;

			Cognito.formViewAdapter = formViewAdapter;

			if (Cognito.Forms.model.currentView.get_Type().get_Name() === 'Form' && !Cognito.formViewAdapter.hasChangeHandler() && Cognito.formViewAdapter.isFormAvailable())
				Cognito.formViewAdapter.addChangesDetected(onEntryChanged)
			Cognito.ready("formViewAdapter");
		}

		Cognito.Forms.onFormViewMounted = function onFormViewMounted(formViewAdapter) {
			Cognito.Forms.onFormViewAdapterReady(formViewAdapter);

			const roleId = Cognito.Forms.model.currentView.get_RoleId();
			const role = Cognito.Forms.model.currentForm.get_Roles().find(function (r) { return r.get_Id() === roleId; });
			const isPublic = role.get_IsPublic();

			// Register the view now that we've remounted the form and previous view data in the form handle is gone
			formViewAdapter.changeView(Cognito.Forms.model.currentView.get_Id(), Cognito.Forms.model.currentView.get_Token());
			formViewAdapter.setCorrectFormAvailability(isPublic);
		}

		Cognito.Forms.beforeFormViewSubmit = function beforeFormViewSubmit() {
			const isRedirectingToEntryView = !!Cognito.Forms.model.currentView.get_AfterSubmitDestinationViewId();
			Cognito.formViewAdapter.setRedirectingToView(isRedirectingToEntryView);
		}

		Cognito.Forms.onFormViewSubmitted = function onFormViewSubmitted() {

			const destinationId = Cognito.Forms.model.currentView.get_AfterSubmitDestinationViewId();

			if (!!destinationId)
				Cognito.Forms.switchToDestinationView(destinationId)
			else
				onOverrideFormEntryCreation(true);
		}

		Cognito.Forms.setEntryNoChanges = function setEntryNoChanges() {
			entryHasChanges = false;
		}

		Cognito.Forms.switchToDestinationView = function switchToDestinationView(viewId) {
			return Cognito.Forms.refreshViews().then(function () {
				var viewIsAccessible = controller.canAccessDestinationView();

				if (viewIsAccessible) {
					Cognito.formViewAdapter.showConfirmationMessage();
					Cognito.Forms.onChangeView(viewId);
				}
				else {
					Cognito.formViewAdapter.showConfirmationPage();

					// Need to show new entry button since we're unexpectedly going to the confirmation page
					onOverrideFormEntryCreation(true);
				}
			});
		}

		function onEntryChanged(event) {
			if (entryHasChanges || event.oldValue == event.newValue)
				return;

			if (Cognito.Forms.onEntryChanged(event))
				controller.entryChanged();
		}

		//#endregion

		function isEntryDetailsVisible() {
			return document.querySelector(".c-entries").hasAttribute("data-show-entry-detail");
		}

		function showEntryDetails() {
			document.querySelector(".c-entries").setAttribute("data-show-entry-detail", "");
			// Need this attribute at a higher level to avoid CSS :has selector.
			// Lower-level one left in place to avoid breaking things.
			document.querySelector(".entries-page").setAttribute("data-has-entry-detail", "");
			setEntryDetailsIsOpen(true);
		}
		function hideEntryDetails() {
			document.querySelector(".c-entries").removeAttribute("data-show-entry-detail");
			document.querySelector(".entries-page").removeAttribute("data-has-entry-detail");
			setEntryDetailsIsOpen(false);
		}
	});
});


/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9DOi9Vc2Vycy9UeWxlclRyb3R0ZXIvcmVwb3MvQ29nbml0byBGb3Jtcy9Db2duaXRvLlNlcnZpY2VzL1ZpZXdzL0FkbWluL2VudHJpZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBO0FBQUE7QUFDZTtBQUNmO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7O0FBRUQ7O0FBRUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLGFBQWEsU0FBUztBQUN0QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ04sS0FBSztBQUNMLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlGQUFpRiw4QkFBOEIsRUFBRTtBQUNqSDtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSw0Q0FBNEMsb0JBQW9CO0FBQ2hFOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxPQUFPOztBQUVQO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0Q0FBNEMsMERBQTBELEVBQUU7QUFDeEc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTixLQUFLO0FBQ0wsSUFBSTs7QUFFSjtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQSxLQUFLOztBQUVMO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQSxtRUFBbUUsZ0NBQWdDO0FBQ25HO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLOztBQUVMO0FBQ0EseURBQXlELHdCQUF3QixFQUFFO0FBQ25GOztBQUVBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTs7QUFFQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0EsS0FBSztBQUNMLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBOztBQUVBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxrQ0FBa0M7QUFDbEM7O0FBRUE7QUFDQSxJQUFJOztBQUVKO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBLGtIQUFrSCx5QkFBeUI7O0FBRTNJO0FBQ0EsbUVBQW1FLGdDQUFnQztBQUNuRzs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxJQUFJO0FBQ0o7QUFDQSx1REFBdUQsYUFBYSxFQUFFO0FBQ3RFLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0EsS0FBSztBQUNMLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxJQUFJOztBQUVKO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0EsS0FBSztBQUNMLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTixJQUFJOztBQUVKO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsZ0VBQWdFLGdDQUFnQztBQUNoRyxNQUFNO0FBQ047QUFDQTtBQUNBLE1BQU07QUFDTixJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVixTQUFTO0FBQ1QsUUFBUTtB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QSxHQUFHOztBQUVIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtEQUErRCwyQkFBMkI7O0FBRTFGO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0Esb0NBQW9DLDRFQUE0RTtBQUNoSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsSUFBSTtBQUNKOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtB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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTixLQUFLOztBQUVMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0EsTUFBTTs7QUFFTjtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxpQkFBaUIsaUNBQWlDO0FBQ2xEOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQkFBK0Isc0NBQXNDLEVBQUU7QUFDdkUsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKOztBQUVBOztBQUVBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxHQUFHOztBQUVIOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUCxNQUFNO0FBQ047QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVcsb0JBQW9CO0FBQy9CLG9EQUFvRCxxQkFBcUIsRUFBRTtBQUMzRTtBQUNBO0FBQ0EsTUFBTSxzQ0FBc0M7QUFDNUMsTUFBTTtBQUNOO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQSx1QkFBdUIsNENBQTRDOztBQUVuRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0VBQW9FLDZHQUE2RyxFQUFFO0FBQ25MO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7O0FBRUg7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0EsR0FBRzs7QUFFSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBLCtFQUErRSw4QkFBOEIsRUFBRTtBQUMvRzs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxFQUFFO0FBQ0YsQ0FBQyIsImZpbGUiOiJWaWV3c0FkbWluU2NyaXB0NC43MWQ3MmZkODU3NTIzMzNiNDkwZi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi9Db2duaXRvLldlYi5DbGllbnQvYXBwcy9zcGEvc3JjL3ZpZXdzL2FkbWluL3V0aWxzL2V4b3dlYi5kLnRzXCIgLz5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKHtcclxuXHRlbWl0Vmlld1VwZGF0ZWQsXHJcblx0Y3VycmVudEVudHJ5VmlldyxcclxuXHRzaG93TmV3RW50cnksXHJcblx0b25DcmVhdGVOZXdFbnRyeSxcclxuXHRvbkV4cG9ydEVudHJpZXMsXHJcblx0b25QZXJmb3JtQnVsa0FjdGlvbixcclxuXHRjdXJyZW50Vmlld0VudHJ5Q291bnQsXHJcblx0aXNMaW1pdGVkQWNjZXNzLFxyXG5cdGNhbk1hbmFnZUVudHJpZXMsXHJcblx0Zm9ybURhdGEsXHJcblx0aXNBc3NpZ25lZFZpZXcsXHJcblx0b25PdmVycmlkZUZvcm1FbnRyeUNyZWF0aW9uLFxyXG5cdG9uVXBkYXRlSGFzU2VsZWN0ZWRFbnRyaWVzLFxyXG5cdHNldEVudHJ5RGV0YWlsc0lzT3BlbixcclxuXHRpc01vYmlsZVxyXG59KSB7XHJcblxyXG5cdENvZ25pdG8ucmVhZHkoXCJlbnRyaWVzXCIsIFtcInBhZ2VTY3JpcHRzXCIsIFwiQ29nbml0by5Gb3Jtc1wiLCBcImV4cHJlc3Npb24tYnVpbGRlclwiXSwgZnVuY3Rpb24gKCQpIHtcclxuXHJcblx0XHRoaWRlRW50cnlEZXRhaWxzKCk7XHJcblxyXG5cdFx0Ly8jcmVnaW9uIEdsb2JhbCBWYXJpYWJsZXNcclxuXHJcblx0XHR2YXIgbGF5b3V0TW9kZTtcclxuXHRcdHZhciBjdXJyZW50RW50cnlLZXk7XHJcblx0XHR2YXIgZW50cnlIYXNDaGFuZ2VzID0gZmFsc2U7XHJcblx0XHR2YXIgcGVyZm9ybWluZ1N1Ym1pdCA9IGZhbHNlO1xyXG5cdFx0dmFyIHBlbmRpbmdBY3Rpb247XHJcblx0XHR2YXIgc2VsZWN0ZWRFbnRyaWVzID0gW107XHJcblx0XHR2YXIgcHJldmlvdXNWaWV3RGF0YTtcclxuXHRcdHZhciBzaGFyZUVudHJ5RGlhbG9nO1xyXG5cdFx0dmFyIHN1Ym1pdHRpbmdDYXNoUGF5bWVudCA9IGZhbHNlO1xyXG5cdFx0dmFyIHN1Ym1pdHRpbmdSZWZ1bmQgPSBmYWxzZTtcclxuXHJcblx0XHR2YXIgdGVtcENvbHVtbnM7XHJcblx0XHR2YXIgdGVtcFNvcnQ7XHJcblx0XHR2YXIgdGVtcEZpbHRlcjtcclxuXHJcblx0XHRjdXJyZW50Vmlld0VudHJ5Q291bnQudmFsdWUgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmluaXRpYWxFbnRyeUNvdW50O1xyXG5cdFx0Ly8gI2VuZHJlZ2lvblxyXG5cclxuXHRcdC8qKlxyXG5cdFx0ICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBjYWxsIHRoZSB1bmRlcmx5aW5nIGNhbGxiYWNrIGFzIGxvbmcgYXMgdGhlIGZvcm0gaGFzIG5vdCBjaGFuZ2VkLlxyXG5cdFx0ICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIHVuZGVybHlpbmcgY2FsbGJhY2sgdG8gaW52b2tlXHJcblx0XHQgKiBAcmV0dXJucyBBIGZ1bmN0aW9uIHRoYXQgY29uZGl0aW9uYWxseSBjYWxscyB0aGUgZ2l2ZW4gY2FsbGJhY2suXHJcblx0XHQgKi9cclxuXHRcdGZ1bmN0aW9uIGNoZWNrRm9ybShjYWxsYmFjaykge1xyXG5cdFx0XHRpZiAoIXdpbmRvdy5Db2duaXRvIHx8ICFDb2duaXRvLkZvcm1zLm1vZGVsIHx8ICFDb2duaXRvLkZvcm1zLm1vZGVsLmZvcm1JZCkge1xyXG5cdFx0XHRcdGNvbnNvbGUud2FybignQ2Fubm90IGJpbmQgYSBjYWxsYmFjayBwcmlvciB0byB0aGUgZm9ybSBpZCBiZWluZyBlc3RhYmxpc2hlZC4nKTtcclxuXHRcdFx0XHRyZXR1cm4gY2FsbGJhY2s7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGxldCBjYXB0dXJlZEZvcm1JZCA9IENvZ25pdG8uRm9ybXMubW9kZWwuZm9ybUlkO1xyXG5cclxuXHRcdFx0cmV0dXJuIGZ1bmN0aW9uIGNoZWNrRm9ybUNhbGxiYWNrKCkge1xyXG5cdFx0XHRcdGlmICghd2luZG93LkNvZ25pdG8gfHwgIUNvZ25pdG8uRm9ybXMgfHwgIUNvZ25pdG8uRm9ybXMubW9kZWwgfHwgQ29nbml0by5Gb3Jtcy5tb2RlbC5mb3JtSWQgIT09IGNhcHR1cmVkRm9ybUlkKSB7XHJcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnRGlzY2FyZGluZyBjYWxsYmFjayBkdWUgdG8gZm9ybSBjaGFuZ2UgZnJvbSAnICsgY2FwdHVyZWRGb3JtSWQgKyAnIHRvICcgKyAod2luZG93LkNvZ25pdG8gJiYgQ29nbml0by5Gb3Jtcy5tb2RlbCAmJiBDb2duaXRvLkZvcm1zLm1vZGVsLmZvcm1JZCkgKyAnLicpO1xyXG5cdFx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0Ly8gQ2FsbCB0aGUgb3JpZ2luYWwgY2FsbGJhY2tcclxuXHRcdFx0XHRyZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxuXHRcdFx0fTtcclxuXHRcdH1cclxuXHJcblx0XHQvLyNyZWdpb24gQ29udHJvbGxlclxyXG5cdFx0dmFyIG1lbnUgPSBudWxsO1xyXG5cdFx0dmFyIHByZXZpb3VzVmlld0lkID0gbnVsbDtcclxuXHRcdHZhciBjb250cm9sbGVyID0ge1xyXG5cclxuXHRcdFx0b3BlbkFjdGlvbnNNZW51OiBmdW5jdGlvbiBvcGVuQWN0aW9uc01lbnUoc2hvdWxkSGlkZURldGFpbHMsIHgsIHkpIHtcclxuXHRcdFx0XHRpZiAobWVudSkge1xyXG5cdFx0XHRcdFx0bWVudS5jbG9zZShcImVudHJ5LXZpZXctYWN0aW9uc1wiKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGlmICghbWVudSB8fCBwcmV2aW91c1ZpZXdJZCAhPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9JZCgpKSB7XHJcblx0XHRcdFx0XHRtZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVudT1cImVudHJ5LXZpZXctYWN0aW9uc19fbWVudS0tY29udGV4dFwiXSA+IHVsJykuX192dWVfXy4kcm9vdC4kcmVmcy5tZW51XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdHByZXZpb3VzVmlld0lkID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKVxyXG5cclxuXHRcdFx0XHQvLyBDbG9zZSBlbnRyeSBkZXRhaWxzIHBhbmUgYmVmb3JlIG9wZW5pbmcgY29udGV4dCBtZW51XHJcblx0XHRcdFx0aWYgKHNob3VsZEhpZGVEZXRhaWxzKSB7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLmhpZGVFbnRyeSgpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0dmFyIG9wZW5EaWFsb2dzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcImMtbW9kYWwgaXMtYWN0aXZlXCIpO1xyXG5cdFx0XHRcdGlmIChvcGVuRGlhbG9ncy5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdG1lbnUub3BlbihcImVudHJ5LXZpZXctYWN0aW9uc1wiKTtcclxuXHRcdFx0XHRcdG1lbnUuJGVtaXQoJ29wZW4nKTtcclxuXHRcdFx0XHRcdG1lbnUuJGVsLmZpcnN0Q2hpbGQuZm9jdXMoKTtcclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0dmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5lbnRyeS12aWV3LWFjdGlvbnNfX21lbnUtLWNvbnRleHQnKTtcclxuXHRcdFx0XHRjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuXHJcblx0XHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XHJcblx0XHRcdFx0XHRjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcblx0XHRcdFx0XHRjb250YWluZXIuc3R5bGUudG9wID0geSArIFwicHhcIjtcclxuXHRcdFx0XHRcdGNvbnRhaW5lci5zdHlsZS5sZWZ0ID0geCArIFwicHhcIjtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEluaXRpYWxpemUgTWFzdGVyXHJcblx0XHRcdGluaXRNYXN0ZXI6IGZ1bmN0aW9uIGluaXRNYXN0ZXIobWFzdGVyQ29udHJvbGxlcikge1xyXG5cdFx0XHRcdGlmICh0eXBlb2YgbWFzdGVyQ29udHJvbGxlciA9PT0gJ3N0cmluZycpXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3RlciA9IENvZ25pdG8uTWVzc2FnaW5nLnByb3h5KCQoXCIjYy1lbnRyeWxpc3RcIilbMF0uY29udGVudFdpbmRvdywgbWFzdGVyQ29udHJvbGxlcik7XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIgPSBtYXN0ZXJDb250cm9sbGVyO1xyXG5cclxuXHRcdFx0XHRDb2duaXRvLnJlYWR5KFwibWFzdGVyXCIpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gSW5pdGlhbGl6ZSBEZXRhaWxcclxuXHRcdFx0aW5pdERldGFpbDogZnVuY3Rpb24gaW5pdERldGFpbChkZXRhaWxDb250cm9sbGVyKSB7XHJcblx0XHRcdFx0aWYgKHR5cGVvZiBkZXRhaWxDb250cm9sbGVyID09PSAnc3RyaW5nJylcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsID0gQ29nbml0by5NZXNzYWdpbmcucHJveHkoJChcIiNjLWVudHJ5ZGV0YWlsc1wiKVswXS5jb250ZW50V2luZG93LCBkZXRhaWxDb250cm9sbGVyKTtcclxuXHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLmRldGFpbCA9IGRldGFpbENvbnRyb2xsZXI7XHJcblx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuc2V0Um9sZShnZXRFbnRyeVZpZXdSb2xlKCkuZ2V0X05hbWUoKSk7XHJcblx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuc2V0U3VtbWFyeVByb3BlcnR5KGdldFN1bW1hcnlQcm9wZXJ0eSgpKTtcclxuXHRcdFx0XHRjb250cm9sbGVyLmRldGFpbC5zZXRJc0Fzc2lnbmVkRW50cnkoaXNBc3NpZ25lZFZpZXcudmFsdWUpO1xyXG5cdFx0XHRcdENvZ25pdG8ucmVhZHkoXCJkZXRhaWxcIik7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBSZW1vdmUgRGV0YWlsIGNvbnRyb2xsZXJcclxuXHRcdFx0cmVtb3ZlRGV0YWlsOiBmdW5jdGlvbiByZW1vdmVEZXRhaWwoKSB7XHJcblx0XHRcdFx0ZGVsZXRlIGNvbnRyb2xsZXIuZGV0YWlsO1xyXG5cdFx0XHRcdGRlbGV0ZSBDb2duaXRvLnJlYWR5RGVwZW5kZW5jaWVzW1wiZGV0YWlsXCJdO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gSW5pdGlhbGl6ZSBSZWZ1bmQgT3JkZXIgRGlhbG9nXHJcblx0XHRcdGluaXRSZWZ1bmRPcmRlcjogZnVuY3Rpb24gaW5pdFJlZnVuZE9yZGVyKHJlZnVuZE9yZGVyQ29udHJvbGxlcikge1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIucmVmdW5kT3JkZXIgPSBDb2duaXRvLk1lc3NhZ2luZy5wcm94eSgkKFwiaWZyYW1lW25hbWU9cmVmdW5kT3JkZXJdXCIpWzBdLmNvbnRlbnRXaW5kb3csIHJlZnVuZE9yZGVyQ29udHJvbGxlcik7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBJbml0aWFsaXplIERvY3VtZW50IFRlbXBsYXRlcyBEaWFsb2dcclxuXHRcdFx0aW5pdERvY3VtZW50VGVtcGxhdGVzOiBmdW5jdGlvbiBpbml0RG9jdW1lbnRUZW1wbGF0ZXMoZG9jdW1lbnRUZW1wbGF0ZXNDb250cm9sbGVyKSB7XHJcblx0XHRcdFx0Y29udHJvbGxlci5kb2N1bWVudFRlbXBsYXRlcyA9IENvZ25pdG8uTWVzc2FnaW5nLnByb3h5KCQoXCJpZnJhbWVbbmFtZT1kb2N1bWVudFRlbXBsYXRlc11cIilbMF0uY29udGVudFdpbmRvdywgZG9jdW1lbnRUZW1wbGF0ZXNDb250cm9sbGVyKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEluaXRpYWxpemUgU2hhcmUgRW50cnkgRGlhbG9nXHJcblx0XHRcdGluaXRTaGFyZUVudHJ5OiBmdW5jdGlvbiBpbml0U2hhcmVFbnRyeShzaGFyZUVudHJ5Q29udHJvbGxlcikge1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIuc2hhcmVFbnRyeURpYWxvZyA9IENvZ25pdG8uTWVzc2FnaW5nLnByb3h5KCQoXCJpZnJhbWVbbmFtZT1zaGFyZV1cIilbMF0uY29udGVudFdpbmRvdywgc2hhcmVFbnRyeUNvbnRyb2xsZXIpO1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIuc2hhcmVFbnRyeURpYWxvZy51cGRhdGVOb3RpZmljYXRpb25Gcm9tQWRkcmVzc0JhZGdlKCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBQcmV2aWV3IEZpbGVzXHJcblx0XHRcdHByZXZpZXdGaWxlczogZnVuY3Rpb24gcHJldmlld0ZpbGVzKGZpbGVzLCBpbmRleCkge1xyXG5cdFx0XHRcdENvZ25pdG8uc2hvd092ZXJsYXkoZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0Q29nbml0by5oaWRlT3ZlcmxheSgpO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gVmlldyBFbnRyeVxyXG5cdFx0XHR2aWV3RW50cnk6IGZ1bmN0aW9uIHZpZXdFbnRyeShlbnRyeUtleSkge1xyXG5cdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0Q29nbml0by5yZWFkeShcInZpZXctZW50cnlcIiwgW1wiZGV0YWlsXCIsIFwibWFzdGVyXCJdLCBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdGN1cnJlbnRFbnRyeUtleSA9IGVudHJ5S2V5O1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci52aWV3RW50cnkoZW50cnlLZXksIENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCkpO1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmRldGFpbC52aWV3RW50cnkoZW50cnlLZXksIENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCkpO1xyXG5cdFx0XHRcdFx0XHRzaG93RW50cnlEZXRhaWxzKCk7XHJcblx0XHRcdFx0XHRcdHVwZGF0ZU5hdmlnYXRpb24oKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gSGlkZSBFbnRyeVxyXG5cdFx0XHRoaWRlRW50cnk6IGZ1bmN0aW9uIGhpZGVFbnRyeShuZXdWaWV3KSB7XHJcblx0XHRcdFx0ZXhlY3V0ZUFjdGlvbihmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRpZiAoIWlzRW50cnlEZXRhaWxzVmlzaWJsZSgpKVxyXG5cdFx0XHRcdFx0XHRyZXR1cm47XHJcblxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIuaGlkZUVudHJ5KCk7XHJcblx0XHRcdFx0XHRjdXJyZW50RW50cnlLZXkgPSBudWxsO1xyXG5cdFx0XHRcdFx0aGlkZUVudHJ5RGV0YWlscygpO1xyXG5cdFx0XHRcdFx0dXBkYXRlTmF2aWdhdGlvbihuZXdWaWV3KTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIE5ldyBFbnRyeVxyXG5cdFx0XHRuZXdFbnRyeTogZnVuY3Rpb24gbmV3RW50cnkoKSB7XHJcblx0XHRcdFx0Y3VycmVudEVudHJ5S2V5ID0gbnVsbDtcclxuXHRcdFx0XHRjb25zdCB2aWV3VHlwZSA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1R5cGUoKS5nZXRfTmFtZSgpO1xyXG5cdFx0XHRcdGlmICh2aWV3VHlwZSA9PT0gJ1RhYmxlJykge1xyXG5cdFx0XHRcdFx0Ly8gQ2xlYXIgdGhlIGN1cnJlbnQgZW50cnkgc2VsZWN0aW9uXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5jbGVhclNlbGVjdGlvbigpO1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIuaGlkZUVudHJ5KCk7XHJcblxyXG5cdFx0XHRcdFx0Ly8gRGlzcGxheSB0aGUgZGV0YWlscyBlZGl0IHZpZXdcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLm5ld0VudHJ5KCk7XHJcblxyXG5cdFx0XHRcdFx0c2hvd0VudHJ5RGV0YWlscygpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRlbHNlIGlmICh2aWV3VHlwZSA9PT0gJ0Zvcm0nKSB7XHJcblx0XHRcdFx0XHRjb25zdCByb2xlSWQgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Sb2xlSWQoKTtcclxuXHRcdFx0XHRcdGNvbnN0IHJvbGUgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9Sb2xlcygpLmZpbmQoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIHIuZ2V0X0lkKCkgPT09IHJvbGVJZDsgfSk7XHJcblx0XHRcdFx0XHRjb25zdCBpc1B1YmxpYyA9IHJvbGUuZ2V0X0lzUHVibGljKCk7XHJcblx0XHRcdFx0XHRDb2duaXRvLmZvcm1WaWV3QWRhcHRlci5zZXROZXdFbnRyeShyb2xlLmdldF9OYW1lKCksIGlzUHVibGljKTtcclxuXHRcdFx0XHRcdG9uT3ZlcnJpZGVGb3JtRW50cnlDcmVhdGlvbihmYWxzZSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEVudHJ5IENoYW5nZWRcclxuXHRcdFx0ZW50cnlDaGFuZ2VkOiBmdW5jdGlvbiBlbnRyeUNoYW5nZWQoKSB7XHJcblx0XHRcdFx0ZW50cnlIYXNDaGFuZ2VzID0gdHJ1ZTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIERpc2NhcmQgRW50cnkgQ2hhbmdlc1xyXG5cdFx0XHRkaXNjYXJkQ2hhbmdlczogZnVuY3Rpb24gZGlzY2FyZENoYW5nZXMoZW50cnlLZXksIGtlZXBOZXdFbnRyeSwgc2hvd0RpYWxvZykge1xyXG5cdFx0XHRcdC8vIFNob3cgdGhlIFwiVW5zYXZlZCBDaGFuZ2VzXCIgZGlhbG9nXHJcblx0XHRcdFx0aWYgKHNob3dEaWFsb2cgJiYgZW50cnlIYXNDaGFuZ2VzKSB7XHJcblx0XHRcdFx0XHRDb2duaXRvLm5hdmlnYXRlKCk7XHJcblx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRlbnRyeUhhc0NoYW5nZXMgPSBmYWxzZTtcclxuXHJcblx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuZGlzY2FyZENoYW5nZXMoZW50cnlLZXksIGtlZXBOZXdFbnRyeSk7XHJcblxyXG5cdFx0XHRcdC8vIEhpZGUgdGhlIGVudHJ5IGRldGFpbHMgaWYgYSBjdXJyZW50IGVudHJ5S2V5IGRvZXMgbm90IGV4aXN0IChuZXcgZW50cnkpXHJcblx0XHRcdFx0aWYgKCFjdXJyZW50RW50cnlLZXkgJiYgIWtlZXBOZXdFbnRyeSlcclxuXHRcdFx0XHRcdGhpZGVFbnRyeURldGFpbHMoKTtcclxuXHJcblx0XHRcdFx0Ly8gRXhlY3V0ZSB0aGUgcGVuZGluZyBhY3Rpb25cclxuXHRcdFx0XHRleGVjdXRlQWN0aW9uKCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBFbnRyeSBBZGRlZFxyXG5cdFx0XHRlbnRyeUFkZGVkOiBmdW5jdGlvbiBlbnRyeUFkZGVkKGVudHJ5S2V5LCB2aWV3RW50cnkpIHtcclxuXHRcdFx0XHRjdXJyZW50RW50cnlLZXkgPSBlbnRyeUtleTtcclxuXHRcdFx0XHRlbnRyeUhhc0NoYW5nZXMgPSBmYWxzZTtcclxuXHJcblx0XHRcdFx0dmFyIG9uRW50cmllc0dyaWRVcGRhdGVkID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIudmlld0VudHJ5KGVudHJ5S2V5KVxyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0aWYgKCFDb2duaXRvLmNvbmZpZy5mbGFncy5BcHBOYXYpIHtcclxuXHRcdFx0XHRcdGlmIChDb2duaXRvLmNvbmZpZy5mbGFncy5Vc2VDb3Ntb3NJbmRleGVzKVxyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5wb2xsRW50cnlDaGFuZ2VzKGVudHJ5S2V5LCBvbkVudHJpZXNHcmlkVXBkYXRlZCk7XHJcblx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnJlZnJlc2hFbnRyaWVzKG9uRW50cmllc0dyaWRVcGRhdGVkKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIudmlld0VudHJ5KGVudHJ5S2V5KTtcclxuXHJcblx0XHRcdFx0Ly8gSWYgcXVhbnRpdHkgaXMgZXhjZWVkZWQgZHVyaW5nIGEgcmFjZSBjb25kaXRpb24sIHRoZSBlbnRyeSB3aWxsIGJlIHNhdmVkIGJ1dCB0aGUgbW9kZWwgaXMgaW52YWxpZCwgc28gc3RheSBvbiB0aGUgZWRpdCB2aWV3XHJcblx0XHRcdFx0aWYgKHZpZXdFbnRyeSAhPT0gZmFsc2UpIHtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnZpZXdFbnRyeShlbnRyeUtleSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHQvLyBFeGVjdXRlIHRoZSBwZW5kaW5nIGFjdGlvblxyXG5cdFx0XHRcdGV4ZWN1dGVBY3Rpb24oKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8qKlxyXG5cdFx0XHQgKiBTZXRzIHRoZSBwZXJmb3JtaW5nU3VibWl0IGZsYWcgdG8gaW5kaWNhdGUgdGhhdCBhIHdvcmtmbG93IGFjdGlvbiBvciBhIHNhdmUgYW5kIHJlc3VtZSBzYXZlIGlzIGJlaW5nIHBlcmZvcm1lZFxyXG5cdFx0XHQgKi9cclxuXHRcdFx0c2V0UGVyZm9ybWluZ1N1Ym1pdDogZnVuY3Rpb24gc2V0UGVyZm9ybWluZ1N1Ym1pdCh2YWx1ZSkge1xyXG5cdFx0XHRcdHBlcmZvcm1pbmdTdWJtaXQgPSB2YWx1ZTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEVudHJ5IFVwZGF0ZWRcclxuXHRcdFx0ZW50cnlVcGRhdGVkOiBmdW5jdGlvbiBlbnRyeVVwZGF0ZWQoZW50cnlLZXksIHZpZXdFbnRyeSwgY2FsbGJhY2spIHtcclxuXHRcdFx0XHRlbnRyeUhhc0NoYW5nZXMgPSBmYWxzZTtcclxuXHJcblx0XHRcdFx0aWYgKCFDb2duaXRvLmNvbmZpZy5mbGFncy5BcHBOYXYpIHtcclxuXHRcdFx0XHRcdGlmIChDb2duaXRvLmNvbmZpZy5mbGFncy5Vc2VDb3Ntb3NJbmRleGVzKVxyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5wb2xsRW50cnlDaGFuZ2VzKGVudHJ5S2V5KTtcclxuXHRcdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIucmVmcmVzaEVudHJpZXMoKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGlmIChjdXJyZW50RW50cnlLZXkgJiYgY3VycmVudEVudHJ5S2V5LkVudHJ5SWQgPT09IGVudHJ5S2V5LkVudHJ5SWQgJiYgdmlld0VudHJ5ICE9PSBmYWxzZSlcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnZpZXdFbnRyeShlbnRyeUtleSk7XHJcblxyXG5cdFx0XHRcdGN1cnJlbnRFbnRyeUtleSA9IGVudHJ5S2V5O1xyXG5cclxuXHRcdFx0XHRpZiAoY2FsbGJhY2spXHJcblx0XHRcdFx0XHRjYWxsYmFjaygpO1xyXG5cclxuXHRcdFx0XHQvLyBFeGVjdXRlIHRoZSBwZW5kaW5nIGFjdGlvblxyXG5cdFx0XHRcdGV4ZWN1dGVBY3Rpb24oKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEVudHJ5IFVwZGF0ZSBGYWlsZWRcclxuXHRcdFx0ZW50cnlVcGRhdGVGYWlsZWQ6IGZ1bmN0aW9uIGVudHJ5VXBkYXRlRmFpbGVkKGVudHJ5S2V5KSB7XHJcblx0XHRcdFx0Y29udHJvbGxlci5oaWRlTWVudXMoKTtcclxuXHJcblx0XHRcdFx0Ly8gRW5zdXJlIHRoZSBjdXJyZW50IGVudHJ5IGlzIHNlbGVjdGVkLiBUaGUgdXBkYXRlIG1heSBoYXZlIGJlZW4gdHJpZ2dlcmVkIGJ5IHRoZVxyXG5cdFx0XHRcdC8vIHVuc2F2ZWQgY2hhbmdlcyBkaWFsb2cgdGhhdCB3YXMgZGlzcGxheWVkIGR1ZSB0byBzZWxlY3RpbmcgYW5vdGhlciBlbnRyeS5cclxuXHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci52aWV3RW50cnkoZW50cnlLZXksIENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCkpO1xyXG5cclxuXHRcdFx0XHQvLyBJZiB0aGUgZW50cnkgdXBkYXRlIGZhaWxlZCwgZXhlY3V0aW5nIHBlbmRpbmcgYWN0aW9uc1xyXG5cdFx0XHRcdGlmIChwZW5kaW5nQWN0aW9uKVxyXG5cdFx0XHRcdFx0ZXhlY3V0ZUFjdGlvbigpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gRW50cnkgRGVsZXRlZFxyXG5cdFx0XHRlbnRyeURlbGV0ZWQ6IGZ1bmN0aW9uIGVudHJ5RGVsZXRlZChlbnRyeUtleSkge1xyXG5cdFx0XHRcdGVudHJ5SGFzQ2hhbmdlcyA9IGZhbHNlO1xyXG5cdFx0XHRcdGlmICghQ29nbml0by5jb25maWcuZmxhZ3MuQXBwTmF2KSB7XHJcblx0XHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuZmxhZ3MuVXNlQ29zbW9zSW5kZXhlcylcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIucG9sbEVudHJ5Q2hhbmdlcyhlbnRyeUtleSk7XHJcblx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnJlZnJlc2hFbnRyaWVzKCk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRpZiAoY3VycmVudEVudHJ5S2V5ICYmIGN1cnJlbnRFbnRyeUtleS5FbnRyeUlkID09PSBlbnRyeUtleS5FbnRyeUlkKVxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlRW50cnkoKTtcclxuXHJcblx0XHRcdFx0Ly8gRXhlY3V0ZSB0aGUgcGVuZGluZyBhY3Rpb25cclxuXHRcdFx0XHRleGVjdXRlQWN0aW9uKCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBEZWxldGUgRW50cmllc1xyXG5cdFx0XHRkZWxldGVFbnRyaWVzOiBmdW5jdGlvbiBkZWxldGVFbnRyaWVzKGVudHJpZXMpIHtcclxuXHRcdFx0XHRkZWxldGVFbnRyeURpYWxvZy5lbnRyaWVzID0gZW50cmllcztcclxuXHRcdFx0XHRkZWxldGVFbnRyeURpYWxvZy5vcGVuKCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBVcGRhdGUgRW50cnkgU3RhdHVzXHJcblx0XHRcdHVwZGF0ZUVudHJ5U3RhdHVzOiBmdW5jdGlvbiB1cGRhdGVFbnRyeVN0YXR1cyhlbnRyaWVzLCBzdGF0dXNOYW1lLCB0cmlnZ2VyRW50cnlOb3RpZmljYXRpb25zLCBzdGF0dXNJZCkge1xyXG5cclxuXHRcdFx0XHQvLyBTaG93IHRoZSBjaGFuZ2Ugc3RhdHVzIGRpYWxvZyB3aGVuIGNoYW5naW5nIHRoZSBzdGF0dXMgb2YgbXVsdGlwbGUgZW50cmllc1xyXG5cdFx0XHRcdGlmIChlbnRyaWVzLmxlbmd0aCA+IDEpIHtcclxuXHJcblx0XHRcdFx0XHQvLyBDbGVhciB0aGUgaW5jb21wbGV0ZSBlbnRyaWVzIGZsYWdcclxuXHRcdFx0XHRcdGRlbGV0ZSBjaGFuZ2VTdGF0dXNEaWFsb2cuaW5jb21wbGV0ZUVudHJpZXM7XHJcblxyXG5cdFx0XHRcdFx0Y2hhbmdlU3RhdHVzRGlhbG9nLmVudHJpZXMgPSBlbnRyaWVzO1xyXG5cdFx0XHRcdFx0Y2hhbmdlU3RhdHVzRGlhbG9nLnN0YXR1c05hbWUgPSBzdGF0dXNOYW1lO1xyXG5cdFx0XHRcdFx0Y2hhbmdlU3RhdHVzRGlhbG9nLnN0YXR1c0lkID0gc3RhdHVzSWQ7XHJcblx0XHRcdFx0XHRjaGFuZ2VTdGF0dXNEaWFsb2cub3BlbigpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRjaGFuZ2VTdGF0dXMoZW50cmllcywgc3RhdHVzTmFtZSwgdHJpZ2dlckVudHJ5Tm90aWZpY2F0aW9ucywgY2hhbmdlU3RhdHVzRGlhbG9nLmluY29tcGxldGVFbnRyaWVzLCBzdGF0dXNJZCk7XHJcblxyXG5cdFx0XHRcdC8vIENsZWFyIHRoZSBpbmNvbXBsZXRlIGVudHJpZXMgZmxhZ1xyXG5cdFx0XHRcdGRlbGV0ZSBjaGFuZ2VTdGF0dXNEaWFsb2cuaW5jb21wbGV0ZUVudHJpZXM7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBVcGRhdGVzIHRoZSBlbnRyeSByZWFkIHN0YXRlcyBpbiB0aGUgZ3JpZC4gVGhpcyBldmVudHVhbGx5IGNhbGxzIHVwZGF0ZUVudHJ5UmVhZFN0YXRlIHdpdGggb25seSBjb21wbGV0ZWQgZW50cmllc1xyXG5cdFx0XHR1cGRhdGVHcmlkUmVhZFN0YXRlOiBmdW5jdGlvbiB1cGRhdGVHcmlkUmVhZFN0YXRlKGVudHJpZXMsIHJlYWQpIHtcclxuXHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5jaGFuZ2VSZWFkU3RhdGVzKGVudHJpZXMsIHJlYWQpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gVXBkYXRlIEVudHJ5IFJlYWQgU3RhdGVcclxuXHRcdFx0dXBkYXRlRW50cnlSZWFkU3RhdGU6IGZ1bmN0aW9uIHVwZGF0ZUVudHJ5UmVhZFN0YXRlKGVudHJpZXMsIHJlYWQpIHtcclxuXHRcdFx0XHRjaGFuZ2VSZWFkU3RhdGUoZW50cmllcywgcmVhZCwgIXJlYWQpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gSW1wb3J0IEVudHJpZXNcclxuXHRcdFx0aW1wb3J0RW50cmllczogZnVuY3Rpb24gaW1wb3J0RW50cmllcygpIHtcclxuXHRcdFx0XHQvLyBIaWRlIG1lbnVzXHJcblx0XHRcdFx0Y29udHJvbGxlci5oaWRlTWVudXMoKTtcclxuXHJcblx0XHRcdFx0ZGlzcGxheUltcG9ydEVudHJpZXNEaWFsb2coKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEV4cG9ydCBFbnRyaWVzXHJcblx0XHRcdGV4cG9ydEVudHJpZXM6IGZ1bmN0aW9uIGV4cG9ydEVudHJpZXMoZXhwb3J0QWxsRmllbGRzLCBzZWxlY3RlZEVudHJpZXMpIHtcclxuXHJcblx0XHRcdFx0Ly8gSGlkZSBtZW51c1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblxyXG5cdFx0XHRcdGlmIChDb2duaXRvLmNvbmZpZy5leHBvcnRJZCkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5vcGVuRW50cnlFeHBvcnREaWFsb2coQ29nbml0by5jb25maWcuZXhwb3J0SWQsIFwiSW5Qcm9ncmVzc1wiKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0XHR2YXIgZm9ybUlkID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5nZXRfSWQoKTtcclxuXHRcdFx0XHRcdHZhciBlbnRyeVZpZXcgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3O1xyXG5cdFx0XHRcdFx0dmFyIGVudHJ5Vmlld1NhdmVkID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfbm9WaWV3Q2hhbmdlcygpO1xyXG5cclxuXHRcdFx0XHRcdENvZ25pdG8uRm9ybXMuZXhwb3J0Q29udHJvbGxlci50cnlTdGFydEV4cG9ydChmb3JtSWQsIGVudHJ5VmlldywgZW50cnlWaWV3U2F2ZWQsIHNlbGVjdGVkRW50cmllcywgZXhwb3J0QWxsRmllbGRzLCBjdXJyZW50Vmlld0VudHJ5Q291bnQudmFsdWUsIHN0YXJ0RXhwb3J0U3VjY2Vzc2Z1bCwgc3RhcnRFeHBvcnRGYWlsZWQpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0ZnVuY3Rpb24gc3RhcnRFeHBvcnRTdWNjZXNzZnVsKGpzb25EYXRhLCB0ZXh0U3RhdHVzLCB4aHJEYXRhKSB7XHJcblx0XHRcdFx0XHRzdGFydEVudHJ5RXhwb3J0Q2FsbGJhY2soanNvbkRhdGEuSWQsIHhockRhdGEpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0ZnVuY3Rpb24gc3RhcnRFeHBvcnRGYWlsZWQoeGhyRGF0YSkge1xyXG5cdFx0XHRcdFx0c3RhcnRFbnRyeUV4cG9ydENhbGxiYWNrKG51bGwsIHhockRhdGEpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0ZnVuY3Rpb24gc3RhcnRFbnRyeUV4cG9ydENhbGxiYWNrKGV4cG9ydElkLCByZXNwb25zZURhdGEpIHtcclxuXHRcdFx0XHRcdGlmIChleHBvcnRJZClcclxuXHRcdFx0XHRcdFx0Q29nbml0by5jb25maWcuZXhwb3J0SWQgPSBleHBvcnRJZDtcclxuXHJcblx0XHRcdFx0XHR2YXIgcmVxdWVzdFN0YXR1cyA9IHJlc3BvbnNlRGF0YS5zdGF0dXM7XHJcblx0XHRcdFx0XHR2YXIgcmVzcG9uc2VNZXNzYWdlID0gbnVsbDtcclxuXHJcblx0XHRcdFx0XHRpZiAocmVzcG9uc2VEYXRhLnJlc3BvbnNlVGV4dCkge1xyXG5cdFx0XHRcdFx0XHR2YXIgcmVzcG9uc2VCb2R5ID0gSlNPTi5wYXJzZShyZXNwb25zZURhdGEucmVzcG9uc2VUZXh0KTtcclxuXHRcdFx0XHRcdFx0cmVzcG9uc2VNZXNzYWdlID0gcmVzcG9uc2VCb2R5Lk1lc3NhZ2U7XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0dmFyIGV4cG9ydFN0YXR1cyA9IHJlcXVlc3RTdGF0dXMgPT09IDIwMCA/IFwiUGVuZGluZ1wiIDogXCJGYWlsZWRcIjtcclxuXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm9wZW5FbnRyeUV4cG9ydERpYWxvZyhleHBvcnRJZCwgZXhwb3J0U3RhdHVzLCByZXF1ZXN0U3RhdHVzLCByZXNwb25zZU1lc3NhZ2UpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdG9wZW5FbnRyeUV4cG9ydERpYWxvZzogZnVuY3Rpb24gKGV4cG9ydElkLCBzdGF0dXMsIHN0YXJ0RXhwb3J0UmVxdWVzdFN0YXR1cywgc3RhcnRFeHBvcnRSZXNwb25zZU1lc3NhZ2UpIHtcclxuXHRcdFx0XHRpZiAoZXhwb3J0SWQgPT09IFwiZXhwaXJlZFwiKVxyXG5cdFx0XHRcdFx0c3RhdHVzID0gXCJFeHBpcmVkXCI7XHJcblxyXG5cdFx0XHRcdC8vIFN1Y2Nlc3MgZXZlbnQgaGFuZGxlciB0byBkb3dubG9hZCB0aGUgZmlsZVxyXG5cdFx0XHRcdHZhciBoYW5kbGVFeHBvcnRTdWNjZXNzID0gZnVuY3Rpb24gKGV2ZW50RGF0YSkge1xyXG5cdFx0XHRcdFx0Q29nbml0by5jb25maWcuZXhwb3J0SWQgPSBudWxsO1xyXG5cdFx0XHRcdFx0JC5maWxlRG93bmxvYWQoZXZlbnREYXRhLmRvd25sb2FkVXJsLCB7IGh0dHBNZXRob2Q6IFwiR0VUXCIgfSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHR2YXIgaGFuZGxlRXhwb3J0RmFpbHVyZSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdENvZ25pdG8uY29uZmlnLmV4cG9ydElkID0gbnVsbDtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFZ1ZUNvbXBvbmVudHMuRW50cnlFeHBvcnREaWFsb2cub3BlbihcclxuXHRcdFx0XHRcdHtcclxuXHRcdFx0XHRcdFx0ZXhwb3J0SWQ6IGV4cG9ydElkLFxyXG5cdFx0XHRcdFx0XHRzdGFydEV4cG9ydFJlcXVlc3RTdGF0dXM6IHN0YXJ0RXhwb3J0UmVxdWVzdFN0YXR1cyxcclxuXHRcdFx0XHRcdFx0c3RhcnRFeHBvcnRSZXNwb25zZU1lc3NhZ2U6IHN0YXJ0RXhwb3J0UmVzcG9uc2VNZXNzYWdlLFxyXG5cdFx0XHRcdFx0XHR1c2VyRW1haWw6IENvZ25pdG8uY29uZmlnLnVzZXJJbmZvLkVtYWlsLFxyXG5cdFx0XHRcdFx0XHRzdGF0dXM6IHN0YXR1c1xyXG5cdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdFtcclxuXHRcdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHRcdGV2ZW50TmFtZTogXCJzdWNjZXNzXCIsXHJcblx0XHRcdFx0XHRcdFx0ZXZlbnRIYW5kbGVyOiBoYW5kbGVFeHBvcnRTdWNjZXNzXHJcblx0XHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRcdHtcclxuXHRcdFx0XHRcdFx0XHRldmVudE5hbWU6IFwiZmFpbHVyZVwiLFxyXG5cdFx0XHRcdFx0XHRcdGV2ZW50SGFuZGxlcjogaGFuZGxlRXhwb3J0RmFpbHVyZVxyXG5cdFx0XHRcdFx0XHR9LFxyXG5cclxuXHRcdFx0XHRcdF1cclxuXHRcdFx0XHQpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0aW5pdFZpZXdzOiBmdW5jdGlvbiBpbml0Vmlld3MoY2hhbmdpbmdGb3JtKSB7XHJcblx0XHRcdFx0VnVlQ29tcG9uZW50cy5jbG9zZUFsbERpYWxvZ3MoKTtcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLnZpZXdzID0gW107XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5yZWZyZXNoVmlld3MoKS50aGVuKGNoZWNrRm9ybShmdW5jdGlvbiAodmlld3MpIHtcclxuXHRcdFx0XHRcdENvZ25pdG8ucmVhZHkobnVsbCwgW1wibWFzdGVyXCJdLCBjaGVja0Zvcm0oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRjb25zdCB2aWV3ID0gdmlld3MuZmluZChmdW5jdGlvbiAodikgeyByZXR1cm4gdi5JZCA9PT0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKTsgfSk7XHJcblx0XHRcdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuc2V0X2lzVXNlclNwZWNpZmljKHZpZXcuSXNVc2VyU3BlY2lmaWMgfHwgZmFsc2UpO1xyXG5cdFx0XHRcdFx0XHRjb25zdCBjdXJyZW50Vmlld1R5cGUgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9UeXBlKCkuZ2V0X05hbWUoKTtcclxuXHRcdFx0XHRcdFx0aWYgKGN1cnJlbnRWaWV3VHlwZSA9PT0gJ0Zvcm0nKSB7XHJcblx0XHRcdFx0XHRcdFx0Q29nbml0by5yZWFkeShudWxsLCBbXCJmb3JtVmlld0FkYXB0ZXJcIl0sIGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuY2hhbmdlVmlldyhDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LCBsYXlvdXRNb2RlLCBjaGFuZ2luZ0Zvcm0pO1xyXG5cdFx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuY2hhbmdlVmlldyhDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LCBsYXlvdXRNb2RlLCBjaGFuZ2luZ0Zvcm0pO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9KSk7XHJcblx0XHRcdFx0fSkpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Y2hhbmdlRm9ybTogZnVuY3Rpb24gY2hhbmdlRm9ybShmb3JtKSB7XHJcblx0XHRcdFx0JGV4dGVuZChDb2duaXRvLkZvcm1zLm1vZGVsLmVudHJ5VHlwZU5hbWUsIGZ1bmN0aW9uIChlbnRyeVR5cGUpIHtcclxuXHJcblx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLmVudHJ5VHlwZSA9IGVudHJ5VHlwZTtcclxuXHJcblx0XHRcdFx0XHQvLyBFbnN1cmUgdGhlIGNhbGN1bGF0ZWQgb3JkZXIgcHJvcGVydHkgaXMgaW5pdGlhbGl6ZWRcclxuXHRcdFx0XHRcdGlmIChlbnRyeVR5cGUuJE9yZGVyKSB7XHJcblx0XHRcdFx0XHRcdGVudHJ5VHlwZS4kT3JkZXIuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoXCJfT3JkZXJcIikpIHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0dGhpcy5zZXRfT3JkZXIobnVsbCk7XHJcblx0XHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0Y3VycmVudEVudHJ5S2V5ID0gbnVsbDtcclxuXHRcdFx0XHRjb250cm9sbGVyLmluaXRWaWV3cyh0cnVlKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIENoYW5nZSBWaWV3XHJcblx0XHRcdGNoYW5nZVZpZXc6IGZ1bmN0aW9uIGNoYW5nZVZpZXcodmlldywgbW9kZSwgY2hhbmdpbmdGb3JtKSB7XHJcblx0XHRcdFx0dmFyIGN1cnJlbnRWaWV3ID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50VmlldztcclxuXHJcblx0XHRcdFx0Ly8gQ2xvc2UgdGhlIGRldGFpbHMgdmlldyBhbmQgY2xlYXIgc2VsZWN0aW9ucyBpZiBjaGFuZ2luZyB2aWV3c1xyXG5cdFx0XHRcdGlmICh2aWV3LmdldF9JZCgpICE9IGN1cnJlbnRWaWV3LmdldF9JZCgpKSB7XHJcblx0XHRcdFx0XHRpZiAoY29udHJvbGxlci5tYXN0ZXIpIHtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlRW50cnkodmlldyk7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLmNsZWFyU2VsZWN0aW9uKCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHQvLyBSb2xsYmFjayBjaGFuZ2VzIGlmIHRoZXJlIGlzIHByZXZpb3VzIHZpZXcgZGF0YVxyXG5cdFx0XHRcdGlmICghQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfbm9WaWV3Q2hhbmdlcygpICYmIHByZXZpb3VzVmlld0RhdGEpIHtcclxuXHRcdFx0XHRcdC8vIFJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBjbGllbnQgbWVtb3J5IGNhY2hlXHJcblx0XHRcdFx0XHR2YXIgZW50cnlWaWV3VHlwZSA9IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3Lm1ldGE7XHJcblx0XHRcdFx0XHRkZWxldGUgZW50cnlWaWV3VHlwZS5fcG9vbFtjdXJyZW50Vmlldy5tZXRhLmlkLnRvTG93ZXJDYXNlKCldO1xyXG5cdFx0XHRcdFx0aWYgKGVudHJ5Vmlld1R5cGUuX2tub3duKVxyXG5cdFx0XHRcdFx0XHRlbnRyeVZpZXdUeXBlLl9rbm93bi5yZW1vdmUoY3VycmVudFZpZXcpO1xyXG5cclxuXHRcdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwudmlld3NbQ29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cy5pbmRleE9mKENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcpXSA9IENvZ25pdG8uZGVzZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXcsIHByZXZpb3VzVmlld0RhdGEpO1xyXG5cclxuXHRcdFx0XHRcdC8vIENsZWFyIHRoZSB2aWV3IGhhcyBjaGFuZ2VzIGZsYWdcclxuXHRcdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuc2V0X25vVmlld0NoYW5nZXModHJ1ZSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHQvLyBTdG9yZSB0aGUgdmlldyBkYXRhIHNvIGl0IGNhbiBiZSByb2xsZWQgYmFjayBpZiBuZWVkZWQuIFN0cmluZ2lmeSBhbmQgcGFyc2UgdGhlIGRhdGEgdG8gZW5zdXJlIGFycmF5cyBhcmUgY29waWVkLlxyXG5cdFx0XHRcdHByZXZpb3VzVmlld0RhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KENvZ25pdG8uc2VyaWFsaXplKHZpZXcpKSk7XHJcblxyXG5cdFx0XHRcdC8vIFJlc2V0IG5vVmlld0NoYW5nZXNcclxuXHRcdFx0XHRjdXJyZW50Vmlldy5zZXRfbm9WaWV3Q2hhbmdlcyh0cnVlKTtcclxuXHJcblx0XHRcdFx0RXhvV2ViLk9ic2VydmVyLnNldFZhbHVlKENvZ25pdG8uRm9ybXMubW9kZWwsIFwiY3VycmVudFZpZXdcIiwgdmlldyk7XHJcblxyXG5cdFx0XHRcdHJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuZmxhZ3MuVXNlclNwZWNpZmljVmlld3MpIHtcclxuXHRcdFx0XHRcdFx0Y29uc3QgbmV3VmlldyA9IENvZ25pdG8uRm9ybXMubW9kZWwudmlld3MuZmluZChmdW5jdGlvbiAodikgeyByZXR1cm4gdi5JZCA9PT0gdmlldy5nZXRfSWQoKSB9KTtcclxuXHRcdFx0XHRcdFx0aWYgKG5ld1ZpZXcpXHJcblx0XHRcdFx0XHRcdFx0Y3VycmVudFZpZXdFbnRyeUNvdW50LnZhbHVlID0gbmV3Vmlldy5FbnRyaWVzO1xyXG5cdFx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdFx0Y3VycmVudFZpZXdFbnRyeUNvdW50LnZhbHVlID0gMDtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0Y29uc3Qgcm9sZUlkID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfUm9sZUlkKCk7XHJcblx0XHRcdFx0Y29uc3Qgcm9sZSA9IGZvcm1EYXRhLnZhbHVlLlJvbGVzLmZpbmQoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIHIuSWQgPT09IHJvbGVJZDsgfSk7XHJcblx0XHRcdFx0RXhvV2ViLk9ic2VydmVyLnNldFZhbHVlKENvZ25pdG8uRm9ybXMubW9kZWwsIFwiaXNQdWJsaWNSb2xlXCIsIHJvbGUuSXNQdWJsaWMpO1xyXG5cclxuXHRcdFx0XHRDb2duaXRvLnJlYWR5KG51bGwsIFsnZGV0YWlsJywgJ21hc3RlciddLCBjaGVja0Zvcm0oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIuY2hhbmdlVmlldyh2aWV3LCBtb2RlLCByb2xlLCBjaGFuZ2luZ0Zvcm0pO1xyXG5cclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnNldElzQXNzaWduZWRFbnRyeShpc0Fzc2lnbmVkVmlldy52YWx1ZSk7XHJcblxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuY2hhbmdlVmlldyh2aWV3KTtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnNldFN1bW1hcnlQcm9wZXJ0eShnZXRTdW1tYXJ5UHJvcGVydHkoKSk7XHJcblxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuc2V0Um9sZShyb2xlLk5hbWUpO1xyXG5cclxuXHRcdFx0XHRcdHVwZGF0ZU5hdmlnYXRpb24oKTtcclxuXHJcblx0XHRcdFx0XHRpZiAoc2hvd05ld0VudHJ5LnZhbHVlKVxyXG5cdFx0XHRcdFx0XHRleGVjdXRlQWN0aW9uKCgpID0+IGNvbnRyb2xsZXIubmV3RW50cnkoKSk7XHJcblx0XHRcdFx0fSkpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gTmV3IFZpZXdcclxuXHRcdFx0bmV3VmlldzogZnVuY3Rpb24gbmV3VmlldygpIHtcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm9uTmV3VmlldygpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gU2F2ZSBWaWV3XHJcblx0XHRcdHNhdmVWaWV3OiBhc3luYyBmdW5jdGlvbiBzYXZlVmlldyh2aWV3LCBpc09ubHlSZW5hbWluZykge1xyXG5cclxuXHRcdFx0XHQvLyBJbmRpdmlkdWFsIFBsYW5cclxuXHRcdFx0XHRpZiAoIUNvZ25pdG8uY29uZmlnLmhhc1BhaWRQbGFuKSB7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLnNob3dGZWF0dXJlV2FybmluZyhcImVudHJ5dmlld3NcIik7XHJcblx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHQvLyBDaGVjayBpZiB1c2VyIGNhbiBtYW5hZ2UgZW50cmllc1xyXG5cdFx0XHRcdGlmICghY2FuTWFuYWdlRW50cmllcy52YWx1ZSkge1xyXG5cdFx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0Ly8gQ2xlYXIgb3V0IHRoZSB2aWV3IGludGVybmFsIG5hbWVcclxuXHRcdFx0XHR2aWV3LnNldF9JbnRlcm5hbE5hbWUobnVsbCk7XHJcblxyXG5cdFx0XHRcdC8vcmVmcmVzaCB0aGUgY3VycmVudCBlbnRyeSB2aWV3J3Mgc2VxdWVuY2Uga2V5XHJcblx0XHRcdFx0aWYgKHZpZXcuZ2V0X0lkKCkgJiYgQ29nbml0by5jb25maWcuZmxhZ3MuQXBwTmF2KVxyXG5cdFx0XHRcdFx0dmlldy5zZXRfU2VxdWVuY2VLZXkoY3VycmVudEVudHJ5Vmlldy52YWx1ZS5TZXF1ZW5jZUtleSk7XHJcblxyXG5cdFx0XHRcdC8vIFNhdmUgdGhlIHZpZXdcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLnNhdmVFbnRyeVZpZXcodmlldywgZnVuY3Rpb24gKGRhdGEpIHtcclxuXHRcdFx0XHRcdHZpZXcuaXNVc2VyU3BlY2lmaWMgPSB2aWV3LmdldF9TaGFyZWRXaXRoTWUoKTtcclxuXHRcdFx0XHRcdENvZ25pdG8uZGVzZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXcsIGRhdGEsIHZpZXcpO1xyXG5cclxuXHRcdFx0XHRcdC8vIFNldCBwcmV2aW91cyB2aWV3IGRhdGEgc2luY2UgbmV3IHZpZXcgY291bGQgYmUgYSBjb3B5IGJlZm9yZSBiZWluZyBzYXZlZFxyXG5cdFx0XHRcdFx0cHJldmlvdXNWaWV3RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoQ29nbml0by5zZXJpYWxpemUodmlldykpKTtcclxuXHJcblx0XHRcdFx0XHQvLyB1cGRhdGUgY3VycmVudFZpZXcgaW4gdGhlIGdsb2JhbFN0b3JlIHBhc3NlZCBpbiBmcm9tIEVudHJpZXNQYWdlLnZ1ZVxyXG5cdFx0XHRcdFx0ZW1pdFZpZXdVcGRhdGVkKGRhdGEuSWQsIGRhdGEpO1xyXG5cclxuXHRcdFx0XHRcdC8vIERvIG5vdCByZWZyZXNoIGdyaWQgaWYgb25seSByZW5hbWluZyBjdXJyZW50IHZpZXcgbmFtZVxyXG5cdFx0XHRcdFx0aWYgKGlzT25seVJlbmFtaW5nKVxyXG5cdFx0XHRcdFx0XHRyZXR1cm47XHJcblxyXG5cdFx0XHRcdFx0Ly8gQ2hhbmdlIHRvIHRoZSBzYXZlZCB2aWV3XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZVZpZXcodmlldywgbnVsbCk7XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHRcdC8vIENsZWFyIHRoZSBwcmV2aW91cyB2aWV3IGRhdGFcclxuXHRcdFx0XHRwcmV2aW91c1ZpZXdEYXRhID0gbnVsbDtcclxuXHJcblx0XHRcdFx0JChcIi5jLXNhdmUtdmlldyAuYy1uYXYtYnV0dG9uXCIpLmFkZENsYXNzKFwiYy1uYXYtZGlzYWJsZWRcIik7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBTYXZlIFZpZXcgQXNcclxuXHRcdFx0c2F2ZVZpZXdBczogZnVuY3Rpb24gc2F2ZVZpZXdBcygpIHtcclxuXHRcdFx0XHRpZiAoIUNvZ25pdG8uY29uZmlnLmhhc1BhaWRQbGFuKSB7XHJcblx0XHRcdFx0XHRpZiAoQ29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cy5sZW5ndGggPiBDb2duaXRvLmNvbmZpZy5lbnRyeVZpZXdMaW1pdClcclxuXHRcdFx0XHRcdFx0dGhpcy5zaG93RmVhdHVyZVdhcm5pbmcoXCJlbnRyeXZpZXdzZXhpc3RcIik7XHJcblx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdHRoaXMuc2hvd0ZlYXR1cmVXYXJuaW5nKFwiZW50cnl2aWV3c1wiKTtcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZSBpZiAoQ29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cy5sZW5ndGggPj0gQ29nbml0by5jb25maWcuZW50cnlWaWV3TGltaXQpIHtcclxuXHRcdFx0XHRcdHNob3dWaWV3TGltaXRFeGNlZWRlZFdhcm5pbmcoKTtcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdHZhciBuZXdWaWV3ID0gT2JqZWN0LmFzc2lnbih7fSwgQ29nbml0by5zZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50VmlldykpO1xyXG5cdFx0XHRcdG5ld1ZpZXcuSWQgPSBudWxsO1xyXG5cclxuXHRcdFx0XHRjb250cm9sbGVyLm9wZW5FbnRyeVZpZXdTZXR0aW5ncyhuZXdWaWV3LCB0cnVlKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFZpZXcgQ2hhbmdlZFxyXG5cdFx0XHR2aWV3Q2hhbmdlZDogZnVuY3Rpb24gdmlld0NoYW5nZWQoKSB7XHJcblxyXG5cdFx0XHRcdC8vIEZsYWcgdGhlIHZpZXcgaGFzIGNoYW5nZXNcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LnNldF9ub1ZpZXdDaGFuZ2VzKGZhbHNlKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIERlbGV0ZSBWaWV3XHJcblx0XHRcdGRlbGV0ZVZpZXc6IGZ1bmN0aW9uIGRlbGV0ZVZpZXcodmlld0lkID0gbnVsbCkge1xyXG5cdFx0XHRcdHZhciB2aWV3ID0gdmlld0lkID8gQ29nbml0by5kZXNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLkVudHJ5VmlldywgQ29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cy5maW5kKGZ1bmN0aW9uICh2KSB7IHJldHVybiB2LklkID09PSB2aWV3SWQgfSkpIDogQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50VmlldztcclxuXHJcblx0XHRcdFx0Ly8gU3dpdGNoIHRvIHRoZSBmaXJzdCB2aWV3IGluIHRoZSBsaXN0IHRoYXQgaXMgbm90IHRoZSBjdXJyZW50IHZpZXdcclxuXHRcdFx0XHR2YXIgZGVmYXVsdFZpZXcgPSBDb2duaXRvLkZvcm1zLm1vZGVsLnZpZXdzLmZpbmQoZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYuSWQgIT09IHZpZXcuZ2V0X0lkKCkgfSk7XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5vbkNoYW5nZVZpZXcoZGVmYXVsdFZpZXcuSWQpO1xyXG5cclxuXHRcdFx0XHQvLyBUaGVuIGRlbGV0ZSB0aGUgdmlld1xyXG5cdFx0XHRcdENvZ25pdG8uRm9ybXMuZGVsZXRlRW50cnlWaWV3KHZpZXcuZ2V0X0lkKCksIGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdC8vLyBSZWZyZXNoIHRoZSBsaXN0IG9mIGF2YWlsYWJsZSB2aWV3c1xyXG5cdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5yZWZyZXNoVmlld3MoKTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIENvcHkgVmlld1xyXG5cdFx0XHRjb3B5VmlldzogZnVuY3Rpb24gY29weVZpZXcoKSB7XHJcblx0XHRcdFx0aWYgKENvZ25pdG8uRm9ybXMubW9kZWwudmlld3MubGVuZ3RoID49IENvZ25pdG8uY29uZmlnLmVudHJ5Vmlld0xpbWl0KSB7XHJcblx0XHRcdFx0XHRzaG93Vmlld0xpbWl0RXhjZWVkZWRXYXJuaW5nKCk7XHJcblx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHQvLyBTYXZlIHRoZSBjb3BpZWQgdmlld1xyXG5cdFx0XHRcdENvZ25pdG8uRm9ybXMuY29weUVudHJ5VmlldyhDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LCBmdW5jdGlvbiAoY29weURhdGEpIHtcclxuXHRcdFx0XHRcdHZhciBjb3B5ID0gQ29nbml0by5kZXNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLkVudHJ5VmlldywgY29weURhdGEpO1xyXG5cdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cy5hZGQoY29weSk7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZVZpZXcoY29weSwgbGF5b3V0TW9kZSk7XHJcblxyXG5cdFx0XHRcdFx0aWYgKCFDb2duaXRvLmNvbmZpZy5mbGFncy5Vc2VyU3BlY2lmaWNWaWV3cykge1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLnNob3dSZW5hbWVWaWV3KCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH0sXHJcblx0XHRcdGNhbkFjY2Vzc0Rlc3RpbmF0aW9uVmlldzogZnVuY3Rpb24gY2FuQWNjZXNzRGVzdGluYXRpb25WaWV3KCkge1xyXG5cdFx0XHRcdHJldHVybiBDb2duaXRvLkZvcm1zLm1vZGVsLnZpZXdzLm1hcChmdW5jdGlvbiAodikgeyByZXR1cm4gdi5JZDsgfSkuaW5jbHVkZXMoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfQWZ0ZXJTdWJtaXREZXN0aW5hdGlvblZpZXdJZCgpKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFNob3cgUmVuYW1lIFZpZXdcclxuXHRcdFx0c2hvd1JlbmFtZVZpZXc6IGZ1bmN0aW9uIHNob3dSZW5hbWVWaWV3KCkge1xyXG5cdFx0XHRcdC8vIFNlbGVjdCBhbmQgZm9jdXMgbmFtZSB0ZXh0XHJcblx0XHRcdFx0dmFyIHRleHRJbnB1dCA9ICQoXCIuYy1yZW5hbWUtdmlldyBpbnB1dDp0ZXh0XCIpLmdldCgwKTtcclxuXHRcdFx0XHR0ZXh0SW5wdXQuc2VsZWN0aW9uU3RhcnQgPSAwO1xyXG5cdFx0XHRcdHRleHRJbnB1dC5zZWxlY3Rpb25FbmQgPSB0ZXh0SW5wdXQudmFsdWUubGVuZ3RoO1xyXG5cclxuXHRcdFx0XHRjb250cm9sbGVyLmhpZGVNZW51cygpO1xyXG5cclxuXHRcdFx0XHRzaG93TWVudSgkKFwiLmMtbWVudS1jdXJyZW50LXZpZXdcIikpO1xyXG5cclxuXHRcdFx0XHR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHQvLyBBZGQgQ1NTIHRvIHNob3cgdGhlIHJlbmFtZSB0ZXh0Ym94XHJcblx0XHRcdFx0XHQkKFwiLmMtbWVudS1jdXJyZW50LXZpZXdcIikuYWRkQ2xhc3MoXCJjLXNob3ctcmVuYW1lXCIpO1xyXG5cclxuXHRcdFx0XHRcdCQoXCIuZW50cnktdmlld3MtbWVudVwiKVswXS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG5cclxuXHRcdFx0XHRcdC8vIEZvY3VzIHRoZSBlbGVtZW50IG5vdyB0aGF0IGl0IGlzIHZpc2libGVcclxuXHRcdFx0XHRcdHRleHRJbnB1dC5mb2N1cygpO1xyXG5cdFx0XHRcdH0sIDApO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gQ2hhbmdlIExheW91dFxyXG5cdFx0XHRjaGFuZ2VMYXlvdXQ6IGZ1bmN0aW9uIGNoYW5nZUxheW91dChtb2RlKSB7XHJcblx0XHRcdFx0Q29nbml0by5yZWFkeShudWxsLCBbXCJtYXN0ZXIsIGRldGFpbFwiXSwgZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIuY2hhbmdlTGF5b3V0KG1vZGUpO1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuY2hhbmdlTGF5b3V0KG1vZGUpO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gQ2hhbmdlIENvbHVtbnNcclxuXHRcdFx0Y2hhbmdlQ29sdW1uczogZnVuY3Rpb24gY2hhbmdlQ29sdW1ucyhjb2x1bW5zKSB7XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5zZXRfQ29sdW1ucyhjb2x1bW5zKTtcclxuXHJcblx0XHRcdFx0aWYgKGNvbnRyb2xsZXIubWFzdGVyKVxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIuY2hhbmdlQ29sdW1ucyhjb2x1bW5zKTtcclxuXHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHR0ZW1wQ29sdW1ucyA9IGNvbHVtbnM7XHJcblxyXG5cdFx0XHRcdGNvbnRyb2xsZXIudmlld0NoYW5nZWQoKTtcclxuXHJcblx0XHRcdFx0aWYgKGNvbnRyb2xsZXIuZGV0YWlsKVxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwuc2V0U3VtbWFyeVByb3BlcnR5KGdldFN1bW1hcnlQcm9wZXJ0eSgpKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIENoYW5nZSBTb3J0XHJcblx0XHRcdGNoYW5nZVNvcnQ6IGZ1bmN0aW9uIGNoYW5nZVNvcnQoY29sdW1ucykge1xyXG5cdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuc2V0X1NvcnRCeShjb2x1bW5zKTtcclxuXHRcdFx0XHRpZiAoY29udHJvbGxlci5tYXN0ZXIpXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5jaGFuZ2VTb3J0KGNvbHVtbnMpO1xyXG5cdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdHRlbXBTb3J0ID0gY29sdW1ucztcclxuXHJcblx0XHRcdFx0Y29udHJvbGxlci52aWV3Q2hhbmdlZCgpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gQ2hhbmdlIEZpbHRlclxyXG5cdFx0XHRjaGFuZ2VGaWx0ZXI6IGZ1bmN0aW9uIGNoYW5nZUZpbHRlcihmaWx0ZXIpIHtcclxuXHRcdFx0XHQvLyBDbG9zZSB0aGUgZGV0YWlscyB2aWV3XHJcblx0XHRcdFx0Y29udHJvbGxlci5oaWRlRW50cnkoKTtcclxuXHJcblx0XHRcdFx0aWYgKGZpbHRlci5nZXRfYWxsRW50cnlTdGF0dXNlcygpKVxyXG5cdFx0XHRcdFx0ZmlsdGVyLmdldF9FbnRyeVN0YXR1cygpLmNsZWFyKCk7XHJcblx0XHRcdFx0aWYgKGZpbHRlci5nZXRfYWxsUGF5bWVudFN0YXR1c2VzKCkpXHJcblx0XHRcdFx0XHRmaWx0ZXIuZ2V0X1BheW1lbnRTdGF0dXMoKS5jbGVhcigpO1xyXG5cclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LnNldF9GaWx0ZXIoZmlsdGVyKTtcclxuXHRcdFx0XHRpZiAoY29udHJvbGxlci5tYXN0ZXIpXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5jaGFuZ2VGaWx0ZXIoZmlsdGVyKTtcclxuXHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHR0ZW1wRmlsdGVyID0gZmlsdGVyO1xyXG5cclxuXHRcdFx0XHRjb250cm9sbGVyLnZpZXdDaGFuZ2VkKCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBIaWRlIE1lbnVzXHJcblx0XHRcdGhpZGVNZW51czogZnVuY3Rpb24gaGlkZU1lbnVzKCkge1xyXG5cdFx0XHRcdENvZ25pdG8udGltZXJzLmhpZGVNZW51cyA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdCQoXCIuYy1tZW51LWV4cGFuZGVkXCIpLnJlbW92ZUNsYXNzKFwiYy1tZW51LWV4cGFuZGVkXCIpO1xyXG5cdFx0XHRcdFx0JChcIi5jLW1lbnUtb3BlblwiKS5yZW1vdmVDbGFzcyhcImMtbWVudS1vcGVuXCIpLmNzcyhcInRyYW5zaXRpb25cIiwgXCJcIikuY3NzKFwibWF4LWhlaWdodFwiLCBcIlwiKS5jc3MoXCJvdmVyZmxvdy15XCIsIFwiXCIpO1xyXG5cclxuXHRcdFx0XHRcdC8vIEhpZGUgY29udGV4dCBtZW51cyBpbiBjaGlsZCB3aW5kb3dzLCBwcm90ZWN0aW5nIGFnYWluc3QgY2FsbHMgb2NjdXJyaW5nIGJlZm9yZSB0aGV5IGFyZSByZWdpc3RlcmVkXHJcblx0XHRcdFx0XHRpZiAoY29udHJvbGxlci5tYXN0ZXIpXHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLmhpZGVNZW51cygpO1xyXG5cclxuXHRcdFx0XHRcdC8vIFJlbW92ZSBDU1MgdXNlZCB0byBkaXNwbGF5IHRoZSByZW5hbWUgdGV4dGJveFxyXG5cdFx0XHRcdFx0JChcIi5jLW1lbnUtY3VycmVudC12aWV3XCIpLnJlbW92ZUNsYXNzKFwiYy1zaG93LXJlbmFtZVwiKTtcclxuXHJcblx0XHRcdFx0XHQvLyBTaG93IGVudHJ5IHZpZXcgbWVudVxyXG5cdFx0XHRcdFx0dmFyIGVudHJ5Vmlld01lbnUgPSAkKFwiLmVudHJ5LXZpZXdzLW1lbnVcIik7XHJcblx0XHRcdFx0XHRpZiAoZW50cnlWaWV3TWVudS5sZW5ndGgpXHJcblx0XHRcdFx0XHRcdGVudHJ5Vmlld01lbnVbMF0uc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuXHJcblx0XHRcdFx0XHQvL0NsZWFyIHotaW5kZXggb2YgZW50cnkgbGlzdCBncmlkIGR1ZSB0byBzY3JvbGxpbmcgaXNzdWVzIGluIGVkZ2VcclxuXHRcdFx0XHRcdCQoXCIjYy1lbnRyeWxpc3RcIikucmVtb3ZlQ2xhc3MoXCJjLWVudHJpZXMtb3Blbi1tZW51XCIpO1xyXG5cdFx0XHRcdH0sIDApO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0Ly8gU2VsZWN0IEVudHJpZXNcclxuXHRcdFx0c2VsZWN0RW50cmllczogZnVuY3Rpb24gc2VsZWN0RW50cmllcyhlbnRyaWVzKSB7XHJcblx0XHRcdFx0Ly8gVXBkYXRlIEVudHJpZXNQYWdlIHZhbHVlIGZpcnN0XHJcblx0XHRcdFx0aWYgKHNlbGVjdGVkRW50cmllcy5sZW5ndGggPT0gMCB8fCBlbnRyaWVzLmxlbmd0aCA9PSAwKVxyXG5cdFx0XHRcdFx0b25VcGRhdGVIYXNTZWxlY3RlZEVudHJpZXMoZW50cmllcy5sZW5ndGggPiAwKTtcclxuXHJcblx0XHRcdFx0c2VsZWN0ZWRFbnRyaWVzID0gZW50cmllcztcclxuXHRcdFx0XHR2YXIgZm9ybSA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm07XHJcblx0XHRcdFx0Ly8gQ2xlYXIgc2VsZWN0ZWQgZW50cmllc1xyXG5cdFx0XHRcdGZvcm0uc2V0X3NlbGVjdGVkRW50cmllcyhbXSk7XHJcblx0XHRcdFx0Zm9ybS5zZXRfc2VsZWN0ZWRFbnRyaWVzTGltaXRlZChbXSk7XHJcblxyXG5cdFx0XHRcdGZvcm0uc2V0X3NlbGVjdGVkRW50cmllcyhzZWxlY3RlZEVudHJpZXMpO1xyXG5cdFx0XHRcdGlmIChzZWxlY3RlZEVudHJpZXMubGVuZ3RoID4gMCAmJiBzZWxlY3RlZEVudHJpZXMubGVuZ3RoIDw9IDEwMDApIHtcclxuXHRcdFx0XHRcdGZvcm0uc2V0X2VudHJpZXNTZWxlY3RlZCh0cnVlKTtcclxuXHRcdFx0XHRcdGZvcm0uc2V0X3NlbGVjdGVkRW50cmllc0xpbWl0ZWQoc2VsZWN0ZWRFbnRyaWVzLnNsaWNlKDAsIDEwMDApKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZSBpZiAoc2VsZWN0ZWRFbnRyaWVzLmxlbmd0aCA+IDEwMDApIHtcclxuXHRcdFx0XHRcdC8vIExpbWl0ZWQgQWNjZXNzIHVzZXJzIHNob3VsZCBhbHdheXMgb25seSBzZWUgYWN0aW9ucyB0aGV5IGNhbiBwZXJmb3JtLCByZWdhcmRsZXNzIG9mIGhvdyBtYW55IGVudHJpZXMgc2VsZWN0ZWRcclxuXHRcdFx0XHRcdGlmIChpc0xpbWl0ZWRBY2Nlc3MudmFsdWUpXHJcblx0XHRcdFx0XHRcdGZvcm0uc2V0X3NlbGVjdGVkRW50cmllc0xpbWl0ZWQoc2VsZWN0ZWRFbnRyaWVzKVxyXG5cdFx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0XHRmb3JtLnNldF9zZWxlY3RlZEVudHJpZXNMaW1pdGVkKFtdKTtcclxuXHJcblx0XHRcdFx0XHRmb3JtLnNldF9lbnRyaWVzU2VsZWN0ZWQodHJ1ZSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdFx0Zm9ybS5zZXRfZW50cmllc1NlbGVjdGVkKGZhbHNlKTtcclxuXHRcdFx0XHRcdGZvcm0uc2V0X3NlbGVjdGVkRW50cmllc0xpbWl0ZWQoW10pO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFVwZGF0ZSBFbnRyeSBDb3VudFxyXG5cdFx0XHR1cGRhdGVFbnRyeUNvdW50OiBmdW5jdGlvbiB1cGRhdGVFbnRyeUNvdW50KGNvdW50KSB7XHJcblx0XHRcdFx0Y3VycmVudFZpZXdFbnRyeUNvdW50LnZhbHVlID0gY291bnQ7XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5nZXRFbnRyeVZpZXdzKENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0uZ2V0X0lkKCkpXHJcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbiAodmlld3MpIHtcclxuXHRcdFx0XHRcdFx0RXhvV2ViLk9ic2VydmVyLnNldFZhbHVlKENvZ25pdG8uRm9ybXMubW9kZWwsIFwidmlld3NcIiwgdmlld3MpO1xyXG5cdFx0XHRcdFx0XHRyZXR1cm4gdmlld3M7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdHVwZGF0ZUVudHJ5RGV0YWlsczogZnVuY3Rpb24gdXBkYXRlRW50cnlEZXRhaWxzKGVudHJ5S2V5KSB7XHJcblx0XHRcdFx0Y29udHJvbGxlci5kZXRhaWwucmVmcmVzaEVudHJ5KGVudHJ5S2V5KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFBheSBXaXRoIENhc2hcclxuXHRcdFx0cGF5V2l0aENhc2g6IGZ1bmN0aW9uIHBheVdpdGhDYXNoKGVudHJ5S2V5LCBwYXltZW50QW1vdW50KSB7XHJcblx0XHRcdFx0aWYgKHN1Ym1pdHRpbmdDYXNoUGF5bWVudClcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHRcdFx0XHRzdWJtaXR0aW5nQ2FzaFBheW1lbnQgPSB0cnVlO1xyXG5cclxuXHRcdFx0XHR2YXIgdmlld0lkID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKTtcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1ha2VQYXltZW50KHZpZXdJZCwgZW50cnlLZXkuRW50cnlJZCwgbnVsbCwgbnVsbCwgcGF5bWVudEFtb3VudClcclxuXHRcdFx0XHRcdC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuZW50cnlVcGRhdGVkKGRhdGEuZW50cnlLZXksIG51bGwsIGZ1bmN0aW9uICgpIHsgc3VibWl0dGluZ0Nhc2hQYXltZW50ID0gZmFsc2UgfSk7XHJcblx0XHRcdFx0XHR9KVxyXG5cdFx0XHRcdFx0LmNhdGNoKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0c3VibWl0dGluZ0Nhc2hQYXltZW50ID0gZmFsc2U7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFN1Ym1pdCBQYXltZW50XHJcblx0XHRcdHN1Ym1pdFBheW1lbnQ6IGZ1bmN0aW9uIHN1Ym1pdFBheW1lbnQoZW50cnlLZXksIGN1c3RvbWVyQ2FyZCkge1xyXG5cdFx0XHRcdGRpc3BsYXlTdWJtaXRQYXltZW50RGlhbG9nKGVudHJ5S2V5LCBjdXN0b21lckNhcmQsIENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0uZ2V0X1BheW1lbnRBY2NvdW50KCkuZ2V0X1Byb2Nlc3Nvck5hbWUoKS50b0xvd2VyQ2FzZSgpKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFJlZnVuZCBNYW51YWwgUGF5bWVudFxyXG5cdFx0XHRyZWZ1bmRNYW51YWxQYXltZW50OiBmdW5jdGlvbiByZWZ1bmRNYW51YWxQYXltZW50KGVudHJ5S2V5KSB7XHJcblx0XHRcdFx0cmVmdW5kT3JkZXIoZW50cnlLZXkuRW50cnlJZCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBSZWZ1bmQgUGF5bWVudFxyXG5cdFx0XHRyZWZ1bmRQYXltZW50OiBmdW5jdGlvbiByZWZ1bmRQYXltZW50KGVudHJ5SWQsIHJlZnVuZE1vZGVsKSB7XHJcblx0XHRcdFx0ZGlzcGxheVJlZnVuZE9yZGVyRGlhbG9nKGVudHJ5SWQsIHJlZnVuZE1vZGVsKTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIFNoYXJlIEVudHJ5XHJcblx0XHRcdHNoYXJlRW50cnk6IGZ1bmN0aW9uIHNoYXJlRW50cnkoZW50cnlLZXksIGVtaXR0ZWRSb2xlcywgYWxsb3dTYXZlQW5kUmVzdW1lTGluaykge1xyXG5cdFx0XHRcdGlmIChDb2duaXRvLmNvbmZpZy5oYXNQYWlkUGxhbikge1xyXG5cdFx0XHRcdFx0Ly8gU2VyaWFsaXplIHJvbGVzXHJcblx0XHRcdFx0XHR2YXIgcm9sZXMgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9Sb2xlcygpO1xyXG5cdFx0XHRcdFx0aWYgKCFyb2xlcylcclxuXHRcdFx0XHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdFx0XHRcdFZ1ZUNvbXBvbmVudHMuU2hhcmVFbnRyeURpYWxvZy5vcGVuKHtcclxuXHRcdFx0XHRcdFx0ZW50cnlJZDogZW50cnlLZXkuRW50cnlJZCxcclxuXHRcdFx0XHRcdFx0ZW50cnlWaWV3SWQ6IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X0lkKCksXHJcblx0XHRcdFx0XHRcdHJvbGVzOiBlbWl0dGVkUm9sZXMsXHJcblx0XHRcdFx0XHRcdGFsbG93U2F2ZUFuZFJlc3VtZUxpbms6IGFsbG93U2F2ZUFuZFJlc3VtZUxpbmssXHJcblx0XHRcdFx0XHRcdGlzTGltaXRlZFdvcmtmbG93UHJvOiBDb2duaXRvLmNvbmZpZy5pc0xpbWl0ZWRXb3JrZmxvd1BybyxcclxuXHRcdFx0XHRcdFx0ZGF0ZUZvcm1hdDogU3lzLkN1bHR1cmVJbmZvLkN1cnJlbnRDdWx0dXJlLmRhdGVUaW1lRm9ybWF0LlNob3J0RGF0ZVBhdHRlcm5cclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuc2hvd0ZlYXR1cmVXYXJuaW5nKFwiZW50cnlzaGFyaW5nXCIpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIENsb3NlIFNoYXJlIEVudHJ5XHJcblx0XHRcdGNsb3NlU2hhcmVFbnRyeTogZnVuY3Rpb24gY2xvc2VTaGFyZUVudHJ5KGVtYWlsU2VudCkge1xyXG5cdFx0XHRcdGlmIChzaGFyZUVudHJ5RGlhbG9nKSB7XHJcblx0XHRcdFx0XHRpZiAoZW1haWxTZW50KSB7XHJcblx0XHRcdFx0XHRcdHZhciAkYnV0dG9uID0gJChcIi5jLW1vZGFsOnZpc2libGUgLmMtbW9kYWwtYnV0dG9uOmNvbnRhaW5zKCdTZW5kJylcIik7XHJcblx0XHRcdFx0XHRcdGlmICgkYnV0dG9uLmxlbmd0aCA+IDApIHtcclxuXHRcdFx0XHRcdFx0XHQkYnV0dG9uLnRleHQoXCJTZW5kaW5nLi4uXCIpO1xyXG5cdFx0XHRcdFx0XHRcdCRidXR0b24uYWRkQ2xhc3MoXCJzZW5kaW5nXCIpLmRlbGF5KDE2MDApLnF1ZXVlKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0XHRcdCRidXR0b24uYWRkQ2xhc3MoXCJkb25lXCIpLmRlcXVldWUoKTtcclxuXHRcdFx0XHRcdFx0XHRcdCRidXR0b24udGV4dChcIlNlbmRcIikuZGVxdWV1ZSgpLmRlbGF5KDE2MDApLnF1ZXVlKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0JGJ1dHRvbi5yZW1vdmVDbGFzcygnc2VuZGluZycpLmRlcXVldWUoKS5kZWxheSgxMjAwKS5xdWV1ZShmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdFx0JGJ1dHRvbi5yZW1vdmVDbGFzcygnZG9uZScpLmRlcXVldWUoKTtcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRzaGFyZUVudHJ5RGlhbG9nLmNsb3NlKCk7XHJcblx0XHRcdFx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdFx0c2hhcmVFbnRyeURpYWxvZy5jbG9zZSgpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIE1hbmFnZSBEb2N1bWVudCBUZW1wbGF0ZXNcclxuXHRcdFx0bWFuYWdlVGVtcGxhdGVzOiBmdW5jdGlvbiBtYW5hZ2VUZW1wbGF0ZXMoKSB7XHJcblx0XHRcdFx0aWYgKENvZ25pdG8uY29uZmlnLmZsYWdzLk5ld0RvY3VtZW50VGVtcGxhdGVzRGlhbG9nKSB7XHJcblx0XHRcdFx0XHR2YXIgY3VycmVudEZvcm0gPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtO1xyXG5cclxuXHRcdFx0XHRcdFZ1ZUNvbXBvbmVudHMuTWFuYWdlRG9jdW1lbnRUZW1wbGF0ZXNEaWFsb2cub3BlbihcclxuXHRcdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHRcdHJhd0RvY3VtZW50VGVtcGxhdGVzOiBDb2duaXRvLnNlcmlhbGl6ZShjdXJyZW50Rm9ybS5nZXRfRG9jdW1lbnRUZW1wbGF0ZXMoKSksXHJcblx0XHRcdFx0XHRcdFx0Zm9ybVJvbGVzOiBDb2duaXRvLnNlcmlhbGl6ZShjdXJyZW50Rm9ybS5nZXRfUm9sZXMoKSksXHJcblx0XHRcdFx0XHRcdFx0dG9rZW5zTGlzdDogQ29nbml0by5Gb3Jtcy5nZW5lcmF0ZVRva2VucygpLFxyXG5cdFx0XHRcdFx0XHRcdGZvcm1OYW1lOiBjdXJyZW50Rm9ybS5nZXRfTmFtZSgpLFxyXG5cdFx0XHRcdFx0XHRcdGhhc1BhaWRQbGFuOiBDb2duaXRvLmNvbmZpZy5oYXNQYWlkUGxhbixcclxuXHRcdFx0XHRcdFx0XHRlbmNyeXB0RW50cmllczogY3VycmVudEZvcm0uZ2V0X0VuY3J5cHRFbnRyaWVzKCksXHJcblx0XHRcdFx0XHRcdFx0aXNQYXltZW50Rm9ybTogQ29nbml0by5Gb3Jtcy5tb2RlbC5pc1BheW1lbnRGb3JtLFxyXG5cdFx0XHRcdFx0XHRcdGlzTXVsdGlQYWdlRm9ybTogZm9ybURhdGEudmFsdWUuSXNNdWx0aVBhZ2VGb3JtLFxyXG5cdFx0XHRcdFx0XHRcdHRva2VuaXplSHRtbDogQ29nbml0by5Gb3Jtcy50b2tlbml6ZUh0bWwsXHJcblx0XHRcdFx0XHRcdFx0bG93ZXJPcmdhbml6YXRpb25Db2RlOiBDb2duaXRvLmNvbmZpZy5sb3dlck9yZ2FuaXphdGlvbkNvZGUsXHJcblx0XHRcdFx0XHRcdFx0Y3VycmVudEZvcm06IENvZ25pdG8uc2VyaWFsaXplKGN1cnJlbnRGb3JtKSxcclxuXHRcdFx0XHRcdFx0XHRpc0Zvcm1QZXJzaXN0ZWQ6IHRydWUsXHJcblx0XHRcdFx0XHRcdFx0Y3VzdG9tVGVtcGxhdGVMaW1pdDogQ29nbml0by5jb25maWcuY3VzdG9tVGVtcGxhdGVMaW1pdCxcclxuXHRcdFx0XHRcdFx0XHR0ZW1wbGF0ZUZlZTogQ29nbml0by5jb25maWcudGVtcGxhdGVGZWUsXHJcblx0XHRcdFx0XHRcdFx0dGllclRlbXBsYXRlRmVlOiBDb2duaXRvLmNvbmZpZy50aWVyVGVtcGxhdGVGZWUsXHJcblx0XHRcdFx0XHRcdFx0cGxhbk5hbWU6IENvZ25pdG8uY29uZmlnLnBsYW5OYW1lLFxyXG5cdFx0XHRcdFx0XHRcdHNhdmVEb2N1bWVudFRlbXBsYXRlczogZnVuY3Rpb24gKGRvY3VtZW50VGVtcGxhdGVzKSB7XHJcblx0XHRcdFx0XHRcdFx0XHR2YXIgZG9jdW1lbnRUZW1wbGF0ZXMgPSBDb2duaXRvLmRlc2VyaWFsaXplKENvZ25pdG8uRm9ybXMuRm9ybURvY3VtZW50VGVtcGxhdGUsIGRvY3VtZW50VGVtcGxhdGVzKTtcclxuXHRcdFx0XHRcdFx0XHRcdHZhciBmb3JtID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybTtcclxuXHJcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gQ29nbml0by5Gb3Jtcy5zYXZlRG9jdW1lbnRUZW1wbGF0ZXMoZm9ybSwgbnVsbCwgZG9jdW1lbnRUZW1wbGF0ZXMpO1xyXG5cdFx0XHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRcdFx0Z2VuZXJhdGVXb3JkVGVtcGxhdGU6IGZ1bmN0aW9uIChkb2N1bWVudFRlbXBsYXRlcywgZG9jVGVtcGxhdGVOdW1iZXIsIGFsbG93Q2FjaGluZykge1xyXG5cdFx0XHRcdFx0XHRcdFx0dmFyIGRvY3VtZW50VGVtcGxhdGVzID0gQ29nbml0by5kZXNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLkZvcm1Eb2N1bWVudFRlbXBsYXRlLCBkb2N1bWVudFRlbXBsYXRlcyk7XHJcblx0XHRcdFx0XHRcdFx0XHR2YXIgZm9ybSA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm07XHJcblxyXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIENvZ25pdG8uRm9ybXMuZ2VuZXJhdGVXb3JkVGVtcGxhdGUoZm9ybSwgZG9jdW1lbnRUZW1wbGF0ZXMsIGRvY1RlbXBsYXRlTnVtYmVyLCBhbGxvd0NhY2hpbmcpXHJcblx0XHRcdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdFx0XHR2YWxpZGF0ZVdvcmRUZW1wbGF0ZTogZnVuY3Rpb24gKGRvY3VtZW50VGVtcGxhdGVzLCBmaWxlcykge1xyXG5cdFx0XHRcdFx0XHRcdFx0Ly8gd2Ugb25seSBwYXNzIG51bGwgZm9yIGZpbGVzIGlmIHdlJ3JlIGRvaW5nIGluaXRpYWxpemF0aW9uIHZhbGlkYXRpb25cclxuXHRcdFx0XHRcdFx0XHRcdGlmICghZG9jdW1lbnRUZW1wbGF0ZXMgJiYgIWZpbGVzKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdGZvcm0gPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9JZCgpO1xyXG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBjcmVhdGUgYSBwYXlsb2FkIHRvIGJhdGNoIHZhbGlkYXRlIGRvY3VtZW50IHRlbXBsYXRlc1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRmaWxlcyA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0uZ2V0X0RvY3VtZW50VGVtcGxhdGVzKCkuZmlsdGVyKGZ1bmN0aW9uIChkKSB7IHJldHVybiBkLmdldF9GaWxlKCkgIT09IG51bGw7IH0pLm1hcChmdW5jdGlvbiAoZCkgeyByZXR1cm4gKHsgRmlsZUlkOiBkLmdldF9GaWxlKCkuZ2V0X0lkKCkgfSk7IH0pO1xyXG5cdFx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdHZhciBkb2N1bWVudFRlbXBsYXRlcyA9IENvZ25pdG8uZGVzZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5Gb3JtRG9jdW1lbnRUZW1wbGF0ZSwgZG9jdW1lbnRUZW1wbGF0ZXMpO1xyXG5cdFx0XHRcdFx0XHRcdFx0XHR2YXIgZm9ybSA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm07XHJcblx0XHRcdFx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIENvZ25pdG8uRm9ybXMudmFsaWRhdGVXb3JkVGVtcGxhdGUoZm9ybSwgZG9jdW1lbnRUZW1wbGF0ZXMsIGZpbGVzKTtcclxuXHRcdFx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0XHRcdGFubm90YXRlV29yZFRlbXBsYXRlOiBmdW5jdGlvbiAoZG9jdW1lbnRUZW1wbGF0ZXMsIGRvY1RlbXBsYXRlTnVtYmVyKSB7XHJcblx0XHRcdFx0XHRcdFx0XHR2YXIgZG9jdW1lbnRUZW1wbGF0ZXMgPSBDb2duaXRvLmRlc2VyaWFsaXplKENvZ25pdG8uRm9ybXMuRm9ybURvY3VtZW50VGVtcGxhdGUsIGRvY3VtZW50VGVtcGxhdGVzKTtcclxuXHRcdFx0XHRcdFx0XHRcdHZhciBmb3JtID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybTtcclxuXHJcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gQ29nbml0by5Gb3Jtcy5hbm5vdGF0ZVdvcmRUZW1wbGF0ZShmb3JtLCBkb2N1bWVudFRlbXBsYXRlcywgZG9jVGVtcGxhdGVOdW1iZXIpXHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0XHRbXHJcblx0XHRcdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHRcdFx0ZXZlbnROYW1lOiBcInRlbXBsYXRlcy11cGRhdGVkXCIsXHJcblx0XHRcdFx0XHRcdFx0XHRldmVudEhhbmRsZXI6IGZ1bmN0aW9uIChkb2N1bWVudFRlbXBsYXRlcywgdmVyc2lvbikge1xyXG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBOZWVkIHRvIHNldCB0aGlzIHNvIHRoYXQgd2UgY2FuIG1ha2Ugc3Vic2VxdWVudCBjaGFuZ2VzIHRvIHRoZSBmb3JtIGFmdGVyIHNhdmluZyBvbmNlXHJcblx0XHRcdFx0XHRcdFx0XHRcdC8vIFNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHN1Y2Nlc3NmdWwgdGVtcGxhdGUgdXBkYXRlXHJcblx0XHRcdFx0XHRcdFx0XHRcdGN1cnJlbnRGb3JtLnNldF9WZXJzaW9uKHZlcnNpb24pO1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLnRlbXBsYXRlc1VwZGF0ZWQoQ29nbml0by5kZXNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLkZvcm1Eb2N1bWVudFRlbXBsYXRlLCBkb2N1bWVudFRlbXBsYXRlcykpO1xyXG5cdFx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0XVxyXG5cdFx0XHRcdFx0KTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1hbmFnZURvY3VtZW50VGVtcGxhdGVzKHtcclxuXHRcdFx0XHRcdFx0YXV0b1NhdmU6IHRydWUsXHJcblx0XHRcdFx0XHRcdHVzZVBlcnNpc3RlZERhdGE6IHRydWUsXHJcblx0XHRcdFx0XHRcdGhhc0V4dGVybmFsQ2hhbmdlczogZW50cnlIYXNDaGFuZ2VzXHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBFeHBvc2VzIGRvY3VtZW50IHRlbXBsYXRlcyBzYXZlIHVzZWQgYnkgdGhlIHNoYXJlIGVudHJ5IHBhZ2UvZGlhbG9nXHJcblx0XHRcdHNhdmVUZW1wbGF0ZXM6IGZ1bmN0aW9uIHNhdmVUZW1wbGF0ZXMoKSB7XHJcblx0XHRcdFx0Y29udHJvbGxlci5kb2N1bWVudFRlbXBsYXRlcy5zYXZlKCk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHQvLyBEb2N1bWVudCBUZW1wbGF0ZXMgVXBkYXRlZFxyXG5cdFx0XHR0ZW1wbGF0ZXNVcGRhdGVkOiBmdW5jdGlvbiB0ZW1wbGF0ZXNVcGRhdGVkKHRlbXBsYXRlcykge1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnRlbXBsYXRlc1VwZGF0ZWQodGVtcGxhdGVzKTtcclxuXHJcblx0XHRcdFx0Ly8gVXBkYXRlIHRoZSBsaXN0IG9mIHRlbXBsYXRlcyB0byByZWZsZWN0IGNoYW5nZXNcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLnNldF9Eb2N1bWVudFRlbXBsYXRlcyh0ZW1wbGF0ZXMpO1xyXG5cclxuXHRcdFx0XHRpZiAoY29udHJvbGxlci5zaGFyZUVudHJ5RGlhbG9nKVxyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5zaGFyZUVudHJ5RGlhbG9nLnRlbXBsYXRlc1VwZGF0ZWQodGVtcGxhdGVzKTtcclxuXHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5jbG9zZVRlbXBsYXRlc0RpYWxvZygpO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0c2F2ZVBhbmVsV2lkdGg6IGZ1bmN0aW9uIHNhdmVQYW5lbFdpZHRoKHdpZHRoKSB7XHJcblx0XHRcdFx0Q29nbml0by5jb25maWcuZW50cnlQYWdlU2V0dGluZ3MuRW50cnlQYW5lbFdpZHRoID0gd2lkdGg7XHJcblx0XHRcdFx0Q29nbml0by5zZXJ2aWNlUmVxdWVzdCh7XHJcblx0XHRcdFx0XHRtZXRob2Q6IFwiUFVUXCIsXHJcblx0XHRcdFx0XHRlbmRwb2ludDogXCIvZm9ybXMvYWRtaW4vXCIgKyBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLm1ldGEuaWQgKyBcIi9lbnRyeS1wYW5lbC13aWR0aC9cIiArIHdpZHRoLFxyXG5cdFx0XHRcdFx0c3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHRcdFx0Ly8gRW1haWwgTm90aWZpY2F0aW9uXHJcblx0XHRcdG9wZW5FbWFpbE5vdGlmaWNhdGlvbkRpYWxvZzogZnVuY3Rpb24gb3BlbkVtYWlsTm90aWZpY2F0aW9uRGlhbG9nKGVudHJ5S2V5LCBkb2N1bWVudFRlbXBsYXRlcywgYXZhaWxhYmxlUm9sZXMpIHtcclxuXHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuaGFzUGFpZFBsYW4pIHtcclxuXHRcdFx0XHRcdHZhciByb2xlc09iamVjdCA9IHtcclxuXHRcdFx0XHRcdFx0cm9sZXM6IGF2YWlsYWJsZVJvbGVzLFxyXG5cdFx0XHRcdFx0XHRzaG93VXBzZWxsOiBmYWxzZSxcclxuXHRcdFx0XHRcdFx0aXNMaW1pdGVkV29ya2Zsb3dQcm86IENvZ25pdG8uY29uZmlnLmlzTGltaXRlZFdvcmtmbG93UHJvLFxyXG5cdFx0XHRcdFx0XHRvcGVuV29ya2Zsb3dVcHNlbGw6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGNvbnRyb2xsZXIuc2hvd0ZlYXR1cmVXYXJuaW5nKCd3b3JrZmxvd2xpbmtzJyk7IH1cclxuXHRcdFx0XHRcdH07XHJcblxyXG5cdFx0XHRcdFx0dmFyIHRoZW1lU2V0dGluZ3MgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9UaGVtZVNldHRpbmdzKCk7XHJcblx0XHRcdFx0XHR2YXIgZm9ybUhhc0xvZ28gPSB0aGVtZVNldHRpbmdzICYmICEhdGhlbWVTZXR0aW5ncy5nZXRfTG9nbygpO1xyXG5cclxuXHRcdFx0XHRcdFZ1ZUNvbXBvbmVudHMuU2VuZEVtYWlsRGlhbG9nLm9wZW4oe1xyXG5cdFx0XHRcdFx0XHRlbnRyeUlkOiBlbnRyeUtleS5FbnRyeUlkLFxyXG5cdFx0XHRcdFx0XHRkb2N1bWVudFRlbXBsYXRlczogZG9jdW1lbnRUZW1wbGF0ZXMsXHJcblx0XHRcdFx0XHRcdHJvbGVzU2VsZWN0OiByb2xlc09iamVjdCxcclxuXHRcdFx0XHRcdFx0ZW5hYmxlRW50cnlTaGFyaW5nOiBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9FbmFibGVFbnRyeVNoYXJpbmcoKSxcclxuXHRcdFx0XHRcdFx0aXNQYXltZW50Rm9ybTogQ29nbml0by5Gb3Jtcy5tb2RlbC5pc1BheW1lbnRGb3JtLFxyXG5cdFx0XHRcdFx0XHRmb3JtSGFzTG9nbzogZm9ybUhhc0xvZ28sXHJcblx0XHRcdFx0XHRcdGRlZmF1bHRXb3JrZmxvd0xpbmtCdXR0b250ZXh0OiBDb2duaXRvLmNvbmZpZy5kZWZhdWx0V29ya2Zsb3dMaW5rQnV0dG9uVGV4dFxyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuc2hvd0ZlYXR1cmVXYXJuaW5nKFwiZW50cnlzaGFyaW5nXCIpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdC8vIEZlYXR1cmUgTm90IEF2YWlsYWJsZVxyXG5cdFx0XHRzaG93RmVhdHVyZVdhcm5pbmc6IGZ1bmN0aW9uIHNob3dGZWF0dXJlV2FybmluZyhmZWF0dXJlKSB7XHJcblx0XHRcdFx0aWYgKHR5cGVvZiBmZWF0dXJlID09PSAnc3RyaW5nJykge1xyXG5cdFx0XHRcdFx0VnVlQ29tcG9uZW50cy5VcHNlbGxEaWFsb2cub3Blbih7IGZlYXR1cmU6IGZlYXR1cmUsIGlzT3JnT3duZXI6IENvZ25pdG8uY29uZmlnLnJvbGUgPT09ICdPd25lcicsIG9yZ0NvZGU6IENvZ25pdG8uY29uZmlnLm9yZ2FuaXphdGlvbkNvZGUgfSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdFZ1ZUNvbXBvbmVudHMuVXBzZWxsRGlhbG9nLm9wZW4oeyBmZWF0dXJlOiBmZWF0dXJlLmZlYXR1cmVOYW1lLCBpc09yZ093bmVyOiBmZWF0dXJlLmlzT3JnT3duZXIsIG9yZ0NvZGU6IENvZ25pdG8uY29uZmlnLm9yZ2FuaXphdGlvbkNvZGUgfSk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHRvcGVuVmlld0VtYWlsRGlhbG9nOiBmdW5jdGlvbiBvcGVuVmlld0VtYWlsRGlhbG9nKGRhdGEpIHtcclxuXHRcdFx0XHRWdWVDb21wb25lbnRzLlZpZXdFbWFpbERpYWxvZy5vcGVuKHtcclxuXHRcdFx0XHRcdG91dGNvbWU6IGRhdGFcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHJcblx0XHRcdG9wZW5WaWV3SW50ZWdyYXRpb25EaWFsb2c6IGZ1bmN0aW9uIG9wZW5WaWV3SW50ZWdyYXRpb25EaWFsb2coZGF0YSkge1xyXG5cdFx0XHRcdFZ1ZUNvbXBvbmVudHMuVmlld0ludGVncmF0aW9uRGlhbG9nLm9wZW4oe1xyXG5cdFx0XHRcdFx0b3V0Y29tZTogZGF0YVxyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0b3BlblZpZXdHb29nbGVBbmFseXRpY3NEaWFsb2c6IGZ1bmN0aW9uIG9wZW5WaWV3R29vZ2xlQW5hbHl0aWNzRGlhbG9nKGRhdGEpIHtcclxuXHRcdFx0XHRWdWVDb21wb25lbnRzLlZpZXdHb29nbGVBbmFseXRpY3NEaWFsb2cub3Blbih7XHJcblx0XHRcdFx0XHRvdXRjb21lOiBkYXRhXHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH0sXHJcblxyXG5cdFx0XHRvcGVuVmlld0VudHJ5Q2hhbmdlRGlhbG9nOiBmdW5jdGlvbiBvcGVuVmlld0VudHJ5Q2hhbmdlRGlhbG9nKGRhdGEpIHtcclxuXHRcdFx0XHRWdWVDb21wb25lbnRzLlZpZXdFbnRyeUNoYW5nZURpYWxvZy5vcGVuKHtcclxuXHRcdFx0XHRcdHNob3c6IGRhdGEuc2hvdyxcclxuXHRcdFx0XHRcdHRpdGxlOiBkYXRhLnRpdGxlLFxyXG5cdFx0XHRcdFx0ZW50cnlJZDogZGF0YS5lbnRyeUlkLFxyXG5cdFx0XHRcdFx0ZW50cnlDaGFuZ2VJZDogZGF0YS5lbnRyeUNoYW5nZUlkLFxyXG5cdFx0XHRcdFx0Y29uZGVuc2VkUmVjb3JkRW50cnlDaGFuZ2VJZDogZGF0YS5jb25kZW5zZWRSZWNvcmRFbnRyeUNoYW5nZUlkLFxyXG5cdFx0XHRcdFx0ZW50cnlDaGFuZ2VDb3VudDogZGF0YS5lbnRyeUNoYW5nZUNvdW50LFxyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9LFxyXG5cclxuXHRcdFx0b3BlbkVudHJ5Vmlld1NldHRpbmdzOiBmdW5jdGlvbiBvcGVuRW50cnlWaWV3U2V0dGluZ3ModmlldywgaXNOZXcpIHtcclxuXHJcblx0XHRcdFx0Ly8gRGVsZXRlIFZpZXdcclxuXHRcdFx0XHR2YXIgb25EZWxldGVWaWV3ID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0ZXhlY3V0ZUFjdGlvbihmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuZGVsZXRlVmlldygpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHQvLyBTYXZlIFZpZXdcclxuXHRcdFx0XHR2YXIgb25TYXZlVmlldyA9IGZ1bmN0aW9uICh2aWV3KSB7XHJcblx0XHRcdFx0XHRleGVjdXRlQWN0aW9uKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0dmlldy5pc1VzZXJTcGVjaWZpYyA9ICEhdmlldy5TaGFyZWRXaXRoTWU7XHJcblxyXG5cdFx0XHRcdFx0XHQvLyBFeGlzdGluZyBWaWV3XHJcblx0XHRcdFx0XHRcdGlmICh2aWV3LklkKVxyXG5cdFx0XHRcdFx0XHRcdHZpZXcgPSBDb2duaXRvLmRlc2VyaWFsaXplKENvZ25pdG8uRm9ybXMuRW50cnlWaWV3LCB2aWV3LCBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3KTtcclxuXHRcdFx0XHRcdFx0Ly8gTmV3IFZpZXdcclxuXHRcdFx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0XHRcdHZpZXcgPSBDb2duaXRvLmRlc2VyaWFsaXplKENvZ25pdG8uRm9ybXMuRW50cnlWaWV3LCB2aWV3KTtcclxuXHJcblx0XHRcdFx0XHRcdC8vIFNhdmUgdGhlIHZpZXdcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5zYXZlVmlldyh2aWV3KTtcclxuXHRcdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5yZWZyZXNoVmlld3MoKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0dmFyIG9uU2hvd1Vwc2VsbCA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLnNob3dGZWF0dXJlV2FybmluZyhcInRhc2tzXCIpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHR2YXIgaXNMYXN0R3JpZFZpZXcgPSBDb2duaXRvLkZvcm1zLm1vZGVsLnZpZXdzLmZpbHRlcihmdW5jdGlvbiAodikge1xyXG5cdFx0XHRcdFx0cmV0dXJuIHYuVHlwZSA9PT0gJ1RhYmxlJztcclxuXHRcdFx0XHR9KS5sZW5ndGggPT09IDEgJiYgdmlldy5UeXBlID09PSAnVGFibGUnO1xyXG5cclxuXHRcdFx0XHQvLyBPcGVuIEVudHJ5IFZpZXcgU2V0dGluZ3MgRGlhbG9nXHJcblx0XHRcdFx0VnVlQ29tcG9uZW50cy5FbnRyeVZpZXdTZXR0aW5nc0RpYWxvZy5vcGVuKFxyXG5cdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHR2aWV3OiB2aWV3LFxyXG5cdFx0XHRcdFx0XHRyb2xlczogZm9ybURhdGEudmFsdWUuUm9sZXMsXHJcblx0XHRcdFx0XHRcdGVudHJ5Vmlld3M6IENvZ25pdG8uRm9ybXMubW9kZWwudmlld3MsXHJcblx0XHRcdFx0XHRcdGNhbkRlbGV0ZTogIWlzTGFzdEdyaWRWaWV3LFxyXG5cdFx0XHRcdFx0XHRjYW5Db3B5OiBDb2duaXRvLkZvcm1zLm1vZGVsLnZpZXdzLmxlbmd0aCA8IENvZ25pdG8uY29uZmlnLmVudHJ5Vmlld0xpbWl0LFxyXG5cdFx0XHRcdFx0XHRpc011bHRpUGFnZUZvcm06IGZvcm1EYXRhLnZhbHVlLklzTXVsdGlQYWdlRm9ybSxcclxuXHRcdFx0XHRcdFx0c2hvd1Rhc2tzOiBDb2duaXRvLkZvcm1zLm1vZGVsLnNob3dXb3JrZmxvd1Rhc2tzLFxyXG5cdFx0XHRcdFx0XHRpc09yZ093bmVyOiBDb2duaXRvLmNvbmZpZy5yb2xlID09PSAnT3duZXInLFxyXG5cdFx0XHRcdFx0XHRvcmdDb2RlOiBDb2duaXRvLmNvbmZpZy5vcmdhbml6YXRpb25Db2RlLFxyXG5cdFx0XHRcdFx0XHRlbWFpbFJvbGVBc3NpZ25tZW50czogZm9ybURhdGEudmFsdWUuRW1haWxSb2xlQXNzaWdubWVudHMsXHJcblx0XHRcdFx0XHRcdHdvcmtmbG93TGlua3NFbmFibGVkOiBmb3JtRGF0YS52YWx1ZS5Xb3JrZmxvd0xpbmtzRW5hYmxlZCxcclxuXHRcdFx0XHRcdFx0aXNUYXNrRGFzaGJvYXJkRW5hYmxlZDogQ29nbml0by5jb25maWcuZmxhZ3MuVGFza0Rhc2hib2FyZCxcclxuXHRcdFx0XHRcdFx0aXNBcHBOYXZFbmFibGVkOiBDb2duaXRvLmNvbmZpZy5mbGFncy5BcHBOYXYsXHJcblx0XHRcdFx0XHRcdGRhdGVGaWVsZEluZm9zOiBDb2duaXRvLkZvcm1zLm1vZGVsLmZpZWxkSW5mb3MuZmlsdGVyKGZpZWxkSW5mbyA9PiBmaWVsZEluZm8uRmllbGRTdWJUeXBlID09PSAnRGF0ZScpLFxyXG5cdFx0XHRcdFx0XHRjdWx0dXJlOiB3aW5kb3cuU3lzLkN1bHR1cmVJbmZvLkN1cnJlbnRDdWx0dXJlXHJcblx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0W1xyXG5cdFx0XHRcdFx0XHR7XHJcblx0XHRcdFx0XHRcdFx0ZXZlbnROYW1lOiBcImRlbGV0ZS12aWV3XCIsXHJcblx0XHRcdFx0XHRcdFx0ZXZlbnRIYW5kbGVyOiBvbkRlbGV0ZVZpZXdcclxuXHRcdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHRcdGV2ZW50TmFtZTogXCJzYXZlLXZpZXdcIixcclxuXHRcdFx0XHRcdFx0XHRldmVudEhhbmRsZXI6IG9uU2F2ZVZpZXdcclxuXHRcdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHRcdGV2ZW50TmFtZTogXCJzaG93LXRhc2tzLXVwc2VsbFwiLFxyXG5cdFx0XHRcdFx0XHRcdGV2ZW50SGFuZGxlcjogb25TaG93VXBzZWxsXHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdF1cclxuXHRcdFx0XHQpO1xyXG5cdFx0XHR9XHJcblx0XHR9O1xyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcblx0XHRDb2duaXRvLnJlYWR5KFwiQ29nbml0by5Gb3Jtcy5jb250cm9sbGVyXCIpO1xyXG5cclxuXHRcdGlmICgkKFwiI2MtZW50cnlsaXN0XCIpLmxlbmd0aCkge1xyXG5cdFx0XHRDb2duaXRvLk1lc3NhZ2luZy50cmlnZ2VyKFwiY29udHJvbGxlclJlYWR5XCIsIHsgdGFyZ2V0OiAkKFwiI2MtZW50cnlsaXN0XCIpLmdldCgwKS5jb250ZW50V2luZG93IH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICgkKFwiI2MtZW50cnlkZXRhaWxzXCIpLmxlbmd0aCkge1xyXG5cdFx0XHRDb2duaXRvLk1lc3NhZ2luZy50cmlnZ2VyKFwiY29udHJvbGxlclJlYWR5XCIsIHsgdGFyZ2V0OiAkKFwiI2MtZW50cnlkZXRhaWxzXCIpLmdldCgwKS5jb250ZW50V2luZG93IH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdC8vI2VuZHJlZ2lvblxyXG5cclxuXHRcdC8vI3JlZ2lvbiBEaWFsb2dzXHJcblxyXG5cdFx0Ly8gVW5zYXZlZCBDaGFuZ2VzXHJcblxyXG5cdFx0Q29nbml0by5vbk5hdmlnYXRlKHtcclxuXHRcdFx0dGl0bGU6IFwiVW5zYXZlZCBDaGFuZ2VzXCIsXHJcblx0XHRcdHRleHQ6IFwiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRpc2NhcmQgeW91ciBjaGFuZ2VzP1wiLFxyXG5cdFx0XHRvcGVuOiBmdW5jdGlvbiAoKSB7IHJldHVybiBlbnRyeUhhc0NoYW5nZXM7IH0sXHJcblx0XHRcdGJ1dHRvbnM6IFtcclxuXHRcdFx0XHR7XHJcblx0XHRcdFx0XHRsYWJlbDogXCJEaXNjYXJkIENoYW5nZXNcIixcclxuXHRcdFx0XHRcdGlzQ2FuY2VsOiB0cnVlLFxyXG5cdFx0XHRcdFx0Y2xpY2s6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0dGhpcy5jbG9zZSgpO1xyXG5cdFx0XHRcdFx0XHRwZW5kaW5nQWN0aW9uID0gcGVuZGluZ0FjdGlvbiB8fCB0aGlzLmNvbnRpbnVlO1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmRpc2NhcmRDaGFuZ2VzKGN1cnJlbnRFbnRyeUtleSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHR7XHJcblx0XHRcdFx0XHRsYWJlbDogXCJLZWVwIEVkaXRpbmdcIixcclxuXHRcdFx0XHRcdGNsaWNrOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdHRoaXMuY2xvc2UoKTtcclxuXHJcblx0XHRcdFx0XHRcdC8vIFJlc2V0IEZsYWdzXHJcblx0XHRcdFx0XHRcdHBlbmRpbmdBY3Rpb24gPSBudWxsO1xyXG5cdFx0XHRcdFx0XHRpZiAoY3VycmVudEVudHJ5S2V5KSB7XHJcblx0XHRcdFx0XHRcdFx0Ly8gRW5zdXJlIHRoZSBjdXJyZW50IGVudHJ5IGlzIHNlbGVjdGVkLiBUaGUgZGlhbG9nIG1heSBoYXZlIGJlZW4gZGlzcGxheWVkIGFzIGEgcmVzdWx0IG9mIHNlbGVjdGluZyBhbm90aGVyIGVudHJ5LlxyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnZpZXdFbnRyeShjdXJyZW50RW50cnlLZXksIENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCkpO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XSxcclxuXHRcdFx0Y2FuY2VsOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0aWYgKCF3aW5kb3cuQ29nbml0bylcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHJcblx0XHRcdFx0Ly8gUmVzZXQgRmxhZ3NcclxuXHRcdFx0XHRwZW5kaW5nQWN0aW9uID0gbnVsbDtcclxuXHRcdFx0XHRpZiAoY3VycmVudEVudHJ5S2V5KSB7XHJcblx0XHRcdFx0XHQvLyBFbnN1cmUgdGhlIGN1cnJlbnQgZW50cnkgaXMgc2VsZWN0ZWQuIFRoZSBkaWFsb2cgbWF5IGhhdmUgYmVlbiBkaXNwbGF5ZWQgYXMgYSByZXN1bHQgb2Ygc2VsZWN0aW5nIGFub3RoZXIgZW50cnkuXHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci52aWV3RW50cnkoY3VycmVudEVudHJ5S2V5LCBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Ub2tlbigpKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cclxuXHRcdC8vIERlbGV0ZSBFbnRyeVxyXG5cdFx0dmFyIGRlbGV0ZUVudHJ5RGlhbG9nID0gJC5mbi5kaWFsb2coe1xyXG5cdFx0XHR0aXRsZTogXCJEZWxldGUgRW50cnk/XCIsXHJcblx0XHRcdHRleHQ6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHR2YXIgZW50cmllc1RvRGVsZXRlID0gZGVsZXRlRW50cnlEaWFsb2cuZW50cmllcztcclxuXHRcdFx0XHR2YXIgaGFzT3JkZXJzID0gZmFsc2U7XHJcblx0XHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBlbnRyaWVzVG9EZWxldGUubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHRcdGlmIChlbnRyaWVzVG9EZWxldGVbaV0uT3JkZXJJZCkge1xyXG5cdFx0XHRcdFx0XHRoYXNPcmRlcnMgPSB0cnVlO1xyXG5cdFx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0dmFyIHJlZmVyZW5jZU1lc3NhZ2UgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmlzTG9va3VwU291cmNlIHx8IENvZ25pdG8uRm9ybXMubW9kZWwuaXNQZW9wbGVTb3VyY2UgPyBcIiBcIiArIChlbnRyaWVzVG9EZWxldGUubGVuZ3RoID4gMSA/IFwiVGhleVwiIDogXCJJdFwiKSArIFwiIG1heSBiZSByZWZlcmVuY2VkIGJ5IFwiIDogXCJcIjtcclxuXHRcdFx0XHRpZiAoQ29nbml0by5Gb3Jtcy5tb2RlbC5pc0xvb2t1cFNvdXJjZSAmJiBDb2duaXRvLkZvcm1zLm1vZGVsLmlzUGVvcGxlU291cmNlKVxyXG5cdFx0XHRcdFx0cmVmZXJlbmNlTWVzc2FnZSArPSBcIkxvb2t1cCBvciBQZXJzb24gZmllbGRzIG9uIG90aGVyIGZvcm1zLlwiO1xyXG5cdFx0XHRcdGVsc2UgaWYgKENvZ25pdG8uRm9ybXMubW9kZWwuaXNMb29rdXBTb3VyY2UpXHJcblx0XHRcdFx0XHRyZWZlcmVuY2VNZXNzYWdlICs9IFwiTG9va3VwIGZpZWxkcyBvbiBvdGhlciBmb3Jtcy5cIjtcclxuXHRcdFx0XHRlbHNlIGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmlzUGVvcGxlU291cmNlKVxyXG5cdFx0XHRcdFx0cmVmZXJlbmNlTWVzc2FnZSArPSBcIlBlcnNvbiBmaWVsZHMgb24gb3RoZXIgZm9ybXMuXCI7XHJcblx0XHRcdFx0cmV0dXJuIFwiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHBlcm1hbmVudGx5IGRlbGV0ZSA8c3Ryb25nPlwiICsgKGVudHJpZXNUb0RlbGV0ZS5sZW5ndGggPiAxID8gZW50cmllc1RvRGVsZXRlLmxlbmd0aCArIFwiIGVudHJpZXNcIiA6IFwidGhpcyBlbnRyeVwiKSArIFwiPC9zdHJvbmc+P1wiICsgcmVmZXJlbmNlTWVzc2FnZSArIFwiPGJyPjxicj5UaGlzIGFjdGlvbiBjYW5ub3QgYmUgdW5kb25lLlwiO1xyXG5cdFx0XHR9LFxyXG5cdFx0XHRoZWlnaHQ6IDIyMCxcclxuXHRcdFx0d2lkdGg6IDQ1MCxcclxuXHRcdFx0YnV0dG9uczogW1xyXG5cdFx0XHRcdHtcclxuXHRcdFx0XHRcdGxhYmVsOiBcIkNhbmNlbFwiLFxyXG5cdFx0XHRcdFx0aXNDYW5jZWw6IHRydWVcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdHtcclxuXHRcdFx0XHRcdGxhYmVsOiBcIkRlbGV0ZVwiLFxyXG5cdFx0XHRcdFx0YXV0b0Nsb3NlOiBmYWxzZSxcclxuXHRcdFx0XHRcdGNsaWNrOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdC8vIERpc2FibGUgdGhlIGRlbGV0ZSBidXR0b24gdW50aWwgdGhlIGRlbGV0ZSBoYXMgY29tcGxldGVkIHRvIHByZXZlbnQgdGhlIGRpYWxvZyBmcm9tIGJlaW5nIHJlb3BlblxyXG5cdFx0XHRcdFx0XHQkKFwiLmMtZGVsZXRlLWJ1dHRvblwiKS5wcm9wKFwiZGlzYWJsZWRcIiwgdHJ1ZSk7XHJcblxyXG5cdFx0XHRcdFx0XHQvLyBTaG93IHRoZSBkZWxldGUgcHJvZ3Jlc3MgbWVzc2FnZVxyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci51cGRhdGVQcm9ncmVzc01lc3NhZ2UoXCJEZWxldGluZy4uLlwiKTtcclxuXHJcblx0XHRcdFx0XHRcdC8vIEhpZGUgZW50cnkgZGV0YWlscyBpZiB0aGUgZW50cnkgaXMgYmVpbmcgZGVsZXRlZFxyXG5cdFx0XHRcdFx0XHRpZiAoY3VycmVudEVudHJ5S2V5KSB7XHJcblx0XHRcdFx0XHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGVFbnRyeURpYWxvZy5lbnRyaWVzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0XHRcdFx0XHR2YXIgZW50cnlLZXkgPSBkZWxldGVFbnRyeURpYWxvZy5lbnRyaWVzW2ldO1xyXG5cdFx0XHRcdFx0XHRcdFx0aWYgKGVudHJ5S2V5LkVudHJ5SWQgPT0gY3VycmVudEVudHJ5S2V5LkVudHJ5SWQpIHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5kaXNjYXJkQ2hhbmdlcyhjdXJyZW50RW50cnlLZXkpO1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLmhpZGVFbnRyeSgpO1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRcdC8vIERlbGV0ZSB0aGUgc3BlY2lmaWVkIGVudHJpZXMgYW5kIHJlZnJlc2ggdGhlIGdyaWRcclxuXHRcdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5kZWxldGVFbnRyaWVzKHsgRW50cmllczogZGVsZXRlRW50cnlEaWFsb2cuZW50cmllcywgVG9rZW46IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCkgfSxcclxuXHRcdFx0XHRcdFx0XHRmdW5jdGlvbiAoZGF0YSkge1xyXG5cdFx0XHRcdFx0XHRcdFx0aWYgKCFDb2duaXRvLmNvbmZpZy5mbGFncy5BcHBOYXYpIHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKGRlbGV0ZUVudHJ5RGlhbG9nLmVudHJpZXMubGVuZ3RoID09PSAxICYmIENvZ25pdG8uY29uZmlnLmZsYWdzLlVzZUNvc21vc0luZGV4ZXMpXHJcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIucG9sbEVudHJ5Q2hhbmdlcyhkZWxldGVFbnRyeURpYWxvZy5lbnRyaWVzWzBdKTtcclxuXHRcdFx0XHRcdFx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnJlZnJlc2hFbnRyaWVzKCk7XHJcblx0XHRcdFx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0XHRcdFx0JChcIi5jLWRlbGV0ZS1idXR0b25cIikucHJvcChcImRpc2FibGVkXCIsIGZhbHNlKTtcclxuXHRcdFx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0XHRcdGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0XHRcdCQoXCIuYy1kZWxldGUtYnV0dG9uXCIpLnByb3AoXCJkaXNhYmxlZFwiLCBmYWxzZSk7XHJcblx0XHRcdFx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHRcdFx0XHR0aGlzLmNsb3NlKCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRdXHJcblx0XHR9KTtcclxuXHJcblx0XHQvLyBDaGFuZ2UgU3RhdHVzXHJcblx0XHRmdW5jdGlvbiBjaGFuZ2VTdGF0dXMoZW50cmllcywgc3RhdHVzTmFtZSwgdHJpZ2dlckVudHJ5Tm90aWZpY2F0aW9ucywgaW5jb21wbGV0ZUVudHJpZXMsIHN0YXR1c0lkKSB7XHJcblxyXG5cdFx0XHQvLyBTaG93IHByb2dyZXNzIG1lc3NhZ2Ugd2hlbiBidWxrIGNoYW5naW5nIGVudHJpZXNcclxuXHRcdFx0aWYgKGVudHJpZXMubGVuZ3RoID4gMSlcclxuXHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci51cGRhdGVQcm9ncmVzc01lc3NhZ2UoXCJDaGFuZ2luZyBTdGF0dXMuLi5cIik7XHJcblxyXG5cdFx0XHQvLyBDaGFuZ2UgdGhlIHN0YXR1cyBhbmQgcmVmcmVzaCB0aGUgbWFzdGVyIGFuZCBkZXRhaWwgdmlld3NcclxuXHRcdFx0Q29nbml0by5Gb3Jtcy51cGRhdGVFbnRyeVN0YXR1cyh7IEVudHJpZXM6IGVudHJpZXMsIFRva2VuOiBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Ub2tlbigpIH0sIHN0YXR1c0lkIHx8IHN0YXR1c05hbWUsIHRyaWdnZXJFbnRyeU5vdGlmaWNhdGlvbnMgIT0gZmFsc2UsICEhaW5jb21wbGV0ZUVudHJpZXMsXHJcblx0XHRcdFx0ZnVuY3Rpb24gKGRhdGEpIHtcclxuXHRcdFx0XHRcdHZhciBmYWlsZWRVcGRhdGVzID0gZGF0YS5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5S2V5KSB7IHJldHVybiBlbnRyeUtleS5TdGF0dXMgIT09IFwiU3VjY2Vzc1wiOyB9KTtcclxuXHRcdFx0XHRcdGlmIChmYWlsZWRVcGRhdGVzLmxlbmd0aCkge1xyXG5cdFx0XHRcdFx0XHRzdGF0dXNVcGRhdGVzRmFpbGVkRGlhbG9nLmNvdW50ID0gZmFpbGVkVXBkYXRlcy5sZW5ndGg7XHJcblx0XHRcdFx0XHRcdHN0YXR1c1VwZGF0ZXNGYWlsZWREaWFsb2cub3BlbigpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0aWYgKGN1cnJlbnRFbnRyeUtleSAmJiAhZW50cnlIYXNDaGFuZ2VzICYmIGVudHJpZXMuc29tZShmdW5jdGlvbiAoZW50cnkpIHsgcmV0dXJuIGVudHJ5LkVudHJ5SWQgPT09IGN1cnJlbnRFbnRyeUtleS5FbnRyeUlkIH0pICYmIGZhaWxlZFVwZGF0ZXMuZXZlcnkoZnVuY3Rpb24gKGVudHJ5S2V5KSB7IHJldHVybiBlbnRyeUtleS5FbnRyeUlkICE9IGN1cnJlbnRFbnRyeUtleS5FbnRyeUlkIH0pKSB7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnNldFN0YXR1cyhzdGF0dXNOYW1lKTtcclxuXHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRpZiAoIUNvZ25pdG8uY29uZmlnLmZsYWdzLkFwcE5hdikge1xyXG5cdFx0XHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuZmxhZ3MuVXNlQ29zbW9zSW5kZXhlcyAmJiBkYXRhLmxlbmd0aCA9PT0gMSlcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5wb2xsRW50cnlDaGFuZ2VzKGRhdGFbMF0pO1xyXG5cdFx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIucmVmcmVzaEVudHJpZXMoKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci51cGRhdGVQcm9ncmVzc01lc3NhZ2UoKTtcclxuXHRcdFx0XHRcdHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0Y2hhbmdlU3RhdHVzRGlhbG9nLmVudHJpZXMgPSBlbnRyaWVzO1xyXG5cdFx0XHRcdFx0XHRjaGFuZ2VTdGF0dXNEaWFsb2cuc3RhdHVzTmFtZSA9IHN0YXR1c05hbWU7XHJcblx0XHRcdFx0XHRcdGNoYW5nZVN0YXR1c0RpYWxvZy5zdGF0dXNJZCA9IHN0YXR1c0lkO1xyXG5cdFx0XHRcdFx0XHRjaGFuZ2VTdGF0dXNEaWFsb2cuaW5jb21wbGV0ZUVudHJpZXMgPSBkYXRhLmxlbmd0aDtcclxuXHRcdFx0XHRcdFx0Y2hhbmdlU3RhdHVzRGlhbG9nLm9wZW4oKTtcclxuXHRcdFx0XHRcdH0sIDUwMCk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gY2hhbmdlUmVhZFN0YXRlKGVudHJpZXMsIHJlYWQpIHtcclxuXHRcdFx0aWYgKGVudHJpZXMubGVuZ3RoID4gMSkge1xyXG5cdFx0XHRcdGNvbnN0IG1lc3NhZ2UgPSBcIk1hcmtpbmcgYXMgXCIgKyAocmVhZCA9PT0gdHJ1ZSA/IFwiUmVhZFwiIDogXCJVbnJlYWRcIikgKyBcIi4uLlwiO1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnVwZGF0ZVByb2dyZXNzTWVzc2FnZShtZXNzYWdlKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Q29nbml0by5Gb3Jtcy51cGRhdGVFbnRyeVJlYWRTdGF0ZSh7IEVudHJpZXM6IGVudHJpZXMsIFRva2VuOiBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Ub2tlbigpIH0sIHJlYWQsXHJcblx0XHRcdFx0ZnVuY3Rpb24gKGRhdGEsIHJlYWQpIHtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLmNoYW5nZVJlYWRTdGF0ZXMoZW50cmllcywgcmVhZCk7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci51cGRhdGVQcm9ncmVzc01lc3NhZ2UoKTtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnVwZGF0ZVByb2dyZXNzTWVzc2FnZSgpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0KTtcclxuXHRcdH1cclxuXHJcblx0XHR2YXIgY2hhbmdlU3RhdHVzRGlhbG9nID0gJC5mbi5kaWFsb2coe1xyXG5cdFx0XHR0aXRsZTogXCJDaGFuZ2UgU3RhdHVzP1wiLFxyXG5cdFx0XHR0ZXh0OiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0aWYgKGNoYW5nZVN0YXR1c0RpYWxvZy5pbmNvbXBsZXRlRW50cmllcykge1xyXG5cdFx0XHRcdFx0dmFyIG1lc3NhZ2UgPSBcIjxzdHJvbmc+XCIgKyAoY2hhbmdlU3RhdHVzRGlhbG9nLmVudHJpZXMubGVuZ3RoID09IDEgPyBcIlRoaXMgZW50cnkgaXNcIiA6IGNoYW5nZVN0YXR1c0RpYWxvZy5pbmNvbXBsZXRlRW50cmllcyArIFwiIG9mIHRoZXNlIGVudHJpZXMgXCIgKyAoY2hhbmdlU3RhdHVzRGlhbG9nLmluY29tcGxldGVFbnRyaWVzID4gMSA/IFwiYXJlXCIgOiBcImlzXCIpKSArIFwiIEluY29tcGxldGUhPC9zdHJvbmc+XCI7XHJcblx0XHRcdFx0XHRtZXNzYWdlICs9IFwiPGJyIC8+PGJyIC8+QXJlIHlvdSBzdXJlIHlvdSB3aXNoIHRvIGNvbnRpbnVlP1wiXHJcblx0XHRcdFx0XHRyZXR1cm4gbWVzc2FnZTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0cmV0dXJuIFwiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGNoYW5nZSB0aGUgc3RhdHVzIG9mIDxzdHJvbmc+XCIgKyAoY2hhbmdlU3RhdHVzRGlhbG9nLmVudHJpZXMubGVuZ3RoID4gMSA/IGNoYW5nZVN0YXR1c0RpYWxvZy5lbnRyaWVzLmxlbmd0aCArIFwiIGVudHJpZXNcIiA6IFwidGhpcyBlbnRyeVwiKSArIFwiPC9zdHJvbmc+IHRvIFwiICsgY2hhbmdlU3RhdHVzRGlhbG9nLnN0YXR1c05hbWUgKyBcIj9cIjtcclxuXHRcdFx0fSxcclxuXHRcdFx0aGVpZ2h0OiAzMDAsXHJcblx0XHRcdHdpZHRoOiA1MDAsXHJcblx0XHRcdGJ1dHRvbnM6IFtcclxuXHRcdFx0XHR7XHJcblx0XHRcdFx0XHRsYWJlbDogXCJDYW5jZWxcIixcclxuXHRcdFx0XHRcdGlzQ2FuY2VsOiB0cnVlXHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHR7XHJcblx0XHRcdFx0XHRsYWJlbDogXCJDaGFuZ2UgU3RhdHVzXCIsXHJcblx0XHRcdFx0XHRhdXRvQ2xvc2U6IGZhbHNlLFxyXG5cdFx0XHRcdFx0Y2xpY2s6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0Y2hhbmdlU3RhdHVzKHRoaXMuZW50cmllcywgdGhpcy5zdGF0dXNOYW1lLCB0cnVlLCB0aGlzLmluY29tcGxldGVFbnRyaWVzLCB0aGlzLnN0YXR1c0lkKTtcclxuXHRcdFx0XHRcdFx0dGhpcy5jbG9zZSgpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XVxyXG5cdFx0fSk7XHJcblxyXG5cdFx0Ly8gVGhpcyBpcyBoYXJkY29kZWQgdG8gaW5kaWNhdGUgYSBxdWFudGl0eSBsaW1pdCBpc3N1ZSwgYWx0aG91Z2ggdGhlIHVwZGF0ZSBmYWlsdXJlIGNhbiBwb3RlbnRpYWxseSBiZSBjYXVzZWQgYnkgb3RoZXIgdGhpbmdzIGluIHRoZSBmdXR1cmUuXHJcblx0XHR2YXIgc3RhdHVzVXBkYXRlc0ZhaWxlZERpYWxvZyA9ICQuZm4uZGlhbG9nKHtcclxuXHRcdFx0dGl0bGU6IFwiU3RhdHVzIFVwZGF0ZSBGYWlsdXJlc1wiLFxyXG5cdFx0XHR0ZXh0OiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0cmV0dXJuIFwiPHN0cm9uZz5VbmFibGUgdG8gY2hhbmdlIHN0YXR1cyBmb3IgXCIgKyBzdGF0dXNVcGRhdGVzRmFpbGVkRGlhbG9nLmNvdW50ICsgXCIgXCIgKyAoc3RhdHVzVXBkYXRlc0ZhaWxlZERpYWxvZy5jb3VudCA+IDEgPyBcImVudHJpZXNcIiA6IFwiZW50cnlcIikgKyBcIiBiZWNhdXNlIGEgcXVhbnRpdHkgbGltaXQgaGFzIGJlZW4gcmVhY2hlZC5cIlxyXG5cdFx0XHR9LFxyXG5cdFx0XHRoZWlnaHQ6IDMwMCxcclxuXHRcdFx0d2lkdGg6IDUwMCxcclxuXHRcdFx0YnV0dG9uczogW1xyXG5cdFx0XHRcdHtcclxuXHRcdFx0XHRcdGxhYmVsOiBcIkNsb3NlXCJcclxuXHRcdFx0XHR9XHJcblx0XHRcdF0sXHJcblx0XHRcdGNhbmNlbDogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHJcblx0XHQvLyBDcmVkaXQgUGF5bWVudFxyXG5cdFx0ZnVuY3Rpb24gZGlzcGxheVN1Ym1pdFBheW1lbnREaWFsb2coZW50cnlLZXksIGN1c3RvbWVyQ2FyZCwgcGF5bWVudFByb2Nlc3Nvcikge1xyXG5cdFx0XHRWdWVDb21wb25lbnRzLkVudHJ5UGF5bWVudERpYWxvZy5vcGVuKFxyXG5cdFx0XHRcdHtcclxuXHRcdFx0XHRcdGFkbWluQXBpOiBBZG1pbkZvcm0sXHJcblx0XHRcdFx0XHRmb3JtSWQ6IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0uZ2V0X0lkKCksXHJcblx0XHRcdFx0XHRlbnRyeUtleTogZW50cnlLZXksXHJcblx0XHRcdFx0XHR2aWV3SWQ6IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X0lkKCksXHJcblx0XHRcdFx0XHR2aWV3VG9rZW46IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCksXHJcblx0XHRcdFx0XHRyb2xlOiBDb2duaXRvLnNlcmlhbGl6ZShnZXRFbnRyeVZpZXdSb2xlKCkpLFxyXG5cdFx0XHRcdFx0cGF5bWVudFByb2Nlc3NvcjogcGF5bWVudFByb2Nlc3NvcixcclxuXHRcdFx0XHRcdGN1cnJlbmN5Q29kZTogQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5nZXRfTG9jYWxpemF0aW9uKCkuZ2V0X0N1cnJlbmN5KCkuZ2V0X0NvZGUoKSxcclxuXHRcdFx0XHRcdGN1c3RvbWVyQ2FyZDogY3VzdG9tZXJDYXJkLFxyXG5cdFx0XHRcdFx0bWFrZVBheW1lbnQ6IENvZ25pdG8uRm9ybXMubWFrZVBheW1lbnRcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdFtcclxuXHRcdFx0XHRcdHtcclxuXHRcdFx0XHRcdFx0ZXZlbnROYW1lOiBcInVwZGF0ZS1lbnRyeVwiLFxyXG5cdFx0XHRcdFx0XHRldmVudEhhbmRsZXI6IGZ1bmN0aW9uIChhcmdzKSB7XHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5lbnRyeVVwZGF0ZWQoYXJncy5lbnRyeUtleSk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHRdXHJcblx0XHRcdCk7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gZGlzcGxheVJlZnVuZE9yZGVyRGlhbG9nKGVudHJ5SWQsIHJlZnVuZE1vZGVsKSB7XHJcblx0XHRcdFZ1ZUNvbXBvbmVudHMuUmVmdW5kT3JkZXJEaWFsb2cub3BlbihcclxuXHRcdFx0XHR7XHJcblx0XHRcdFx0XHRtb2RlbDogcmVmdW5kTW9kZWwsXHJcblx0XHRcdFx0XHRlbnRyeUlkOiBlbnRyeUlkXHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRbXHJcblx0XHRcdFx0XHR7XHJcblx0XHRcdFx0XHRcdGV2ZW50TmFtZTogXCJyZWZ1bmQtZW50cnktb3JkZXJcIixcclxuXHRcdFx0XHRcdFx0ZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoYXJncykge1xyXG5cdFx0XHRcdFx0XHRcdHJlZnVuZE9yZGVyKGFyZ3MuZW50cnlJZCwgYXJncy5yZWZ1bmRTdWNjZXNzLCBhcmdzLnJlZnVuZEVycm9yKTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdF1cclxuXHRcdFx0KTtcclxuXHRcdH1cclxuXHJcblx0XHRmdW5jdGlvbiByZWZ1bmRPcmRlcihlbnRyeUlkLCBzdWNjZXNzLCBlcnJvcikge1xyXG5cdFx0XHRpZiAoc3VibWl0dGluZ1JlZnVuZClcclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdHN1Ym1pdHRpbmdSZWZ1bmQgPSB0cnVlO1xyXG5cdFx0XHR2YXIgdmlld0lkID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKTtcclxuXHRcdFx0Q29nbml0by5Gb3Jtcy5yZWZ1bmRFbnRyeU9yZGVyKHZpZXdJZCwgZW50cnlJZCxcclxuXHRcdFx0XHRmdW5jdGlvbiAoZGF0YSkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5lbnRyeVVwZGF0ZWQoZGF0YS5lbnRyeUtleSwgbnVsbCwgZnVuY3Rpb24gKCkgeyBzdWJtaXR0aW5nUmVmdW5kID0gZmFsc2UgfSk7XHJcblxyXG5cdFx0XHRcdFx0aWYgKHN1Y2Nlc3MpXHJcblx0XHRcdFx0XHRcdHN1Y2Nlc3MoZGF0YSk7XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRzdWJtaXR0aW5nUmVmdW5kID0gZmFsc2U7XHJcblx0XHRcdFx0XHRpZiAoZXJyb3IpXHJcblx0XHRcdFx0XHRcdGVycm9yKCk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHQpO1xyXG5cdFx0fVxyXG5cclxuXHRcdC8vIEFkdmFuY2VkIEZpbHRlclxyXG5cdFx0ZnVuY3Rpb24gYWR2YW5jZWRGaWx0ZXIoY2FsbGJhY2spIHtcclxuXHJcblx0XHRcdC8vIE9wZW4gdGhlIGFkdmFuY2UgZmlsdGVyIGRpYWxvZ1xyXG5cdFx0XHRDb2duaXRvLm9wZW5FeHByZXNzaW9uQnVpbGRlcih7XHJcblx0XHRcdFx0cm9vdFR5cGU6IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0sXHJcblx0XHRcdFx0aW5jbHVkZVRyYW5zaWVudFByb3BlcnRpZXM6IGZhbHNlLFxyXG5cdFx0XHRcdHNjb3BlOiBDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfc2NvcGUoKSxcclxuXHRcdFx0XHRwcm9wZXJ0eTogXCJBZHZhbmNlZCBGaWx0ZXJcIixcclxuXHRcdFx0XHRsYWJlbDogXCJBZHZhbmNlZCBGaWx0ZXIuLi5cIixcclxuXHRcdFx0XHRleHByZXNzaW9uOiBDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfRXhwcmVzc2lvbigpLFxyXG5cdFx0XHRcdHNhdmVDYWxsYmFjazogZnVuY3Rpb24gZmlsdGVyKG5ld0V4cHJlc3Npb24pIHtcclxuXHRcdFx0XHRcdGZ1bmN0aW9uIHVwZGF0ZUZpbHRlcihleHByZXNzaW9uLCBzdW1tYXJ5LCBpbnZhbGlkKSB7XHJcblxyXG5cdFx0XHRcdFx0XHQvLyBTdG9yZSB0aGUgbmV3IGZpbHRlciBjcml0ZXJpYVxyXG5cdFx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5zZXRfRXhwcmVzc2lvbihleHByZXNzaW9uKTtcclxuXHJcblx0XHRcdFx0XHRcdC8vIFVwZGF0ZSB0aGUgZXhwcmVzc2lvbiBzdW1tYXJ5XHJcblx0XHRcdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwuZmlsdGVyLnNldF9FeHByZXNzaW9uU3VtbWFyeShzdW1tYXJ5KTtcclxuXHRcdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC5maWx0ZXIuc2V0X0ludmFsaWQoaW52YWxpZCk7XHJcblxyXG5cdFx0XHRcdFx0XHQvLyBBcHBseSB0aGUgbmV3IGZpbHRlclxyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUZpbHRlcihDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlcik7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0aWYgKG5ld0V4cHJlc3Npb24pIHtcclxuXHRcdFx0XHRcdFx0Q29nbml0by5nZXRFeHByZXNzaW9uQnVpbGRlclByZXZpZXcoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybSwgQ29nbml0by5Gb3Jtcy5tb2RlbC5maWx0ZXIuZ2V0X3Njb3BlKCksIG5ld0V4cHJlc3Npb24sXHJcblx0XHRcdFx0XHRcdFx0ZnVuY3Rpb24gKHByZXZpZXcsIGludmFsaWQpIHsgdXBkYXRlRmlsdGVyKG5ld0V4cHJlc3Npb24sIGludmFsaWQgPyBcIkludmFsaWQgRmlsdGVyXCIgOiBwcmV2aWV3LCBpbnZhbGlkKTsgfVxyXG5cdFx0XHRcdFx0XHQpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0XHR1cGRhdGVGaWx0ZXIobmV3RXhwcmVzc2lvbiwgXCJcIiwgZmFsc2UpO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0b3BlbkNhbGxiYWNrOiBmdW5jdGlvbiBvcGVuKGRpYWxvZykge1xyXG5cdFx0XHRcdFx0Ly8gU3dpdGNoIHRoZSBTYXZlIGJ1dHRvbiB0byBGaWx0ZXIgZm9yIGNvbnNpc3RlbmN5XHJcblx0XHRcdFx0XHQkKFwiLmMtZXhwcmVzc2lvbi1idWlsZGVyLWRpYWxvZyAuYy1tb2RhbC1idXR0b25cIikubm90KFwiLmMtbW9kYWwtYnV0dG9uLWNhbmNlbFwiKS50ZXh0KFwiRmlsdGVyXCIpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gZGlzcGxheUJ1bGtEb3dubG9hZERpYWxvZyh0eXBlLCBkb2N1bWVudFRlbXBsYXRlSWQsIGJ1bGtEb3dubG9hZElkID0gbnVsbCkge1xyXG5cdFx0XHRWdWVDb21wb25lbnRzLkJ1bGtEb3dubG9hZERpYWxvZy5vcGVuKHtcclxuXHRcdFx0XHR0aXRsZTogdHlwZSA9PT0gXCJGaWxlXCIgPyBcIkRvd25sb2FkIEZpbGVzXCIgOiBcIkRvd25sb2FkIERvY3VtZW50c1wiLFxyXG5cdFx0XHRcdHNob3c6IHRydWUsXHJcblx0XHRcdFx0dXNlckVtYWlsOiBDb2duaXRvLmNvbmZpZy51c2VySW5mby5FbWFpbCxcclxuXHRcdFx0XHRzZWxlY3RlZEVudHJpZXM6IHNlbGVjdGVkRW50cmllcyxcclxuXHRcdFx0XHRlbnRyeVZpZXdJZDogQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKSxcclxuXHRcdFx0XHRkb3dubG9hZFR5cGU6IHR5cGUsXHJcblx0XHRcdFx0ZG9jdW1lbnRUZW1wbGF0ZUlkOiBkb2N1bWVudFRlbXBsYXRlSWQsXHJcblx0XHRcdFx0YnVsa0Rvd25sb2FkSWQ6IGJ1bGtEb3dubG9hZElkXHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdGZ1bmN0aW9uIGRpc3BsYXlCdWxrRmlsZURvd25sb2FkVXBzZWxsRGlhbG9nKCkge1xyXG5cdFx0XHRjb250cm9sbGVyLnNob3dGZWF0dXJlV2FybmluZygnYnVsa2ZpbGVkb3dubG9hZCcpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGZ1bmN0aW9uIGRpc3BsYXlCdWxrRG9jdW1lbnREb3dubG9hZFVwc2VsbERpYWxvZygpIHtcclxuXHRcdFx0Y29udHJvbGxlci5zaG93RmVhdHVyZVdhcm5pbmcoJ2J1bGtkb2N1bWVudGRvd25sb2FkJyk7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gZGlzcGxheUJ1bGtBY3Rpb25EaWFsb2coYWN0aW9uKSB7XHJcblx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnN0b3BSZWZyZXNoSW50ZXJ2YWwoKTtcclxuXHRcdFx0VnVlQ29tcG9uZW50cy5CdWxrQWN0aW9uRGlhbG9nLm9wZW4oe1xyXG5cdFx0XHRcdGFjdGlvbjogYWN0aW9uLkFjdGlvbk5hbWUsXHJcblx0XHRcdFx0cm9sZTogZ2V0RW50cnlWaWV3Um9sZSgpLmdldF9OYW1lKCksXHJcblx0XHRcdFx0dXNlckluZm86IENvZ25pdG8uY29uZmlnLnVzZXJJbmZvLFxyXG5cdFx0XHRcdHNlbGVjdGVkRW50cmllczogc2VsZWN0ZWRFbnRyaWVzLFxyXG5cdFx0XHRcdHZpZXdJZDogQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKSxcclxuXHRcdFx0XHR2aWV3VG9rZW46IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X1Rva2VuKCksXHJcblx0XHRcdFx0YWRtaW5BcGk6IEFkbWluRm9ybVxyXG5cdFx0XHR9KS50aGVuKGZ1bmN0aW9uIChkbGcpIHtcclxuXHRcdFx0XHRkbGcuJG9uY2UoXCJjbG9zZVwiLCBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLm1hc3Rlci5zdGFydFJlZnJlc2hJbnRlcnZhbCgpO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9KTtcclxuXHRcdH1cclxuXHJcblx0XHRmdW5jdGlvbiBkaXNwbGF5SW1wb3J0RW50cmllc0RpYWxvZyhpbXBvcnRJZCwgY2FsbGJhY2spIHtcclxuXHRcdFx0VnVlQ29tcG9uZW50cy5JbXBvcnRFbnRyaWVzRGlhbG9nLm9wZW4oXHJcblx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0c2hvdzogdHJ1ZSxcclxuXHRcdFx0XHRcdGZvcm1JbnRlcm5hbE5hbWU6IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0uZ2V0X0xvd2VyZWRJbnRlcm5hbE5hbWUoKSxcclxuXHRcdFx0XHRcdGZvcm1EaXNwbGF5TmFtZTogQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5nZXRfTmFtZSgpLFxyXG5cdFx0XHRcdFx0aW1wb3J0SWQ6IGltcG9ydElkIHx8ICcnLFxyXG5cdFx0XHRcdFx0aXNPcmdPd25lcjogQ29nbml0by5jb25maWcucm9sZSA9PT0gJ093bmVyJyxcclxuXHRcdFx0XHRcdG9yZ0NvZGU6IENvZ25pdG8uY29uZmlnLm9yZ2FuaXphdGlvbkNvZGVcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdFtcclxuXHRcdFx0XHRcdHtcclxuXHRcdFx0XHRcdFx0ZXZlbnROYW1lOiBcInJlZnJlc2g6ZW50cmllc1wiLFxyXG5cdFx0XHRcdFx0XHRldmVudEhhbmRsZXI6IGNvbnRyb2xsZXIubWFzdGVyLnJlZnJlc2hFbnRyaWVzXHJcblx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0e1xyXG5cdFx0XHRcdFx0XHRldmVudE5hbWU6IFwiY2xvc2VcIixcclxuXHRcdFx0XHRcdFx0ZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdFx0aWYgKGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gXCJmdW5jdGlvblwiKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRjYWxsYmFjaygpO1xyXG5cdFx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdF1cclxuXHRcdFx0KVxyXG5cdFx0fVxyXG5cclxuXHRcdC8vIFNoYXJlIEVudHJ5XHJcblx0XHRmdW5jdGlvbiBkaXNwbGF5c2hhcmVFbnRyeURpYWxvZyhlbnRyeUtleSkge1xyXG5cdFx0XHR2YXIgZW50cnlOdW1iZXIgPSBlbnRyeUtleS5FbnRyeUlkLnNwbGl0KFwiLVwiKVsxXTtcclxuXHJcblx0XHRcdHNoYXJlRW50cnlEaWFsb2cgPSAkLmZuLmRpYWxvZyh7XHJcblx0XHRcdFx0dGl0bGU6IFwiU2hhcmUgRW50cnlcIixcclxuXHRcdFx0XHRuYW1lOiBcInNoYXJlXCIsXHJcblx0XHRcdFx0dXJsOiBDb2duaXRvLmNvbmZpZy5iYXNlVXJsICsgXCJmb3Jtcy9hZG1pbi92aWV3L1wiICsgQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5nZXRfTG93ZXJlZEludGVybmFsTmFtZSgpICsgXCIvZW50cmllcy9cIiArIGVudHJ5TnVtYmVyICsgXCIvc2hhcmU/dmlld1Rva2VuPVwiICsgQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfVG9rZW4oKSxcclxuXHRcdFx0XHR3aWR0aDogODAwLFxyXG5cdFx0XHRcdGhlaWdodDogXCI3NTBweFwiLFxyXG5cdFx0XHRcdGJ1dHRvbnM6IFtcclxuXHRcdFx0XHRcdHtcclxuXHRcdFx0XHRcdFx0bGFiZWw6IFwiQ2xvc2VcIixcclxuXHRcdFx0XHRcdFx0aXNDYW5jZWw6IGZhbHNlLFxyXG5cdFx0XHRcdFx0XHRjbGljazogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRcdHRoaXMuY2xvc2UodHJ1ZSk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHR7XHJcblx0XHRcdFx0XHRcdGxhYmVsOiBcIlNlbmRcIixcclxuXHRcdFx0XHRcdFx0YXV0b0Nsb3NlOiBmYWxzZSxcclxuXHRcdFx0XHRcdFx0Y2xpY2s6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLnNoYXJlRW50cnlEaWFsb2cuc2VuZEVtYWlsKCk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHRdXHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0c2hhcmVFbnRyeURpYWxvZy5fZGlhbG9nLmZpbmQoXCIuYy1tb2RhbC1idXR0b246Y29udGFpbnMoJ1NlbmQnKVwiKS5hZGRDbGFzcyhcInNlbmQtYW5pbWF0aW9uXCIpO1xyXG5cclxuXHRcdFx0c2hhcmVFbnRyeURpYWxvZy5vcGVuKCk7XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gVmlldyBMaW1pdCBFeGNlZWRlZCBBdmFpbGFibGVcclxuXHRcdHZhciB2aWV3TGltaXRFeGNlZWRlZERpYWxvZztcclxuXHRcdGZ1bmN0aW9uIHNob3dWaWV3TGltaXRFeGNlZWRlZFdhcm5pbmcoKSB7XHJcblx0XHRcdGlmICghdmlld0xpbWl0RXhjZWVkZWREaWFsb2cpIHtcclxuXHRcdFx0XHR2YXIgdmlld0xpbWl0RXhjZWVkZWREaWFsb2cgPSAkLmZuLmRpYWxvZyh7XHJcblx0XHRcdFx0XHR0aXRsZTogXCJWaWV3IExpbWl0IFJlYWNoZWRcIixcclxuXHRcdFx0XHRcdHRleHQ6IFwiT25seSBcIiArIENvZ25pdG8uY29uZmlnLmVudHJ5Vmlld0xpbWl0ICsgXCIgc2F2ZWQgdmlld3MgYXJlIGFsbG93ZWQgcGVyIGZvcm0uXCIsXHJcblx0XHRcdFx0XHRidXR0b25zOiBbXHJcblx0XHRcdFx0XHRcdHtcclxuXHRcdFx0XHRcdFx0XHRsYWJlbDogXCJPa2F5XCIsXHJcblx0XHRcdFx0XHRcdFx0YXV0b0Nsb3NlOiB0cnVlLFxyXG5cdFx0XHRcdFx0XHRcdGlzRGVmYXVsdDogdHJ1ZVxyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRdXHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH1cclxuXHRcdFx0dmlld0xpbWl0RXhjZWVkZWREaWFsb2cub3BlbigpO1xyXG5cdFx0fVxyXG5cclxuXHRcdC8vICNlbmRyZWdpb25cclxuXHJcblx0XHQvLyNyZWdpb24gTW9kZWwgVHlwZSBEZWZpbml0aW9uc1xyXG5cclxuXHRcdC8vIEVudHJ5IFZpZXdcclxuXHRcdCRleHRlbmQoW1wiQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdcIiwgXCJDb2duaXRvLkZvcm1zLkVudHJ5Vmlld0NvbHVtblwiLCBcIkNvZ25pdG8uRmllbGRJbmZvXCJdLCBmdW5jdGlvbiAodHlwZSkge1xyXG5cclxuXHRcdFx0Ly8gUHJldmVudCBFbnRyeSBDcmVhdGlvblxyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImlzR3JpZFZpZXdcIiwgdHlwZTogQm9vbGVhbiB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHJldHVybiAhdGhpcy5nZXRfVHlwZSgpIHx8IHRoaXMuZ2V0X1R5cGUoKS5nZXRfTmFtZSgpICE9PSAnRm9ybSc7XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRvbkNoYW5nZU9mOiBbXCJUeXBlLk5hbWVcIl1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0XHQvLyBBdmFpbGFibGUgQ29sdW1uc1xyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImF2YWlsYWJsZUNvbHVtbnNcIiwgdHlwZTogQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdDb2x1bW4sIGlzTGlzdDogdHJ1ZSB9KTtcclxuXHJcblx0XHRcdHR5cGUuJFNoYXJlZFdpdGhNZS5hZGRDaGFuZ2VkKGZ1bmN0aW9uIChzZW5kZXIsIGFyZ3MpIHtcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9GaWx0ZXIoKS5zZXRfc2hhcmVkV2l0aE1lKGFyZ3MubmV3VmFsdWUpXHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0Ly8gQWxsIEZpZWxkc1xyXG5cdFx0XHR0eXBlLiRBbGxGaWVsZHMuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHR2YXIgc2VsZWN0ZWRGaWVsZHMgPSAwO1xyXG5cdFx0XHRcdFx0dmFyIGFsbEZpZWxkcyA9IDA7XHJcblx0XHRcdFx0XHR2YXIgY29sdW1ucyA9IHRoaXMuZ2V0X0NvbHVtbnMoKTtcclxuXHRcdFx0XHRcdGZvciAodmFyIGMgPSAwOyBjIDwgY29sdW1ucy5sZW5ndGg7IGMrKykge1xyXG5cdFx0XHRcdFx0XHRpZiAoJC5pc051bWVyaWMoY29sdW1uc1tjXS5nZXRfRmllbGRJZCgpWzBdKSlcclxuXHRcdFx0XHRcdFx0XHRzZWxlY3RlZEZpZWxkcysrXHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR2YXIgY29sdW1ucyA9IHRoaXMuZ2V0X2F2YWlsYWJsZUNvbHVtbnMoKTtcclxuXHRcdFx0XHRcdGZvciAodmFyIGMgPSAwOyBjIDwgY29sdW1ucy5sZW5ndGg7IGMrKykge1xyXG5cdFx0XHRcdFx0XHRpZiAoJC5pc051bWVyaWMoY29sdW1uc1tjXS5nZXRfRmllbGRJZCgpWzBdKSlcclxuXHRcdFx0XHRcdFx0XHRhbGxGaWVsZHMrK1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0cmV0dXJuIHNlbGVjdGVkRmllbGRzID09IGFsbEZpZWxkcztcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFtcIkNvbHVtbnNcIiwgXCJhdmFpbGFibGVDb2x1bW5zXCJdXHJcblx0XHRcdH0pXHJcblx0XHRcdFx0LmFkZENoYW5nZWQoZnVuY3Rpb24gKHNlbmRlciwgYXJncykge1xyXG5cdFx0XHRcdFx0aWYgKCFhcmdzLmNhbGN1bGF0ZWQpIHtcclxuXHRcdFx0XHRcdFx0JChcIi5jLXZpZXctY29sdW1ucyAuYy12aWV3LWZvcm0tZmllbGQgaW5wdXQ6Y2hlY2tib3hcIikucHJvcCgnY2hlY2tlZCcsIGFyZ3MubmV3VmFsdWUpO1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUNvbHVtbnMoJChcIi5jLXZpZXctY29sdW1ucyBpbnB1dDpjaGVja2JveDpjaGVja2VkXCIpLm1hcChmdW5jdGlvbiAoKSB7IHJldHVybiAkcGFyZW50Q29udGV4dERhdGEodGhpcykuZ2V0X3Jhd1ZhbHVlKCk7IH0pLnRvQXJyYXkoKSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHQvLyBGb3JjZSB0aGUgdG9rZW4gdG8gYmUgc2VyaWFsaXplZCBpbiBjcm9zcyB3aW5kb3cgY2FsbHNcclxuXHRcdFx0dHlwZS4kVG9rZW4uX2lzUGVyc2lzdGVkID0gdHJ1ZTtcclxuXHJcblx0XHRcdC8vIFNjb3BlIElkXHJcblx0XHRcdHR5cGUubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwic2NvcGVJZFwiLCB0eXBlOiBTdHJpbmcgfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5nZXRfRmlsdGVyKCkuZ2V0X1Njb3BlSWQoKSB8fCBcIlwiO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSlcclxuXHRcdFx0XHQuYWRkQ2hhbmdlZChmdW5jdGlvbiAoc2VuZGVyLCBhcmdzKSB7XHJcblxyXG5cdFx0XHRcdFx0aWYgKCFhcmdzLmNhbGN1bGF0ZWQpIHtcclxuXHJcblx0XHRcdFx0XHRcdC8vIFJlbW92ZSBjb2x1bW5zIHRoYXQgYXJlIG5vIGxvbmdlciB2YWxpZCBmb3IgdGhlIHNwZWNpZmllZCBzY29wZVxyXG5cdFx0XHRcdFx0XHR2YXIgY29sdW1ucyA9IHNlbmRlci5nZXRfQ29sdW1ucygpLnNsaWNlKCk7XHJcblx0XHRcdFx0XHRcdHZhciBjb3VudCA9IGNvbHVtbnMubGVuZ3RoO1xyXG5cdFx0XHRcdFx0XHR2YXIgc2NvcGUgPSBzZW5kZXIuZ2V0X3Njb3BlSWQoKSB8fCBcIlwiO1xyXG5cdFx0XHRcdFx0XHRmb3IgKHZhciBjID0gY291bnQgLSAxOyBjID49IDA7IGMtLSkge1xyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAoIXNjb3BlLnN0YXJ0c1dpdGgoY29sdW1uc1tjXS5nZXRfZmllbGQoKS5nZXRfU2NvcGVJZCgpIHx8IFwiXCIpKVxyXG5cdFx0XHRcdFx0XHRcdFx0Y29sdW1ucy5zcGxpY2UoYywgMSk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0aWYgKGNvbHVtbnMubGVuZ3RoIDwgY291bnQpXHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5jaGFuZ2VDb2x1bW5zKGNvbHVtbnMpO1xyXG5cclxuXHRcdFx0XHRcdFx0Ly8gUmVmcmVzaCB0aGUgY29sdW1uIG1lbnVcclxuXHRcdFx0XHRcdFx0cmVmcmVzaENvbHVtbk1lbnUoKTtcclxuXHJcblx0XHRcdFx0XHRcdC8vIFJlbW92ZSBzb3J0IGNvbHVtbnMgdGhhdCBhcmUgbm8gbG9uZ2VyIHZhbGlkIGZvciB0aGUgc3BlY2lmaWVkIHNjb3BlXHJcblx0XHRcdFx0XHRcdHZhciBzb3J0QnkgPSBzZW5kZXIuZ2V0X1NvcnRCeSgpLnNsaWNlKCk7XHJcblx0XHRcdFx0XHRcdGNvdW50ID0gc29ydEJ5Lmxlbmd0aDtcclxuXHRcdFx0XHRcdFx0Zm9yICh2YXIgYyA9IGNvdW50IC0gMTsgYyA+PSAwOyBjLS0pIHtcclxuXHJcblx0XHRcdFx0XHRcdFx0aWYgKCFzY29wZS5zdGFydHNXaXRoKHNvcnRCeVtjXS5nZXRfZmllbGQoKS5nZXRfU2NvcGVJZCgpIHx8IFwiXCIpKVxyXG5cdFx0XHRcdFx0XHRcdFx0c29ydEJ5LnNwbGljZShjLCAxKTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRpZiAoc29ydEJ5Lmxlbmd0aCA8IGNvdW50KVxyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuY2hhbmdlU29ydChzb3J0QnkpO1xyXG5cclxuXHRcdFx0XHRcdFx0Ly8gQ2xlYXIgdGhlIGZpbHRlciwgc2luY2UgaXQgaXMgbm93IGludmFsaWRcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5jaGFuZ2VGaWx0ZXIobmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3RmlsdGVyKHsgU2NvcGVJZDogc2NvcGUgfSkpO1xyXG5cclxuXHRcdFx0XHRcdFx0Ly8gSGlkZSBlbnRyeSBkZXRhaWxzIGFuZCBjbGVhciBjdXJyZW50IHNlbGVjdGlvbnNcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlRW50cnkoKTtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIuY2xlYXJTZWxlY3Rpb24oKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIENvbHVtbnNcclxuXHRcdFx0dHlwZS4kQ29sdW1ucy5vcHRpb25WYWx1ZXMoXCJhdmFpbGFibGVDb2x1bW5zXCIpO1xyXG5cclxuXHRcdFx0Ly8gRmlsdGVyXHJcblx0XHRcdHR5cGUuJEZpbHRlci5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuZ2V0X0ZpbHRlcigpIHx8IG5ldyBDb2duaXRvLkZvcm1zLkVudHJ5Vmlld0ZpbHRlcigpOyB9XHJcblx0XHRcdH0pO1xyXG5cdFx0XHR0eXBlLm1ldGEuYWRkSW5pdEV4aXN0aW5nKGZ1bmN0aW9uICh2aWV3KSB7IGlmICghdmlldy5nZXRfRmlsdGVyKCkpIHZpZXcuc2V0X0ZpbHRlcihuZXcgQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdGaWx0ZXIoKSk7IH0pO1xyXG5cclxuXHRcdFx0Ly8gU29ydCBTdW1tYXJ5XHJcblx0XHRcdHR5cGUubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwic29ydFN1bW1hcnlcIiwgdHlwZTogU3RyaW5nIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0dmFyIHNvcnRCeSA9IHRoaXMuZ2V0X1NvcnRCeSgpO1xyXG5cdFx0XHRcdFx0aWYgKHNvcnRCeS5sZW5ndGggPT0gMClcclxuXHRcdFx0XHRcdFx0cmV0dXJuIFwiTW9zdCBSZWNlbnQgRmlyc3RcIjtcclxuXHJcblx0XHRcdFx0XHR2YXIgZGVzY3JpcHRpb24gPSBcIlNvcnQgYnkgXCI7XHJcblx0XHRcdFx0XHRmb3IgKHZhciBzID0gMDsgcyA8IHNvcnRCeS5sZW5ndGg7IHMrKykge1xyXG5cdFx0XHRcdFx0XHRpZiAocyA+IDApXHJcblx0XHRcdFx0XHRcdFx0ZGVzY3JpcHRpb24gKz0gXCIsIHRoZW4gYnkgXCI7XHJcblx0XHRcdFx0XHRcdGRlc2NyaXB0aW9uICs9IHNvcnRCeVtzXS5nZXRfZmllbGQoKS5nZXRfTmFtZSgpO1xyXG5cdFx0XHRcdFx0XHRpZiAoIXNvcnRCeVtzXS5nZXRfQXNjZW5kaW5nKCkpXHJcblx0XHRcdFx0XHRcdFx0ZGVzY3JpcHRpb24gKz0gXCIgZGVzY2VuZGluZ1wiO1xyXG5cdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdHJldHVybiBkZXNjcmlwdGlvbjtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFwiU29ydEJ5e0ZpZWxkSWQsQXNjZW5kaW5nfVwiXHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0Ly8gU29ydCBDbGFzc1xyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcInNvcnRDbGFzc1wiLCB0eXBlOiBTdHJpbmcgfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHR2YXIgYnV0dG9uQ2xhc3MgPSBDb2duaXRvLmNvbmZpZy5mbGFncy5BcHBOYXYgPyAndGV4dC1idXR0b24nIDogJ2MtbmF2LWJ1dHRvbic7XHJcblxyXG5cdFx0XHRcdFx0aWYgKHRoaXMuZ2V0X1NvcnRCeSgpLmxlbmd0aClcclxuXHRcdFx0XHRcdFx0cmV0dXJuIGJ1dHRvbkNsYXNzICsgJyBjLXNvcnQtYXBwbGllZCc7XHJcblx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdHJldHVybiBidXR0b25DbGFzcztcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFwiU29ydEJ5XCJcclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImNhbkRlbGV0ZVwiLCB0eXBlOiBCb29sZWFuIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0cmV0dXJuIENvZ25pdG8uRm9ybXMubW9kZWwudmlld3MubGVuZ3RoID4gMTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0Ly9UT0RPOiB3aGVuIFVzZXJTcGVjaWZpY1ZpZXdzIGlzIG9uLCBkZWxldGUgdGhpc1xyXG5cdFx0XHR0eXBlLiROYW1lLmFkZENoYW5nZWQoZnVuY3Rpb24gKHNlbmRlciwgYXJncykge1xyXG5cdFx0XHRcdGlmICghQ29nbml0by5jb25maWcuZmxhZ3MuVXNlclNwZWNpZmljVmlld3MpIHtcclxuXHRcdFx0XHRcdGlmICghYXJncy5uZXdWYWx1ZSB8fCBhcmdzLm5ld1ZhbHVlLnRyaW0oKSA9PSBhcmdzLm9sZFZhbHVlIHx8IGFyZ3MubmV3VmFsdWUudHJpbSgpID09IFwiXCIpIHtcclxuXHRcdFx0XHRcdFx0c2VuZGVyLnNldF9OYW1lKGFyZ3Mub2xkVmFsdWUpO1xyXG5cdFx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5yZW5hbWVFbnRyeVZpZXcoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKSwgc2VuZGVyLmdldF9OYW1lKCksIGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRcdHNlbmRlci5zZXRfSW50ZXJuYWxOYW1lKGRhdGEpO1xyXG5cclxuXHRcdFx0XHRcdFx0Ly8gVXBkYXRlIHRoZSByb2xsYmFjayBkYXRhXHJcblx0XHRcdFx0XHRcdGlmIChwcmV2aW91c1ZpZXdEYXRhKSB7XHJcblx0XHRcdFx0XHRcdFx0cHJldmlvdXNWaWV3RGF0YS5OYW1lID0gc2VuZGVyLmdldF9OYW1lKCk7XHJcblx0XHRcdFx0XHRcdFx0cHJldmlvdXNWaWV3RGF0YS5JbnRlcm5hbE5hbWUgPSBzZW5kZXIuZ2V0X0ludGVybmFsTmFtZSgpO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdHVwZGF0ZU5hdmlnYXRpb24oKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcInJvbGVOYW1lXCIsIHR5cGU6IFN0cmluZyB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHZhciBmb3JtID0gZ2V0Rm9ybSh0aGlzLmdldF9Gb3JtKCkuZ2V0X0lkKCkpO1xyXG5cdFx0XHRcdFx0cmV0dXJuIGdldEVudHJ5Vmlld1JvbGUoZm9ybSwgdGhpcykuZ2V0X05hbWUoKTtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uSW5pdDogdHJ1ZSxcclxuXHRcdFx0XHRvbkNoYW5nZU9mOiBbXCJSb2xlSWRcIl1cclxuXHRcdFx0fSk7XHJcblx0XHR9KTtcclxuXHJcblx0XHQvLyBFbnRyeSBWaWV3IENvbHVtblxyXG5cdFx0JGV4dGVuZChcIkNvZ25pdG8uRm9ybXMuRW50cnlWaWV3Q29sdW1uXCIsIGZ1bmN0aW9uICh0eXBlKSB7XHJcblxyXG5cdFx0XHQvLyBGb3JtYXRcclxuXHRcdFx0dHlwZS5tZXRhLnNldF9mb3JtYXQoXCJbZmllbGQuTmFtZV1cIik7XHJcblxyXG5cdFx0XHQvLyBGaWVsZFxyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImZpZWxkXCIsIHR5cGU6IENvZ25pdG8uRmllbGRJbmZvIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0dmFyIGZpZWxkSWQgPSB0aGlzLmdldF9GaWVsZElkKCk7XHJcblx0XHRcdFx0XHRyZXR1cm4gQ29nbml0by5kZXNlcmlhbGl6ZShDb2duaXRvLkZpZWxkSW5mbywgQ29nbml0by5Gb3Jtcy5tb2RlbC5maWVsZEluZm9zLmZpbHRlcihmdW5jdGlvbiAoZikgeyByZXR1cm4gZi5JZCA9PSBmaWVsZElkOyB9KVswXSkgfHwgbnVsbDtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFwiRmllbGRJZFwiXHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdH0pO1xyXG5cclxuXHRcdC8vIEVudHJ5IFZpZXcgRmlsdGVyXHJcblx0XHQkZXh0ZW5kKFwiQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdGaWx0ZXJcIiwgZnVuY3Rpb24gKHR5cGUpIHtcclxuXHJcblx0XHRcdC8vIFNjb3BlXHJcblx0XHRcdHR5cGUubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwic2NvcGVcIiwgdHlwZTogU3RyaW5nIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0dmFyIHNjb3BlID0gdGhpcy5nZXRfU2NvcGVJZCgpO1xyXG5cdFx0XHRcdFx0cmV0dXJuIHNjb3BlID8gQ29nbml0by5Gb3Jtcy5tb2RlbC5maWVsZEluZm9zLmZpbHRlcihmdW5jdGlvbiAoZikgeyByZXR1cm4gZi5JZCA9PSBzY29wZTsgfSlbMF0uUGF0aCA6IFwiXCI7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIEFsbG93ZWQgRW50cnkgU3RhdHVzZXNcclxuXHRcdFx0dHlwZS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJhbGxvd2VkRW50cnlTdGF0dXNlc1wiLCB0eXBlOiBTdHJpbmcsIGlzTGlzdDogdHJ1ZSB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHJldHVybiBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9FbnRyeVN0YXR1c2VzKCkuZmlsdGVyKGZ1bmN0aW9uIChzKSB7IHJldHVybiAhcy5nZXRfSXNBcmNoaXZlZCgpOyB9KS5tYXAoZnVuY3Rpb24gKHMpIHsgcmV0dXJuIHMuZ2V0X0lkKCkudG9TdHJpbmcoKSB9KTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0Ly8gRW50cnkgU3RhdHVzXHJcblx0XHRcdHR5cGUuJEVudHJ5U3RhdHVzLm9wdGlvblZhbHVlcyhcImFsbG93ZWRFbnRyeVN0YXR1c2VzXCIpO1xyXG5cclxuXHRcdFx0Ly8gQWxsIEVudHJ5IFN0YXR1c2VzXHJcblx0XHRcdHR5cGUubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwiYWxsRW50cnlTdGF0dXNlc1wiLCB0eXBlOiBCb29sZWFuIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0dHJ5IHsgaWYgKHdpbmRvdy5ldmVudCkgd2luZG93LmV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyB9IGNhdGNoIChlKSB7IH1cclxuXHRcdFx0XHRcdHJldHVybiB0aGlzLmdldF9hbGxvd2VkRW50cnlTdGF0dXNlcygpLmxlbmd0aCA9PSB0aGlzLmdldF9FbnRyeVN0YXR1cygpLmxlbmd0aDtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFwiRW50cnlTdGF0dXNcIlxyXG5cdFx0XHR9KVxyXG5cdFx0XHRcdC5hZGRDaGFuZ2VkKGZ1bmN0aW9uIChzZW5kZXIsIGFyZ3MpIHtcclxuXHRcdFx0XHRcdGlmICghYXJncy5jYWxjdWxhdGVkKSB7XHJcblx0XHRcdFx0XHRcdHNlbmRlci5nZXRfRW50cnlTdGF0dXMoKS5jbGVhcigpO1xyXG5cdFx0XHRcdFx0XHRpZiAoYXJncy5uZXdWYWx1ZSlcclxuXHRcdFx0XHRcdFx0XHRzZW5kZXIuZ2V0X0VudHJ5U3RhdHVzKCkuYWRkUmFuZ2Uoc2VuZGVyLmdldF9hbGxvd2VkRW50cnlTdGF0dXNlcygpKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIEFsbG93ZWQgUGF5bWVudCBTdGF0dXNlc1xyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImFsbG93ZWRQYXltZW50U3RhdHVzZXNcIiwgdHlwZTogU3RyaW5nLCBpc0xpc3Q6IHRydWUgfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gQ29nbml0by5QYXltZW50LlBheW1lbnRTdGF0dXMuZ2V0X0FsbCgpLmZpbHRlcihmdW5jdGlvbiAocCkgeyByZXR1cm4gcC5nZXRfTmFtZSgpICE9PSAnQ2FuY2VsbGVkJyAmJiBwLmdldF9OYW1lKCkgIT09IFwiTmV3XCI7IH0pLm1hcChmdW5jdGlvbiAocCkgeyByZXR1cm4gcC5nZXRfTmFtZSgpOyB9KTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0Ly8gUGF5bWVudCBTdGF0dXNcclxuXHRcdFx0dHlwZS4kUGF5bWVudFN0YXR1cy5vcHRpb25WYWx1ZXMoXCJhbGxvd2VkUGF5bWVudFN0YXR1c2VzXCIpO1xyXG5cclxuXHRcdFx0Ly8gQWxsIFBheW1lbnQgU3RhdHVzZXNcclxuXHRcdFx0dHlwZS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJhbGxQYXltZW50U3RhdHVzZXNcIiwgdHlwZTogQm9vbGVhbiB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHRyeSB7IGlmICh3aW5kb3cuZXZlbnQpIHdpbmRvdy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgfSBjYXRjaCAoZSkgeyB9XHJcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5nZXRfYWxsb3dlZFBheW1lbnRTdGF0dXNlcygpLmxlbmd0aCA9PSB0aGlzLmdldF9QYXltZW50U3RhdHVzKCkubGVuZ3RoO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0b25DaGFuZ2VPZjogXCJQYXltZW50U3RhdHVzXCJcclxuXHRcdFx0fSlcclxuXHRcdFx0XHQuYWRkQ2hhbmdlZChmdW5jdGlvbiAoc2VuZGVyLCBhcmdzKSB7XHJcblx0XHRcdFx0XHRpZiAoIWFyZ3MuY2FsY3VsYXRlZCkge1xyXG5cdFx0XHRcdFx0XHRzZW5kZXIuZ2V0X1BheW1lbnRTdGF0dXMoKS5jbGVhcigpO1xyXG5cdFx0XHRcdFx0XHRpZiAoYXJncy5uZXdWYWx1ZSlcclxuXHRcdFx0XHRcdFx0XHRzZW5kZXIuZ2V0X1BheW1lbnRTdGF0dXMoKS5hZGRSYW5nZShzZW5kZXIuZ2V0X2FsbG93ZWRQYXltZW50U3RhdHVzZXMoKSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHQvLyBGaWx0ZXIgU3VtbWFyeVxyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImZpbHRlclN1bW1hcnlcIiwgdHlwZTogU3RyaW5nIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cclxuXHRcdFx0XHRcdHZhciBzdW1tYXJ5ID0gXCJcIjtcclxuXHJcblx0XHRcdFx0XHRpZiAodGhpcy5nZXRfSW52YWxpZCgpKSB7XHJcblx0XHRcdFx0XHRcdHRoaXMuc2V0X0V4cHJlc3Npb25TdW1tYXJ5KFwiSW52YWxpZCBGaWx0ZXJcIik7XHJcblx0XHRcdFx0XHRcdHJldHVybiBcIkludmFsaWQgRmlsdGVyXCI7XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0Ly8gRW50cnkgU3RhdHVzXHJcblx0XHRcdFx0XHRpZiAoIXRoaXMuZ2V0X2FsbEVudHJ5U3RhdHVzZXMoKSAmJiB0aGlzLmdldF9FbnRyeVN0YXR1cygpLmxlbmd0aCA+IDApIHtcclxuXHRcdFx0XHRcdFx0c3VtbWFyeSA9IFwiRW50cnkgaXMgXCI7XHJcblx0XHRcdFx0XHRcdHZhciBzdGF0dXNlcyA9IHRoaXMuZ2V0X0VudHJ5U3RhdHVzKCk7XHJcblxyXG5cdFx0XHRcdFx0XHRzdGF0dXNlcyA9IHN0YXR1c2VzLm1hcChmdW5jdGlvbiAocykge1xyXG5cdFx0XHRcdFx0XHRcdHJldHVybiBDb2duaXRvLkZvcm1zLmdldEVudHJ5U3RhdHVzQnlJZChDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9FbnRyeVN0YXR1c2VzKCksIHMpLk5hbWU7XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cclxuXHRcdFx0XHRcdFx0Zm9yICh2YXIgcyA9IDA7IHMgPCBzdGF0dXNlcy5sZW5ndGg7IHMrKykge1xyXG5cdFx0XHRcdFx0XHRcdGlmIChzID4gMClcclxuXHRcdFx0XHRcdFx0XHRcdHN1bW1hcnkgKz0gXCIgb3IgXCI7XHJcblx0XHRcdFx0XHRcdFx0c3VtbWFyeSArPSBzdGF0dXNlc1tzXTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdC8vIFBheW1lbnQgU3RhdHVzXHJcblx0XHRcdFx0XHRpZiAoIXRoaXMuZ2V0X2FsbFBheW1lbnRTdGF0dXNlcygpICYmIHRoaXMuZ2V0X1BheW1lbnRTdGF0dXMoKS5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0XHRcdHN1bW1hcnkgPSAoc3VtbWFyeSA/IHN1bW1hcnkgKyBcIiBhbmQgXCIgOiBcIlwiKSArIFwiT3JkZXIgaXMgXCI7XHJcblx0XHRcdFx0XHRcdHZhciBzdGF0dXNlcyA9IHRoaXMuZ2V0X1BheW1lbnRTdGF0dXMoKTtcclxuXHRcdFx0XHRcdFx0Zm9yICh2YXIgcyA9IDA7IHMgPCBzdGF0dXNlcy5sZW5ndGg7IHMrKykge1xyXG5cdFx0XHRcdFx0XHRcdGlmIChzID4gMClcclxuXHRcdFx0XHRcdFx0XHRcdHN1bW1hcnkgKz0gXCIgb3IgXCI7XHJcblx0XHRcdFx0XHRcdFx0c3VtbWFyeSArPSBzdGF0dXNlc1tzXTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdC8vIEV4cHJlc3Npb25cclxuXHRcdFx0XHRcdGlmICh0aGlzLmdldF9FeHByZXNzaW9uU3VtbWFyeSgpKVxyXG5cdFx0XHRcdFx0XHRzdW1tYXJ5ID0gdGhpcy5nZXRfRXhwcmVzc2lvblN1bW1hcnkoKSArIChzdW1tYXJ5ID8gXCIgYW5kIFwiICsgc3VtbWFyeSA6IFwiXCIpO1xyXG5cclxuXHRcdFx0XHRcdC8vIEtleXdvcmRzXHJcblx0XHRcdFx0XHRpZiAodGhpcy5nZXRfS2V5d29yZCgpKVxyXG5cdFx0XHRcdFx0XHRzdW1tYXJ5ID0gXCJBbnkgZmllbGQgY29udGFpbmluZyBcIiArIHRoaXMuZ2V0X0tleXdvcmQoKSArIChzdW1tYXJ5ID8gXCIgYW5kIFwiICsgc3VtbWFyeSA6IFwiXCIpO1xyXG5cclxuXHRcdFx0XHRcdHJldHVybiBzdW1tYXJ5O1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0b25DaGFuZ2VPZjogW1wiRXhwcmVzc2lvblN1bW1hcnlcIiwgXCJJbnZhbGlkXCIsIFwiRW50cnlTdGF0dXNcIiwgXCJQYXltZW50U3RhdHVzXCIsIFwiS2V5d29yZFwiXVxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdHR5cGUubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwic2hhcmVkV2l0aE1lXCIsIHR5cGU6IEJvb2xlYW4gfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfU2hhcmVkV2l0aE1lKCk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIEZpbHRlciBDb3VudFxyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImZpbHRlckNvdW50XCIsIHR5cGU6IE51bWJlciB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHZhciBrZXl3b3JkID0gdGhpcy5nZXRfS2V5d29yZCgpID8gMSA6IDA7XHJcblx0XHRcdFx0XHR2YXIgZXhwcmVzc2lvbnMgPSB0aGlzLmdldF9FeHByZXNzaW9uKCkgPyAxICsgKHRoaXMuZ2V0X0V4cHJlc3Npb24oKS5tYXRjaCgvIGFuZCAvZykgfHwgW10pLmxlbmd0aCArICh0aGlzLmdldF9FeHByZXNzaW9uKCkubWF0Y2goLyBvciAvZykgfHwgW10pLmxlbmd0aCA6IDA7XHJcblx0XHRcdFx0XHR2YXIgc3RhdHVzZXMgPSAodGhpcy5nZXRfRW50cnlTdGF0dXMoKS5sZW5ndGggPT0gMCB8fCB0aGlzLmdldF9hbGxFbnRyeVN0YXR1c2VzKCkgPyAwIDogMSkgKyAodGhpcy5nZXRfUGF5bWVudFN0YXR1cygpLmxlbmd0aCA9PSAwIHx8IHRoaXMuZ2V0X2FsbFBheW1lbnRTdGF0dXNlcygpID8gMCA6IDEpO1xyXG5cdFx0XHRcdFx0dmFyIHNoYXJlZFdpdGhNZSA9IHRoaXMuZ2V0X3NoYXJlZFdpdGhNZSgpID8gMSA6IDA7XHJcblx0XHRcdFx0XHRyZXR1cm4ga2V5d29yZCArIGV4cHJlc3Npb25zICsgc3RhdHVzZXMgKyBzaGFyZWRXaXRoTWU7XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRvbkNoYW5nZU9mOiBbXCJLZXl3b3JkXCIsIFwiRXhwcmVzc2lvblwiLCBcIkVudHJ5U3RhdHVzXCIsIFwiUGF5bWVudFN0YXR1c1wiLCBcInNoYXJlZFdpdGhNZVwiXVxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIEZpbHRlciBDbGFzc1xyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImZpbHRlckNsYXNzXCIsIHR5cGU6IFN0cmluZyB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHZhciBidXR0b25DbGFzcyA9IENvZ25pdG8uY29uZmlnLmZsYWdzLkFwcE5hdiA/ICd0ZXh0LWJ1dHRvbicgOiAnYy1uYXYtYnV0dG9uJztcclxuXHJcblx0XHRcdFx0XHRpZiAodGhpcy5nZXRfSW52YWxpZCgpKVxyXG5cdFx0XHRcdFx0XHRyZXR1cm4gYnV0dG9uQ2xhc3MgKyAnIGMtZmlsdGVyLWludmFsaWQnO1xyXG5cclxuXHRcdFx0XHRcdGlmICh0aGlzLmdldF9maWx0ZXJDb3VudCgpKVxyXG5cdFx0XHRcdFx0XHRyZXR1cm4gYnV0dG9uQ2xhc3MgKyAnIGMtZmlsdGVyLWFwcGxpZWQnO1xyXG5cclxuXHRcdFx0XHRcdHJldHVybiBidXR0b25DbGFzcztcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFtcImZpbHRlckNvdW50XCIsIFwiSW52YWxpZFwiXVxyXG5cdFx0XHR9KTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdC8vIEVudHJ5IFZpZXcgU29ydFxyXG5cdFx0JGV4dGVuZChcIkNvZ25pdG8uRm9ybXMuRW50cnlWaWV3U29ydFwiLCBmdW5jdGlvbiAodHlwZSkge1xyXG5cclxuXHRcdFx0Ly8gRmllbGRcclxuXHRcdFx0dHlwZS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJmaWVsZFwiLCB0eXBlOiBDb2duaXRvLkZpZWxkSW5mbyB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHZhciBmaWVsZElkID0gdGhpcy5nZXRfRmllbGRJZCgpO1xyXG5cdFx0XHRcdFx0cmV0dXJuIENvZ25pdG8uZGVzZXJpYWxpemUoQ29nbml0by5GaWVsZEluZm8sIENvZ25pdG8uRm9ybXMubW9kZWwuZmllbGRJbmZvcy5maWx0ZXIoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIGYuSWQgPT0gZmllbGRJZDsgfSlbMF0pIHx8IG51bGw7XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRvbkNoYW5nZU9mOiBcIkZpZWxkSWRcIlxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIFNvcnQgRGlyZWN0aW9uc1xyXG5cdFx0XHR0eXBlLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcInNvcnREaXJlY3Rpb25zXCIsIHR5cGU6IFN0cmluZywgaXNMaXN0OiB0cnVlIH0pLmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0dmFyIGZpZWxkID0gdGhpcy5nZXRfZmllbGQoKTtcclxuXHRcdFx0XHRcdGlmIChmaWVsZCkge1xyXG5cdFx0XHRcdFx0XHR2YXIgZmllbGRUeXBlID0gZmllbGQuZ2V0X0ZpZWxkVHlwZSgpLmdldF9OYW1lKCk7XHJcblx0XHRcdFx0XHRcdHZhciBmaWVsZFN1YlR5cGUgPSBmaWVsZC5nZXRfRmllbGRTdWJUeXBlKCkgPyBmaWVsZC5nZXRfRmllbGRTdWJUeXBlKCkuZ2V0X05hbWUoKSA6IFwiXCI7XHJcblx0XHRcdFx0XHRcdGlmIChmaWVsZFR5cGUgPT0gXCJOdW1iZXJcIiB8fCBmaWVsZFR5cGUgPT0gXCJDdXJyZW5jeVwiIHx8IGZpZWxkU3ViVHlwZSA9PSBcIkN1cnJlbmN5XCIgfHwgZmllbGRTdWJUeXBlID09IFwiRGVjaW1hbFwiKVxyXG5cdFx0XHRcdFx0XHRcdHJldHVybiBbXCIwIC0gOVwiLCBcIjkgLSAwXCJdO1xyXG5cdFx0XHRcdFx0XHRpZiAoZmllbGRTdWJUeXBlID09IFwiRGF0ZVwiIHx8IGZpZWxkU3ViVHlwZSA9PSBcIlRpbWVcIiB8fCBmaWVsZFN1YlR5cGUgPT0gXCJEYXRlVGltZVwiKVxyXG5cdFx0XHRcdFx0XHRcdHJldHVybiBbXCJPbGRlc3QgdG8gTmV3ZXN0XCIsIFwiTmV3ZXN0IHRvIE9sZGVzdFwiXTtcclxuXHRcdFx0XHRcdFx0ZWxzZSBpZiAoZmllbGRUeXBlID09IFwiU2lnbmF0dXJlXCIpXHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIFtcIlVuc2lnbmVkLCBTaWduZWRcIiwgXCJTaWduZWQsIFVuc2lnbmVkXCJdO1xyXG5cdFx0XHRcdFx0XHRlbHNlIGlmIChmaWVsZFR5cGUgPT0gXCJGaWxlXCIpXHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIFtcIk5vbmUgdG8gTW9zdFwiLCBcIk1vc3QgdG8gTm9uZVwiXTtcclxuXHRcdFx0XHRcdFx0ZWxzZSBpZiAoZmllbGRUeXBlID09IFwiWWVzTm9cIiB8fCBmaWVsZFN1YlR5cGUgPT0gXCJZZXNOb1wiICYmIGZpZWxkLmdldF9DaG9pY2VzKCkgJiYgZmllbGQuZ2V0X0Nob2ljZXMubGVuZ3RoID09IDIpIHtcclxuXHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIFtmaWVsZC5nZXRfQ2hvaWNlcygpWzFdLmdldF9MYWJlbCgpICsgXCIsIHRoZW4gXCIgKyBmaWVsZC5nZXRfQ2hvaWNlcygpWzBdLmdldF9MYWJlbCgpLCBmaWVsZC5nZXRfQ2hvaWNlcygpWzBdLmdldF9MYWJlbCgpICsgXCIsIHRoZW4gXCIgKyBmaWVsZC5nZXRfQ2hvaWNlcygpWzFdLmdldF9MYWJlbCgpXTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIFtcIkEgLSBaXCIsIFwiWiAtIEFcIl07XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRyZXR1cm4gW107XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRvbkNoYW5nZU9mOiBcImZpZWxkXCJcclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0fSk7XHJcblxyXG5cdFx0Ly8gRm9ybVxyXG5cdFx0JGV4dGVuZChcIkNvZ25pdG8uRm9ybXMuRm9ybVwiLCBmdW5jdGlvbiAoZm9ybSkge1xyXG5cclxuXHRcdFx0Zm9ybS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJ3b3JrZmxvd0FjdGlvbnNMaXN0XCIsIHR5cGU6IE9iamVjdCwgaXNMaXN0OiB0cnVlIH0pXHJcblx0XHRcdFx0LmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdHZhciBhY3Rpb25zID0gdGhpcy5nZXRfQWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7XHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIGFjdGlvbi5nZXRfSXNBcmNoaXZlZCgpICE9PSB0cnVlO1xyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0XHRcdHJldHVybiBhY3Rpb25zLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7XHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHtcclxuXHRcdFx0XHRcdFx0XHRcdElkOiBhY3Rpb24uZ2V0X0lkKCksXHJcblx0XHRcdFx0XHRcdFx0XHRBY3Rpb25OYW1lOiBhY3Rpb24uZ2V0X0FjdGlvbk5hbWUoKSxcclxuXHRcdFx0XHRcdFx0XHRcdEFsbG93ZWRXaGVuOiBhY3Rpb24uZ2V0X0FsbG93ZWRXaGVuKCksXHJcblx0XHRcdFx0XHRcdFx0XHRCdXR0b25UZXh0OiBhY3Rpb24uZ2V0X0J1dHRvblRleHQoKSxcclxuXHRcdFx0XHRcdFx0XHRcdE5ld1N0YXR1czogYWN0aW9uLmdldF9OZXdTdGF0dXMoKSxcclxuXHRcdFx0XHRcdFx0XHRcdENvbmZpcm1hdGlvbjogYWN0aW9uLmdldF9Db25maXJtYXRpb24oKSxcclxuXHRcdFx0XHRcdFx0XHRcdEVtYWlsczogYWN0aW9uLmdldF9FbWFpbHMoKSxcclxuXHRcdFx0XHRcdFx0XHRcdElzQXJjaGl2ZWQ6IGFjdGlvbi5nZXRfSXNBcmNoaXZlZCgpLFxyXG5cdFx0XHRcdFx0XHRcdFx0RmllbGRzVG9DbGVhcjogYWN0aW9uLmdldF9GaWVsZHNUb0NsZWFyKCksXHJcblx0XHRcdFx0XHRcdFx0XHRQcmVmaWxsQ29uZmlnczogYWN0aW9uLmdldF9QcmVmaWxsQ29uZmlncygpXHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdGZvcm0ubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwicm9sZU9wdGlvbnNcIiwgdHlwZTogT2JqZWN0LCBpc0xpc3Q6IHRydWUgfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gQ29nbml0by5zZXJpYWxpemUodGhpcy5nZXRfUm9sZXMoKSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdGZvcm0ubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwiZW50cmllc1NlbGVjdGVkXCIsIHR5cGU6IEJvb2xlYW4gfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gc2VsZWN0ZWRFbnRyaWVzLmxlbmd0aCA+IDA7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdGZvcm0ubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwiZW50cnlEZXRhaWxzT3BlblwiLCB0eXBlOiBCb29sZWFuIH0pO1xyXG5cclxuXHRcdFx0Zm9ybS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJzZWxlY3RlZEVudHJpZXNMaW1pdGVkXCIsIHR5cGU6IE9iamVjdCwgaXNMaXN0OiB0cnVlIH0pO1xyXG5cclxuXHRcdFx0Zm9ybS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJkb2N1bWVudFRlbXBsYXRlc1wiLCB0eXBlOiBPYmplY3QsIGlzTGlzdDogdHJ1ZSB9KVxyXG5cdFx0XHRcdC5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRcdGNhbGN1bGF0ZTogZnVuY3Rpb24gY2FsY3VsYXRlJGRvY3VtZW50VGVtcGxhdGVzKCkge1xyXG5cdFx0XHRcdFx0XHRyZXR1cm4gdGhpcy5nZXRfRG9jdW1lbnRUZW1wbGF0ZXMoKS5tYXAoZnVuY3Rpb24gKGQpIHtcclxuXHRcdFx0XHRcdFx0XHR2YXIgZG9jdW1lbnQgPSBDb2duaXRvLnNlcmlhbGl6ZShkKTtcclxuXHRcdFx0XHRcdFx0XHRkb2N1bWVudC5EZXNjcmlwdGlvbiA9IGQuZ2V0X2Rlc2NyaXB0aW9uKCk7XHJcblx0XHRcdFx0XHRcdFx0ZG9jdW1lbnQuTmFtZUh0bWwgPSBkLmdldF9uYW1lSHRtbCgpO1xyXG5cdFx0XHRcdFx0XHRcdHJldHVybiBkb2N1bWVudDtcclxuXHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0b25DaGFuZ2VPZjogWydEb2N1bWVudFRlbXBsYXRlc3tOdW1iZXIsTmFtZSxEZXNjcmlwdGlvbixPdXRwdXRUeXBlfSddXHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHRmb3JtLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImlzTW9iaWxlXCIsIHR5cGU6IEJvb2xlYW4gfSkuZGVmYXVsdFZhbHVlKGZ1bmN0aW9uICgpIHsgcmV0dXJuIGlzTW9iaWxlLnZhbHVlOyB9KTtcclxuXHRcdFx0VnVlLndhdGNoKGlzTW9iaWxlLCAoKSA9PiB7XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5zZXRfaXNNb2JpbGUoaXNNb2JpbGUudmFsdWUpO1xyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIEFwcE5hdiBMaW1pdGVkIEFjY2VzcyBNb2JpbGUgdmVyc2lvbiBvZiBhY3Rpb25zIGJ1dHRvbiBsaXZlcyBpbiBFbnRyaWVzUGFnZS52dWVcclxuXHRcdFx0Zm9ybS5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJzaG93QWN0aW9uc0J1dHRvblwiLCB0eXBlOiBCb29sZWFuIH0pXHJcblx0XHRcdFx0LmNhbGN1bGF0ZWQoe1xyXG5cdFx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdHJldHVybiAhaXNMaW1pdGVkQWNjZXNzLnZhbHVlIHx8ICFpc01vYmlsZS52YWx1ZTtcclxuXHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRvbkNoYW5nZU9mOiBbXCJpc01vYmlsZSwgaXNMaW1pdGVkQWNjZXNzXCJdXHJcblx0XHRcdFx0fSlcclxuXHRcdH0pXHJcblxyXG5cdFx0JGV4dGVuZChbXCJDb2duaXRvLkZvcm1zLkVudHJ5Vmlld1wiLCBcIkNvZ25pdG8uRm9ybXMuRm9ybVwiXSwgZnVuY3Rpb24gKHZpZXcsIGZvcm0pIHtcclxuXHRcdFx0dmFyIGlzVXNlclNwZWNpZmljUHJvcCA9IHZpZXcubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwiaXNVc2VyU3BlY2lmaWNcIiwgdHlwZTogQm9vbGVhbiwgb3JpZ2luOiBcInNlcnZlclwiIH0pLmRlZmF1bHRWYWx1ZShmYWxzZSk7XHJcblx0XHRcdGlzVXNlclNwZWNpZmljUHJvcC5fb3JpZ2luID0gXCJzZXJ2ZXJcIjtcclxuXHRcdFx0aXNVc2VyU3BlY2lmaWNQcm9wLl9pc1BlcnNpc3RlZCA9IHRydWU7XHJcblxyXG5cdFx0XHRmb3JtLm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcInNlbGVjdGVkRW50cmllc1wiLCB0eXBlOiBPYmplY3QsIGlzTGlzdDogdHJ1ZSB9KTtcclxuXHJcblx0XHRcdGZvcm0ubWV0YS5hZGRQcm9wZXJ0eSh7IG5hbWU6IFwiY2FuTWFuYWdlRW50cmllc1wiLCB0eXBlOiBCb29sZWFuIH0pLmRlZmF1bHRWYWx1ZShmdW5jdGlvbiAoKSB7IHJldHVybiBjYW5NYW5hZ2VFbnRyaWVzLnZhbHVlOyB9KTtcclxuXHRcdFx0VnVlLndhdGNoKGNhbk1hbmFnZUVudHJpZXMsICgpID0+IHtcclxuXHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLnNldF9jYW5NYW5hZ2VFbnRyaWVzKGNhbk1hbmFnZUVudHJpZXMudmFsdWUpO1xyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdFZ1ZS53YXRjaChpc0Fzc2lnbmVkVmlldywgKCkgPT4ge1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIuZGV0YWlsLnNldElzQXNzaWduZWRFbnRyeShpc0Fzc2lnbmVkVmlldy52YWx1ZSk7XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0dmlldy5tZXRhLmFkZFByb3BlcnR5KHsgbmFtZTogXCJmb3JtXCIsIHR5cGU6IENvZ25pdG8uRm9ybXMuRm9ybSB9KS5jYWxjdWxhdGVkKHtcclxuXHRcdFx0XHRjYWxjdWxhdGU6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHJldHVybiBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0XHR2aWV3Lm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcIm5vVmlld0NoYW5nZXNcIiwgdHlwZTogQm9vbGVhbiB9KS5kZWZhdWx0VmFsdWUodHJ1ZSk7XHJcblxyXG5cdFx0XHR2aWV3Lm1ldGEuYWRkUHJvcGVydHkoeyBuYW1lOiBcImhhc1ZpZXdDaGFuZ2VzXCIsIHR5cGU6IEJvb2xlYW4gfSkuY2FsY3VsYXRlZCh7XHJcblx0XHRcdFx0Y2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gIXRoaXMuZ2V0X25vVmlld0NoYW5nZXMoKTtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdG9uQ2hhbmdlT2Y6IFtcIm5vVmlld0NoYW5nZXNcIl1cclxuXHRcdFx0fSk7XHJcblx0XHR9KVxyXG5cclxuXHRcdC8vI2VuZHJlZ2lvblxyXG5cclxuXHRcdC8vI3JlZ2lvbiBNZW51XHJcblxyXG5cdFx0Ly8gU2hvdyBNZW51XHJcblx0XHRmdW5jdGlvbiBzaG93TWVudShhY3Rpb24sIGRlbHRhKSB7XHJcblx0XHRcdHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHR2YXIgbWVudSA9IGFjdGlvbi5maW5kKFwiPiAuYy1uYXYtbWVudVwiKTtcclxuXHRcdFx0XHR2YXIgY29udGVudCA9IG1lbnUuZmluZChcIj4gLmMtbmF2LW1lbnUtY29udGVudFwiKTtcclxuXHRcdFx0XHR2YXIgbWVudVN0eWxlcyA9IGdldENvbXB1dGVkU3R5bGUoY29udGVudFswXSk7XHJcblx0XHRcdFx0dmFyIG1lbnVQYWRkaW5nID0gcGFyc2VJbnQobWVudVN0eWxlcy5wYWRkaW5nVG9wKSArIHBhcnNlSW50KG1lbnVTdHlsZXMucGFkZGluZ0JvdHRvbSk7XHJcblx0XHRcdFx0dmFyIG1lbnVIZWlnaHQgPSBjb250ZW50LmhlaWdodCgpICsgbWVudVBhZGRpbmcgKyAoZGVsdGEgfHwgMCk7XHJcblx0XHRcdFx0dmFyIG1heEhlaWdodCA9IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0IC0gMTEwO1xyXG5cdFx0XHRcdHZhciBsZWZ0ID0gYWN0aW9uLm9mZnNldCgpLmxlZnQ7XHJcblx0XHRcdFx0dmFyIHdpZHRoID0gbWVudS53aWR0aCgpO1xyXG5cdFx0XHRcdHZhciBtYXhXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xyXG5cdFx0XHRcdGxlZnQgPSBsZWZ0ICsgd2lkdGggPCBtYXhXaWR0aCA/IDAgOiBNYXRoLm1heCgtbGVmdCwgbWF4V2lkdGggLSB3aWR0aCAtIGxlZnQpO1xyXG5cdFx0XHRcdGFjdGlvbi5hZGRDbGFzcyhcImMtbWVudS1leHBhbmRlZFwiKTtcclxuXHRcdFx0XHRtZW51LmFkZENsYXNzKFwiYy1tZW51LW9wZW5cIikuY3NzKFwibGVmdFwiLCBsZWZ0ICsgXCJweFwiKS5jc3MoXCJ0cmFuc2l0aW9uXCIsIFwibWF4LWhlaWdodCAwLjNzIGVhc2VcIikuY3NzKFwibWF4LXdpZHRoXCIsIE1hdGgubWluKHdpZHRoLCBtYXhXaWR0aCkgKyBcInB4XCIpLmNzcyhcIm1heC1oZWlnaHRcIiwgTWF0aC5taW4obWVudUhlaWdodCwgbWF4SGVpZ2h0KSArIFwicHhcIikuY3NzKFwib3ZlcmZsb3cteVwiLCBtZW51SGVpZ2h0ID4gbWF4SGVpZ2h0ID8gXCJhdXRvXCIgOiBcImhpZGRlblwiKTtcclxuXHJcblx0XHRcdFx0Ly8gQWxzbyByZXNpemUgdGhlIHBhcmVudCBtZW51XHJcblx0XHRcdFx0dmFyIHBhcmVudCA9IGFjdGlvbi5wYXJlbnQoKS5jbG9zZXN0KFwiLmMtbmF2LWFjdGlvblwiKTtcclxuXHRcdFx0XHRpZiAocGFyZW50Lmxlbmd0aCA+IDApXHJcblx0XHRcdFx0XHRzaG93TWVudShwYXJlbnQsIG1lbnVIZWlnaHQpO1xyXG5cclxuXHRcdFx0XHQvL1NldCB6LWluZGV4IG9mIGVudHJ5IGxpc3QgZ3JpZCB0byAtMSB0byBwcmV2ZW50IHNjcm9sbGluZyBpc3N1ZXMgaW4gZWRnZVxyXG5cdFx0XHRcdCQoXCIjYy1lbnRyeWxpc3RcIikuYWRkQ2xhc3MoXCJjLWVudHJpZXMtb3Blbi1tZW51XCIpO1xyXG5cclxuXHRcdFx0fSwgMCk7XHJcblx0XHR9XHJcblxyXG5cdFx0JChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpXHJcblxyXG5cdFx0XHQvLyBIaWRlL1Nob3cgY29udGV4dCBtZW51c1xyXG5cdFx0XHQub24oXCJjbGlja1wiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHJcblx0XHRcdFx0aWYgKCFldmVudC5vcmlnaW5hbEV2ZW50IHx8IGV2ZW50Lm9yaWdpbmFsRXZlbnQuZGlhbG9nIHx8IGV2ZW50LmRpYWxvZylcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHJcblx0XHRcdFx0dmFyIGlzTWVudUJ1dHRvbiA9ICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KENvZ25pdG8uY29uZmlnLmZsYWdzLkFwcE5hdiA/IFwiLnRleHQtYnV0dG9uXCIgOiBcIi5jLW5hdi1idXR0b25cIikubm90KFwiLmMtbmF2LWRpc2FibGVkXCIpLm5leHQoXCIuYy1uYXYtbWVudVwiKS5sZW5ndGggPiAwO1xyXG5cclxuXHRcdFx0XHQvLyBDbG9zZSBhbGwgbWVudXMgaWYgdGhlIHRhcmdldCBpcyBhIG1lbnUgYnV0dG9uIG9yIHRoZSBjbGljayBpcyBub3QgaW5zaWRlIGEgbWVudVxyXG5cdFx0XHRcdGlmIChpc01lbnVCdXR0b24gfHwgKCQoZXZlbnQudGFyZ2V0KS5wYXJlbnRzKFwiLmMtbWVudS1vcGVuXCIpLmxlbmd0aCA9PSAwICYmICQuY29udGFpbnMoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBldmVudC50YXJnZXQpKSlcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblxyXG5cdFx0XHRcdC8vIE9wZW4gdGhlIG1lbnUgd2hlbiBhIG1lbnUgYnV0dG9uIGlzIGNsaWNrZWRcclxuXHRcdFx0XHRpZiAoaXNNZW51QnV0dG9uKSB7XHJcblxyXG5cdFx0XHRcdFx0Ly8gQ2FsY3VsYXRlIE1lbnUgU2l6ZSBhbmQgUG9zaXRpb25cclxuXHRcdFx0XHRcdHZhciBhY3Rpb24gPSAkKGV2ZW50LnRhcmdldCkucGFyZW50cyhcIi5jLW5hdi1hY3Rpb25cIik7XHJcblxyXG5cdFx0XHRcdFx0Ly8gT25seSBvcGVuIG1lbnVzIHRoYXQgYXJlIGN1cnJlbnRseSBjbG9zZWRcclxuXHRcdFx0XHRcdGlmICgkKGV2ZW50LnRhcmdldCkuY2xvc2VzdChcIi5jLW5hdi1hY3Rpb25cIikuZmluZChcIi5jLW5hdi1tZW51XCIpLmNzcyhcIm1heC1oZWlnaHRcIikgIT0gXCIwcHhcIilcclxuXHRcdFx0XHRcdFx0YWN0aW9uID0gJChldmVudC50YXJnZXQpLmNsb3Nlc3QoXCIuYy1uYXYtYWN0aW9uXCIpLnBhcmVudHMoXCIuYy1uYXYtYWN0aW9uXCIpO1xyXG5cdFx0XHRcdFx0aWYgKGFjdGlvbi5sZW5ndGggPT0gMClcclxuXHRcdFx0XHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdFx0XHRcdC8vIENvbHVtbnMgTWVudSBJbml0aWFsaXphdGlvblxyXG5cdFx0XHRcdFx0aWYgKGFjdGlvbi5pcyhcIi5jLWNvbHVtbnNcIikpXHJcblx0XHRcdFx0XHRcdHJlZnJlc2hDb2x1bW5NZW51KCk7XHJcblxyXG5cdFx0XHRcdFx0Ly8gU29ydCBNZW51IEluaXRpYWxpemF0aW9uXHJcblx0XHRcdFx0XHRpZiAoYWN0aW9uLmlzKFwiLmMtc29ydFwiKSkge1xyXG5cdFx0XHRcdFx0XHR2YXIgYXZhaWxhYmxlQ29sdW1ucyA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X0NvbHVtbnMoKS5zbGljZSgpO1xyXG5cdFx0XHRcdFx0XHRhdmFpbGFibGVDb2x1bW5zLnVuc2hpZnQobmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3Q29sdW1uKHsgRmllbGRJZDogXCJFbnRyeS5OdW1iZXJcIiwgV2lkdGg6IDUwIH0pKTtcclxuXHRcdFx0XHRcdFx0YXZhaWxhYmxlQ29sdW1ucy5hZGRSYW5nZShDb2duaXRvLkZvcm1zLm1vZGVsLmZpZWxkSW5mb3NcclxuXHRcdFx0XHRcdFx0XHQuZmlsdGVyKGZ1bmN0aW9uIChmaWVsZCkgeyByZXR1cm4gZmllbGQuSWQgIT0gXCJFbnRyeS5OdW1iZXJcIiAmJiAhZmllbGQuSWQuaW5jbHVkZXMoJy4nKSAmJiBmaWVsZC5GaWVsZFR5cGUgIT09IFwiRW50aXR5XCIgJiYgZmllbGQuRmllbGRUeXBlICE9PSBcIkVudGl0eUxpc3RcIiAmJiAhYXZhaWxhYmxlQ29sdW1ucy5zb21lKGZ1bmN0aW9uIChjb2x1bW4pIHsgcmV0dXJuIGNvbHVtbi5nZXRfRmllbGRJZCgpID09IGZpZWxkLklkOyB9KTsgfSlcclxuXHRcdFx0XHRcdFx0XHQubWFwKGZ1bmN0aW9uIChmaWVsZCkgeyByZXR1cm4gbmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3Q29sdW1uKHsgRmllbGRJZDogZmllbGQuSWQsIFdpZHRoOiBmaWVsZC5XaWR0aCB9KTsgfSkpO1xyXG5cdFx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LnNldF9hdmFpbGFibGVDb2x1bW5zKGF2YWlsYWJsZUNvbHVtbnMpO1xyXG5cdFx0XHRcdFx0XHRFeG9XZWIuT2JzZXJ2ZXIuc2V0VmFsdWUoQ29nbml0by5Gb3Jtcy5tb2RlbCwgXCJzb3J0QnlcIiwgRXhvV2ViLk9ic2VydmVyLm1ha2VPYnNlcnZhYmxlKENvZ25pdG8uZGVzZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdTb3J0LCBDb2duaXRvLnNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Tb3J0QnkoKSkpKSk7XHJcblx0XHRcdFx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLnNvcnRCeS5sZW5ndGggPT0gMClcclxuXHRcdFx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLnNvcnRCeS5hZGQobmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3U29ydCh7IEFzY2VuZGluZzogdHJ1ZSB9KSk7XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0Ly8gRmlsdGVyIE1lbnUgSW5pdGlhbGl6YXRpb25cclxuXHRcdFx0XHRcdGlmIChhY3Rpb24uaXMoXCIuYy1maWx0ZXJcIikpIHtcclxuXHRcdFx0XHRcdFx0RXhvV2ViLk9ic2VydmVyLnNldFZhbHVlKENvZ25pdG8uRm9ybXMubW9kZWwsIFwiZmlsdGVyXCIsIENvZ25pdG8uZGVzZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdGaWx0ZXIsIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoQ29nbml0by5zZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfRmlsdGVyKCkgfHwgbmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3RmlsdGVyKHsgYWxsRW50cnlTdGF0dXNlczogdHJ1ZSwgYWxsUGF5bWVudFN0YXR1c2VzOiB0cnVlIH0pKSkpKSk7XHJcblx0XHRcdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwuZmlsdGVyLnNldF9FeHByZXNzaW9uU3VtbWFyeShDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9GaWx0ZXIoKS5nZXRfRXhwcmVzc2lvblN1bW1hcnkoKSk7XHJcblx0XHRcdFx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfRW50cnlTdGF0dXMoKS5sZW5ndGggPT0gMClcclxuXHRcdFx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfRW50cnlTdGF0dXMoKS5hZGRSYW5nZShDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfYWxsb3dlZEVudHJ5U3RhdHVzZXMoKSk7XHJcblx0XHRcdFx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfUGF5bWVudFN0YXR1cygpLmxlbmd0aCA9PSAwKVxyXG5cdFx0XHRcdFx0XHRcdENvZ25pdG8uRm9ybXMubW9kZWwuZmlsdGVyLmdldF9QYXltZW50U3RhdHVzKCkuYWRkUmFuZ2UoQ29nbml0by5Gb3Jtcy5tb2RlbC5maWx0ZXIuZ2V0X2FsbG93ZWRQYXltZW50U3RhdHVzZXMoKSk7XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0Ly8gU2hvdyBNZW51XHJcblx0XHRcdFx0XHRzaG93TWVudShhY3Rpb24pO1xyXG5cdFx0XHRcdFx0aWYgKGFjdGlvbi5wYXJlbnRzKFwiLmMtbmF2LWFjdGlvblwiKS5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0XHRcdGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdFx0XHRcdFx0XHRzaG93TWVudShhY3Rpb24ucGFyZW50cyhcIi5jLW5hdi1hY3Rpb25cIikpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0Ly8jZW5kcmVnaW9uXHJcblxyXG5cdFx0Ly8jcmVnaW9uIFV0aWxpdHkgRnVuY3Rpb25zXHJcblxyXG5cdFx0Ly8gRXhlY3V0ZXMgYW4gYWN0aW9uIGlmIHRoZXJlIGFyZSBubyBwZW5kaW5nIGNoYW5nZXMsIG90aGVyd2lzZVxyXG5cdFx0Ly8gcXVldWUgdGhlIGFjdGlvbiB0byBiZSBleGVjdXRlZCBhZnRlciB0aGUgY2hhbmdlcyBoYXZlIGJlZW4gY29uZmlybWVkXHJcblx0XHRmdW5jdGlvbiBleGVjdXRlQWN0aW9uKGFjdGlvbiwgdGhpc1B0cikge1xyXG5cclxuXHRcdFx0Ly8gUXVldWUgdGhlIGFjdGlvbiBpZiBwcm92aWRlZFxyXG5cdFx0XHRpZiAoYWN0aW9uKVxyXG5cdFx0XHRcdHBlbmRpbmdBY3Rpb24gPSBmdW5jdGlvbiAoKSB7IGFjdGlvbi5hcHBseSh0aGlzUHRyIHx8IHRoaXMpIH07XHJcblxyXG5cdFx0XHQvLyBJZiBhbiBlbnRyeSBoYXMgY2hhbmdlcyB0aGVuIHByb21wdCB0aGUgdXNlciBvZiB1bnNhdmVkIGNoYW5nZXMsIGlmIHRoZXJlIGlzIG5vIHN1Ym1pc3Npb24gYmVpbmcgcGVyZm9ybWVkXHJcblx0XHRcdGlmIChlbnRyeUhhc0NoYW5nZXMpIHtcclxuXHRcdFx0XHRpZiAoIXBlcmZvcm1pbmdTdWJtaXQpXHJcblx0XHRcdFx0XHRDb2duaXRvLm5hdmlnYXRlKCk7XHJcblx0XHRcdH1cclxuXHRcdFx0Ly8gT3RoZXJ3aXNlLCBleGVjdXRlIHRoZSBwZW5kaW5nIGFjdGlvblxyXG5cdFx0XHRlbHNlIGlmIChwZW5kaW5nQWN0aW9uKSB7XHJcblx0XHRcdFx0cGVuZGluZ0FjdGlvbigpO1xyXG5cdFx0XHRcdHBlbmRpbmdBY3Rpb24gPSBudWxsO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gU29ydCB2aWV3cyBhbHBoYWJldGljYWxseSB3aXRoIHRoZSBjdXJyZW50IHZpZXcgb24gdG9wXHJcblx0XHRmdW5jdGlvbiByZW9yZGVyVmlld3MoKSB7XHJcblx0XHRcdHZhciBjdXJyZW50VmlldyA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXc7XHJcblx0XHRcdHZhciB2aWV3cyA9IENvZ25pdG8uRm9ybXMubW9kZWwudmlld3M7XHJcblxyXG5cdFx0XHQvLyBSZW1vdmUgY3VycmVudCB2aWV3XHJcblx0XHRcdHZhciB2aWV3cyA9IHZpZXdzLmZpbHRlcihmdW5jdGlvbiAodikgeyByZXR1cm4gdiAhPSBjdXJyZW50VmlldzsgfSk7XHJcblxyXG5cdFx0XHQvLyBTb3J0IHRoZSB2aWV3cyBhbHBoYWJldGljYWxseSBieSBuYW1lXHJcblx0XHRcdHZhciB2aWV3cyA9ICR0cmFuc2Zvcm0odmlld3MpLm9yZGVyQnkoXCJOYW1lXCIpO1xyXG5cclxuXHRcdFx0Ly8gQWRkIGN1cnJlbnQgdmlldyB0byB0aGUgYmVnaW5uaW5nXHJcblx0XHRcdHZpZXdzLnVuc2hpZnQoY3VycmVudFZpZXcpO1xyXG5cclxuXHRcdFx0Ly8gVXBkYXRlIHRoZSB2aWV3c1xyXG5cdFx0XHRFeG9XZWIudXBkYXRlQXJyYXkoQ29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cywgdmlld3MpO1xyXG5cclxuXHRcdFx0cmV0dXJuIENvZ25pdG8uRm9ybXMubW9kZWwudmlld3M7XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gVXBkYXRlIHRoZSBuYXZpZ2F0aW9uIHRvIHJlZmxlY3QgdGhlIGN1cnJlbnQgdmlldyBhbmQgc2VsZWN0ZWQgZW50cnlcclxuXHRcdGZ1bmN0aW9uIHVwZGF0ZU5hdmlnYXRpb24odmlldywgcXVlcnkpIHtcclxuXHRcdFx0dmFyIGZvcm0gPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtO1xyXG5cdFx0XHR2YXIgZm9ybU5hbWUgPSBmb3JtLmdldF9Mb3dlcmVkSW50ZXJuYWxOYW1lKCk7XHJcblx0XHRcdGlmICghdmlldylcclxuXHRcdFx0XHR2aWV3ID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50VmlldztcclxuXHRcdFx0dmFyIHZpZXdJZCA9IHZpZXcuZ2V0X0lkKCkuc3BsaXQoJy0nKVsxXTtcclxuXHRcdFx0dmFyIHZpZXdOYW1lID0gdmlldy5nZXRfSW50ZXJuYWxOYW1lKCk7XHJcblx0XHRcdHZhciBlbnRyeU51bWJlciA9IGN1cnJlbnRFbnRyeUtleSA9PSBudWxsID8gXCJcIiA6IChjdXJyZW50RW50cnlLZXkuRW50cnlJZC5zcGxpdCgnLScpWzFdICsgKGN1cnJlbnRFbnRyeUtleS5TY29wZSA/IFwiLlwiICsgY3VycmVudEVudHJ5S2V5LlNjb3BlIDogXCJcIikpO1xyXG5cdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLnNldF9lbnRyeURldGFpbHNPcGVuKGVudHJ5TnVtYmVyICE9PSBcIlwiKTtcclxuXHJcblx0XHRcdHZhciBuYXYgPSBDb2duaXRvLmNvbmZpZy5uYXZpZ2F0aW9uO1xyXG5cclxuXHRcdFx0dmFyIGVudHJpZXNVcmwgPSAodmlld0lkICYmIHZpZXdJZCAhPSBcIjBcIiA/IFwiL1wiICsgdmlld0lkICsgXCItXCIgKyB2aWV3TmFtZSA6IFwiXCIpICsgKGVudHJ5TnVtYmVyID8gXCIvXCIgKyBlbnRyeU51bWJlciA6IFwiXCIpICsgKHF1ZXJ5ID8gXCI/XCIgKyBxdWVyeSA6IFwiXCIpO1xyXG5cdFx0XHRpZiAoIUNvZ25pdG8uY29uZmlnLmZsYWdzLkFwcE5hdilcclxuXHRcdFx0XHRlbnRyaWVzVXJsID0gXCIvZW50cmllc1wiICsgZW50cmllc1VybDtcclxuXHRcdFx0ZWxzZSBpZiAoIUNvZ25pdG8uY29uZmlnLmhhc1BhaWRQbGFuKVxyXG5cdFx0XHRcdGVudHJpZXNVcmwgPSAnL2VudHJpZXMnO1xyXG5cclxuXHRcdFx0dmFyIG9yZ0NvZGUgPSBcIi9cIiArIENvZ25pdG8uY29uZmlnLmxvd2VyT3JnYW5pemF0aW9uQ29kZSArIFwiL1wiO1xyXG5cdFx0XHRuYXYudXJsID0gb3JnQ29kZSArIGZvcm1OYW1lICsgZW50cmllc1VybDtcclxuXHRcdFx0bmF2LnByaW1hcnlbMF0udXJsID0gb3JnQ29kZSArIGZvcm1OYW1lICsgXCIvYnVpbGRcIjtcclxuXHRcdFx0bmF2LnByaW1hcnlbMF0udGl0bGUgPSBmb3JtLmdldF9OYW1lKCk7XHJcblx0XHRcdGZvciAodmFyIHAgPSAwOyBwIDwgbmF2LnNlY29uZGFyeS5sZW5ndGg7IHArKylcclxuXHRcdFx0XHRuYXYuc2Vjb25kYXJ5W3BdLnVybCA9IG9yZ0NvZGUgKyBmb3JtTmFtZSArIG5hdi5zZWNvbmRhcnlbcF0udXJsLnN1YnN0cihuYXYuc2Vjb25kYXJ5W3BdLnVybC5sYXN0SW5kZXhPZignLycpKTtcclxuXHJcblx0XHRcdENvZ25pdG8uTWVzc2FnaW5nLnRyaWdnZXIoeyBldmVudDogXCJuYXZpZ2F0ZVwiLCBkYXRhOiBuYXYgfSk7XHJcblx0XHR9XHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5nZW5lcmF0ZVRva2VucyA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0dmFyIHRva2VucyA9IFtdO1xyXG5cclxuXHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC5maWVsZEluZm9zLmZvckVhY2goZnVuY3Rpb24gKGYpIHtcclxuXHRcdFx0XHRpZiAoZi5GaWVsZFR5cGUpIHtcclxuXHRcdFx0XHRcdHZhciBmaWVsZFR5cGUgPSBmLkZpZWxkVHlwZTtcclxuXHRcdFx0XHRcdGlmIChmaWVsZFR5cGUgIT09IFwiU2lnbmF0dXJlXCIgJiYgZmllbGRUeXBlICE9PSBcIkZpbGVcIikge1xyXG5cdFx0XHRcdFx0XHR2YXIgaGllcmFyY2h5TGV2ZWwgPSBmLlBhdGguc3BsaXQoJy4nKS5sZW5ndGggLSAxO1xyXG5cdFx0XHRcdFx0XHR2YXIgaW5kZW50YXRpb24gPSBcIlwiO1xyXG5cdFx0XHRcdFx0XHRmb3IgKHZhciBpID0gMDsgaSA8IGhpZXJhcmNoeUxldmVsOyBpKyspXHJcblx0XHRcdFx0XHRcdFx0aW5kZW50YXRpb24gKz0gXCLCoMKgwqDCoFwiO1xyXG5cclxuXHRcdFx0XHRcdFx0dmFyIGludGVybmFsTmFtZSA9IGYuUGF0aDtcclxuXHJcblx0XHRcdFx0XHRcdGlmIChmaWVsZFR5cGUgPT09IFwiUmF0aW5nU2NhbGVcIiB8fCBmaWVsZFR5cGUgPT09IFwiRW50aXR5XCIgfHwgZmllbGRUeXBlID09PSBcIkVudGl0eUxpc3RcIikge1xyXG5cdFx0XHRcdFx0XHRcdGludGVybmFsTmFtZSA9IFwiXCI7XHJcblx0XHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRcdHZhciBpc1Byb3RlY3RlZCA9IGYuSXNQcm90ZWN0ZWQ7XHJcblx0XHRcdFx0XHRcdGlmIChmLlNjb3BlICE9PSAnRW50cnknKSB7IC8vIEVudHJ5IHRva2VucyBhcmUgYWRkZWQgYXQgdGhlIGVuZCBvZiB0aGlzIGZ1bmN0aW9uXHJcblx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goe1xyXG5cdFx0XHRcdFx0XHRcdFx0TmFtZTogZi5OYW1lLFxyXG5cdFx0XHRcdFx0XHRcdFx0SW50ZXJuYWxOYW1lOiBpbnRlcm5hbE5hbWUsXHJcblx0XHRcdFx0XHRcdFx0XHRQYXRoOiBpbmRlbnRhdGlvbiArIGYuTmFtZSxcclxuXHRcdFx0XHRcdFx0XHRcdEZpZWxkVHlwZTogZmllbGRUeXBlLFxyXG5cdFx0XHRcdFx0XHRcdFx0SXNQcm90ZWN0ZWQ6IGlzUHJvdGVjdGVkLFxyXG5cdFx0XHRcdFx0XHRcdFx0RmllbGRQYXRoOiBmLlBhdGhcclxuXHRcdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdFx0dmFyIHBhdGggPSBpbnRlcm5hbE5hbWUgKyBcIi5cIjtcclxuXHJcblx0XHRcdFx0XHRcdGlmIChmaWVsZFR5cGUgPT09IFwiTmFtZVwiKSB7XHJcblx0XHRcdFx0XHRcdFx0aW5kZW50YXRpb24gKz0gXCLCoMKgwqDCoFwiO1xyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAoZi5Gb3JtYXQuaW5kZXhPZihcIlByZWZpeFwiKSA+IC0xKVxyXG5cdFx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIlRpdGxlXCIsIEludGVybmFsTmFtZTogcGF0aCArIFwiUHJlZml4XCIsIEZpZWxkUGF0aDogcGF0aCArIFwiUHJlZml4XCIsIFBhdGg6IGluZGVudGF0aW9uICsgXCJUaXRsZVwiLCBGaWVsZFR5cGU6IG51bGwsIElzUHJvdGVjdGVkOiBpc1Byb3RlY3RlZCB9KTtcclxuXHJcblx0XHRcdFx0XHRcdFx0aWYgKGYuRm9ybWF0LmluZGV4T2YoXCJGaXJzdFwiKSA+IC0xKVxyXG5cdFx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIkZpcnN0XCIsIEludGVybmFsTmFtZTogcGF0aCArIFwiRmlyc3RcIiwgRmllbGRQYXRoOiBwYXRoICsgXCJGaXJzdFwiLCBQYXRoOiBpbmRlbnRhdGlvbiArIFwiRmlyc3RcIiwgRmllbGRUeXBlOiBudWxsLCBJc1Byb3RlY3RlZDogaXNQcm90ZWN0ZWQgfSk7XHJcblxyXG5cdFx0XHRcdFx0XHRcdGlmIChmLkZvcm1hdC5pbmRleE9mKFwiTWlkZGxlSW5pdGlhbFwiKSA+IC0xKVxyXG5cdFx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIk1pZGRsZSBJbml0aWFsXCIsIEludGVybmFsTmFtZTogcGF0aCArIFwiTWlkZGxlSW5pdGlhbFwiLCBGaWVsZFBhdGg6IHBhdGggKyBcIk1pZGRsZUluaXRpYWxcIiwgUGF0aDogaW5kZW50YXRpb24gKyBcIk1pZGRsZSBJbml0aWFsXCIsIEZpZWxkVHlwZTogbnVsbCwgSXNQcm90ZWN0ZWQ6IGlzUHJvdGVjdGVkIH0pO1xyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAoZi5Gb3JtYXQuaW5kZXhPZihcIk1pZGRsZVwiKSA+IC0xKVxyXG5cdFx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIk1pZGRsZSBOYW1lXCIsIEludGVybmFsTmFtZTogcGF0aCArIFwiTWlkZGxlXCIsIEZpZWxkUGF0aDogcGF0aCArIFwiTWlkZGxlXCIsIFBhdGg6IGluZGVudGF0aW9uICsgXCJNaWRkbGUgTmFtZVwiLCBGaWVsZFR5cGU6IG51bGwsIElzUHJvdGVjdGVkOiBpc1Byb3RlY3RlZCB9KTtcclxuXHJcblx0XHRcdFx0XHRcdFx0aWYgKGYuRm9ybWF0LmluZGV4T2YoXCJMYXN0XCIpID4gLTEpXHJcblx0XHRcdFx0XHRcdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiTGFzdFwiLCBJbnRlcm5hbE5hbWU6IHBhdGggKyBcIkxhc3RcIiwgRmllbGRQYXRoOiBwYXRoICsgXCJMYXN0XCIsIFBhdGg6IGluZGVudGF0aW9uICsgXCJMYXN0XCIsIEZpZWxkVHlwZTogbnVsbCwgSXNQcm90ZWN0ZWQ6IGlzUHJvdGVjdGVkIH0pO1xyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAoZi5Gb3JtYXQuaW5kZXhPZihcIlN1ZmZpeFwiKSA+IC0xKVxyXG5cdFx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIlN1ZmZpeFwiLCBJbnRlcm5hbE5hbWU6IHBhdGggKyBcIlN1ZmZpeFwiLCBGaWVsZFBhdGg6IHBhdGggKyBcIlN1ZmZpeFwiLCBQYXRoOiBpbmRlbnRhdGlvbiArIFwiU3VmZml4XCIsIEZpZWxkVHlwZTogbnVsbCwgSXNQcm90ZWN0ZWQ6IGlzUHJvdGVjdGVkIH0pO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdGVsc2UgaWYgKGZpZWxkVHlwZSA9PT0gXCJBZGRyZXNzXCIpIHtcclxuXHRcdFx0XHRcdFx0XHRpbmRlbnRhdGlvbiArPSBcIsKgwqDCoMKgXCI7XHJcblxyXG5cdFx0XHRcdFx0XHRcdHRva2Vucy5wdXNoKHsgTmFtZTogXCJMaW5lIDFcIiwgSW50ZXJuYWxOYW1lOiBwYXRoICsgXCJMaW5lMVwiLCBGaWVsZFBhdGg6IHBhdGggKyBcIkxpbmUxXCIsIFBhdGg6IGluZGVudGF0aW9uICsgXCJMaW5lIDFcIiwgRmllbGRUeXBlOiBudWxsLCBJc1Byb3RlY3RlZDogaXNQcm90ZWN0ZWQgfSk7XHJcblx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIkxpbmUgMlwiLCBJbnRlcm5hbE5hbWU6IHBhdGggKyBcIkxpbmUyXCIsIEZpZWxkUGF0aDogcGF0aCArIFwiTGluZTJcIiwgUGF0aDogaW5kZW50YXRpb24gKyBcIkxpbmUgMlwiLCBGaWVsZFR5cGU6IG51bGwsIElzUHJvdGVjdGVkOiBpc1Byb3RlY3RlZCB9KTtcclxuXHRcdFx0XHRcdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiQ2l0eVwiLCBJbnRlcm5hbE5hbWU6IHBhdGggKyBcIkNpdHlcIiwgRmllbGRQYXRoOiBwYXRoICsgXCJDaXR5XCIsIFBhdGg6IGluZGVudGF0aW9uICsgXCJDaXR5XCIsIEZpZWxkVHlwZTogbnVsbCwgSXNQcm90ZWN0ZWQ6IGlzUHJvdGVjdGVkIH0pO1xyXG5cdFx0XHRcdFx0XHRcdHRva2Vucy5wdXNoKHsgTmFtZTogXCJTdGF0ZVwiLCBJbnRlcm5hbE5hbWU6IHBhdGggKyBcIlN0YXRlXCIsIEZpZWxkUGF0aDogcGF0aCArIFwiU3RhdGVcIiwgUGF0aDogaW5kZW50YXRpb24gKyBcIlN0YXRlXCIsIEZpZWxkVHlwZTogbnVsbCwgSXNQcm90ZWN0ZWQ6IGlzUHJvdGVjdGVkIH0pO1xyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAoZi5GaWVsZFN1YlR5cGUgPT09IFwiSW50ZXJuYXRpb25hbEFkZHJlc3NcIilcclxuXHRcdFx0XHRcdFx0XHRcdHRva2Vucy5wdXNoKHsgTmFtZTogXCJQb3N0YWwgQ29kZVwiLCBJbnRlcm5hbE5hbWU6IHBhdGggKyBcIlBvc3RhbENvZGVcIiwgRmllbGRQYXRoOiBwYXRoICsgXCJQb3N0YWxDb2RlXCIsIFBhdGg6IGluZGVudGF0aW9uICsgXCJQb3N0YWwgQ29kZVwiLCBGaWVsZFR5cGU6IG51bGwsIElzUHJvdGVjdGVkOiBpc1Byb3RlY3RlZCB9KTtcclxuXHRcdFx0XHRcdFx0XHRlbHNlXHJcblx0XHRcdFx0XHRcdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiWmlwIENvZGVcIiwgSW50ZXJuYWxOYW1lOiBwYXRoICsgXCJQb3N0YWxDb2RlXCIsIEZpZWxkUGF0aDogcGF0aCArIFwiUG9zdGFsQ29kZVwiLCBQYXRoOiBpbmRlbnRhdGlvbiArIFwiWmlwIENvZGVcIiwgRmllbGRUeXBlOiBudWxsLCBJc1Byb3RlY3RlZDogaXNQcm90ZWN0ZWQgfSk7XHJcblxyXG5cdFx0XHRcdFx0XHRcdGlmIChmLkZpZWxkU3ViVHlwZSA9PT0gXCJJbnRlcm5hdGlvbmFsQWRkcmVzc1wiKVxyXG5cdFx0XHRcdFx0XHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIkNvdW50cnlcIiwgSW50ZXJuYWxOYW1lOiBwYXRoICsgXCJDb3VudHJ5XCIsIEZpZWxkUGF0aDogcGF0aCArIFwiQ291bnRyeVwiLCBQYXRoOiBpbmRlbnRhdGlvbiArIFwiQ291bnRyeVwiLCBGaWVsZFR5cGU6IG51bGwsIElzUHJvdGVjdGVkOiBpc1Byb3RlY3RlZCB9KTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiRW50cnlcIiwgSW50ZXJuYWxOYW1lOiBcIlwiLCBGaWVsZFBhdGg6IFwiRW50cnlcIiwgUGF0aDogXCJFbnRyeVwiLCBGaWVsZFR5cGU6IG51bGwgfSk7XHJcblx0XHRcdHRva2Vucy5wdXNoKHsgTmFtZTogXCJOdW1iZXJcIiwgSW50ZXJuYWxOYW1lOiBcIkVudHJ5Lk51bWJlclwiLCBGaWVsZFBhdGg6IFwiRW50cnkuTnVtYmVyXCIsIFBhdGg6IFwiwqDCoMKgwqBOdW1iZXJcIiwgRmllbGRUeXBlOiBudWxsIH0pO1xyXG5cdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiU3RhdHVzXCIsIEludGVybmFsTmFtZTogXCJFbnRyeS5TdGF0dXNcIiwgRmllbGRQYXRoOiBcIkVudHJ5LlN0YXR1c1wiLCBQYXRoOiBcIsKgwqDCoMKgU3RhdHVzXCIsIEZpZWxkVHlwZTogbnVsbCB9KTtcclxuXHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIkRhdGUgQ3JlYXRlZFwiLCBJbnRlcm5hbE5hbWU6IFwiRW50cnkuRGF0ZUNyZWF0ZWRcIiwgRmllbGRQYXRoOiBcIkVudHJ5LkRhdGVDcmVhdGVkXCIsIFBhdGg6IFwiwqDCoMKgwqBEYXRlIENyZWF0ZWRcIiwgRmllbGRUeXBlOiBudWxsIH0pO1xyXG5cdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiRGF0ZSBTdWJtaXR0ZWRcIiwgSW50ZXJuYWxOYW1lOiBcIkVudHJ5LkRhdGVTdWJtaXR0ZWRcIiwgRmllbGRQYXRoOiBcIkVudHJ5LkRhdGVTdWJtaXR0ZWRcIiwgUGF0aDogXCLCoMKgwqDCoERhdGUgU3VibWl0dGVkXCIsIEZpZWxkVHlwZTogbnVsbCB9KTtcclxuXHRcdFx0dG9rZW5zLnB1c2goeyBOYW1lOiBcIkRhdGUgVXBkYXRlZFwiLCBJbnRlcm5hbE5hbWU6IFwiRW50cnkuRGF0ZVVwZGF0ZWRcIiwgRmllbGRQYXRoOiBcIkVudHJ5LkRhdGVVcGRhdGVkXCIsIFBhdGg6IFwiwqDCoMKgwqBEYXRlIFVwZGF0ZWRcIiwgRmllbGRUeXBlOiBudWxsIH0pO1xyXG5cclxuXHRcdFx0aWYgKENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0gJiYgQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5nZXRfUGF5bWVudEVuYWJsZWQoKSlcclxuXHRcdFx0XHR0b2tlbnMucHVzaCh7IE5hbWU6IFwiT3JkZXIgSWRcIiwgSW50ZXJuYWxOYW1lOiBcIkVudHJ5Lk9yZGVyLklkXCIsIEZpZWxkUGF0aDogXCJFbnRyeS5PcmRlci5JZFwiLCBQYXRoOiBcIsKgwqDCoMKgT3JkZXIgSWRcIiwgRmllbGRUeXBlOiBudWxsIH0pO1xyXG5cclxuXHRcdFx0cmV0dXJuIHRva2VucztcclxuXHRcdH07XHJcblxyXG5cdFx0Ly8gUmVmcmVzaGVzIHRoZSBzZXQgb2YgYXZhaWxhYmxlIGNvbHVtbnMgb24gdGhlIGNvbHVtbiBtZW51XHJcblx0XHRmdW5jdGlvbiByZWZyZXNoQ29sdW1uTWVudSgpIHtcclxuXHRcdFx0dmFyIGF2YWlsYWJsZUNvbHVtbnMgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Db2x1bW5zKCkuc2xpY2UoKTtcclxuXHRcdFx0dmFyIHNjb3BlID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfc2NvcGVJZCgpO1xyXG5cdFx0XHRhdmFpbGFibGVDb2x1bW5zLmFkZFJhbmdlKENvZ25pdG8uRm9ybXMubW9kZWwuZmllbGRJbmZvc1xyXG5cdFx0XHRcdC5maWx0ZXIoZnVuY3Rpb24gKGZpZWxkKSB7IHJldHVybiBmaWVsZC5JZCAhPSBcIkVudHJ5Lk51bWJlclwiICYmIHNjb3BlLnN0YXJ0c1dpdGgoZmllbGQuU2NvcGVJZCB8fCBcIlwiKSAmJiBmaWVsZC5GaWVsZFR5cGUgIT09IFwiRW50aXR5XCIgJiYgZmllbGQuRmllbGRUeXBlICE9PSBcIkVudGl0eUxpc3RcIiAmJiBmaWVsZC5GaWVsZFR5cGUgIT09IFwiUmF0aW5nU2NhbGVcIiAmJiAhYXZhaWxhYmxlQ29sdW1ucy5zb21lKGZ1bmN0aW9uIChjb2x1bW4pIHsgcmV0dXJuIGNvbHVtbi5nZXRfRmllbGRJZCgpID09IGZpZWxkLklkOyB9KTsgfSlcclxuXHRcdFx0XHQubWFwKGZ1bmN0aW9uIChmaWVsZCkgeyByZXR1cm4gbmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3Q29sdW1uKHsgRmllbGRJZDogZmllbGQuSWQsIFdpZHRoOiBmaWVsZC5XaWR0aCB9KTsgfSkpO1xyXG5cdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LnNldF9hdmFpbGFibGVDb2x1bW5zKGF2YWlsYWJsZUNvbHVtbnMpO1xyXG5cdFx0XHR2YXIgY29sdW1uTGlzdCA9ICQoXCIuYy12aWV3LWNvbHVtbnNcIik7XHJcblx0XHRcdGNvbHVtbkxpc3RbMF0uY29udHJvbC5zZXRfZGF0YShjb2x1bW5MaXN0WzBdLmNvbnRyb2wuZ2V0X3BhcmVudCgpLmdldF9kYXRhKCkuZ2V0X29wdGlvbnMoKSk7XHJcblx0XHRcdGNvbHVtbkxpc3RbMF0uY29udHJvbC5yZWZyZXNoKCk7XHJcblx0XHRcdHZhciBpbnN0YW5jZSA9IGNvbHVtbkxpc3Quc29ydGFibGUoXCJpbnN0YW5jZVwiKTtcclxuXHRcdFx0aWYgKGluc3RhbmNlKVxyXG5cdFx0XHRcdGNvbHVtbkxpc3Quc29ydGFibGUoXCJkZXN0cm95XCIpO1xyXG5cdFx0XHRjb2x1bW5MaXN0LnNvcnRhYmxlKCkuYmluZCgnc29ydHVwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUNvbHVtbnMoJChcIi5jLXZpZXctY29sdW1ucyBpbnB1dDpjaGVja2JveDpjaGVja2VkXCIpLm1hcChmdW5jdGlvbiAoKSB7IHJldHVybiAkcGFyZW50Q29udGV4dERhdGEodGhpcykuZ2V0X3Jhd1ZhbHVlKCk7IH0pLnRvQXJyYXkoKSk7XHJcblx0XHRcdH0pO1xyXG5cdFx0XHRzaG93TWVudSgkKFwiLmMtY29sdW1uc1wiKSk7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gcGFyc2VRdWVyeVN0cmluZyhsb2NhdGlvbikge1xyXG5cdFx0XHR2YXIgcXM7XHJcblx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobG9jYXRpb24pID09PSBcIltvYmplY3QgTG9jYXRpb25dXCIpIHtcclxuXHRcdFx0XHRxcyA9IGxvY2F0aW9uLnNlYXJjaCA/IGxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSkgOiBcIlwiO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHZhciB1cmwgPSB0eXBlb2YgbG9jYXRpb24gPT09IFwic3RyaW5nXCIgPyBsb2NhdGlvbiA6IGxvY2F0aW9uID8gbG9jYXRpb24udG9TdHJpbmcoKSA6IFwiXCI7XHJcblx0XHRcdFx0dmFyIHFzSWR4ID0gdXJsLmluZGV4T2YoJz8nKTtcclxuXHRcdFx0XHRxcyA9IHFzSWR4ID49IDAgPyB1cmwuc3Vic3RyaW5nKHFzSWR4ICsgMSkgOiBcIlwiO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHR2YXIgcXNPYmogPSB7fTtcclxuXHJcblx0XHRcdGlmIChxcykge1xyXG5cdFx0XHRcdHFzLnNwbGl0KCcmJykubWFwKGZ1bmN0aW9uIChxc1Rva2VuKSB7XHJcblx0XHRcdFx0XHR2YXIgc3BsaXRJZHggPSBxc1Rva2VuLmluZGV4T2YoJz0nKTtcclxuXHRcdFx0XHRcdHZhciB0b2tlbk5hbWUsIHRva2VuVmFsdWU7XHJcblx0XHRcdFx0XHRpZiAoc3BsaXRJZHggPiAwKSB7XHJcblx0XHRcdFx0XHRcdHRva2VuTmFtZSA9IHFzVG9rZW4uc3Vic3RyaW5nKDAsIHNwbGl0SWR4KTtcclxuXHRcdFx0XHRcdFx0dG9rZW5WYWx1ZSA9IHFzVG9rZW4uc3Vic3RyaW5nKHNwbGl0SWR4ICsgMSk7XHJcblx0XHRcdFx0XHR9IGVsc2UgaWYgKHNwbGl0SWR4ID09PSBxc1Rva2VuLmxlbmd0aCAtIDEpIHtcclxuXHRcdFx0XHRcdFx0dG9rZW5OYW1lID0gcXNUb2tlbi5zdWJzdHJpbmcoMCwgc3BsaXRJZHgpO1xyXG5cdFx0XHRcdFx0XHR0b2tlblZhbHVlID0gXCJcIjtcclxuXHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdHRva2VuTmFtZSA9IHFzVG9rZW47XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0cXNPYmpbdG9rZW5OYW1lXSA9IHRva2VuVmFsdWU7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHJldHVybiBxc09iajtcclxuXHRcdH1cclxuXHJcblx0XHRmdW5jdGlvbiBnZXRGb3JtKGlkKSB7XHJcblx0XHRcdHZhciBmb3JtID0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybTtcclxuXHRcdFx0aWYgKGZvcm0uZ2V0X0lkKCkgPT09IGlkKVxyXG5cdFx0XHRcdHJldHVybiBmb3JtO1xyXG5cdFx0XHRyZXR1cm4gZm9ybS5tZXRhLnR5cGUua25vd24oKS5maWx0ZXIoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIGYuZ2V0X0lkKCkgPT09IGlkOyB9KVswXTtcclxuXHRcdH1cclxuXHJcblx0XHRmdW5jdGlvbiBnZXRFbnRyeVZpZXdSb2xlKGZvcm0sIHZpZXcpIHtcclxuXHRcdFx0aWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKVxyXG5cdFx0XHRcdHZpZXcgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3O1xyXG5cclxuXHRcdFx0aWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApXHJcblx0XHRcdFx0Zm9ybSA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm07XHJcblxyXG5cdFx0XHR2YXIgcm9sZTtcclxuXHJcblx0XHRcdC8vIElmIHRoaXMgZW50cnkgdmlldydzIHJvbGUgaXMgZGVmaW5lZCwgdHJ5IHRvIGZpbmQgaXRcclxuXHRcdFx0aWYgKHZpZXcuZ2V0X1JvbGVJZCgpICE9PSBudWxsKSB7XHJcblx0XHRcdFx0cm9sZSA9IGZvcm0uZ2V0X1JvbGVzKCkuZmlsdGVyKGZ1bmN0aW9uIChyKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gci5nZXRfSWQoKSA9PT0gdmlldy5nZXRfUm9sZUlkKCk7XHJcblx0XHRcdFx0fSlbMF07XHJcblxyXG5cdFx0XHRcdC8vIElmIGNhbm5vdCBmaW5kIHJvbGUgb24gZm9ybSwgY2hlY2sgZm9ybURhdGEgYXMgd2VsbFxyXG5cdFx0XHRcdGlmIChyb2xlID09PSB1bmRlZmluZWQpIHtcclxuXHRcdFx0XHRcdHJvbGUgPSBmb3JtRGF0YS52YWx1ZS5Sb2xlcy5maW5kKGZ1bmN0aW9uIChyKSB7XHJcblx0XHRcdFx0XHRcdHJldHVybiByLklkID09PSB2aWV3LmdldF9Sb2xlSWQoKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gSWYgdGhlIHJvbGUgd2FzIHVuZGVmaW5lZCBvciB0aGUgcm9sZSB3YXNuJ3QgZm91bmQsIGRlZmF1bHQgdG8gdGhlIGludGVybmFsIHJvbGVcclxuXHRcdFx0aWYgKHJvbGUgPT09IHVuZGVmaW5lZCkge1xyXG5cdFx0XHRcdHJvbGUgPSBmb3JtLmdldF9Sb2xlcygpLmZpbHRlcihmdW5jdGlvbiAocikge1xyXG5cdFx0XHRcdFx0cmV0dXJuIHIuZ2V0X0lzSW50ZXJuYWwoKTtcclxuXHRcdFx0XHR9KVswXTtcclxuXHJcblx0XHRcdFx0dmlldy5zZXRfUm9sZUlkKHJvbGUuZ2V0X0lkKCkpO1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIuc2F2ZVZpZXcodmlldyk7XHJcblx0XHRcdH1cclxuXHRcdFx0cmV0dXJuIHJvbGU7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gZ2V0U3VtbWFyeVByb3BlcnR5KCkge1xyXG5cdFx0XHR2YXIgdmlldyA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXc7XHJcblx0XHRcdHZhciBjb2x1bW5zID0gdmlldy5nZXRfQ29sdW1ucygpO1xyXG5cdFx0XHRpZiAoY29sdW1ucy5sZW5ndGggPT09IDApXHJcblx0XHRcdFx0cmV0dXJuIG51bGw7XHJcblxyXG5cdFx0XHRmb3IgKHZhciBpID0gMDsgaSA8IGNvbHVtbnMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHR2YXIgY29sdW1uID0gY29sdW1uc1tpXTtcclxuXHRcdFx0XHR2YXIgaXNGaWVsZCA9ICQuaXNOdW1lcmljKGNvbHVtbi5nZXRfRmllbGRJZCgpLnNwbGl0KFwiLlwiKS5wb3AoKSk7XHJcblx0XHRcdFx0aWYgKCFpc0ZpZWxkKVxyXG5cdFx0XHRcdFx0Y29udGludWU7XHJcblxyXG5cdFx0XHRcdHZhciBmaWVsZEluZm8gPSBDb2duaXRvLkZvcm1zLm1vZGVsLmZpZWxkSW5mb3MuZmlsdGVyKGZ1bmN0aW9uIChmaWVsZEluZm8pIHtcclxuXHRcdFx0XHRcdHJldHVybiBmaWVsZEluZm8uSWQgPT09IGNvbHVtbi5nZXRfRmllbGRJZCgpO1xyXG5cdFx0XHRcdH0pWzBdO1xyXG5cclxuXHRcdFx0XHRpZiAoIWZpZWxkSW5mbylcclxuXHRcdFx0XHRcdGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0XHR2YXIgcHJvcGVydHlUeXBlID0gZmllbGRJbmZvLlByb3BlcnR5VHlwZTtcclxuXHJcblx0XHRcdFx0Ly8gQWNjZXB0ZWQgcHJvcGVydHkgdHlwZXMgdGhhdCBkb24ndCBoYXZlIGEgdmFsaWQgZm9ybWF0IHNldFxyXG5cdFx0XHRcdHZhciBhY2NlcHRlZFR5cGVzID0gW1wiU3RyaW5nXCIsIFwiTnVtYmVyXCIsIFwiQ2hvaWNlXCIsIFwiWWVzTm9cIiwgXCJEYXRlXCIsIFwiRm9ybUVudHJ5XCIsIFwiVGltZVwiXTtcclxuXHJcblx0XHRcdFx0aWYgKGZpZWxkSW5mby5Gb3JtYXQgIT09IG51bGwgfHwgYWNjZXB0ZWRUeXBlcy5pbmRleE9mKHByb3BlcnR5VHlwZSkgPiAtMSlcclxuXHRcdFx0XHRcdHJldHVybiBmaWVsZEluZm8uUGF0aDtcclxuXHJcblx0XHRcdH1cclxuXHRcdFx0cmV0dXJuIG51bGw7XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gI2VuZHJlZ2lvblxyXG5cclxuXHRcdC8vI3JlZ2lvbiBJbml0aWFsaXplIEVudHJpZXNcclxuXHJcblx0XHRDb2duaXRvLnJlYWR5KFwiaW5pdC1lbnRyaWVzXCIsIFtcImVudHJpZXNcIiwgXCJFeG9XZWIuZG9tXCIsIFwiVmlld3MuQWRtaW4uZW50cmllcy5odG1cIiwgXCJleHByZXNzaW9uLWJ1aWxkZXIuaHRtXCIsIFwiYWRtaW4tY29tcG9uZW50LWxpYnJhcnlcIiwgXCJhZG1pbi1mb3JtLWFwaVwiXSwgZnVuY3Rpb24gKCQpIHtcclxuXHJcblx0XHRcdGlmICh3aW5kb3cubWF0Y2hNZWRpYSkge1xyXG5cdFx0XHRcdHZhciBwaG9uZU1vZGUgPSB3aW5kb3cubWF0Y2hNZWRpYShcIihtYXgtd2lkdGg6IDQwMHB4KVwiKTtcclxuXHRcdFx0XHRpZiAocGhvbmVNb2RlLm1hdGNoZXMpXHJcblx0XHRcdFx0XHRsYXlvdXRNb2RlID0gXCJwaG9uZVwiO1xyXG5cdFx0XHRcdHZhciB0YWJsZXRNb2RlID0gd2luZG93Lm1hdGNoTWVkaWEoXCIobWluLXdpZHRoOiA0MDFweCkgYW5kIChtYXgtd2lkdGg6IDczOXB4KVwiKTtcclxuXHRcdFx0XHRpZiAodGFibGV0TW9kZS5tYXRjaGVzKVxyXG5cdFx0XHRcdFx0bGF5b3V0TW9kZSA9IFwidGFibGV0XCI7XHJcblx0XHRcdFx0dmFyIGRlc2t0b3BNb2RlID0gd2luZG93Lm1hdGNoTWVkaWEoXCIobWluLXdpZHRoOiA3NDBweClcIik7XHJcblx0XHRcdFx0aWYgKGRlc2t0b3BNb2RlLm1hdGNoZXMpXHJcblx0XHRcdFx0XHRsYXlvdXRNb2RlID0gXCJkZXNrdG9wXCI7XHJcblxyXG5cdFx0XHRcdHBob25lTW9kZS5hZGRMaXN0ZW5lcihmdW5jdGlvbiAoKSB7IGlmIChwaG9uZU1vZGUubWF0Y2hlcykgY29udHJvbGxlci5jaGFuZ2VMYXlvdXQoXCJwaG9uZVwiKTsgfSk7XHJcblx0XHRcdFx0dGFibGV0TW9kZS5hZGRMaXN0ZW5lcihmdW5jdGlvbiAoKSB7IGlmICh0YWJsZXRNb2RlLm1hdGNoZXMpIGNvbnRyb2xsZXIuY2hhbmdlTGF5b3V0KFwidGFibGV0XCIpOyB9KTtcclxuXHRcdFx0XHRkZXNrdG9wTW9kZS5hZGRMaXN0ZW5lcihmdW5jdGlvbiAoKSB7IGlmIChkZXNrdG9wTW9kZS5tYXRjaGVzKSBjb250cm9sbGVyLmNoYW5nZUxheW91dChcImRlc2t0b3BcIik7IH0pO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQvLyBMb2FkIHZpZXdzIGZyb20gdGhlIHNlcnZlciB3aGVuIHRoZSBwYWdlIGxvYWRzXHJcblx0XHRcdGNvbnRyb2xsZXIuaW5pdFZpZXdzKCk7XHJcblxyXG5cdFx0XHQvLyBTdG9yZSB0aGUgdmlldyBkYXRhIHNvIGl0IGNhbiBiZSByb2xsZWQgYmFjayBpZiBuZWVkZWQuIFN0cmluZ2lmeSBhbmQgcGFyc2UgdGhlIGRhdGEgdG8gZW5zdXJlIGFycmF5cyBhcmUgY29waWVkLlxyXG5cdFx0XHRwcmV2aW91c1ZpZXdEYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShDb2duaXRvLnNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3KSkpO1xyXG5cclxuXHRcdFx0aW5pdGlhbGl6ZUV2ZW50SGFuZGxlcnMoKTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdENvZ25pdG8ucmVhZHkoXCJpbml0LWxheW91dFwiLCBbXCJpbml0LWVudHJpZXNcIiwgXCJtYXN0ZXJcIiwgXCJkZXRhaWxcIl0sIGZ1bmN0aW9uICgkKSB7XHJcblx0XHRcdC8vIFVwZGF0ZSB0aGUgbGF5b3V0IG1vZGVcclxuXHRcdFx0Y29udHJvbGxlci5jaGFuZ2VMYXlvdXQobGF5b3V0TW9kZSk7XHJcblxyXG5cdFx0XHRjb250cm9sbGVyLmRldGFpbC5jaGFuZ2VWaWV3KENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcpO1xyXG5cclxuXHRcdFx0b25DcmVhdGVOZXdFbnRyeSgoKSA9PiB7XHJcblx0XHRcdFx0ZXhlY3V0ZUFjdGlvbigoKSA9PiBjb250cm9sbGVyLm5ld0VudHJ5KCkpO1xyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmRlZmF1bHRFbnRyeSlcclxuXHRcdFx0XHRjb250cm9sbGVyLnZpZXdFbnRyeShDb2duaXRvLkZvcm1zLm1vZGVsLmRlZmF1bHRFbnRyeSk7XHJcblx0XHRcdGVsc2UgaWYgKHNob3dOZXdFbnRyeS52YWx1ZSlcclxuXHRcdFx0XHRleGVjdXRlQWN0aW9uKCgpID0+IGNvbnRyb2xsZXIubmV3RW50cnkoKSk7XHJcblx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdHZhciBxdWVyeSA9IFwiXCI7XHJcblxyXG5cdFx0XHRcdC8vIEV4dHJhY3QgYW55IHF1ZXJ5IHN0cmluZyBhcmd1bWVudHMgdGhhdCB3ZSB3YW50IHRvIGtlZXAuLi5cclxuXHRcdFx0XHR2YXIgcXNPYmogPSBwYXJzZVF1ZXJ5U3RyaW5nKHdpbmRvdy5sb2NhdGlvbik7XHJcblx0XHRcdFx0aWYgKHFzT2JqLmhhc093blByb3BlcnR5KCdpbXBvcnQnKSkge1xyXG5cdFx0XHRcdFx0cXVlcnkgPSBcImltcG9ydD1cIiArIHFzT2JqLmltcG9ydDtcclxuXHRcdFx0XHRcdHVwZGF0ZU5hdmlnYXRpb24obnVsbCwgcXVlcnkpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmltcG9ydElkICYmIENvZ25pdG8uY29uZmlnLmFsbG93SW1wb3J0RW50cmllcylcclxuXHRcdFx0XHRkaXNwbGF5SW1wb3J0RW50cmllc0RpYWxvZyhDb2duaXRvLkZvcm1zLm1vZGVsLmltcG9ydElkLCBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuZW50cnlMaW1pdEV4Y2VlZGVkID09PSB0cnVlKSB7XHJcblx0XHRcdFx0XHRcdC8vIERlbGF5IGZvciBhIG1vbWVudCB0byBhbGxvdyB0aGUgY3VycmVudGx5IGNsb3NpbmcgZGlhbG9nIHRvIGNsZWFuLXVwXHJcblx0XHRcdFx0XHRcdHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuc2hvd0ZlYXR1cmVXYXJuaW5nKFwiZW50cnlsaW1pdHNcIik7XHJcblx0XHRcdFx0XHRcdH0sIDEwMCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdGVsc2UgaWYgKENvZ25pdG8uRm9ybXMubW9kZWwuaW1wb3J0SWQgJiYgIUNvZ25pdG8uY29uZmlnLmFsbG93SW1wb3J0RW50cmllcylcclxuXHRcdFx0XHRjb250cm9sbGVyLnNob3dGZWF0dXJlV2FybmluZyhcImVudHJ5bGltaXRzXCIpO1xyXG5cdFx0XHRlbHNlIGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmJ1bGtEb3dubG9hZElkKVxyXG5cdFx0XHRcdGRpc3BsYXlCdWxrRG93bmxvYWREaWFsb2coQ29nbml0by5Gb3Jtcy5tb2RlbC5kb3dubG9hZFR5cGUsIG51bGwsIENvZ25pdG8uRm9ybXMubW9kZWwuYnVsa0Rvd25sb2FkSWQpO1xyXG5cdFx0XHRlbHNlIGlmIChDb2duaXRvLmNvbmZpZy5mb3JtRW50cnlFeHBvcnRJZClcclxuXHRcdFx0XHRjb250cm9sbGVyLm9wZW5FbnRyeUV4cG9ydERpYWxvZyhDb2duaXRvLmNvbmZpZy5mb3JtRW50cnlFeHBvcnRJZCwgXCJTdWNjZXNzZnVsXCIsIG51bGwsIG51bGwpO1xyXG5cclxuXHRcdFx0Ly8gQXBwbHkgZW50cnkgdmlldyBjaGFuZ2VzIHRoYXQgaGFwcGVuZWQgYmVmb3JlIHRoZSBncmlkIGxvYWRlZFxyXG5cdFx0XHRpZiAodGVtcEZpbHRlcilcclxuXHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUZpbHRlcih0ZW1wRmlsdGVyKTtcclxuXHJcblx0XHRcdGlmICh0ZW1wU29ydClcclxuXHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZVNvcnQodGVtcFNvcnQpO1xyXG5cclxuXHRcdFx0aWYgKHRlbXBDb2x1bW5zKVxyXG5cdFx0XHRcdGNvbnRyb2xsZXIuY2hhbmdlQ29sdW1ucyh0ZW1wQ29sdW1ucyk7XHJcblx0XHR9KTtcclxuXHJcblx0XHQvLyAjZW5kcmVnaW9uXHJcblxyXG5cdFx0Ly8jcmVnaW9uIGpRdWVyeSBFdmVudCBIYW5kbGVyc1xyXG5cclxuXHRcdGZ1bmN0aW9uIGluaXRpYWxpemVFdmVudEhhbmRsZXJzKCkge1xyXG5cclxuXHRcdFx0JChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpXHJcblxyXG5cdFx0XHRcdC8vIFNlbGVjdCBDb2x1bW5cclxuXHRcdFx0XHQub24oXCJjaGFuZ2VcIiwgXCIuYy12aWV3LWNvbHVtbnMgaW5wdXRcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUNvbHVtbnMoJChcIi5jLXZpZXctY29sdW1ucyBpbnB1dDpjaGVja2JveDpjaGVja2VkXCIpLm1hcChmdW5jdGlvbiAoKSB7IHJldHVybiAkcGFyZW50Q29udGV4dERhdGEodGhpcykuZ2V0X3Jhd1ZhbHVlKCk7IH0pLnRvQXJyYXkoKSk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gQWRkIFNvcnQgQ29sdW1uXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1jcml0ZXJpYS1jb2wuYy1hZGRcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLnNvcnRCeS5hZGQobmV3IENvZ25pdG8uRm9ybXMuRW50cnlWaWV3U29ydCh7IEFzY2VuZGluZzogdHJ1ZSB9KSk7XHJcblx0XHRcdFx0XHRzaG93TWVudSgkKFwiLmMtc29ydFwiKSk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gRGVsZXRlIFNvcnQgQ29sdW1uXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1jcml0ZXJpYS1jb2wuYy1kZWxldGVcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLnNvcnRCeS5yZW1vdmUoJHBhcmVudENvbnRleHREYXRhKHRoaXMpKTtcclxuXHRcdFx0XHRcdHNob3dNZW51KCQoXCIuYy1zb3J0XCIpKTtcclxuXHRcdFx0XHR9KVxyXG5cclxuXHRcdFx0XHQvLyBBcHBseSBTb3J0XHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1zb3J0IC5jLW5hdi1tZW51LWJ1dHRvbnMgYnV0dG9uXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5jaGFuZ2VTb3J0KENvZ25pdG8uRm9ybXMubW9kZWwuc29ydEJ5LmZpbHRlcihmdW5jdGlvbiAoYykgeyByZXR1cm4gISFjLmdldF9maWVsZCgpOyB9KSk7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLmhpZGVNZW51cygpO1xyXG5cdFx0XHRcdH0pXHJcblxyXG5cdFx0XHRcdC8vIENsZWFyIFNvcnRcclxuXHRcdFx0XHQub24oXCJjbGlja1wiLCBcIi5jLXNvcnQgLmMtbmF2LW1lbnUtYnV0dG9ucyBhXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0Y29udHJvbGxlci5jaGFuZ2VTb3J0KFtdKTtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gQXBwbHkgRmlsdGVyXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1maWx0ZXIgLmMtbmF2LW1lbnUtYnV0dG9ucyBidXR0b25cIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRleGVjdXRlQWN0aW9uKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5jaGFuZ2VGaWx0ZXIoQ29nbml0by5Gb3Jtcy5tb2RlbC5maWx0ZXIpO1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmhpZGVNZW51cygpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gQWR2YW5jZWQgRmlsdGVyXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1maWx0ZXItYWR2YW5jZWRcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRhZHZhbmNlZEZpbHRlcigpO1xyXG5cdFx0XHRcdH0pXHJcblxyXG5cdFx0XHRcdC8vIENsZWFyIEZpbHRlclxyXG5cdFx0XHRcdC5vbihcImNsaWNrXCIsIFwiLmMtZmlsdGVyIC5jLW5hdi1tZW51LWJ1dHRvbnMgYVwiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUZpbHRlcihuZXcgQ29nbml0by5Gb3Jtcy5FbnRyeVZpZXdGaWx0ZXIoeyBTY29wZUlkOiBDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5nZXRfU2NvcGVJZCgpIH0pKTtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlTWVudXMoKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0pXHJcblxyXG5cdFx0XHRcdC8vIEZpbHRlciBvbiBcIkVudGVyXCIga2V5XHJcblx0XHRcdFx0Lm9uKFwia2V5dXBcIiwgXCIuYy1maWx0ZXIta2V5d29yZFwiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHRcdFx0XHRcdGlmIChldmVudC5rZXlDb2RlID09IDEzKSB7XHJcblx0XHRcdFx0XHRcdHZhciBrZXl3b3JkID0gdGhpcy52YWx1ZTtcclxuXHRcdFx0XHRcdFx0ZXhlY3V0ZUFjdGlvbihmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdFx0Ly8gSW4gSUUxMSwgdGhlIGxvc3QgZm9jdXMgKGJpbmRpbmcpIGV2ZW50IGlzIG5vdCBiZWluZyBoYW5kbGVkIGluIHRpbWVcclxuXHRcdFx0XHRcdFx0XHRDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlci5zZXRfS2V5d29yZChrZXl3b3JkKTtcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLmNoYW5nZUZpbHRlcihDb2duaXRvLkZvcm1zLm1vZGVsLmZpbHRlcik7XHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlTWVudXMoKTtcclxuXHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gTmV3IFZpZXdcclxuXHRcdFx0XHQub24oXCJjbGlja1wiLCBcIi5jLW5ldy12aWV3XCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0ZXhlY3V0ZUFjdGlvbihmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubmV3VmlldygpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gU2F2ZSBFbnRyeSBWaWV3XHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1zYXZlLXZpZXdcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRpZiAoJChcIi5jLXNhdmUtdmlldyAuYy1uYXYtZGlzYWJsZWRcIikubGVuZ3RoID09IDApXHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuc2F2ZVZpZXcoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldyk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gU2F2ZSBFbnRyeSBWaWV3IEFzXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1zYXZlLXZpZXctYXNcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLnNhdmVWaWV3QXMoKTtcclxuXHRcdFx0XHR9KVxyXG5cclxuXHRcdFx0XHQvLyBOZXcgRW50cnlcclxuXHRcdFx0XHQub24oXCJjbGlja1wiLCBcIi5jLW5ldy1lbnRyeVwiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLm5ld0VudHJ5KCk7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHR9KVxyXG5cclxuXHRcdFx0XHQvLyBDaGFuZ2UgU3RhdHVzXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1uYXYtbWVudS1jb250ZW50IC5jLW5hdi1tZW51IC5jLWFjdGlvbi1jaGFuZ2Utc3RhdHVzXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0aWYgKHNlbGVjdGVkRW50cmllcy5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci51cGRhdGVFbnRyeVN0YXR1cyhzZWxlY3RlZEVudHJpZXMsICQodGhpcykudGV4dCgpLnRyaW0oKSwgbnVsbCwgJCh0aGlzKS5hdHRyKFwic3RhdHVzLWlkXCIpKTtcclxuXHRcdFx0XHRcdFx0fSwgdGhpcyk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gQ2hhbmdlIFJlYWQgU3RhdGVcclxuXHRcdFx0XHQub24oXCJjbGlja1wiLCBcIi5jLW5hdi1tZW51LWNvbnRlbnQgLmMtbmF2LW1lbnUgLmMtYWN0aW9uLWNoYW5nZS1yZWFkLXN0YXRlXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0aWYgKHNlbGVjdGVkRW50cmllcy5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRcdHZhciByZWFkID0gJCh0aGlzKS50ZXh0KCkudHJpbSgpID09PSBcIlJlYWRcIjtcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLmhpZGVNZW51cygpO1xyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIudXBkYXRlR3JpZFJlYWRTdGF0ZShzZWxlY3RlZEVudHJpZXMsIHJlYWQpO1xyXG5cdFx0XHRcdFx0XHR9LCB0aGlzKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KVxyXG5cclxuXHRcdFx0XHQvLyBEZWxldGUgRW50cmllc1xyXG5cdFx0XHRcdC5vbihcImNsaWNrXCIsIFwiLmMtYWN0aW9uLWRlbGV0ZS1lbnRyaWVzXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0aWYgKHNlbGVjdGVkRW50cmllcy5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5kZWxldGVFbnRyaWVzKHNlbGVjdGVkRW50cmllcyk7XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH0pXHJcblxyXG5cdFx0XHRcdC8vIEltcG9ydCBFbnRyaWVzXHJcblx0XHRcdFx0Lm9uKFwiY2xpY2tcIiwgXCIuYy1hY3Rpb24taW1wb3J0LWVudHJpZXNcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRleGVjdXRlQWN0aW9uKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlTWVudXMoKTtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5pbXBvcnRFbnRyaWVzKCk7XHJcblx0XHRcdFx0XHR9LCB0aGlzKTtcclxuXHRcdFx0XHR9KVxyXG5cclxuXHRcdFx0XHQvLyBDaGFuZ2UgVmlld1xyXG5cdFx0XHRcdC5vbihcImNsaWNrXCIsIFwiLmMtbWVudS1jdXJyZW50LXZpZXcgLmMtbmF2LW1lbnUgLmMtbmF2LWJ1dHRvblwiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHRcdFx0XHRcdC8vIElkIGNoZWNrIGV4Y2x1ZGVzIHRoZSBcIk5ldyBWaWV3XCIgc2VsZWN0aW9uXHJcblx0XHRcdFx0XHR2YXIgaWQgPSAkKHRoaXMpLmF0dHIoXCJpZFwiKTtcclxuXHRcdFx0XHRcdGlmIChpZCkge1xyXG5cclxuXHRcdFx0XHRcdFx0aWYgKCEkKHRoaXMpLmhhc0NsYXNzKFwiYy12aWV3LWVuYWJsZWRcIikpIHtcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLnNob3dGZWF0dXJlV2FybmluZyhcImVudHJ5dmlld3NleGlzdFwiKTtcclxuXHRcdFx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRcdENvZ25pdG8uRm9ybXMub25DaGFuZ2VWaWV3KGlkKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KVxyXG5cclxuXHRcdFx0XHQvLyBEZWxldGUgVmlld1xyXG5cdFx0XHRcdC5vbihcImNsaWNrXCIsIFwiLmMtdmlldy1kZWxldGUtdmlld1wiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHQvL2V2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdFx0XHRcdFx0XHRjb250cm9sbGVyLmRlbGV0ZVZpZXcoKTtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5oaWRlTWVudXMoKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0pXHJcblxyXG5cdFx0XHRcdC8vIENvcHkgVmlld1xyXG5cdFx0XHRcdC5vbihcImNsaWNrXCIsIFwiLmMtdmlldy1jb3B5LXZpZXdcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRleGVjdXRlQWN0aW9uKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0Ly9ldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHRcdFx0XHRcdFx0Y29udHJvbGxlci5jb3B5VmlldygpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gUmVuYW1lIFZpZXdcclxuXHRcdFx0XHQub24oXCJjbGlja1wiLCBcIi5jLXZpZXctcmVuYW1lXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0ZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0XHRjb250cm9sbGVyLnNob3dSZW5hbWVWaWV3KCk7XHJcblx0XHRcdFx0fSlcclxuXHJcblx0XHRcdFx0Ly8gQ2FuY2VsIFJlbmFtZVxyXG5cdFx0XHRcdC5vbihcImtleWRvd25cIiwgXCIuYy1yZW5hbWUtdmlldyBpbnB1dDp0ZXh0XCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG5cdFx0XHRcdFx0aWYgKGV2ZW50LmtleUNvZGUgPT0gMjcgfHwgZXZlbnQua2V5Q29kZSA9PSA5IHx8IGV2ZW50LmtleUNvZGUgPT0gMTMpIHtcclxuXHRcdFx0XHRcdFx0ZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuaGlkZU1lbnVzKCk7XHJcblxyXG5cdFx0XHRcdFx0XHQvLyBSb2xsYmFjayBjaGFuZ2VzXHJcblx0XHRcdFx0XHRcdGlmIChldmVudC5rZXlDb2RlID09IDI3KVxyXG5cdFx0XHRcdFx0XHRcdCQodGhpcykudmFsKENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X05hbWUoKSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHQvLyBQcmV2ZW50IGRlZmF1bHQgY29udGV4dCBtZW51IGZyb20gb3BlbmluZyBvbiB0b3Agb2YgdGhlIEFjdGlvbnMgc3VibWVudVxyXG5cdFx0XHR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuXHRcdFx0XHRpZiAoZXZlbnQudGFyZ2V0Lm1hdGNoZXMoXCIuZW50cnktdmlldy1hY3Rpb25zX19tZW51LCAuZW50cnktdmlldy1hY3Rpb25zX19tZW51ICpcIikpIHtcclxuXHRcdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdFx0XHRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0Ly8jcmVnaW9uIFBhbmVsIHJlc2l6aW5nXHJcblx0XHRcdChmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0aWYgKENvZ25pdG8uY29uZmlnLmZsYWdzLkFwcE5hdilcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHJcblx0XHRcdFx0dmFyICRjb250YWluZXIgPSAkKFwiLmMtZW50cmllc1wiKSxcclxuXHRcdFx0XHRcdCRsZWZ0ID0gJChcIiNjLWVudHJ5bGlzdFwiKSxcclxuXHRcdFx0XHRcdCRyaWdodCA9ICQoXCIjYy1lbnRyeWRldGFpbHNcIik7XHJcblxyXG5cdFx0XHRcdC8vIFZhcmlhYmxlcyB1c2VkIGR1cmluZyBlYWNoIHJlc2l6ZSBvcGVyYXRpb25cclxuXHRcdFx0XHR2YXIgX3N0YXJ0WCA9IDAsXHJcblx0XHRcdFx0XHRfc3RhcnRXaWR0aCxcclxuXHRcdFx0XHRcdF9jb250YWluZXJQaXhlbFdpZHRoLFxyXG5cdFx0XHRcdFx0X21heFdpZHRoUGN0LFxyXG5cdFx0XHRcdFx0X21pbldpZHRoUGN0O1xyXG5cclxuXHRcdFx0XHRmdW5jdGlvbiBwYXJzZVBlcmNlbnRXaWR0aCh3aWR0aFN0eWxlKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gTnVtYmVyKHdpZHRoU3R5bGUuc3BsaXQoXCIlXCIpWzBdKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGZ1bmN0aW9uIHBhcnNlUGl4ZWxXaWR0aCh3aWR0aFN0eWxlKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gTnVtYmVyKHdpZHRoU3R5bGUuc3BsaXQoXCJweFwiKVswXSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRmdW5jdGlvbiByZXNpemVEcmFnU3RhcnQoZXZlbnQpIHtcclxuXHRcdFx0XHRcdHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcblx0XHRcdFx0XHRcdF9zdGFydFggPSBldmVudC5jbGllbnRYO1xyXG5cdFx0XHRcdFx0XHRfc3RhcnRXaWR0aCA9ICRyaWdodC53aWR0aCgpO1xyXG5cdFx0XHRcdFx0XHRfY29udGFpbmVyUGl4ZWxXaWR0aCA9ICRjb250YWluZXIud2lkdGgoKTtcclxuXHRcdFx0XHRcdFx0X21heFdpZHRoUGN0ID0gTWF0aC5mbG9vcihwYXJzZVBpeGVsV2lkdGgoJHJpZ2h0LmNzcyhcIm1heC13aWR0aFwiKSkgLyBfY29udGFpbmVyUGl4ZWxXaWR0aCAqIDEwMCk7XHJcblx0XHRcdFx0XHRcdF9taW5XaWR0aFBjdCA9IE1hdGguY2VpbChwYXJzZVBpeGVsV2lkdGgoJHJpZ2h0LmNzcyhcIm1pbi13aWR0aFwiKSkgLyBfY29udGFpbmVyUGl4ZWxXaWR0aCAqIDEwMCk7XHJcblxyXG5cdFx0XHRcdFx0XHQkY29udGFpbmVyLmFkZENsYXNzKFwiYy1yZXNpemluZ1wiKTtcclxuXHJcblx0XHRcdFx0XHRcdCQoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5vbihcIm1vdXNldXAgbW91c2VvdXRcIiwgcmVzaXplRHJhZ0VuZCk7XHJcblx0XHRcdFx0XHRcdCQoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5vbihcIm1vdXNlbW92ZVwiLCByZXNpemVEcmFnKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cclxuXHRcdFx0XHRcdGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdFx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGZ1bmN0aW9uIHNldFdpZHRoKGVudHJ5UGFuZWxXaWR0aCkge1xyXG5cdFx0XHRcdFx0JHJpZ2h0LmNzcyh7IFwid2lkdGhcIjogZW50cnlQYW5lbFdpZHRoICsgXCIlXCIgfSk7XHJcblx0XHRcdFx0XHQkbGVmdC5jc3MoXCJ3aWR0aFwiLCAoMTAwIC0gZW50cnlQYW5lbFdpZHRoKSArIFwiJVwiKTtcclxuXHJcblx0XHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuZmxhZ3MuQXBwTmF2KVxyXG5cdFx0XHRcdFx0XHQkdG9vbGJhci5jc3MoXCJ3aWR0aFwiLCAoMTAwIC0gZW50cnlQYW5lbFdpZHRoKSArIFwiJVwiKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGZ1bmN0aW9uIGRvUmVzaXplKHgsIGlzRW5kKSB7XHJcblx0XHRcdFx0XHQvLyBTaW5jZSB3ZSByZXNpemUgZnJvbSB0aGUgbGVmdCBlZGdlIG9mIHRoZSByaWdodCBwYW5lbCwgbW92aW5nIHRoZSBjdXJzb3IgbGVmdCByZXByZXNlbnRzIGluY3JlYXNlIGluIHdpZHRoXHJcblx0XHRcdFx0XHR2YXIgcGl4ZWxEZWx0YSA9IF9zdGFydFggLSB4O1xyXG5cdFx0XHRcdFx0dmFyIG5ld1dpZHRoID0gTWF0aC5tYXgoX21pbldpZHRoUGN0LCBNYXRoLm1pbihfbWF4V2lkdGhQY3QsIDEwMCAqIChfc3RhcnRXaWR0aCArIHBpeGVsRGVsdGEpIC8gX2NvbnRhaW5lclBpeGVsV2lkdGgpKTtcclxuXHJcblx0XHRcdFx0XHRpZiAobmV3V2lkdGggPiA5MCAmJiBpc0VuZClcclxuXHRcdFx0XHRcdFx0bmV3V2lkdGggPSBNYXRoLm1pbigxMDAsIF9tYXhXaWR0aFBjdCk7XHJcblxyXG5cdFx0XHRcdFx0Ly8gQ2xhbXAgdGhlIHdpZHRoIHRvIGFuIGludGVnZXIgdG8gcHJldmVudCBpbmNvbnNpc3RlbnQgYnJvd3NlciBpbXBsZW1lbnRhdGlvbiBvZiBmbG9hdGluZyBwb2ludCBwZXJjZW50IHdpZHRoXHJcblx0XHRcdFx0XHRpZiAoaXNFbmQpXHJcblx0XHRcdFx0XHRcdG5ld1dpZHRoID0gTWF0aC5mbG9vcihuZXdXaWR0aCk7XHJcblxyXG5cdFx0XHRcdFx0c2V0V2lkdGgobmV3V2lkdGgpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0ZnVuY3Rpb24gcmVzaXplRHJhZyhldmVudCkge1xyXG5cdFx0XHRcdFx0cmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcclxuXHRcdFx0XHRcdFx0aWYgKGRvUmVzaXplKGV2ZW50LmNsaWVudFgpKVxyXG5cdFx0XHRcdFx0XHRcdHJlc2l6ZURyYWdFbmQoZXZlbnQpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRmdW5jdGlvbiByZXNpemVEcmFnRW5kKGV2ZW50KSB7XHJcblx0XHRcdFx0XHRkb1Jlc2l6ZShldmVudC5jbGllbnRYLCB0cnVlKTtcclxuXHJcblx0XHRcdFx0XHQkKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkub2ZmKFwibW91c2V1cCBtb3VzZW91dFwiLCByZXNpemVEcmFnRW5kKTtcclxuXHRcdFx0XHRcdCQoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5vZmYoXCJtb3VzZW1vdmVcIiwgcmVzaXplRHJhZyk7XHJcblxyXG5cdFx0XHRcdFx0JGNvbnRhaW5lci5hZGRDbGFzcyhcImMtY3VzdG9tLXNpemVcIik7XHJcblx0XHRcdFx0XHQkY29udGFpbmVyLnJlbW92ZUNsYXNzKFwiYy1yZXNpemluZ1wiKTtcclxuXHRcdFx0XHRcdF9pc1Jlc2l6aW5nID0gZmFsc2U7XHJcblxyXG5cdFx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0XHRcdGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuc2F2ZVBhbmVsV2lkdGgoTnVtYmVyKHBhcnNlUGVyY2VudFdpZHRoKCRyaWdodFswXS5zdHlsZS53aWR0aCkpKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGlmICghQ29nbml0by5jb25maWcuQXBwTmF2KVxyXG5cdFx0XHRcdFx0JChcIi5jLXBhbmVsLXJlc2l6ZXJcIikub24oXCJtb3VzZWRvd25cIiwgcmVzaXplRHJhZ1N0YXJ0KTtcclxuXHJcblx0XHRcdFx0aWYgKENvZ25pdG8uY29uZmlnLmVudHJ5UGFnZVNldHRpbmdzLkVudHJ5UGFuZWxXaWR0aCkge1xyXG5cdFx0XHRcdFx0JGNvbnRhaW5lci5hZGRDbGFzcyhcImMtY3VzdG9tLXNpemVcIik7XHJcblx0XHRcdFx0XHRzZXRXaWR0aChDb2duaXRvLmNvbmZpZy5lbnRyeVBhZ2VTZXR0aW5ncy5FbnRyeVBhbmVsV2lkdGgpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0Ly8gTWFrZSBzdXJlIGxlZnQgYW5kIHJpZ2h0IHBhbmVscyBmaWxsIHRoZSBzcGFjZSB3aGVuIHdpbmRvdyBpcyByZXNpemVkXHJcblx0XHRcdFx0ZnVuY3Rpb24gd2luZG93UmVzaXplZCgpIHtcclxuXHRcdFx0XHRcdGlmICgkY29udGFpbmVyLmhhc0NsYXNzKFwiYy1jdXN0b20tc2l6ZVwiKSkge1xyXG5cdFx0XHRcdFx0XHRjbGVhclRpbWVvdXQoQ29nbml0by50aW1lcnMucGFuZWxSZXNpemluZyk7XHJcblx0XHRcdFx0XHRcdENvZ25pdG8udGltZXJzLnBhbmVsUmVzaXppbmcgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0XHR2YXIgYWN0dWFsUGN0V2lkdGggPSAkcmlnaHQud2lkdGgoKSAvICRjb250YWluZXIud2lkdGgoKSAqIDEwMDtcclxuXHRcdFx0XHRcdFx0XHQkY29udGFpbmVyLmFkZENsYXNzKFwiYy1yZXNpemluZ1wiKTtcclxuXHRcdFx0XHRcdFx0XHQkbGVmdC5jc3MoXCJ3aWR0aFwiLCAoMTAwIC0gYWN0dWFsUGN0V2lkdGgpICsgXCIlXCIpO1xyXG5cdFx0XHRcdFx0XHRcdGlmIChDb2duaXRvLmNvbmZpZy5mbGFncy5BcHBOYXYpXHJcblx0XHRcdFx0XHRcdFx0XHQkdG9vbGJhci5jc3MoXCJ3aWR0aFwiLCAoMTAwIC0gYWN0dWFsUGN0V2lkdGgpICsgXCIlXCIpO1xyXG5cdFx0XHRcdFx0XHRcdHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyAkY29udGFpbmVyLnJlbW92ZUNsYXNzKFwiYy1yZXNpemluZ1wiKTsgfSk7XHJcblx0XHRcdFx0XHRcdH0sIDEwMCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdCQod2luZG93KS5yZXNpemUod2luZG93UmVzaXplZCk7XHJcblx0XHRcdFx0d2luZG93UmVzaXplZCgpO1xyXG5cdFx0XHR9KSgpO1xyXG5cdFx0XHQvLyNlbmRyZWdpb25cclxuXHJcblx0XHR9XHJcblxyXG5cdFx0Ly8jZW5kcmVnaW9uXHJcblxyXG5cdFx0Ly8gI3JlZ2lvbiBtZW51IGV2ZW50IGhhbmRsZXJzXHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5vbk9wZW5FbnRyeVZpZXdTZXR0aW5ncyA9IGZ1bmN0aW9uIG9uT3BlbkVudHJ5Vmlld1NldHRpbmdzKCkge1xyXG5cdFx0XHRpZiAoIWNvbnRyb2xsZXIuY2FuQWNjZXNzRGVzdGluYXRpb25WaWV3KCkpXHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5zZXRfQWZ0ZXJTdWJtaXREZXN0aW5hdGlvblZpZXdJZChudWxsKTtcclxuXHRcdFx0Y29udHJvbGxlci5vcGVuRW50cnlWaWV3U2V0dGluZ3MoQ29nbml0by5zZXJpYWxpemUoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50VmlldykpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25SZW5hbWVWaWV3ID0gZnVuY3Rpb24gb25SZW5hbWVWaWV3KCkge1xyXG5cdFx0XHRjb250cm9sbGVyLnNob3dSZW5hbWVWaWV3KCk7XHJcblx0XHR9XHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5vbkNvcHlWaWV3ID0gZnVuY3Rpb24gb25Db3B5VmlldygpIHtcclxuXHRcdFx0Y29udHJvbGxlci5jb3B5VmlldygpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25EZWxldGVWaWV3ID0gZnVuY3Rpb24gb25EZWxldGVWaWV3KCkge1xyXG5cdFx0XHRjb250cm9sbGVyLmRlbGV0ZVZpZXcoKTtcclxuXHRcdH1cclxuXHJcblx0XHRDb2duaXRvLk1lc3NhZ2luZy5hZGRIYW5kbGVyKFwiY2hhbmdlVmlld1wiLCBmdW5jdGlvbiAodmlld0lkKSB7XHJcblx0XHRcdENvZ25pdG8uRm9ybXMub25DaGFuZ2VWaWV3KHZpZXdJZCk7XHJcblx0XHR9KTtcclxuXHRcdENvZ25pdG8uTWVzc2FnaW5nLmFkZEhhbmRsZXIoXCJuZXdWaWV3XCIsIGZ1bmN0aW9uICh0eXBlKSB7XHJcblx0XHRcdENvZ25pdG8uRm9ybXMub25OZXdWaWV3KHR5cGUpO1xyXG5cdFx0fSk7XHJcblx0XHRDb2duaXRvLk1lc3NhZ2luZy5hZGRIYW5kbGVyKFwicmVvcmRlclZpZXdcIiwgZnVuY3Rpb24gKHZpZXdJZE9iamVjdCkge1xyXG5cdFx0XHRDb2duaXRvLkZvcm1zLm9uUmVvcmRlclZpZXcodmlld0lkT2JqZWN0KTtcclxuXHRcdH0pO1xyXG5cdFx0Q29nbml0by5NZXNzYWdpbmcuYWRkSGFuZGxlcihcInNhdmVWaWV3XCIsIGZ1bmN0aW9uICh2aWV3T2JqZWN0KSB7XHJcblx0XHRcdGxldCB2aWV3ID0gdmlld09iamVjdDtcclxuXHRcdFx0bGV0IGlzT25seVJlbmFtaW5nID0gZmFsc2U7XHJcblx0XHRcdGlmICh2aWV3T2JqZWN0LnZpZXcpIHtcclxuXHRcdFx0XHR2aWV3ID0gdmlld09iamVjdC52aWV3O1xyXG5cdFx0XHRcdGlzT25seVJlbmFtaW5nID0gdmlld09iamVjdC5pc09ubHlSZW5hbWluZztcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0dmlldy5pc1VzZXJTcGVjaWZpYyA9ICEhdmlldy5TaGFyZWRXaXRoTWU7XHJcblxyXG5cdFx0XHQvLyBFeGlzdGluZyBWaWV3XHJcblx0XHRcdGlmICh2aWV3LklkKVxyXG5cdFx0XHRcdHZpZXcgPSBDb2duaXRvLmRlc2VyaWFsaXplKENvZ25pdG8uRm9ybXMuRW50cnlWaWV3LCB2aWV3LCBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3KTtcclxuXHRcdFx0Ly8gTmV3IFZpZXdcclxuXHRcdFx0ZWxzZVxyXG5cdFx0XHRcdHZpZXcgPSBDb2duaXRvLmRlc2VyaWFsaXplKENvZ25pdG8uRm9ybXMuRW50cnlWaWV3LCB2aWV3KTtcclxuXHJcblx0XHRcdGNvbnRyb2xsZXIuc2F2ZVZpZXcodmlldywgaXNPbmx5UmVuYW1pbmcpO1xyXG5cdFx0fSk7XHJcblx0XHRDb2duaXRvLk1lc3NhZ2luZy5hZGRIYW5kbGVyKFwiZGVsZXRlVmlld1wiLCBmdW5jdGlvbiAodmlld0lkT2JqZWN0KSB7XHJcblx0XHRcdGNvbnRyb2xsZXIuZGVsZXRlVmlldyh2aWV3SWRPYmplY3QpO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5vbkNoYW5nZVZpZXcgPSBmdW5jdGlvbiBvbkNoYW5nZVZpZXcodmlld0lkKSB7XHJcblxyXG5cdFx0XHRpZiAodmlld0lkICYmIHZpZXdJZCAhPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9JZCgpKSB7XHJcblxyXG5cdFx0XHRcdC8vIEluZGl2aWR1YWwgUGxhblxyXG5cdFx0XHRcdGlmICghQ29nbml0by5jb25maWcuaGFzUGFpZFBsYW4pIHtcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXIuc2hvd0ZlYXR1cmVXYXJuaW5nKFwiZW50cnl2aWV3c2V4aXN0XCIpO1xyXG5cdFx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0Ly8gTG9hZHMgdGhlIHNwZWNpZmllZCB2aWV3IGFuZCB0aGVuIGNoYW5nZXMgdG8gdGhlIG5ldyB2aWV3XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5nZXRFbnRyeVZpZXcodmlld0lkKVxyXG5cdFx0XHRcdFx0LnRoZW4oY2hlY2tGb3JtKGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRcdGRhdGEudmlldy5pc1VzZXJTcGVjaWZpYyA9IGRhdGEuaXNVc2VyU3BlY2lmaWMgfHwgZmFsc2U7XHJcblx0XHRcdFx0XHRcdHZhciB2aWV3ID0gQ29nbml0by5kZXNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLkVudHJ5VmlldywgZGF0YS52aWV3KTtcclxuXHJcblx0XHRcdFx0XHRcdGV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdncmlkJykuY2xhc3NMaXN0LmFkZCgnYy1oaWRlLWVudHJpZXMtZ3JpZCcpO1xyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXIuY2hhbmdlVmlldyh2aWV3LCBsYXlvdXRNb2RlKTtcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLmhpZGVNZW51cygpO1xyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdH0pKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25OZXdWaWV3ID0gZnVuY3Rpb24gb25OZXdWaWV3KHR5cGUpIHtcclxuXHJcblx0XHRcdC8vIEluZGl2aWR1YWwgUGxhblxyXG5cdFx0XHRpZiAoIUNvZ25pdG8uY29uZmlnLmhhc1BhaWRQbGFuKSB7XHJcblx0XHRcdFx0Y29udHJvbGxlci5zaG93RmVhdHVyZVdhcm5pbmcoXCJlbnRyeXZpZXdzXCIpO1xyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gRW5mb3JjZSBFbnRyeSBWaWV3IExpbWl0XHJcblx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLnZpZXdzLmxlbmd0aCA+PSBDb2duaXRvLmNvbmZpZy5lbnRyeVZpZXdMaW1pdCkge1xyXG5cdFx0XHRcdHNob3dWaWV3TGltaXRFeGNlZWRlZFdhcm5pbmcoKTtcclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGNvbnN0IGlzVGFza1ZpZXcgPSB0eXBlID09PSAnVGFzayc7XHJcblx0XHRcdGlmIChpc1Rhc2tWaWV3KSB7XHJcblx0XHRcdFx0dHlwZSA9ICdUYWJsZSc7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdC8vIENyZWF0ZSB0aGUgbmV3IHZpZXdcclxuXHRcdFx0dmFyIGZvcm0gPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtO1xyXG5cdFx0XHR2YXIgdmlldyA9XHJcblx0XHRcdHtcclxuXHRcdFx0XHROYW1lOiAnTmV3IFZpZXcnLFxyXG5cdFx0XHRcdEZvcm06IHsgSWQ6IGZvcm0uZ2V0X0lkKCkgfSxcclxuXHRcdFx0XHRSb2xlSWQ6IGZvcm1EYXRhLnZhbHVlLlJvbGVzLmZpbmQoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIHIuSXNJbnRlcm5hbDsgfSkuSWQsXHJcblx0XHRcdFx0VHlwZTogdHlwZSxcclxuXHRcdFx0XHRDb2x1bW5zOiBbXHJcblx0XHRcdFx0XHR7IEZpZWxkSWQ6IFwiRW50cnkuU3RhdHVzXCIsIFdpZHRoOiAxMDAgfSxcclxuXHRcdFx0XHRcdHsgRmllbGRJZDogXCJFbnRyeS5EYXRlU3VibWl0dGVkXCIsIFdpZHRoOiAxNDAgfVxyXG5cdFx0XHRcdF0sXHJcblx0XHRcdFx0UHJldmVudEVudHJ5Q3JlYXRpb246IGlzVGFza1ZpZXcgPyB0cnVlIDogZmFsc2UsXHJcblx0XHRcdFx0U2hvd1BhZ2VCcmVha3M6IHRydWVcclxuXHRcdFx0fTtcclxuXHJcblx0XHRcdC8vIEFkZCBvcmRlciBzdW1tYXJ5IGZvciBwYXltZW50IGZvcm1zXHJcblx0XHRcdGlmIChmb3JtLlBheW1lbnRFbmFibGVkKVxyXG5cdFx0XHRcdHZpZXcuQ29sdW1ucy5wdXNoKHsgRmllbGRJZDogXCJPcmRlci5PcmRlclN1bW1hcnlcIiwgV2lkdGg6IDEyMCB9KTtcclxuXHJcblx0XHRcdC8vIEluY2x1ZGUgYWxsIGZpZWxkc1xyXG5cdFx0XHR2aWV3LkFsbEZpZWxkcyA9IHRydWU7XHJcblx0XHRcdGlmICh0eXBlID09IFwiRm9ybVwiKVxyXG5cdFx0XHRcdG9uT3ZlcnJpZGVGb3JtRW50cnlDcmVhdGlvbihmYWxzZSk7XHJcblx0XHRcdGVsc2VcclxuXHRcdFx0XHRvbk92ZXJyaWRlRm9ybUVudHJ5Q3JlYXRpb24odHJ1ZSk7XHJcblxyXG5cdFx0XHQvL2luaXRpdGlhbHplIFNoYXJlZFdpdGhNZVxyXG5cdFx0XHRpZiAoQ29nbml0by5jb25maWcuZmxhZ3MuVXNlclNwZWNpZmljVmlld3MpIHtcclxuXHRcdFx0XHR2aWV3LlNoYXJlZFdpdGhNZSA9IGlzVGFza1ZpZXc7XHJcblx0XHRcdFx0dmlldy5Jc1Rhc2tWaWV3ID0gaXNUYXNrVmlldztcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gQ3JlYXRlIE5ldyBWaWV3XHJcblx0XHRcdGNvbnRyb2xsZXIub3BlbkVudHJ5Vmlld1NldHRpbmdzKHZpZXcsIHRydWUpO1xyXG5cdFx0fVxyXG5cclxuXHRcdC8vIFJlb3JkZXJzIHRoZSBzcGVjaWZpZWQgdmlldyBhbmQgcmVmcmVzaGVzIHRvIGVuc3VyZSB2aWV3cyBhcHBlYXIgaW4gdGhlIGNvcnJlY3Qgb3JkZXJcclxuXHRcdENvZ25pdG8uRm9ybXMub25SZW9yZGVyVmlldyA9IGZ1bmN0aW9uIG9uUmVvcmRlclZpZXcoZSkge1xyXG5cdFx0XHRDb2duaXRvLkZvcm1zLnJlb3JkZXJFbnRyeVZpZXcoZS52aWV3SWQsIGUuYWZ0ZXJWaWV3SWQpXHJcblx0XHRcdFx0LnRoZW4oQ29nbml0by5Gb3Jtcy5yZWZyZXNoVmlld3MpXHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gUmVmcmVzaGVkIHRoZSBsaXN0IG9mIHZpZXdzIGZvciB0aGUgZm9ybVxyXG5cdFx0Q29nbml0by5Gb3Jtcy5yZWZyZXNoVmlld3MgPSBmdW5jdGlvbiByZWZyZXNoVmlld3MoKSB7XHJcblx0XHRcdHJldHVybiBDb2duaXRvLkZvcm1zLmdldEVudHJ5Vmlld3MoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Rm9ybS5nZXRfSWQoKSlcclxuXHRcdFx0XHQudGhlbihmdW5jdGlvbiAodmlld3MpIHtcclxuXHRcdFx0XHRcdEV4b1dlYi5PYnNlcnZlci5zZXRWYWx1ZShDb2duaXRvLkZvcm1zLm1vZGVsLCBcInZpZXdzXCIsIHZpZXdzKTtcclxuXHRcdFx0XHRcdHZhciByZWZldGNoR3JpZCA9IENvZ25pdG8uRm9ybXMubW9kZWwudmlld3MuZmluZChmdW5jdGlvbiAodikgeyByZXR1cm4gdi5JZCA9PT0gQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKSAmJiB2LkVudHJpZXMgIT0gKGN1cnJlbnRWaWV3RW50cnlDb3VudC52YWx1ZSB8fCAwKTsgfSk7XHJcblx0XHRcdFx0XHRpZiAocmVmZXRjaEdyaWQgJiYgY29udHJvbGxlci5tYXN0ZXIpXHJcblx0XHRcdFx0XHRcdGNvbnRyb2xsZXIubWFzdGVyLnJlZnJlc2hFbnRyaWVzKCk7XHJcblx0XHRcdFx0XHRyZXR1cm4gdmlld3M7XHJcblx0XHRcdFx0fSkuY2F0Y2goZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblx0XHRcdFx0XHQvLyBJZiBhIHVzZXIgbG9zZXMgYWNjZXNzIHRvIHRoZSBlbnRyaWVzIHBhZ2Ugc2V0IGFsbCB2aWV3cyB0byAwIGFuZCByZWZyZXNoIHRoZSBncmlkXHJcblx0XHRcdFx0XHRpZiAoQ29nbml0by5jb25maWcuZmxhZ3MuVXNlclNwZWNpZmljVmlld3MgJiYgcmVzcG9uc2Uuc3RhdHVzID09IDQwMykge1xyXG5cdFx0XHRcdFx0XHR2YXIgcmVmZXRjaEdyaWQgPSBmYWxzZTtcclxuXHRcdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC52aWV3cy5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7XHJcblx0XHRcdFx0XHRcdFx0aWYgKHYuRW50cmllcykge1xyXG5cdFx0XHRcdFx0XHRcdFx0di5FbnRyaWVzID0gMDtcclxuXHRcdFx0XHRcdFx0XHRcdHJlZmV0Y2hHcmlkID0gdHJ1ZTtcclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHRpZiAocmVmZXRjaEdyaWQpXHJcblx0XHRcdFx0XHRcdFx0Y29udHJvbGxlci5tYXN0ZXIucmVmcmVzaEVudHJpZXMoKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdHJldHVybiByZXNwb25zZTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdH1cclxuXHJcblx0XHRDb2duaXRvLkZvcm1zLmdldFJvbGVPcHRpb25zID0gZnVuY3Rpb24gZ2V0Um9sZU9wdGlvbnMoKSB7XHJcblx0XHRcdHJldHVybiBDb2duaXRvLnNlcmlhbGl6ZShDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRGb3JtLmdldF9Sb2xlcygpKTtcclxuXHRcdH1cclxuXHJcblx0XHRDb2duaXRvLkZvcm1zLm9uUm9sZUNoYW5nZWQgPSBmdW5jdGlvbiBvblJvbGVDaGFuZ2VkKGUpIHtcclxuXHRcdFx0ZXhlY3V0ZUFjdGlvbihmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5zZXRfUm9sZUlkKGUuSWQpO1xyXG5cdFx0XHRcdGNvbnRyb2xsZXIudmlld0NoYW5nZWQoKTtcclxuXHRcdFx0XHRjb250cm9sbGVyLmRldGFpbC5zZXRSb2xlKGUuTmFtZSk7XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25EZWxldGUgPSBmdW5jdGlvbiBvbkRlbGV0ZShlKSB7XHJcblx0XHRcdGlmIChzZWxlY3RlZEVudHJpZXMubGVuZ3RoKVxyXG5cdFx0XHRcdGNvbnRyb2xsZXIuZGVsZXRlRW50cmllcyhzZWxlY3RlZEVudHJpZXMpO1xyXG5cdFx0fVxyXG5cclxuXHRcdG9uRXhwb3J0RW50cmllcygoZXhwb3J0RGF0YSkgPT4ge1xyXG5cdFx0XHRjb25zdCBbIGV4cG9ydEFsbEZpZWxkcywgc2VsZWN0ZWRFbnRyaWVzIF0gPSBleHBvcnREYXRhO1xyXG5cdFx0XHRDb2duaXRvLkZvcm1zLm9uRXhwb3J0KGV4cG9ydEFsbEZpZWxkcywgc2VsZWN0ZWRFbnRyaWVzKTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25FeHBvcnQgPSBmdW5jdGlvbiBvbkV4cG9ydChleHBvcnRBbGxGaWVsZHMsIHNlbGVjdGVkRW50cmllcykge1xyXG5cdFx0XHRjb250cm9sbGVyLmV4cG9ydEVudHJpZXMoZXhwb3J0QWxsRmllbGRzLCBzZWxlY3RlZEVudHJpZXMpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25SZWFkU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbiBvblJlYWRTdGF0ZUNoYW5nZShyZWFkKSB7XHJcblx0XHRcdGlmIChzZWxlY3RlZEVudHJpZXMubGVuZ3RoKVxyXG5cdFx0XHRcdGNvbnRyb2xsZXIudXBkYXRlR3JpZFJlYWRTdGF0ZShzZWxlY3RlZEVudHJpZXMsIHJlYWQpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25JbXBvcnQgPSBmdW5jdGlvbiBvbkltcG9ydChlKSB7XHJcblx0XHRcdGNvbnRyb2xsZXIuaW1wb3J0RW50cmllcygpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25TdGF0dXNDaGFuZ2UgPSBmdW5jdGlvbiBvblN0YXR1c0NoYW5nZShzdGF0dXMpIHtcclxuXHRcdFx0aWYgKHNlbGVjdGVkRW50cmllcy5sZW5ndGgpXHJcblx0XHRcdFx0Y29udHJvbGxlci51cGRhdGVFbnRyeVN0YXR1cyhzZWxlY3RlZEVudHJpZXMsIHN0YXR1cy5OYW1lLCBudWxsLCBzdGF0dXMuSWQpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25CdWxrRmlsZURvd25sb2FkID0gZnVuY3Rpb24gb25CdWxrRmlsZURvd25sb2FkKCkge1xyXG5cdFx0XHRpZiAoQ29nbml0by5jb25maWcuYWxsb3dCdWxrRmlsZURvd25sb2FkKSB7XHJcblx0XHRcdFx0ZGlzcGxheUJ1bGtEb3dubG9hZERpYWxvZyhcIkZpbGVcIik7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZVxyXG5cdFx0XHRcdGRpc3BsYXlCdWxrRmlsZURvd25sb2FkVXBzZWxsRGlhbG9nKCk7XHJcblx0XHR9XHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5vbkJ1bGtEb2N1bWVudERvd25sb2FkID0gZnVuY3Rpb24gb25CdWxrRG9jdW1lbnREb3dubG9hZChkb2N1bWVudFRlbXBsYXRlSWQpIHtcclxuXHRcdFx0aWYgKENvZ25pdG8uY29uZmlnLmFsbG93QnVsa0RvY3VtZW50RG93bmxvYWQpIHtcclxuXHRcdFx0XHRkaXNwbGF5QnVsa0Rvd25sb2FkRGlhbG9nKFwiRG9jdW1lbnRcIiwgZG9jdW1lbnRUZW1wbGF0ZUlkKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0ZGlzcGxheUJ1bGtEb2N1bWVudERvd25sb2FkVXBzZWxsRGlhbG9nKCk7XHJcblx0XHR9XHJcblxyXG5cdFx0b25QZXJmb3JtQnVsa0FjdGlvbigoYWN0aW9uKSA9PiB7XHJcblx0XHRcdENvZ25pdG8uRm9ybXMub25CdWxrQWN0aW9uKGFjdGlvbik7XHJcblx0XHR9KTtcclxuXHJcblx0XHRDb2duaXRvLkZvcm1zLm9uQnVsa0FjdGlvbiA9IGZ1bmN0aW9uIG9uQnVsa0FjdGlvbihhY3Rpb24pIHtcclxuXHRcdFx0aWYgKENvZ25pdG8uY29uZmlnLmFsbG93QnVsa0FjdGlvbnMpXHJcblx0XHRcdFx0ZGlzcGxheUJ1bGtBY3Rpb25EaWFsb2coYWN0aW9uKTtcclxuXHRcdFx0ZWxzZVxyXG5cdFx0XHRcdGNvbnRyb2xsZXIuc2hvd0ZlYXR1cmVXYXJuaW5nKCdidWxrYWN0aW9ucycpO1xyXG5cdFx0fVxyXG5cclxuXHRcdC8vI2VuZHJlZ2lvblxyXG5cclxuXHRcdC8vICNyZWdpb24gVXRpbGl0eVxyXG5cdFx0Q29nbml0by5Gb3Jtcy5vbkZvcm1WaWV3QWRhcHRlclJlYWR5ID0gZnVuY3Rpb24gb25Gb3JtVmlld0FkYXB0ZXJSZWFkeShmb3JtVmlld0FkYXB0ZXIpIHtcclxuXHRcdFx0aWYgKCF3aW5kb3cuQ29nbml0bylcclxuXHRcdFx0XHRyZXR1cm47XHJcblxyXG5cdFx0XHRDb2duaXRvLmZvcm1WaWV3QWRhcHRlciA9IGZvcm1WaWV3QWRhcHRlcjtcclxuXHJcblx0XHRcdGlmIChDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9UeXBlKCkuZ2V0X05hbWUoKSA9PT0gJ0Zvcm0nICYmICFDb2duaXRvLmZvcm1WaWV3QWRhcHRlci5oYXNDaGFuZ2VIYW5kbGVyKCkgJiYgQ29nbml0by5mb3JtVmlld0FkYXB0ZXIuaXNGb3JtQXZhaWxhYmxlKCkpXHJcblx0XHRcdFx0Q29nbml0by5mb3JtVmlld0FkYXB0ZXIuYWRkQ2hhbmdlc0RldGVjdGVkKG9uRW50cnlDaGFuZ2VkKVxyXG5cdFx0XHRDb2duaXRvLnJlYWR5KFwiZm9ybVZpZXdBZGFwdGVyXCIpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMub25Gb3JtVmlld01vdW50ZWQgPSBmdW5jdGlvbiBvbkZvcm1WaWV3TW91bnRlZChmb3JtVmlld0FkYXB0ZXIpIHtcclxuXHRcdFx0Q29nbml0by5Gb3Jtcy5vbkZvcm1WaWV3QWRhcHRlclJlYWR5KGZvcm1WaWV3QWRhcHRlcik7XHJcblxyXG5cdFx0XHRjb25zdCByb2xlSWQgPSBDb2duaXRvLkZvcm1zLm1vZGVsLmN1cnJlbnRWaWV3LmdldF9Sb2xlSWQoKTtcclxuXHRcdFx0Y29uc3Qgcm9sZSA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudEZvcm0uZ2V0X1JvbGVzKCkuZmluZChmdW5jdGlvbiAocikgeyByZXR1cm4gci5nZXRfSWQoKSA9PT0gcm9sZUlkOyB9KTtcclxuXHRcdFx0Y29uc3QgaXNQdWJsaWMgPSByb2xlLmdldF9Jc1B1YmxpYygpO1xyXG5cclxuXHRcdFx0Ly8gUmVnaXN0ZXIgdGhlIHZpZXcgbm93IHRoYXQgd2UndmUgcmVtb3VudGVkIHRoZSBmb3JtIGFuZCBwcmV2aW91cyB2aWV3IGRhdGEgaW4gdGhlIGZvcm0gaGFuZGxlIGlzIGdvbmVcclxuXHRcdFx0Zm9ybVZpZXdBZGFwdGVyLmNoYW5nZVZpZXcoQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfSWQoKSwgQ29nbml0by5Gb3Jtcy5tb2RlbC5jdXJyZW50Vmlldy5nZXRfVG9rZW4oKSk7XHJcblx0XHRcdGZvcm1WaWV3QWRhcHRlci5zZXRDb3JyZWN0Rm9ybUF2YWlsYWJpbGl0eShpc1B1YmxpYyk7XHJcblx0XHR9XHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5iZWZvcmVGb3JtVmlld1N1Ym1pdCA9IGZ1bmN0aW9uIGJlZm9yZUZvcm1WaWV3U3VibWl0KCkge1xyXG5cdFx0XHRjb25zdCBpc1JlZGlyZWN0aW5nVG9FbnRyeVZpZXcgPSAhIUNvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X0FmdGVyU3VibWl0RGVzdGluYXRpb25WaWV3SWQoKTtcclxuXHRcdFx0Q29nbml0by5mb3JtVmlld0FkYXB0ZXIuc2V0UmVkaXJlY3RpbmdUb1ZpZXcoaXNSZWRpcmVjdGluZ1RvRW50cnlWaWV3KTtcclxuXHRcdH1cclxuXHJcblx0XHRDb2duaXRvLkZvcm1zLm9uRm9ybVZpZXdTdWJtaXR0ZWQgPSBmdW5jdGlvbiBvbkZvcm1WaWV3U3VibWl0dGVkKCkge1xyXG5cclxuXHRcdFx0Y29uc3QgZGVzdGluYXRpb25JZCA9IENvZ25pdG8uRm9ybXMubW9kZWwuY3VycmVudFZpZXcuZ2V0X0FmdGVyU3VibWl0RGVzdGluYXRpb25WaWV3SWQoKTtcclxuXHJcblx0XHRcdGlmICghIWRlc3RpbmF0aW9uSWQpXHJcblx0XHRcdFx0Q29nbml0by5Gb3Jtcy5zd2l0Y2hUb0Rlc3RpbmF0aW9uVmlldyhkZXN0aW5hdGlvbklkKVxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdFx0b25PdmVycmlkZUZvcm1FbnRyeUNyZWF0aW9uKHRydWUpO1xyXG5cdFx0fVxyXG5cclxuXHRcdENvZ25pdG8uRm9ybXMuc2V0RW50cnlOb0NoYW5nZXMgPSBmdW5jdGlvbiBzZXRFbnRyeU5vQ2hhbmdlcygpIHtcclxuXHRcdFx0ZW50cnlIYXNDaGFuZ2VzID0gZmFsc2U7XHJcblx0XHR9XHJcblxyXG5cdFx0Q29nbml0by5Gb3Jtcy5zd2l0Y2hUb0Rlc3RpbmF0aW9uVmlldyA9IGZ1bmN0aW9uIHN3aXRjaFRvRGVzdGluYXRpb25WaWV3KHZpZXdJZCkge1xyXG5cdFx0XHRyZXR1cm4gQ29nbml0by5Gb3Jtcy5yZWZyZXNoVmlld3MoKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHR2YXIgdmlld0lzQWNjZXNzaWJsZSA9IGNvbnRyb2xsZXIuY2FuQWNjZXNzRGVzdGluYXRpb25WaWV3KCk7XHJcblxyXG5cdFx0XHRcdGlmICh2aWV3SXNBY2Nlc3NpYmxlKSB7XHJcblx0XHRcdFx0XHRDb2duaXRvLmZvcm1WaWV3QWRhcHRlci5zaG93Q29uZmlybWF0aW9uTWVzc2FnZSgpO1xyXG5cdFx0XHRcdFx0Q29nbml0by5Gb3Jtcy5vbkNoYW5nZVZpZXcodmlld0lkKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0XHRDb2duaXRvLmZvcm1WaWV3QWRhcHRlci5zaG93Q29uZmlybWF0aW9uUGFnZSgpO1xyXG5cclxuXHRcdFx0XHRcdC8vIE5lZWQgdG8gc2hvdyBuZXcgZW50cnkgYnV0dG9uIHNpbmNlIHdlJ3JlIHVuZXhwZWN0ZWRseSBnb2luZyB0byB0aGUgY29uZmlybWF0aW9uIHBhZ2VcclxuXHRcdFx0XHRcdG9uT3ZlcnJpZGVGb3JtRW50cnlDcmVhdGlvbih0cnVlKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuXHRcdGZ1bmN0aW9uIG9uRW50cnlDaGFuZ2VkKGV2ZW50KSB7XHJcblx0XHRcdGlmIChlbnRyeUhhc0NoYW5nZXMgfHwgZXZlbnQub2xkVmFsdWUgPT0gZXZlbnQubmV3VmFsdWUpXHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdFx0aWYgKENvZ25pdG8uRm9ybXMub25FbnRyeUNoYW5nZWQoZXZlbnQpKVxyXG5cdFx0XHRcdGNvbnRyb2xsZXIuZW50cnlDaGFuZ2VkKCk7XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8jZW5kcmVnaW9uXHJcblxyXG5cdFx0ZnVuY3Rpb24gaXNFbnRyeURldGFpbHNWaXNpYmxlKCkge1xyXG5cdFx0XHRyZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5jLWVudHJpZXNcIikuaGFzQXR0cmlidXRlKFwiZGF0YS1zaG93LWVudHJ5LWRldGFpbFwiKTtcclxuXHRcdH1cclxuXHJcblx0XHRmdW5jdGlvbiBzaG93RW50cnlEZXRhaWxzKCkge1xyXG5cdFx0XHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmMtZW50cmllc1wiKS5zZXRBdHRyaWJ1dGUoXCJkYXRhLXNob3ctZW50cnktZGV0YWlsXCIsIFwiXCIpO1xyXG5cdFx0XHQvLyBOZWVkIHRoaXMgYXR0cmlidXRlIGF0IGEgaGlnaGVyIGxldmVsIHRvIGF2b2lkIENTUyA6aGFzIHNlbGVjdG9yLlxyXG5cdFx0XHQvLyBMb3dlci1sZXZlbCBvbmUgbGVmdCBpbiBwbGFjZSB0byBhdm9pZCBicmVha2luZyB0aGluZ3MuXHJcblx0XHRcdGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZW50cmllcy1wYWdlXCIpLnNldEF0dHJpYnV0ZShcImRhdGEtaGFzLWVudHJ5LWRldGFpbFwiLCBcIlwiKTtcclxuXHRcdFx0c2V0RW50cnlEZXRhaWxzSXNPcGVuKHRydWUpO1xyXG5cdFx0fVxyXG5cdFx0ZnVuY3Rpb24gaGlkZUVudHJ5RGV0YWlscygpIHtcclxuXHRcdFx0ZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5jLWVudHJpZXNcIikucmVtb3ZlQXR0cmlidXRlKFwiZGF0YS1zaG93LWVudHJ5LWRldGFpbFwiKTtcclxuXHRcdFx0ZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5lbnRyaWVzLXBhZ2VcIikucmVtb3ZlQXR0cmlidXRlKFwiZGF0YS1oYXMtZW50cnktZGV0YWlsXCIpO1xyXG5cdFx0XHRzZXRFbnRyeURldGFpbHNJc09wZW4oZmFsc2UpO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiIn0=